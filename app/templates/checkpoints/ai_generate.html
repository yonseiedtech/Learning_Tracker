{% extends "base.html" %}

{% block title %}AI 체크포인트 생성 - {{ course.title }}{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">대시보드</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('courses.view', course_id=course.id) }}">{{ course.title }}</a></li>
        <li class="breadcrumb-item active">AI 체크포인트 생성</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold mb-1"><i class="bi bi-robot text-primary me-2"></i>AI 체크포인트 생성</h2>
        <p class="text-muted mb-0">강의 자료를 업로드하면 AI가 자동으로 체크포인트를 생성합니다</p>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-5">
        <div class="glass-card p-4">
            <h5 class="fw-bold mb-4"><i class="bi bi-cloud-upload me-2 text-primary"></i>자료 업로드</h5>
            
            <ul class="nav nav-pills nav-fill mb-4" id="sourceTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="ppt-tab" data-bs-toggle="pill" data-bs-target="#ppt-panel" type="button" role="tab">
                        <i class="bi bi-file-earmark-slides me-1"></i>PPT/PDF
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="video-tab" data-bs-toggle="pill" data-bs-target="#video-panel" type="button" role="tab">
                        <i class="bi bi-camera-video me-1"></i>영상
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="audio-tab" data-bs-toggle="pill" data-bs-target="#audio-panel" type="button" role="tab">
                        <i class="bi bi-mic me-1"></i>음성
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="text-tab" data-bs-toggle="pill" data-bs-target="#text-panel" type="button" role="tab">
                        <i class="bi bi-textarea-t me-1"></i>텍스트
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="sourceTabContent">
                <div class="tab-pane fade show active" id="ppt-panel" role="tabpanel">
                    <div class="upload-zone p-5 text-center rounded-3 mb-3" id="pptDropZone" 
                         ondrop="handleDrop(event, 'ppt')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <i class="bi bi-file-earmark-slides fs-1 text-primary mb-3 d-block"></i>
                        <p class="mb-2">PPT, PPTX, PDF 파일을 드래그하거나</p>
                        <input type="file" id="pptFile" accept=".ppt,.pptx,.pdf" class="d-none" onchange="handleFileSelect(this, 'ppt')">
                        <button class="btn btn-outline-primary" onclick="document.getElementById('pptFile').click()">
                            파일 선택
                        </button>
                        <p class="small text-muted mt-2 mb-0" id="pptFileName"></p>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="video-panel" role="tabpanel">
                    <div class="upload-zone p-5 text-center rounded-3 mb-3" id="videoDropZone"
                         ondrop="handleDrop(event, 'video')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <i class="bi bi-camera-video fs-1 text-success mb-3 d-block"></i>
                        <p class="mb-2">MP4, WebM, MOV 파일을 드래그하거나</p>
                        <input type="file" id="videoFile" accept="video/*" class="d-none" onchange="handleFileSelect(this, 'video')">
                        <button class="btn btn-outline-success" onclick="document.getElementById('videoFile').click()">
                            파일 선택
                        </button>
                        <p class="small text-muted mt-2 mb-0" id="videoFileName"></p>
                    </div>
                    <div class="alert alert-info small">
                        <i class="bi bi-info-circle me-1"></i>
                        영상 분석 시 자동으로 전사문이 생성됩니다. 대용량 파일은 시간이 소요될 수 있습니다.
                    </div>
                </div>
                
                <div class="tab-pane fade" id="audio-panel" role="tabpanel">
                    <div class="upload-zone p-5 text-center rounded-3 mb-3" id="audioDropZone"
                         ondrop="handleDrop(event, 'audio')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <i class="bi bi-mic fs-1 text-warning mb-3 d-block"></i>
                        <p class="mb-2">MP3, WAV, M4A 파일을 드래그하거나</p>
                        <input type="file" id="audioFile" accept="audio/*" class="d-none" onchange="handleFileSelect(this, 'audio')">
                        <button class="btn btn-outline-warning" onclick="document.getElementById('audioFile').click()">
                            파일 선택
                        </button>
                        <p class="small text-muted mt-2 mb-0" id="audioFileName"></p>
                    </div>
                    <div class="alert alert-info small">
                        <i class="bi bi-info-circle me-1"></i>
                        음성 파일이 텍스트로 전사되며, 전사문 수정이 가능합니다.
                    </div>
                </div>
                
                <div class="tab-pane fade" id="text-panel" role="tabpanel">
                    <textarea class="form-control mb-3" id="textContent" rows="10" placeholder="강의 내용, 커리큘럼, 또는 학습 목표를 입력하세요..."></textarea>
                </div>
            </div>
            
            <button class="btn btn-primary w-100 py-2" onclick="generateCheckpoints()" id="generateBtn">
                <i class="bi bi-magic me-2"></i>AI로 체크포인트 생성
            </button>
            
            <div class="progress mt-3 d-none" id="progressBar" style="height: 8px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
            </div>
            <p class="text-center small text-muted mt-2 d-none" id="progressText">분석 중...</p>
        </div>
    </div>
    
    <div class="col-lg-7">
        <div class="glass-card p-4" id="resultSection">
            <h5 class="fw-bold mb-4"><i class="bi bi-list-check me-2 text-success"></i>생성된 체크포인트</h5>
            
            <div id="emptyState" class="text-center py-5">
                <i class="bi bi-inbox fs-1 text-muted mb-3 d-block"></i>
                <p class="text-muted">자료를 업로드하고 AI 생성 버튼을 클릭하세요</p>
            </div>
            
            <div id="checkpointsList" class="d-none">
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <span class="badge bg-primary" id="checkpointCount">0개 생성됨</span>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="selectAllCheckpoints()">
                            <i class="bi bi-check-all me-1"></i>전체 선택
                        </button>
                        <button class="btn btn-outline-secondary" onclick="deselectAllCheckpoints()">
                            <i class="bi bi-x-lg me-1"></i>전체 해제
                        </button>
                    </div>
                </div>
                
                <div id="checkpointsContainer" style="max-height: 400px; overflow-y: auto;"></div>
                
                <div class="mt-4 d-flex gap-2">
                    <button class="btn btn-success flex-grow-1" onclick="saveCheckpoints()" id="saveBtn">
                        <i class="bi bi-save me-2"></i>선택한 체크포인트 저장
                    </button>
                    <button class="btn btn-outline-secondary" onclick="regenerateCheckpoints()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="glass-card p-4 mt-4 d-none" id="transcriptSection">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold mb-0"><i class="bi bi-chat-left-text me-2 text-info"></i>전사문</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="toggleTranscriptEdit()">
                    <i class="bi bi-pencil me-1"></i>수정
                </button>
            </div>
            <div id="transcriptView" class="p-3 bg-light rounded-3" style="max-height: 300px; overflow-y: auto; white-space: pre-wrap;"></div>
            <textarea id="transcriptEdit" class="form-control d-none" rows="10"></textarea>
            <div class="mt-2 d-none" id="transcriptEditButtons">
                <button class="btn btn-sm btn-primary me-2" onclick="saveTranscript()">저장</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="cancelTranscriptEdit()">취소</button>
                <button class="btn btn-sm btn-outline-info ms-2" onclick="regenerateFromTranscript()">
                    <i class="bi bi-arrow-clockwise me-1"></i>전사문으로 다시 생성
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.upload-zone {
    border: 2px dashed rgba(102, 126, 234, 0.3);
    background: rgba(102, 126, 234, 0.02);
    transition: all 0.3s ease;
    cursor: pointer;
}
.upload-zone:hover, .upload-zone.drag-over {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.08);
}
.upload-zone.has-file {
    border-color: #28a745;
    background: rgba(40, 167, 69, 0.05);
}
.checkpoint-preview {
    background: rgba(255,255,255,0.7);
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 12px;
    padding: 12px 16px;
    margin-bottom: 10px;
    transition: all 0.2s ease;
}
.checkpoint-preview:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
.checkpoint-preview.selected {
    border-color: var(--primary-color);
    background: rgba(102, 126, 234, 0.05);
}
.nav-pills .nav-link {
    border-radius: 10px;
    padding: 10px 16px;
    color: var(--bs-body-color);
}
.nav-pills .nav-link.active {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
}
</style>

<script>
const csrfToken = '{{ csrf_token() }}';
const courseId = {{ course.id }};
let currentSourceType = 'ppt';
let currentFile = null;
let generatedCheckpoints = [];
let currentTranscript = '';

document.querySelectorAll('#sourceTab button').forEach(btn => {
    btn.addEventListener('shown.bs.tab', function(e) {
        currentSourceType = e.target.id.replace('-tab', '');
        currentFile = null;
        ['pptFileName', 'videoFileName', 'audioFileName'].forEach(id => {
            document.getElementById(id).textContent = '';
        });
    });
});

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

function handleDrop(e, type) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        currentFile = files[0];
        document.getElementById(`${type}FileName`).textContent = currentFile.name;
        e.currentTarget.classList.add('has-file');
    }
}

function handleFileSelect(input, type) {
    if (input.files.length > 0) {
        currentFile = input.files[0];
        document.getElementById(`${type}FileName`).textContent = currentFile.name;
        input.closest('.upload-zone').classList.add('has-file');
    }
}

async function generateCheckpoints() {
    const btn = document.getElementById('generateBtn');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    const formData = new FormData();
    formData.append('source_type', currentSourceType);
    
    if (currentSourceType === 'text') {
        const textContent = document.getElementById('textContent').value;
        if (!textContent.trim()) {
            alert('텍스트를 입력해주세요.');
            return;
        }
        formData.append('text_content', textContent);
    } else {
        if (!currentFile) {
            alert('파일을 선택해주세요.');
            return;
        }
        formData.append('file', currentFile);
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>분석 중...';
    progressBar.classList.remove('d-none');
    progressText.classList.remove('d-none');
    
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress = Math.min(progress + Math.random() * 10, 90);
        progressBar.querySelector('.progress-bar').style.width = `${progress}%`;
    }, 500);
    
    try {
        const response = await fetch(`/checkpoints/course/${courseId}/ai-generate/upload`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            generatedCheckpoints = data.checkpoints;
            currentTranscript = data.transcript || '';
            displayCheckpoints();
            
            if (currentTranscript) {
                document.getElementById('transcriptSection').classList.remove('d-none');
                document.getElementById('transcriptView').textContent = currentTranscript;
            }
        } else {
            alert('오류: ' + (data.error || '알 수 없는 오류'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('오류가 발생했습니다: ' + error.message);
    } finally {
        clearInterval(progressInterval);
        progressBar.querySelector('.progress-bar').style.width = '100%';
        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-magic me-2"></i>AI로 체크포인트 생성';
            progressBar.classList.add('d-none');
            progressText.classList.add('d-none');
        }, 500);
    }
}

function displayCheckpoints() {
    const container = document.getElementById('checkpointsContainer');
    const emptyState = document.getElementById('emptyState');
    const checkpointsList = document.getElementById('checkpointsList');
    
    if (generatedCheckpoints.length === 0) {
        emptyState.classList.remove('d-none');
        checkpointsList.classList.add('d-none');
        return;
    }
    
    emptyState.classList.add('d-none');
    checkpointsList.classList.remove('d-none');
    document.getElementById('checkpointCount').textContent = `${generatedCheckpoints.length}개 생성됨`;
    
    container.innerHTML = generatedCheckpoints.map((cp, index) => `
        <div class="checkpoint-preview selected" data-index="${index}" onclick="toggleCheckpoint(this)">
            <div class="d-flex align-items-start">
                <div class="form-check me-3">
                    <input class="form-check-input" type="checkbox" checked id="cp-${index}">
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 mb-1">
                        <span class="badge bg-primary">${cp.order || index + 1}</span>
                        <input type="text" class="form-control form-control-sm border-0 fw-bold p-0" 
                               value="${cp.title}" onchange="updateCheckpoint(${index}, 'title', this.value)"
                               style="background: transparent;">
                    </div>
                    <textarea class="form-control form-control-sm border-0 text-muted p-0" rows="2"
                              onchange="updateCheckpoint(${index}, 'description', this.value)"
                              style="background: transparent; resize: none;">${cp.description || ''}</textarea>
                    <div class="d-flex align-items-center mt-2">
                        <i class="bi bi-clock text-primary me-1"></i>
                        <input type="number" class="form-control form-control-sm border-0 p-0" 
                               value="${cp.estimated_minutes || 5}" min="1" max="60"
                               onchange="updateCheckpoint(${index}, 'estimated_minutes', parseInt(this.value))"
                               style="width: 40px; background: transparent;">
                        <span class="text-muted small">분</span>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function toggleCheckpoint(element) {
    const checkbox = element.querySelector('input[type="checkbox"]');
    checkbox.checked = !checkbox.checked;
    element.classList.toggle('selected', checkbox.checked);
}

function selectAllCheckpoints() {
    document.querySelectorAll('.checkpoint-preview').forEach(el => {
        el.classList.add('selected');
        el.querySelector('input[type="checkbox"]').checked = true;
    });
}

function deselectAllCheckpoints() {
    document.querySelectorAll('.checkpoint-preview').forEach(el => {
        el.classList.remove('selected');
        el.querySelector('input[type="checkbox"]').checked = false;
    });
}

function updateCheckpoint(index, field, value) {
    generatedCheckpoints[index][field] = value;
}

async function saveCheckpoints() {
    const selectedIndices = [];
    document.querySelectorAll('.checkpoint-preview').forEach((el, index) => {
        if (el.querySelector('input[type="checkbox"]').checked) {
            selectedIndices.push(index);
        }
    });
    
    if (selectedIndices.length === 0) {
        alert('저장할 체크포인트를 선택해주세요.');
        return;
    }
    
    const checkpointsToSave = selectedIndices.map(i => generatedCheckpoints[i]);
    
    const btn = document.getElementById('saveBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>저장 중...';
    
    try {
        const response = await fetch(`/checkpoints/course/${courseId}/ai-generate/save`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ checkpoints: checkpointsToSave })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`${data.created_count}개의 체크포인트가 저장되었습니다!`);
            window.location.href = data.redirect_url;
        } else {
            alert('오류: ' + (data.error || '알 수 없는 오류'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('저장 중 오류가 발생했습니다.');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-save me-2"></i>선택한 체크포인트 저장';
    }
}

function regenerateCheckpoints() {
    if (confirm('체크포인트를 다시 생성하시겠습니까? 현재 수정 사항이 사라집니다.')) {
        generateCheckpoints();
    }
}

function toggleTranscriptEdit() {
    const view = document.getElementById('transcriptView');
    const edit = document.getElementById('transcriptEdit');
    const buttons = document.getElementById('transcriptEditButtons');
    
    view.classList.toggle('d-none');
    edit.classList.toggle('d-none');
    buttons.classList.toggle('d-none');
    
    if (!edit.classList.contains('d-none')) {
        edit.value = currentTranscript;
    }
}

function saveTranscript() {
    currentTranscript = document.getElementById('transcriptEdit').value;
    document.getElementById('transcriptView').textContent = currentTranscript;
    toggleTranscriptEdit();
}

function cancelTranscriptEdit() {
    toggleTranscriptEdit();
}

async function regenerateFromTranscript() {
    currentSourceType = 'text';
    document.getElementById('textContent').value = currentTranscript;
    document.querySelector('#text-tab').click();
    await generateCheckpoints();
}
</script>
{% endblock %}
