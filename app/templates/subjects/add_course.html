{% extends "base.html" %}

{% block title %}활동 추가 - {{ subject.title }}{% endblock %}

{% block content %}
<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('subjects.list_subjects') }}">과목 목록</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('subjects.view', subject_id=subject.id) }}">{{ subject.title }}</a></li>
            <li class="breadcrumb-item active">활동 추가</li>
        </ol>
    </nav>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="glass-card p-4">
            <h3 class="fw-bold mb-4">
                <i class="bi bi-plus-circle me-2 text-primary"></i>
                활동 추가
            </h3>
            <form method="POST" enctype="multipart/form-data">
                {{ form.hidden_tag() }}
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="mb-3">
                            {{ form.order_number.label(class="form-label fw-medium") }}
                            {{ form.order_number(class="form-control", placeholder="예: 1") }}
                            <small class="text-muted">세션의 표시 순서를 지정합니다</small>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    {{ form.session_type.label(class="form-label fw-medium") }}
                    {{ form.session_type(class="form-select", id="sessionType", onchange="toggleSessionFields()") }}
                </div>
                
                <div class="mb-3">
                    {{ form.title.label(class="form-label fw-medium") }}
                    {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else ""), placeholder="세션명을 입력하세요") }}
                    {% for error in form.title.errors %}
                    <div class="invalid-feedback">{{ error }}</div>
                    {% endfor %}
                </div>
                
                <div class="mb-3">
                    {{ form.description.label(class="form-label fw-medium") }}
                    {{ form.description(class="form-control", rows="3", placeholder="세션 설명을 입력하세요...") }}
                </div>
                
                <hr class="my-4">
                <h5 class="fw-bold mb-3"><i class="bi bi-calendar3 me-2"></i>운영 기간</h5>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-medium">시작 일시</label>
                        {{ form.start_date(class="form-control", type="datetime-local") }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-medium">종료 일시</label>
                        {{ form.end_date(class="form-control", type="datetime-local") }}
                    </div>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="syncAttendance" onchange="toggleSyncAttendance()">
                    <label class="form-check-label" for="syncAttendance">
                        출석 기간을 운영 기간과 동일하게 설정
                    </label>
                </div>
                
                <div class="row" id="attendanceDateFields">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-medium">출석 시작</label>
                        {{ form.attendance_start(class="form-control", type="datetime-local", id="attendance_start") }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-medium">출석 마감</label>
                        {{ form.attendance_end(class="form-control", type="datetime-local", id="attendance_end") }}
                    </div>
                </div>
                
                <div class="row align-items-end">
                    <div class="col-md-4 mb-3">
                        <div class="form-check">
                            {{ form.late_allowed(class="form-check-input") }}
                            {{ form.late_allowed.label(class="form-check-label") }}
                        </div>
                    </div>
                    <div class="col-md-4 mb-3" id="lateEndField" style="display: none;">
                        <label class="form-label fw-medium">지각 마감</label>
                        {{ form.late_end(class="form-control", type="datetime-local") }}
                    </div>
                </div>
                
                <hr class="my-4">
                <h5 class="fw-bold mb-3"><i class="bi bi-gear me-2"></i>공개 설정</h5>
                
                <div class="mb-3">
                    {{ form.visibility.label(class="form-label fw-medium") }}
                    {{ form.visibility(class="form-select", id="visibilitySelect", onchange="toggleVisibilityFields()") }}
                </div>
                
                <div id="dateBasedFields" class="visibility-fields p-3 rounded-3 mb-3" style="display: none; background: rgba(59, 130, 246, 0.1);">
                    <div class="alert alert-info mb-3 py-2">
                        <i class="bi bi-calendar-range me-1"></i>
                        위에서 설정한 운영 기간(시작/종료 일시) 동안에만 학생들이 접근할 수 있습니다.
                    </div>
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        운영 기간을 먼저 설정해주세요. 해당 기간 외에는 학생에게 세션이 잠금 처리됩니다.
                    </small>
                </div>
                
                <div id="prerequisiteFields" class="visibility-fields p-3 rounded-3 mb-3" style="display: none; background: rgba(245, 158, 11, 0.1);">
                    <div class="alert alert-warning mb-3 py-2">
                        <i class="bi bi-diagram-3 me-1"></i>
                        선행 세션을 완료해야 이 세션에 접근할 수 있습니다.
                    </div>
                    <div class="mb-0">
                        <label class="form-label fw-medium">선행 세션 선택</label>
                        <select class="form-select" id="prerequisite_course_id" name="prerequisite_course_id">
                            <option value="">선행 세션 없음</option>
                            {% for course in subject.courses if course.id != form.data.get('id') and not course.deleted_at %}
                            <option value="{{ course.id }}">{{ course.order_number or course.week_number or loop.index }}. {{ course.title }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">학생이 이 세션에 접근하기 전에 완료해야 하는 세션입니다.</small>
                    </div>
                </div>
                
                <div id="videoFields" style="display: none;">
                    <hr class="my-4">
                    <h5 class="fw-bold mb-3"><i class="bi bi-play-circle me-2"></i>동영상 설정</h5>
                    
                    <div class="mb-3">
                        {{ form.video_url.label(class="form-label fw-medium") }}
                        {{ form.video_url(class="form-control", placeholder="https://www.youtube.com/watch?v=...") }}
                        <small class="text-muted">유튜브 URL을 입력하세요</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-medium">또는 동영상 파일 업로드</label>
                        <input type="file" name="video_file" class="form-control" accept=".mp4,.mov,.webm">
                        <small class="text-muted">MP4, MOV, WebM 파일 (최대 500MB)</small>
                    </div>
                </div>
                
                <div id="materialFields" style="display: none;">
                    <hr class="my-4">
                    <h5 class="fw-bold mb-3"><i class="bi bi-file-earmark-text me-2"></i>학습 자료 설정</h5>
                    
                    <div class="mb-3">
                        <label class="form-label fw-medium">학습 자료 파일</label>
                        <input type="file" name="material_file" class="form-control" accept=".pdf,.hwp,.hwpx,.doc,.docx,.ppt,.pptx">
                        <small class="text-muted">PDF, 한글(HWP), Word, PowerPoint 파일</small>
                    </div>
                </div>
                
                <div id="assignmentFields" style="display: none;">
                    <hr class="my-4">
                    <h5 class="fw-bold mb-3"><i class="bi bi-clipboard-check me-2"></i>과제 설정</h5>
                    
                    <div class="mb-3">
                        {{ form.assignment_description.label(class="form-label fw-medium") }}
                        {{ form.assignment_description(class="form-control", rows="4", placeholder="과제 내용을 상세히 설명하세요...") }}
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-medium">과제 제출 마감</label>
                        {{ form.assignment_due_date(class="form-control", type="datetime-local") }}
                    </div>
                </div>
                
                <div id="quizFields" style="display: none;">
                    <hr class="my-4">
                    <h5 class="fw-bold mb-3"><i class="bi bi-question-circle me-2"></i>퀴즈 설정</h5>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.quiz_time_limit.label(class="form-label fw-medium") }}
                            {{ form.quiz_time_limit(class="form-control", placeholder="예: 30") }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.quiz_pass_score.label(class="form-label fw-medium") }}
                            {{ form.quiz_pass_score(class="form-control", placeholder="예: 70") }}
                        </div>
                    </div>
                    <p class="text-muted small"><i class="bi bi-info-circle me-1"></i>퀴즈 문항은 세션 생성 후 추가할 수 있습니다.</p>
                </div>
                
                <hr class="my-4">
                
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary flex-grow-1">
                        <i class="bi bi-plus-lg me-1"></i>활동 추가
                    </button>
                    <a href="{{ url_for('subjects.view', subject_id=subject.id) }}" class="btn btn-outline-secondary">취소</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleSessionFields() {
    const sessionType = document.getElementById('sessionType').value;
    
    document.getElementById('videoFields').style.display = sessionType === 'video' ? 'block' : 'none';
    document.getElementById('materialFields').style.display = sessionType === 'material' ? 'block' : 'none';
    document.getElementById('assignmentFields').style.display = sessionType === 'assignment' ? 'block' : 'none';
    document.getElementById('quizFields').style.display = sessionType === 'quiz' ? 'block' : 'none';
}

function toggleVisibilityFields() {
    const visibility = document.getElementById('visibilitySelect').value;
    
    document.querySelectorAll('.visibility-fields').forEach(el => el.style.display = 'none');
    
    if (visibility === 'date_based') {
        document.getElementById('dateBasedFields').style.display = 'block';
    } else if (visibility === 'prerequisite') {
        document.getElementById('prerequisiteFields').style.display = 'block';
    }
}

function toggleSyncAttendance() {
    const syncCheckbox = document.getElementById('syncAttendance');
    const attendanceFields = document.getElementById('attendanceDateFields');
    const startDate = document.getElementById('start_date');
    const endDate = document.getElementById('end_date');
    const attendanceStart = document.getElementById('attendance_start');
    const attendanceEnd = document.getElementById('attendance_end');
    
    if (syncCheckbox.checked) {
        attendanceFields.style.opacity = '0.5';
        attendanceStart.readOnly = true;
        attendanceEnd.readOnly = true;
        attendanceStart.value = startDate.value;
        attendanceEnd.value = endDate.value;
        
        startDate.addEventListener('change', syncDates);
        endDate.addEventListener('change', syncDates);
    } else {
        attendanceFields.style.opacity = '1';
        attendanceStart.readOnly = false;
        attendanceEnd.readOnly = false;
        
        startDate.removeEventListener('change', syncDates);
        endDate.removeEventListener('change', syncDates);
    }
}

function syncDates() {
    document.getElementById('attendance_start').value = document.getElementById('start_date').value;
    document.getElementById('attendance_end').value = document.getElementById('end_date').value;
}

document.getElementById('late_allowed').addEventListener('change', function() {
    document.getElementById('lateEndField').style.display = this.checked ? 'block' : 'none';
});

toggleSessionFields();
toggleVisibilityFields();
</script>
{% endblock %}
