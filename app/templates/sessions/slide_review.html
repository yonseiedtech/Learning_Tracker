{% extends "base.html" %}

{% block title %}ìŠ¬ë¼ì´ë“œ ë¦¬ë·° - {{ course.title }}{% endblock %}

{% block head %}
<style>
.review-header {
    margin-bottom: 1.5rem;
}
.summary-cards {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}
.summary-card {
    flex: 1;
    min-width: 180px;
    padding: 1rem 1.25rem;
    border-radius: 12px;
    background: var(--app-card-bg);
    border: 1px solid var(--app-border);
}
.summary-card .sc-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--app-text);
}
.summary-card .sc-label {
    font-size: 0.8rem;
    color: var(--app-text-muted);
}
.filter-bar {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}
.filter-btn {
    padding: 0.5rem 1.25rem;
    border-radius: 20px;
    border: 1px solid var(--app-border);
    background: var(--app-input-bg);
    color: var(--app-text);
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s ease;
}
.filter-btn:hover {
    background: rgba(59, 130, 246, 0.1);
    border-color: rgba(59, 130, 246, 0.3);
}
.filter-btn.active {
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    color: #fff;
    border-color: transparent;
}
.review-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1rem;
}
.review-slide-card {
    border-radius: 14px;
    overflow: hidden;
    background: var(--app-card-bg);
    border: 2px solid var(--app-border);
    transition: all 0.2s ease;
    cursor: pointer;
}
.review-slide-card:hover {
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}
.review-slide-card.bookmark-auto {
    border-color: #ef4444;
}
.review-slide-card.bookmark-manual {
    border-color: #3b82f6;
}
.review-slide-card.bookmark-both {
    border-color: #ef4444;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
}
.review-slide-thumb {
    width: 100%;
    aspect-ratio: 16/9;
    object-fit: cover;
    display: block;
    border-bottom: 1px solid var(--app-border);
}
.review-slide-info {
    padding: 0.75rem 1rem;
}
.review-slide-number {
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.review-agg {
    display: flex;
    gap: 1rem;
    font-size: 0.85rem;
}
.review-agg-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}
.bookmark-indicator {
    font-size: 0.75rem;
    padding: 0.15rem 0.5rem;
    border-radius: 10px;
    font-weight: 500;
}
.bookmark-indicator.auto {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}
.bookmark-indicator.manual {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
}
.modal-slide-img {
    width: 100%;
    border-radius: 8px;
    margin-bottom: 1rem;
}
.modal-agg-row {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}
.modal-agg-item {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.9rem;
}
.modal-agg-item .count {
    font-weight: 700;
    font-size: 1.1rem;
}
[data-theme="dark"] .review-slide-card {
    background: var(--app-card-bg);
}
@media (max-width: 768px) {
    .review-grid {
        grid-template-columns: 1fr;
    }
    .summary-cards {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="review-header">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">ëŒ€ì‹œë³´ë“œ</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('courses.view', course_id=course.id) }}">{{ course.title }}</a></li>
            <li class="breadcrumb-item active">ìŠ¬ë¼ì´ë“œ ë¦¬ë·°</li>
        </ol>
    </nav>
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
            <h3 class="fw-bold mb-1"><i class="bi bi-journal-text me-2 text-primary"></i>ìŠ¬ë¼ì´ë“œ ë¦¬ë·°</h3>
            <p class="text-muted mb-0">{{ deck.file_name }}</p>
        </div>
        <a href="{{ url_for('slides.presenter_view', deck_id=deck.id) }}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-easel me-1"></i>í”„ë ˆì  í„°ë¡œ ëŒì•„ê°€ê¸°
        </a>
    </div>
</div>

{% set bookmark_count = bookmarks|length %}
{% set most_problematic = namespace(index=0, score=0) %}
{% for i in range(slides|length) %}
    {% set agg = aggregates.get(i, {}) %}
    {% set score = (agg.get('question', 0) + agg.get('hard', 0)) %}
    {% if score > most_problematic.score %}
        {% set most_problematic.score = score %}
        {% set most_problematic.index = i %}
    {% endif %}
{% endfor %}

<div class="summary-cards">
    <div class="summary-card glass-card no-hover">
        <div class="sc-value">{{ slides|length }}</div>
        <div class="sc-label"><i class="bi bi-images me-1"></i>ì „ì²´ ìŠ¬ë¼ì´ë“œ</div>
    </div>
    <div class="summary-card glass-card no-hover">
        <div class="sc-value">{{ bookmark_count }}</div>
        <div class="sc-label"><i class="bi bi-bookmark-fill me-1 text-danger"></i>ë¶ë§ˆí¬ëœ ìŠ¬ë¼ì´ë“œ</div>
    </div>
    <div class="summary-card glass-card no-hover">
        <div class="sc-value">{{ most_problematic.index + 1 }}ë²ˆ</div>
        <div class="sc-label"><i class="bi bi-exclamation-triangle me-1 text-warning"></i>ê°€ì¥ ì–´ë ¤ìš´ ìŠ¬ë¼ì´ë“œ</div>
    </div>
</div>

<div class="filter-bar">
    <button class="filter-btn active" onclick="filterSlides('all', this)">ì „ì²´</button>
    <button class="filter-btn" onclick="filterSlides('bookmarked', this)">ğŸ”– ë¶ë§ˆí¬ëœ ìŠ¬ë¼ì´ë“œë§Œ</button>
</div>

<div class="review-grid" id="reviewGrid">
    {% for url in slides %}
    {% set idx = loop.index0 %}
    {% set agg = aggregates.get(idx, {'understood': 0, 'question': 0, 'hard': 0}) %}
    {% set bm = bookmarks.get(idx) %}
    <div class="review-slide-card {% if bm %}{% if bm.is_auto and bm.is_manual %}bookmark-both{% elif bm.is_auto %}bookmark-auto{% elif bm.is_manual %}bookmark-manual{% endif %}{% endif %}"
         data-index="{{ idx }}" data-bookmarked="{{ 'true' if bm else 'false' }}"
         onclick="openSlideModal({{ idx }})">
        <img src="{{ url }}" class="review-slide-thumb" alt="ìŠ¬ë¼ì´ë“œ {{ loop.index }}">
        <div class="review-slide-info">
            <div class="review-slide-number">
                <span>ìŠ¬ë¼ì´ë“œ {{ loop.index }}</span>
                {% if bm %}
                    {% if bm.is_auto %}
                    <span class="bookmark-indicator auto"><i class="bi bi-flag-fill"></i> ìë™</span>
                    {% endif %}
                    {% if bm.is_manual %}
                    <span class="bookmark-indicator manual"><i class="bi bi-bookmark-fill"></i> ìˆ˜ë™</span>
                    {% endif %}
                {% endif %}
            </div>
            <div class="review-agg">
                <span class="review-agg-item"><span>ğŸ‘</span><strong>{{ agg.understood }}</strong></span>
                <span class="review-agg-item"><span>â“</span><strong>{{ agg.question }}</strong></span>
                <span class="review-agg-item"><span>ğŸ˜µ</span><strong>{{ agg.hard }}</strong></span>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="modal fade" id="slideModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px; border: 1px solid var(--app-border); background: var(--app-card-bg);">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="modalTitle">ìŠ¬ë¼ì´ë“œ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <img src="" class="modal-slide-img" id="modalSlideImage" alt="ìŠ¬ë¼ì´ë“œ">
                <div class="modal-agg-row" id="modalAggRow">
                    <div class="modal-agg-item">
                        <span>ğŸ‘ ì˜ ì´í•´ë¼ìš”</span>
                        <span class="count" id="modalUnderstood" style="color: #22c55e;">0</span>
                    </div>
                    <div class="modal-agg-item">
                        <span>â“ ê¶ê¸ˆí•œ ë¶€ë¶„ì´ ìˆì–´ìš”</span>
                        <span class="count" id="modalQuestion" style="color: #f59e0b;">0</span>
                    </div>
                    <div class="modal-agg-item">
                        <span>ğŸ˜µ ì–´ë ¤ì›Œìš”</span>
                        <span class="count" id="modalHard" style="color: #ef4444;">0</span>
                    </div>
                </div>
                <hr style="border-color: var(--app-border);">
                <div class="mb-3">
                    <label class="form-label fw-bold">ğŸ“ ë©”ëª¨</label>
                    <textarea class="form-control" id="modalMemo" rows="3" placeholder="ì´ ìŠ¬ë¼ì´ë“œì— ëŒ€í•œ ë©”ëª¨ë¥¼ ì‘ì„±í•˜ì„¸ìš”..."></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">ğŸ”— ë³´ì¶© ìë£Œ URL</label>
                    <input type="url" class="form-control" id="modalSupplementUrl" placeholder="https://...">
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary" onclick="saveMemo()">
                    <i class="bi bi-check-lg me-1"></i>ì €ì¥
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const deckId = {{ deck.id }};
const slides = {{ slides|tojson }};
const aggregates = {{ aggregates|tojson }};
const bookmarksData = {};
{% for idx, bm in bookmarks.items() %}
bookmarksData[{{ idx }}] = {
    memo: {{ (bm.memo or '')|tojson }},
    supplement_url: {{ (bm.supplement_url or '')|tojson }},
    is_auto: {{ 'true' if bm.is_auto else 'false' }},
    is_manual: {{ 'true' if bm.is_manual else 'false' }}
};
{% endfor %}

let currentModalIndex = null;

function filterSlides(type, btnEl) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btnEl.classList.add('active');

    document.querySelectorAll('.review-slide-card').forEach(card => {
        if (type === 'all') {
            card.style.display = '';
        } else {
            card.style.display = card.dataset.bookmarked === 'true' ? '' : 'none';
        }
    });
}

function openSlideModal(index) {
    currentModalIndex = index;
    const agg = aggregates[index] || { understood: 0, question: 0, hard: 0 };
    const bm = bookmarksData[index] || {};

    document.getElementById('modalTitle').textContent = 'ìŠ¬ë¼ì´ë“œ ' + (index + 1);
    document.getElementById('modalSlideImage').src = slides[index];
    document.getElementById('modalUnderstood').textContent = agg.understood || 0;
    document.getElementById('modalQuestion').textContent = agg.question || 0;
    document.getElementById('modalHard').textContent = agg.hard || 0;
    document.getElementById('modalMemo').value = bm.memo || '';
    document.getElementById('modalSupplementUrl').value = bm.supplement_url || '';

    const modal = new bootstrap.Modal(document.getElementById('slideModal'));
    modal.show();
}

function saveMemo() {
    const memo = document.getElementById('modalMemo').value;
    const supplementUrl = document.getElementById('modalSupplementUrl').value;

    fetch('/slides/review/' + deckId + '/save-memo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            slide_index: currentModalIndex,
            memo: memo,
            supplement_url: supplementUrl
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            if (!bookmarksData[currentModalIndex]) {
                bookmarksData[currentModalIndex] = {};
            }
            bookmarksData[currentModalIndex].memo = memo;
            bookmarksData[currentModalIndex].supplement_url = supplementUrl;

            const toast = document.createElement('div');
            toast.className = 'toast-notification toast-success';
            toast.innerHTML = '<div class="toast-icon"><i class="bi bi-check-circle-fill"></i></div><div class="toast-content"><div class="toast-title">ì™„ë£Œ</div><div class="toast-message">ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</div></div><button type="button" class="toast-close" onclick="this.parentElement.remove()"><i class="bi bi-x"></i></button>';
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);

            bootstrap.Modal.getInstance(document.getElementById('slideModal')).hide();
        }
    })
    .catch(err => {
        console.error('ì €ì¥ ì‹¤íŒ¨:', err);
    });
}
</script>
{% endblock %}
