{% extends "base.html" %}

{% block title %}ÌîÑÎ†àÏ††ÌÑ∞ - {{ deck.file_name }}{% endblock %}

{% block head %}
<style>
.presenter-layout {
    display: flex;
    height: calc(100vh - 80px);
    gap: 0;
    margin: -1rem -0.75rem 0;
}
.slide-sidebar {
    width: 200px;
    min-width: 200px;
    background: var(--app-card-bg);
    border-right: 1px solid var(--app-border);
    overflow-y: auto;
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}
.slide-search-box .input-group {
    background: var(--app-input-bg, #f8f9fa);
    border-radius: 6px;
    border: 1px solid var(--app-border, #dee2e6);
}
.slide-search-box .form-control { border: none; background: transparent; }
.slide-search-box .form-control:focus { box-shadow: none; }
.slide-thumb-wrapper {
    position: relative;
    cursor: pointer;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid transparent;
    transition: all 0.2s ease;
}
.slide-thumb-wrapper:hover { border-color: var(--primary-color); }
.slide-thumb-wrapper.active { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
.slide-thumb-wrapper.flagged { border-color: #ef4444; }
.slide-thumb-wrapper.flagged.active { border-color: #ef4444; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3); }
.slide-thumb-wrapper.search-hidden { display: none; }
.slide-thumb-img { width: 100%; aspect-ratio: 16/9; object-fit: cover; display: block; }
.slide-thumb-number {
    position: absolute; bottom: 4px; left: 4px;
    background: rgba(0,0,0,0.7); color: #fff; font-size: 0.7rem;
    padding: 1px 6px; border-radius: 4px;
}
.slide-thumb-flag { position: absolute; top: 4px; right: 4px; font-size: 0.75rem; }
.slide-thumb-time {
    position: absolute; bottom: 4px; right: 4px;
    background: rgba(0,0,0,0.7); color: #fff; font-size: 0.6rem;
    padding: 1px 5px; border-radius: 4px;
}
.presenter-main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
.presenter-topbar {
    display: flex; justify-content: space-between; align-items: center;
    padding: 0.5rem 1rem; background: var(--app-card-bg);
    border-bottom: 1px solid var(--app-border); flex-shrink: 0; gap: 0.5rem; flex-wrap: wrap;
}
.presenter-slide-area {
    flex: 1; display: flex; align-items: center; justify-content: center;
    padding: 0.75rem; background: var(--app-bg); min-height: 0;
}
.presenter-slide-area img {
    max-width: 100%; max-height: 100%; object-fit: contain;
    border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.15);
}
.slide-jumpbar {
    display: flex; gap: 1px; height: 8px; margin: 0 1rem; flex-shrink: 0;
}
.jumpbar-segment {
    flex: 1; background: var(--app-input-bg, #e0e3e8); cursor: pointer;
    position: relative; transition: all 0.2s; border-radius: 1px;
}
.jumpbar-segment:hover { background: rgba(59,130,246,0.3); transform: scaleY(1.8); }
.jumpbar-segment.active { background: #3b82f6; }
.jumpbar-segment.visited { background: rgba(59,130,246,0.5); }
.jumpbar-fill {
    position: absolute; bottom: 0; left: 0; right: 0;
    height: 0%; background: rgba(239,68,68,0.6); transition: height 0.3s;
}
.presenter-bottom {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0.5rem 1rem; background: var(--app-card-bg);
    border-top: 1px solid var(--app-border); flex-shrink: 0; gap: 0.75rem; flex-wrap: wrap;
}
.nav-btn {
    width: 40px; height: 40px; border-radius: 10px;
    border: 1px solid var(--app-border); background: var(--app-input-bg);
    color: var(--app-text); display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 1.1rem; transition: all 0.2s ease;
}
.nav-btn:hover { background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3); }
.nav-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.slide-counter { font-weight: 600; font-size: 0.9rem; color: var(--app-text); min-width: 70px; text-align: center; }
.engagement-panel { display: flex; align-items: center; gap: 0.75rem; flex: 1; max-width: 600px; }
.reaction-donut-fs { position: relative; width: 55px; height: 55px; flex-shrink: 0; }
.donut-center-fs {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    font-size: 0.7rem; font-weight: 700; color: var(--app-text, #333);
}
.reaction-bars-fs { flex: 1; min-width: 120px; }
.reaction-bar-row { display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.2rem; }
.reaction-bar-label { font-size: 0.75rem; width: 20px; text-align: center; flex-shrink: 0; }
.reaction-bar-track { flex: 1; height: 12px; background: var(--app-input-bg); border-radius: 6px; overflow: hidden; }
.reaction-bar-fill { height: 100%; border-radius: 6px; transition: width 0.3s ease; min-width: 0; }
.reaction-bar-count { font-size: 0.7rem; font-weight: 600; width: 24px; text-align: left; flex-shrink: 0; }
.reaction-bar-pct { font-size: 0.6rem; color: var(--app-text-muted); width: 28px; flex-shrink: 0; }
.trend-chart-fs { flex-shrink: 0; }
.participant-badge {
    display: flex; align-items: center; gap: 0.4rem;
    padding: 0.3rem 0.7rem; background: var(--app-input-bg);
    border-radius: 8px; font-size: 0.8rem; font-weight: 500; color: var(--app-text); flex-shrink: 0;
}
.bookmark-btn {
    border: 1px solid var(--app-border); background: var(--app-input-bg);
    color: var(--app-text-muted); border-radius: 8px; padding: 0.3rem 0.6rem;
    cursor: pointer; font-size: 0.8rem; transition: all 0.2s ease;
    display: flex; align-items: center; gap: 0.3rem;
}
.bookmark-btn.active { background: rgba(239, 68, 68, 0.1); border-color: #ef4444; color: #ef4444; }
.lecture-timer-fs {
    display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;
}
.lecture-timer-fs .time-over { color: #ef4444 !important; animation: pulse 1.5s infinite; }
.engagement-alert-fs {
    padding: 0.4rem 1rem; flex-shrink: 0; animation: slideDown 0.3s ease;
}
.engagement-alert-fs.alert-warning-custom { background: rgba(245,158,11,0.12); border-bottom: 2px solid rgba(245,158,11,0.4); color: #92400e; }
.engagement-alert-fs.alert-danger-custom { background: rgba(239,68,68,0.12); border-bottom: 2px solid rgba(239,68,68,0.4); color: #991b1b; }
.engagement-alert-fs.alert-success-custom { background: rgba(34,197,94,0.12); border-bottom: 2px solid rgba(34,197,94,0.4); color: #166534; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
@media (max-width: 768px) {
    .presenter-layout { flex-direction: column; }
    .slide-sidebar {
        width: 100%; min-width: 100%; height: 100px;
        flex-direction: row; overflow-x: auto; overflow-y: hidden;
    }
    .slide-thumb-wrapper { min-width: 120px; }
    .presenter-bottom { flex-wrap: wrap; }
    .engagement-panel { max-width: 100%; width: 100%; order: 3; }
}
</style>
{% endblock %}

{% block content %}
<div class="presenter-layout">
    <div class="slide-sidebar" id="slideSidebar">
        <div class="slide-search-box mb-1">
            <div class="input-group input-group-sm">
                <span class="input-group-text" style="border:none; background:transparent; padding:2px 6px;"><i class="bi bi-search" style="font-size:0.7rem;"></i></span>
                <input type="text" class="form-control form-control-sm" id="slideSearchInput" placeholder="Í≤ÄÏÉâ..." oninput="filterSlides(this.value)" style="font-size:0.7rem; padding:2px 6px;">
            </div>
        </div>
        {% for url in slides %}
        <div class="slide-thumb-wrapper {% if loop.index0 == 0 %}active{% endif %} {% if loop.index0 in bookmarks %}flagged{% endif %}"
             data-index="{{ loop.index0 }}" onclick="goToSlide({{ loop.index0 }})" title="Ïä¨ÎùºÏù¥Îìú {{ loop.index }}">
            <img src="{{ url }}" class="slide-thumb-img" alt="Ïä¨ÎùºÏù¥Îìú {{ loop.index }}">
            <span class="slide-thumb-number">{{ loop.index }}</span>
            <span class="slide-thumb-flag {% if loop.index0 not in bookmarks %}d-none{% endif %}" id="thumbFlag{{ loop.index0 }}">üîñ</span>
            <span class="slide-thumb-time d-none" id="thumbTime{{ loop.index0 }}"></span>
        </div>
        {% endfor %}
    </div>

    <div class="presenter-main">
        <div class="presenter-topbar">
            <div class="lecture-timer-fs">
                <a href="{{ url_for('courses.view', course_id=course.id) }}" class="text-decoration-none" style="color: var(--app-text);">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <i class="bi bi-stopwatch text-primary" style="font-size:0.85rem;"></i>
                <span class="fw-bold small" id="lectureElapsed">00:00:00</span>
                <span class="text-muted small">/</span>
                <span class="small text-muted" id="lectureTotalTime">--:--</span>
                <div style="width: 150px;">
                    <div class="position-relative" style="height: 12px; background: var(--app-input-bg, #e9ecef); border-radius: 6px; overflow: hidden;">
                        <div id="lectureProgressFill" style="height: 100%; width: 0%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 6px; transition: width 0.5s;"></div>
                        <div id="lectureProgressMarker" style="position: absolute; top: 0; width: 2px; height: 100%; background: #fff; box-shadow: 0 0 3px rgba(0,0,0,0.4); left: 0%; transition: left 0.5s;"></div>
                    </div>
                </div>
                <span class="fw-bold small text-primary" id="lectureProgressPct">0%</span>
                <span class="small text-muted"><i class="bi bi-flag me-1"></i><span id="slideTimeDisplay">00:00</span></span>
                <span class="badge bg-opacity-10 small" id="slideTimePace" style="display: none;">
                    <i class="bi bi-speedometer2 me-1"></i><span id="slideTimePaceText"></span>
                </span>
                <span class="small text-muted ms-2"><i class="bi bi-clock-history me-1"></i>Ï¢ÖÎ£å: <span class="fw-bold" id="estimatedEndTime">--:--</span></span>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button class="bookmark-btn" id="bookmarkToggle" onclick="toggleBookmark()">
                    <i class="bi bi-bookmark" id="bookmarkIcon"></i>
                    <span>Î∂ÅÎßàÌÅ¨</span>
                </button>
                <a href="{{ url_for('slides.review_view', deck_id=deck.id) }}" class="btn btn-sm btn-outline-primary" target="_blank">
                    <i class="bi bi-journal-text me-1"></i>Î¶¨Î∑∞
                </a>
            </div>
        </div>

        <div class="engagement-alert-fs d-none" id="engagementAlert">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-lightbulb" id="engagementAlertIcon"></i>
                <strong class="small" id="engagementAlertTitle"></strong>
                <span class="small" id="engagementAlertMsg"></span>
                <button class="btn btn-sm ms-auto" onclick="dismissEngagementAlert()" style="font-size: 0.65rem; padding: 1px 6px;">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        </div>

        <div class="presenter-slide-area">
            <img src="{{ slides[0] if slides else '' }}" alt="ÌòÑÏû¨ Ïä¨ÎùºÏù¥Îìú" id="currentSlideImage">
        </div>

        <div class="slide-jumpbar" id="slideJumpBar">
            {% for url in slides %}
            <div class="jumpbar-segment {% if loop.index0 == 0 %}active{% endif %}" data-index="{{ loop.index0 }}" onclick="goToSlide({{ loop.index0 }})" title="Ïä¨ÎùºÏù¥Îìú {{ loop.index }}">
                <div class="jumpbar-fill" id="jumpFill{{ loop.index0 }}"></div>
            </div>
            {% endfor %}
        </div>

        <div class="presenter-bottom">
            <div class="d-flex align-items-center gap-2">
                <button class="nav-btn" id="prevBtn" onclick="prevSlide()">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <span class="slide-counter" id="slideCounter">1 / {{ slides|length }}</span>
                <button class="nav-btn" id="nextBtn" onclick="nextSlide()">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>

            <div class="engagement-panel">
                <div class="reaction-donut-fs">
                    <canvas id="reactionDonutChart" width="55" height="55"></canvas>
                    <span class="donut-center-fs" id="donutCenterText">0</span>
                </div>
                <div class="reaction-bars-fs">
                    <div class="reaction-bar-row">
                        <span class="reaction-bar-label">üëç</span>
                        <div class="reaction-bar-track"><div class="reaction-bar-fill" id="barUnderstood" style="width: 0%; background: #22c55e;"></div></div>
                        <span class="reaction-bar-count" id="countUnderstood">0</span>
                        <span class="reaction-bar-pct" id="pctUnderstood">0%</span>
                    </div>
                    <div class="reaction-bar-row">
                        <span class="reaction-bar-label">‚ùì</span>
                        <div class="reaction-bar-track"><div class="reaction-bar-fill" id="barQuestion" style="width: 0%; background: #f59e0b;"></div></div>
                        <span class="reaction-bar-count" id="countQuestion">0</span>
                        <span class="reaction-bar-pct" id="pctQuestion">0%</span>
                    </div>
                    <div class="reaction-bar-row">
                        <span class="reaction-bar-label">üòµ</span>
                        <div class="reaction-bar-track"><div class="reaction-bar-fill" id="barHard" style="width: 0%; background: #ef4444;"></div></div>
                        <span class="reaction-bar-count" id="countHard">0</span>
                        <span class="reaction-bar-pct" id="pctHard">0%</span>
                    </div>
                </div>
                <div class="trend-chart-fs">
                    <canvas id="trendMiniChart" width="110" height="50"></canvas>
                </div>
            </div>

            <div class="d-flex align-items-center gap-2">
                <div class="participant-badge">
                    <i class="bi bi-people-fill"></i>
                    <span id="participantCount">0</span>Î™Ö
                </div>
            </div>
        </div>

        <div class="engagement-guide-bar px-3 py-1 d-none" id="engagementGuide" style="background: var(--app-input-bg); border-top: 1px solid var(--app-border); flex-shrink: 0;">
            <small class="text-muted"><i class="bi bi-info-circle me-1"></i><span id="engagementGuideText"></span></small>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const deckId = {{ deck.id }};
const slides = {{ slides|tojson }};
const totalSlides = slides.length;
let currentIndex = 0;
let slideAggregates = {};
let bookmarkedSlides = new Set([{% for idx in bookmarks %}{{ idx }},{% endfor %}]);
let visitedSlides = new Set([0]);

let lectureStartTime = new Date();
let slideStartTime = new Date();
let slideTimeSpent = new Array(totalSlides).fill(0);
let lectureTimerInterval = null;
let trendHistory = [];
const TREND_MAX_POINTS = 100;
let lastAlertType = null;
let alertDismissed = false;
let donutChart = null;
let trendChart = null;
const estimatedDurationMinutes = {{ deck.estimated_duration_minutes or 0 }};

const socket = io();

socket.emit('join_slide_session', { deck_id: deckId });
socket.emit('request_slide_aggregates', { deck_id: deckId });

initDonutChart();
initTrendChart();
startLectureTimer();

function startLectureTimer() {
    if (lectureTimerInterval) return;
    lectureTimerInterval = setInterval(function() {
        updateLectureTimerDisplay();
        updateSlideTimeDisplay();
        recordTrendPoint();
        checkEngagementAlerts();
    }, 1000);
}

function updateLectureTimerDisplay() {
    const elapsed = Math.floor((Date.now() - lectureStartTime.getTime()) / 1000);
    const h = Math.floor(elapsed / 3600);
    const m = Math.floor((elapsed % 3600) / 60);
    const s = elapsed % 60;
    const el = document.getElementById('lectureElapsed');
    if (el) el.textContent = String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');

    const totalEstMin = estimatedDurationMinutes || (totalSlides * 2);
    const totalEl = document.getElementById('lectureTotalTime');
    const totalH = Math.floor(totalEstMin / 60);
    const totalM = totalEstMin % 60;
    if (totalEl) totalEl.textContent = totalH > 0 ? totalH + ':' + String(totalM).padStart(2,'0') + ':00' : String(totalM).padStart(2,'0') + ':00';

    const pct = Math.min(100, ((currentIndex + 1) / totalSlides) * 100);
    const fill = document.getElementById('lectureProgressFill');
    const marker = document.getElementById('lectureProgressMarker');
    const pctEl = document.getElementById('lectureProgressPct');
    if (fill) fill.style.width = pct + '%';
    if (marker) marker.style.left = pct + '%';
    if (pctEl) pctEl.textContent = Math.round(pct) + '%';

    const avgTimePerSlide = elapsed / Math.max(currentIndex + 1, 1);
    const remainingSlides = totalSlides - currentIndex - 1;
    const estRemainingSeconds = Math.round(avgTimePerSlide * remainingSlides);
    const endTime = new Date(Date.now() + estRemainingSeconds * 1000);
    const endEl = document.getElementById('estimatedEndTime');
    if (endEl) endEl.textContent = String(endTime.getHours()).padStart(2,'0') + ':' + String(endTime.getMinutes()).padStart(2,'0');

    if (elapsed > totalEstMin * 60) {
        if (el) el.classList.add('time-over');
    } else {
        if (el) el.classList.remove('time-over');
    }
}

function updateSlideTimeDisplay() {
    const currentSlideElapsed = Math.floor((Date.now() - slideStartTime.getTime()) / 1000);
    const totalForSlide = slideTimeSpent[currentIndex] + currentSlideElapsed;
    const m = Math.floor(totalForSlide / 60);
    const s = totalForSlide % 60;
    const display = document.getElementById('slideTimeDisplay');
    if (display) display.textContent = String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');

    const avgPerSlide = estimatedDurationMinutes ? (estimatedDurationMinutes * 60 / totalSlides) : 120;
    const paceEl = document.getElementById('slideTimePace');
    const paceText = document.getElementById('slideTimePaceText');
    if (totalForSlide > avgPerSlide * 1.5 && paceEl && paceText) {
        paceEl.style.display = '';
        paceEl.className = 'badge bg-danger bg-opacity-10 text-danger small';
        paceText.textContent = 'ÎäêÎ¶º';
    } else if (totalForSlide < avgPerSlide * 0.5 && totalForSlide > 10 && paceEl && paceText) {
        paceEl.style.display = '';
        paceEl.className = 'badge bg-info bg-opacity-10 text-info small';
        paceText.textContent = 'Îπ†Î¶Ñ';
    } else if (paceEl) {
        paceEl.style.display = 'none';
    }
}

function saveSlideTime() {
    if (slideStartTime) {
        slideTimeSpent[currentIndex] += Math.floor((Date.now() - slideStartTime.getTime()) / 1000);
        const thumbTime = document.getElementById('thumbTime' + currentIndex);
        if (thumbTime) {
            const t = slideTimeSpent[currentIndex];
            thumbTime.textContent = Math.floor(t/60) + ':' + String(t%60).padStart(2,'0');
            thumbTime.classList.remove('d-none');
        }
    }
    slideStartTime = new Date();
}

function goToSlide(index) {
    if (index < 0 || index >= totalSlides || index === currentIndex) return;
    saveSlideTime();
    currentIndex = index;
    visitedSlides.add(index);
    updateSlideDisplay();
    socket.emit('change_slide', { deck_id: deckId, slide_index: currentIndex });
}

function prevSlide() { if (currentIndex > 0) goToSlide(currentIndex - 1); }
function nextSlide() { if (currentIndex < totalSlides - 1) goToSlide(currentIndex + 1); }

function updateSlideDisplay() {
    document.getElementById('currentSlideImage').src = slides[currentIndex];
    document.getElementById('slideCounter').textContent = (currentIndex + 1) + ' / ' + totalSlides;

    document.querySelectorAll('.slide-thumb-wrapper').forEach(el => {
        el.classList.toggle('active', parseInt(el.dataset.index) === currentIndex);
    });

    const activeThumb = document.querySelector('.slide-thumb-wrapper.active');
    if (activeThumb) activeThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    document.querySelectorAll('.jumpbar-segment').forEach(el => {
        const idx = parseInt(el.dataset.index);
        el.classList.toggle('active', idx === currentIndex);
        el.classList.toggle('visited', visitedSlides.has(idx) && idx !== currentIndex);
    });

    updateReactionBars();
    updateBookmarkButton();
    updateDonutChart();
    updateEngagementGuide();
    document.getElementById('prevBtn').disabled = currentIndex === 0;
    document.getElementById('nextBtn').disabled = currentIndex === totalSlides - 1;
}

function updateReactionBars() {
    const agg = slideAggregates[currentIndex] || { understood: 0, question: 0, hard: 0, total_reacted: 0 };
    const total = Math.max(agg.total_reacted, 1);
    const u = agg.understood, q = agg.question, h = agg.hard;
    const uPct = Math.round(u / total * 100), qPct = Math.round(q / total * 100), hPct = Math.round(h / total * 100);

    document.getElementById('countUnderstood').textContent = u;
    document.getElementById('countQuestion').textContent = q;
    document.getElementById('countHard').textContent = h;
    document.getElementById('pctUnderstood').textContent = uPct + '%';
    document.getElementById('pctQuestion').textContent = qPct + '%';
    document.getElementById('pctHard').textContent = hPct + '%';

    document.getElementById('barUnderstood').style.width = (u / total * 100) + '%';
    document.getElementById('barQuestion').style.width = (q / total * 100) + '%';
    document.getElementById('barHard').style.width = (h / total * 100) + '%';

    document.getElementById('participantCount').textContent = agg.total_reacted;

    const jumpFill = document.getElementById('jumpFill' + currentIndex);
    if (jumpFill) {
        const hardPct = agg.total_reacted > 0 ? ((q + h) / agg.total_reacted * 100) : 0;
        jumpFill.style.height = hardPct + '%';
    }
}

function initDonutChart() {
    const canvas = document.getElementById('reactionDonutChart');
    if (!canvas) return;
    donutChart = new Chart(canvas.getContext('2d'), {
        type: 'doughnut',
        data: { labels: ['Ïù¥Ìï¥', 'ÏßàÎ¨∏', 'Ïñ¥Î†§ÏõÄ'], datasets: [{ data: [0, 0, 0], backgroundColor: ['#22c55e', '#f59e0b', '#ef4444'], borderWidth: 0, cutout: '70%' }] },
        options: { responsive: false, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: true, bodyFont: { size: 10 } } }, animation: { duration: 300 } }
    });
}

function updateDonutChart() {
    if (!donutChart) return;
    const agg = slideAggregates[currentIndex] || { understood: 0, question: 0, hard: 0, total_reacted: 0 };
    donutChart.data.datasets[0].data = [agg.understood, agg.question, agg.hard];
    donutChart.update('none');
    const center = document.getElementById('donutCenterText');
    if (center) center.textContent = agg.total_reacted;
}

function initTrendChart() {
    const canvas = document.getElementById('trendMiniChart');
    if (!canvas) return;
    trendChart = new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [
            { label: 'üëç', data: [], borderColor: '#22c55e', borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3 },
            { label: '‚ùì', data: [], borderColor: '#f59e0b', borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3 },
            { label: 'üòµ', data: [], borderColor: '#ef4444', borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3 }
        ] },
        options: { responsive: false, maintainAspectRatio: false, scales: { x: { display: false }, y: { display: false, beginAtZero: true } }, plugins: { legend: { display: false }, tooltip: { enabled: true, bodyFont: { size: 9 } } }, animation: { duration: 200 } }
    });
}

function recordTrendPoint() {
    if (!trendChart) return;
    const agg = slideAggregates[currentIndex] || { understood: 0, question: 0, hard: 0 };
    const now = new Date();
    const label = String(now.getMinutes()).padStart(2,'0') + ':' + String(now.getSeconds()).padStart(2,'0');
    trendHistory.push({ t: label, u: agg.understood, q: agg.question, h: agg.hard });
    if (trendHistory.length > TREND_MAX_POINTS) trendHistory.shift();
    if (Date.now() % 3000 < 1100) {
        trendChart.data.labels = trendHistory.map(p => p.t);
        trendChart.data.datasets[0].data = trendHistory.map(p => p.u);
        trendChart.data.datasets[1].data = trendHistory.map(p => p.q);
        trendChart.data.datasets[2].data = trendHistory.map(p => p.h);
        trendChart.update('none');
    }
}

function updateEngagementGuide() {
    const agg = slideAggregates[currentIndex] || { understood: 0, question: 0, hard: 0, total_reacted: 0 };
    const total = Math.max(agg.total_reacted, 1);
    const uPct = agg.understood / total * 100;
    const qPct = agg.question / total * 100;
    const hPct = agg.hard / total * 100;
    const guideEl = document.getElementById('engagementGuide');
    const guideText = document.getElementById('engagementGuideText');
    if (!guideEl || !guideText) return;
    if (agg.total_reacted === 0) { guideEl.classList.add('d-none'); return; }
    guideEl.classList.remove('d-none');
    if (uPct >= 70) guideText.textContent = 'ÌïôÏäµÏûêÏùò ' + Math.round(uPct) + '%Í∞Ä Ïù¥Ìï¥ÌñàÏäµÎãàÎã§. ÌòÑÏû¨ ÏßÑÌñâ ÏÜçÎèÑÎ•º Ïú†ÏßÄÌïòÏÑ∏Ïöî.';
    else if (hPct >= 30) guideText.textContent = 'Ïñ¥Î†§ÏõÄ Î∞òÏùëÏù¥ ' + Math.round(hPct) + '%ÏûÖÎãàÎã§. Ï∂îÍ∞Ä ÏÑ§Î™ÖÏù¥ ÌïÑÏöîÌï† Ïàò ÏûàÏäµÎãàÎã§.';
    else if (qPct >= 30) guideText.textContent = 'ÏßàÎ¨∏ Î∞òÏùëÏù¥ ' + Math.round(qPct) + '%ÏûÖÎãàÎã§. Q&A ÏãúÍ∞ÑÏùÑ Í≥†Î†§ÌïòÏÑ∏Ïöî.';
    else guideText.textContent = 'Ïù¥Ìï¥ ' + Math.round(uPct) + '% | ÏßàÎ¨∏ ' + Math.round(qPct) + '% | Ïñ¥Î†§ÏõÄ ' + Math.round(hPct) + '%';
}

function checkEngagementAlerts() {
    if (alertDismissed) return;
    const agg = slideAggregates[currentIndex] || { understood: 0, question: 0, hard: 0, total_reacted: 0 };
    if (agg.total_reacted < 2) return;
    const total = agg.total_reacted;
    const uPct = agg.understood / total * 100;
    const hPct = agg.hard / total * 100;
    const qPct = agg.question / total * 100;
    const alertEl = document.getElementById('engagementAlert');
    const alertIcon = document.getElementById('engagementAlertIcon');
    const alertTitle = document.getElementById('engagementAlertTitle');
    const alertMsg = document.getElementById('engagementAlertMsg');
    if (!alertEl) return;
    let newAlertType = null;
    if (hPct > 30) {
        newAlertType = 'hard';
        alertEl.className = 'engagement-alert-fs d-flex align-items-center gap-2 alert-danger-custom';
        alertIcon.className = 'bi bi-exclamation-triangle-fill text-danger';
        alertTitle.textContent = '‚ö†Ô∏è Ïñ¥Î†§ÏõÄ Î∞òÏùë ' + Math.round(hPct) + '%';
        alertMsg.textContent = 'Ïù¥ ÏãúÏ†êÏóêÏÑú Í∞úÎÖê ÏÑ§Î™ÖÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.';
    } else if (qPct > 40) {
        newAlertType = 'question';
        alertEl.className = 'engagement-alert-fs d-flex align-items-center gap-2 alert-warning-custom';
        alertIcon.className = 'bi bi-question-circle-fill text-warning';
        alertTitle.textContent = '‚ùì ÏßàÎ¨∏ Î∞òÏùë ' + Math.round(qPct) + '%';
        alertMsg.textContent = 'Q&A ÏãúÍ∞ÑÏùÑ Í∞ÄÏßÄÏÑ∏Ïöî.';
    } else if (uPct > 80) {
        newAlertType = 'positive';
        alertEl.className = 'engagement-alert-fs d-flex align-items-center gap-2 alert-success-custom';
        alertIcon.className = 'bi bi-check-circle-fill text-success';
        alertTitle.textContent = '‚úÖ Í∏çÏ†ï Î∞òÏùë ' + Math.round(uPct) + '%';
        alertMsg.textContent = 'ÌòÑÏû¨ ÏßÑÌñâ ÏÜçÎèÑÎ•º Ïú†ÏßÄÌïòÏÑ∏Ïöî.';
    } else {
        alertEl.classList.add('d-none');
        lastAlertType = null;
        return;
    }
    if (newAlertType !== lastAlertType) {
        lastAlertType = newAlertType;
        alertDismissed = false;
        alertEl.classList.remove('d-none');
    }
}

function dismissEngagementAlert() {
    const alertEl = document.getElementById('engagementAlert');
    if (alertEl) alertEl.classList.add('d-none');
    alertDismissed = true;
    setTimeout(() => { alertDismissed = false; }, 30000);
}

function filterSlides(query) {
    query = query.toLowerCase().trim();
    document.querySelectorAll('.slide-thumb-wrapper').forEach(el => {
        const idx = parseInt(el.dataset.index);
        const slideNum = String(idx + 1);
        if (!query || slideNum.includes(query)) el.classList.remove('search-hidden');
        else el.classList.add('search-hidden');
    });
}

function updateBookmarkButton() {
    const btn = document.getElementById('bookmarkToggle');
    const icon = document.getElementById('bookmarkIcon');
    if (bookmarkedSlides.has(currentIndex)) {
        btn.classList.add('active');
        icon.className = 'bi bi-bookmark-fill';
    } else {
        btn.classList.remove('active');
        icon.className = 'bi bi-bookmark';
    }
}

function toggleBookmark() {
    socket.emit('toggle_slide_bookmark', { deck_id: deckId, slide_index: currentIndex });
}

function updateThumbFlag(slideIndex, isFlagged) {
    const flag = document.getElementById('thumbFlag' + slideIndex);
    const wrapper = document.querySelector(`.slide-thumb-wrapper[data-index="${slideIndex}"]`);
    if (flag) flag.classList.toggle('d-none', !isFlagged);
    if (wrapper) wrapper.classList.toggle('flagged', isFlagged);
}

socket.on('all_slide_aggregates', function(data) {
    slideAggregates = data.aggregates;
    bookmarkedSlides = new Set();
    if (data.flagged_slides) {
        data.flagged_slides.forEach(function(fs) {
            bookmarkedSlides.add(fs.slide_index);
            updateThumbFlag(fs.slide_index, true);
        });
    }
    updateReactionBars();
    updateBookmarkButton();
    updateDonutChart();
    updateEngagementGuide();
    Object.keys(slideAggregates).forEach(function(idx) {
        const a = slideAggregates[idx];
        const jf = document.getElementById('jumpFill' + idx);
        if (jf && a.total_reacted > 0) jf.style.height = ((a.question + a.hard) / a.total_reacted * 100) + '%';
    });
});

socket.on('slide_aggregate_updated', function(data) {
    slideAggregates[data.slide_index] = data.counts;
    if (data.slide_index === currentIndex) {
        updateReactionBars();
        updateDonutChart();
        updateEngagementGuide();
    }
    if (data.flagged) {
        bookmarkedSlides.add(data.slide_index);
        updateThumbFlag(data.slide_index, true);
    }
    const jf = document.getElementById('jumpFill' + data.slide_index);
    if (jf && data.counts.total_reacted > 0) jf.style.height = ((data.counts.question + data.counts.hard) / data.counts.total_reacted * 100) + '%';
});

socket.on('bookmark_updated', function(data) {
    if (data.is_bookmarked) bookmarkedSlides.add(data.slide_index);
    else bookmarkedSlides.delete(data.slide_index);
    updateThumbFlag(data.slide_index, data.is_bookmarked);
    if (data.slide_index === currentIndex) updateBookmarkButton();
});

document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    if (e.key === 'ArrowLeft' || e.key === 'PageUp') { e.preventDefault(); prevSlide(); }
    if (e.key === 'ArrowRight' || e.key === 'PageDown') { e.preventDefault(); nextSlide(); }
    if (e.key === 'Home') { e.preventDefault(); goToSlide(0); }
    if (e.key === 'End') { e.preventDefault(); goToSlide(totalSlides - 1); }
});

updateSlideDisplay();
</script>
{% endblock %}
