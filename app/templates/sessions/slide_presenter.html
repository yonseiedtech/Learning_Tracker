{% extends "base.html" %}

{% block title %}ÌîÑÎ†àÏ††ÌÑ∞ - {{ deck.file_name }}{% endblock %}

{% block head %}
<style>
.presenter-layout {
    display: flex;
    height: calc(100vh - 80px);
    gap: 0;
    margin: -1rem -0.75rem 0;
}
.slide-sidebar {
    width: 200px;
    min-width: 200px;
    background: var(--app-card-bg);
    border-right: 1px solid var(--app-border);
    overflow-y: auto;
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}
.slide-thumb-wrapper {
    position: relative;
    cursor: pointer;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid transparent;
    transition: all 0.2s ease;
}
.slide-thumb-wrapper:hover {
    border-color: var(--primary-color);
}
.slide-thumb-wrapper.active {
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
}
.slide-thumb-wrapper.flagged {
    border-color: #ef4444;
}
.slide-thumb-wrapper.flagged.active {
    border-color: #ef4444;
    box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3);
}
.slide-thumb-img {
    width: 100%;
    aspect-ratio: 16/9;
    object-fit: cover;
    display: block;
}
.slide-thumb-number {
    position: absolute;
    bottom: 4px;
    left: 4px;
    background: rgba(0,0,0,0.7);
    color: #fff;
    font-size: 0.7rem;
    padding: 1px 6px;
    border-radius: 4px;
}
.slide-thumb-flag {
    position: absolute;
    top: 4px;
    right: 4px;
    font-size: 0.75rem;
}
.presenter-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
}
.presenter-topbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1.5rem;
    background: var(--app-card-bg);
    border-bottom: 1px solid var(--app-border);
    flex-shrink: 0;
}
.presenter-slide-area {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    background: var(--app-bg);
    min-height: 0;
}
.presenter-slide-area img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.15);
}
.presenter-bottom {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1.5rem;
    background: var(--app-card-bg);
    border-top: 1px solid var(--app-border);
    flex-shrink: 0;
    gap: 1rem;
}
.nav-btn {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    border: 1px solid var(--app-border);
    background: var(--app-input-bg);
    color: var(--app-text);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 1.2rem;
    transition: all 0.2s ease;
}
.nav-btn:hover {
    background: rgba(59, 130, 246, 0.1);
    border-color: rgba(59, 130, 246, 0.3);
}
.nav-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}
.slide-counter {
    font-weight: 600;
    font-size: 1rem;
    color: var(--app-text);
    min-width: 80px;
    text-align: center;
}
.reaction-bars {
    flex: 1;
    max-width: 500px;
}
.reaction-bar-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
}
.reaction-bar-label {
    font-size: 0.8rem;
    width: 50px;
    text-align: right;
    flex-shrink: 0;
}
.reaction-bar-track {
    flex: 1;
    height: 16px;
    background: var(--app-input-bg);
    border-radius: 8px;
    overflow: hidden;
}
.reaction-bar-fill {
    height: 100%;
    border-radius: 8px;
    transition: width 0.3s ease;
    min-width: 0;
}
.reaction-bar-count {
    font-size: 0.8rem;
    font-weight: 600;
    width: 30px;
    text-align: left;
    flex-shrink: 0;
}
.participant-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--app-input-bg);
    border-radius: 10px;
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--app-text);
    flex-shrink: 0;
}
.bookmark-btn {
    border: 1px solid var(--app-border);
    background: var(--app-input-bg);
    color: var(--app-text-muted);
    border-radius: 8px;
    padding: 0.4rem 0.75rem;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.4rem;
}
.bookmark-btn.active {
    background: rgba(239, 68, 68, 0.1);
    border-color: #ef4444;
    color: #ef4444;
}
@media (max-width: 768px) {
    .presenter-layout {
        flex-direction: column;
    }
    .slide-sidebar {
        width: 100%;
        min-width: 100%;
        height: 120px;
        flex-direction: row;
        overflow-x: auto;
        overflow-y: hidden;
    }
    .slide-thumb-wrapper {
        min-width: 120px;
    }
    .presenter-bottom {
        flex-wrap: wrap;
    }
    .reaction-bars {
        order: 3;
        max-width: 100%;
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="presenter-layout">
    <div class="slide-sidebar" id="slideSidebar">
        {% for url in slides %}
        <div class="slide-thumb-wrapper {% if loop.index0 == 0 %}active{% endif %} {% if loop.index0 in bookmarks %}flagged{% endif %}"
             data-index="{{ loop.index0 }}" onclick="goToSlide({{ loop.index0 }})">
            <img src="{{ url }}" class="slide-thumb-img" alt="Ïä¨ÎùºÏù¥Îìú {{ loop.index }}">
            <span class="slide-thumb-number">{{ loop.index }}</span>
            <span class="slide-thumb-flag {% if loop.index0 not in bookmarks %}d-none{% endif %}" id="thumbFlag{{ loop.index0 }}">üîñ</span>
        </div>
        {% endfor %}
    </div>

    <div class="presenter-main">
        <div class="presenter-topbar">
            <div class="d-flex align-items-center gap-3">
                <a href="{{ url_for('courses.view', course_id=course.id) }}" class="text-decoration-none" style="color: var(--app-text);">
                    <i class="bi bi-arrow-left me-1"></i>
                </a>
                <div>
                    <h6 class="mb-0 fw-bold">{{ course.title }}</h6>
                    <small class="text-muted">{{ deck.file_name }}</small>
                </div>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button class="bookmark-btn" id="bookmarkToggle" onclick="toggleBookmark()">
                    <i class="bi bi-bookmark" id="bookmarkIcon"></i>
                    <span>Î∂ÅÎßàÌÅ¨</span>
                </button>
                <a href="{{ url_for('slides.review_view', deck_id=deck.id) }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-journal-text me-1"></i>Î¶¨Î∑∞ ÌéòÏù¥ÏßÄ
                </a>
            </div>
        </div>

        <div class="presenter-slide-area">
            <img src="{{ slides[0] if slides else '' }}" alt="ÌòÑÏû¨ Ïä¨ÎùºÏù¥Îìú" id="currentSlideImage">
        </div>

        <div class="presenter-bottom">
            <div class="d-flex align-items-center gap-2">
                <button class="nav-btn" id="prevBtn" onclick="prevSlide()">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <span class="slide-counter" id="slideCounter">1 / {{ slides|length }}</span>
                <button class="nav-btn" id="nextBtn" onclick="nextSlide()">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>

            <div class="reaction-bars" id="reactionBars">
                <div class="reaction-bar-row">
                    <span class="reaction-bar-label">üëç</span>
                    <div class="reaction-bar-track">
                        <div class="reaction-bar-fill" id="barUnderstood" style="width: 0%; background: #22c55e;"></div>
                    </div>
                    <span class="reaction-bar-count" id="countUnderstood">0</span>
                </div>
                <div class="reaction-bar-row">
                    <span class="reaction-bar-label">‚ùì</span>
                    <div class="reaction-bar-track">
                        <div class="reaction-bar-fill" id="barQuestion" style="width: 0%; background: #f59e0b;"></div>
                    </div>
                    <span class="reaction-bar-count" id="countQuestion">0</span>
                </div>
                <div class="reaction-bar-row">
                    <span class="reaction-bar-label">üòµ</span>
                    <div class="reaction-bar-track">
                        <div class="reaction-bar-fill" id="barHard" style="width: 0%; background: #ef4444;"></div>
                    </div>
                    <span class="reaction-bar-count" id="countHard">0</span>
                </div>
            </div>

            <div class="participant-badge">
                <i class="bi bi-people-fill"></i>
                <span id="participantCount">0</span>Î™Ö
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const deckId = {{ deck.id }};
const slides = {{ slides|tojson }};
const totalSlides = slides.length;
let currentIndex = 0;
let slideAggregates = {};
let bookmarkedSlides = new Set([{% for idx in bookmarks %}{{ idx }},{% endfor %}]);

const socket = io();

socket.emit('join_slide_session', { deck_id: deckId });
socket.emit('request_slide_aggregates', { deck_id: deckId });

function goToSlide(index) {
    if (index < 0 || index >= totalSlides || index === currentIndex) return;
    currentIndex = index;
    updateSlideDisplay();
    socket.emit('change_slide', { deck_id: deckId, slide_index: currentIndex });
}

function prevSlide() {
    if (currentIndex > 0) goToSlide(currentIndex - 1);
}

function nextSlide() {
    if (currentIndex < totalSlides - 1) goToSlide(currentIndex + 1);
}

function updateSlideDisplay() {
    document.getElementById('currentSlideImage').src = slides[currentIndex];
    document.getElementById('slideCounter').textContent = (currentIndex + 1) + ' / ' + totalSlides;

    document.querySelectorAll('.slide-thumb-wrapper').forEach(el => {
        el.classList.toggle('active', parseInt(el.dataset.index) === currentIndex);
    });

    const activeThumb = document.querySelector('.slide-thumb-wrapper.active');
    if (activeThumb) {
        activeThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    updateReactionBars();
    updateBookmarkButton();
    document.getElementById('prevBtn').disabled = currentIndex === 0;
    document.getElementById('nextBtn').disabled = currentIndex === totalSlides - 1;
}

function updateReactionBars() {
    const agg = slideAggregates[currentIndex] || { understood: 0, question: 0, hard: 0, total_reacted: 0 };
    const total = Math.max(agg.total_reacted, 1);

    document.getElementById('countUnderstood').textContent = agg.understood;
    document.getElementById('countQuestion').textContent = agg.question;
    document.getElementById('countHard').textContent = agg.hard;

    document.getElementById('barUnderstood').style.width = (agg.understood / total * 100) + '%';
    document.getElementById('barQuestion').style.width = (agg.question / total * 100) + '%';
    document.getElementById('barHard').style.width = (agg.hard / total * 100) + '%';

    document.getElementById('participantCount').textContent = agg.total_reacted;
}

function updateBookmarkButton() {
    const btn = document.getElementById('bookmarkToggle');
    const icon = document.getElementById('bookmarkIcon');
    if (bookmarkedSlides.has(currentIndex)) {
        btn.classList.add('active');
        icon.className = 'bi bi-bookmark-fill';
    } else {
        btn.classList.remove('active');
        icon.className = 'bi bi-bookmark';
    }
}

function toggleBookmark() {
    socket.emit('toggle_slide_bookmark', { deck_id: deckId, slide_index: currentIndex });
}

function updateThumbFlag(slideIndex, isFlagged) {
    const flag = document.getElementById('thumbFlag' + slideIndex);
    const wrapper = document.querySelector(`.slide-thumb-wrapper[data-index="${slideIndex}"]`);
    if (flag) {
        flag.classList.toggle('d-none', !isFlagged);
    }
    if (wrapper) {
        wrapper.classList.toggle('flagged', isFlagged);
    }
}

socket.on('all_slide_aggregates', function(data) {
    slideAggregates = data.aggregates;
    bookmarkedSlides = new Set();
    if (data.flagged_slides) {
        data.flagged_slides.forEach(function(fs) {
            bookmarkedSlides.add(fs.slide_index);
            updateThumbFlag(fs.slide_index, true);
        });
    }
    updateReactionBars();
    updateBookmarkButton();
});

socket.on('slide_aggregate_updated', function(data) {
    slideAggregates[data.slide_index] = data.counts;
    if (data.slide_index === currentIndex) {
        updateReactionBars();
    }
    if (data.flagged) {
        bookmarkedSlides.add(data.slide_index);
        updateThumbFlag(data.slide_index, true);
    }
});

socket.on('bookmark_updated', function(data) {
    if (data.is_bookmarked) {
        bookmarkedSlides.add(data.slide_index);
    } else {
        bookmarkedSlides.delete(data.slide_index);
    }
    updateThumbFlag(data.slide_index, data.is_bookmarked);
    if (data.slide_index === currentIndex) {
        updateBookmarkButton();
    }
});

document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    if (e.key === 'ArrowLeft') { e.preventDefault(); prevSlide(); }
    if (e.key === 'ArrowRight') { e.preventDefault(); nextSlide(); }
});

updateSlideDisplay();
</script>
{% endblock %}
