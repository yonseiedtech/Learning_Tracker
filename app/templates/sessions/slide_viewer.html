{% extends "base.html" %}

{% block title %}ìŠ¬ë¼ì´ë“œ - {{ course.title }}{% endblock %}

{% block head %}
<style>
.viewer-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 1rem 0;
}
.viewer-slide-area {
    background: var(--app-card-bg);
    border: 1px solid var(--app-border);
    border-radius: 14px;
    overflow: hidden;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 24px rgba(0,0,0,0.06);
    position: relative;
}
.viewer-slide-area img {
    width: 100%;
    display: block;
}
.slide-indicator {
    text-align: center;
    padding: 0.75rem;
    font-weight: 600;
    color: var(--app-text-muted);
    font-size: 0.9rem;
    border-top: 1px solid var(--app-border);
    background: var(--app-input-bg);
}
.reaction-buttons {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    margin-bottom: 1.5rem;
}
.reaction-btn {
    flex: 1;
    max-width: 220px;
    padding: 0.875rem 1rem;
    border-radius: 12px;
    border: 2px solid var(--app-border);
    background: var(--app-card-bg);
    color: var(--app-text);
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.4rem;
    text-align: center;
}
.reaction-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
}
.reaction-btn .reaction-emoji {
    font-size: 1.75rem;
}
.reaction-btn .reaction-text {
    font-size: 0.8rem;
    line-height: 1.3;
}
.reaction-btn.active-understood {
    border-color: #22c55e;
    background: rgba(34, 197, 94, 0.1);
    color: #16a34a;
}
.reaction-btn.active-question {
    border-color: #f59e0b;
    background: rgba(245, 158, 11, 0.1);
    color: #d97706;
}
.reaction-btn.active-hard {
    border-color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
}
.aggregate-display {
    display: flex;
    justify-content: center;
    gap: 2rem;
    padding: 1rem;
}
.aggregate-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: var(--app-text-muted);
}
.aggregate-item .agg-emoji {
    font-size: 1.2rem;
}
.aggregate-item .agg-count {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--app-text);
}
.sync-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.3rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
}
.share-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.3rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    animation: shareBadgePulse 2s infinite;
}
@keyframes shareBadgePulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.2); }
    50% { box-shadow: 0 0 0 4px rgba(239, 68, 68, 0); }
}
.share-badge .share-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: #ef4444; animation: dotBlink 1.2s infinite;
}
@keyframes dotBlink { 0%,100%{opacity:1} 50%{opacity:0.3} }
.screen-share-display {
    display: none;
    width: 100%;
}
.screen-share-display img {
    width: 100%;
    display: block;
}
.viewer-pip {
    position: absolute;
    bottom: 50px;
    right: 8px;
    width: 160px;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 16px rgba(0,0,0,0.25);
    border: 2px solid rgba(255,255,255,0.2);
    z-index: 10;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #000;
}
.viewer-pip:hover {
    border-color: rgba(59, 130, 246, 0.5);
    transform: scale(1.05);
}
.viewer-pip img {
    width: 100%;
    display: block;
}
.viewer-pip .pip-label {
    position: absolute;
    top: 3px; left: 3px;
    background: rgba(0,0,0,0.7);
    color: #fff;
    font-size: 0.55rem;
    padding: 1px 5px;
    border-radius: 3px;
}
.share-toast {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 1000;
    padding: 0.75rem 1.25rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 500;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    animation: toastSlideIn 0.4s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.share-toast.started {
    background: linear-gradient(135deg, rgba(239,68,68,0.95), rgba(220,38,38,0.95));
    color: #fff;
}
.share-toast.stopped {
    background: linear-gradient(135deg, rgba(59,130,246,0.95), rgba(99,102,241,0.95));
    color: #fff;
}
@keyframes toastSlideIn {
    from { opacity: 0; transform: translateX(40px); }
    to { opacity: 1; transform: translateX(0); }
}
@media (max-width: 576px) {
    .reaction-buttons {
        flex-direction: column;
        align-items: center;
    }
    .reaction-btn {
        max-width: 100%;
        width: 100%;
        flex-direction: row;
        gap: 0.75rem;
        text-align: left;
    }
    .reaction-btn .reaction-emoji {
        font-size: 1.5rem;
    }
    .aggregate-display {
        gap: 1rem;
    }
    .viewer-pip { width: 120px; }
}
</style>
{% endblock %}

{% block content %}
<div class="viewer-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h5 class="fw-bold mb-1">{{ course.title }}</h5>
            <small class="text-muted">{{ deck.file_name }}</small>
        </div>
        <div class="d-flex align-items-center gap-2">
            <span class="share-badge d-none" id="shareBadge">
                <span class="share-dot"></span>í™”ë©´ ê³µìœ  ì¤‘
            </span>
            <span class="sync-badge" id="syncBadge">
                <i class="bi bi-broadcast"></i> ì‹¤ì‹œê°„ ë™ê¸°í™”
            </span>
        </div>
    </div>

    <div class="viewer-slide-area glass-card no-hover p-0">
        <img src="{{ slides[0] if slides else '' }}" alt="í˜„ì¬ ìŠ¬ë¼ì´ë“œ" id="currentSlideImage">
        <div class="screen-share-display" id="screenShareDisplay">
            <img src="" alt="í™”ë©´ ê³µìœ " id="screenShareImage">
        </div>
        <div class="viewer-pip d-none" id="viewerPip" onclick="toggleViewerPipExpand()">
            <span class="pip-label" id="pipLabel">ìŠ¬ë¼ì´ë“œ</span>
            <img src="{{ slides[0] if slides else '' }}" alt="PiP" id="pipImage">
        </div>
        <div class="slide-indicator" id="slideIndicator">
            ìŠ¬ë¼ì´ë“œ 1 / {{ slides|length }}
        </div>
    </div>

    <div class="reaction-buttons">
        <button class="reaction-btn {% if my_reactions.get(0) == 'understood' %}active-understood{% endif %}"
                id="btnUnderstood" onclick="setReaction('understood')">
            <span class="reaction-emoji">ğŸ‘</span>
            <span class="reaction-text">ì˜ ì´í•´ë¼ìš”</span>
        </button>
        <button class="reaction-btn {% if my_reactions.get(0) == 'question' %}active-question{% endif %}"
                id="btnQuestion" onclick="setReaction('question')">
            <span class="reaction-emoji">â“</span>
            <span class="reaction-text">ê¶ê¸ˆí•œ ë¶€ë¶„ì´ ìˆì–´ìš”</span>
        </button>
        <button class="reaction-btn {% if my_reactions.get(0) == 'hard' %}active-hard{% endif %}"
                id="btnHard" onclick="setReaction('hard')">
            <span class="reaction-emoji">ğŸ˜µ</span>
            <span class="reaction-text">ì–´ë ¤ì›Œìš”</span>
        </button>
    </div>

    <div class="glass-card no-hover p-3">
        <div class="aggregate-display" id="aggregateDisplay">
            <div class="aggregate-item">
                <span class="agg-emoji">ğŸ‘</span>
                <span class="agg-count" id="aggUnderstood">0</span>
            </div>
            <div class="aggregate-item">
                <span class="agg-emoji">â“</span>
                <span class="agg-count" id="aggQuestion">0</span>
            </div>
            <div class="aggregate-item">
                <span class="agg-emoji">ğŸ˜µ</span>
                <span class="agg-count" id="aggHard">0</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const deckId = {{ deck.id }};
const slides = {{ slides|tojson }};
const totalSlides = slides.length;
let currentIndex = 0;
let myReactions = {{ my_reactions|tojson }};
let currentReaction = myReactions[0] || null;
let isScreenSharing = false;
let shareFrameTimeout = null;

const socket = io();

socket.emit('join_slide_session', { deck_id: deckId });

socket.on('slide_session_state', function(data) {
    currentIndex = data.current_slide_index || 0;
    updateSlideDisplay();
    loadMyReaction();
    if (data.screen_share_active) {
        enterScreenShareMode();
    }
});

socket.on('slide_changed', function(data) {
    currentIndex = data.slide_index;
    updateSlideDisplay();
    loadMyReaction();
    if (isScreenSharing) {
        document.getElementById('pipImage').src = slides[currentIndex];
    }
});

socket.on('slide_aggregate_updated', function(data) {
    if (data.slide_index === currentIndex) {
        updateAggregates(data.counts);
    }
});

socket.on('screen_share_started', function(data) {
    enterScreenShareMode();
    showShareToast(true, data.instructor_name);
});

socket.on('screen_share_stopped', function(data) {
    exitScreenShareMode();
    showShareToast(false);
});

socket.on('screen_share_frame', function(data) {
    if (!isScreenSharing) enterScreenShareMode();
    document.getElementById('screenShareImage').src = data.frame;
    resetShareFrameTimeout();
});

function enterScreenShareMode() {
    isScreenSharing = true;
    document.getElementById('currentSlideImage').style.display = 'none';
    document.getElementById('screenShareDisplay').style.display = 'block';
    document.getElementById('shareBadge').classList.remove('d-none');
    document.getElementById('viewerPip').classList.remove('d-none');
    document.getElementById('pipImage').src = slides[currentIndex];
    document.getElementById('pipLabel').textContent = 'ìŠ¬ë¼ì´ë“œ';
    document.getElementById('slideIndicator').innerHTML =
        '<i class="bi bi-display me-1"></i>ê°•ì‚¬ í™”ë©´ ê³µìœ  ì¤‘ <span class="text-muted ms-2">ìŠ¬ë¼ì´ë“œ ' + (currentIndex + 1) + ' / ' + totalSlides + '</span>';
    resetShareFrameTimeout();
}

function resetShareFrameTimeout() {
    if (shareFrameTimeout) clearTimeout(shareFrameTimeout);
    shareFrameTimeout = setTimeout(function() {
        if (isScreenSharing) {
            exitScreenShareMode();
        }
    }, 8000);
}

function exitScreenShareMode() {
    isScreenSharing = false;
    if (shareFrameTimeout) { clearTimeout(shareFrameTimeout); shareFrameTimeout = null; }
    document.getElementById('currentSlideImage').style.display = 'block';
    document.getElementById('screenShareDisplay').style.display = 'none';
    document.getElementById('shareBadge').classList.add('d-none');
    document.getElementById('viewerPip').classList.add('d-none');
    document.getElementById('currentSlideImage').src = slides[currentIndex];
    document.getElementById('slideIndicator').textContent = 'ìŠ¬ë¼ì´ë“œ ' + (currentIndex + 1) + ' / ' + totalSlides;
}

function toggleViewerPipExpand() {
    var slideImg = document.getElementById('currentSlideImage');
    var shareDisplay = document.getElementById('screenShareDisplay');
    var pipImg = document.getElementById('pipImage');
    var pipLabel = document.getElementById('pipLabel');

    if (pipLabel.textContent === 'ìŠ¬ë¼ì´ë“œ') {
        slideImg.style.display = 'block';
        slideImg.src = slides[currentIndex];
        shareDisplay.style.display = 'none';
        pipImg.src = document.getElementById('screenShareImage').src;
        pipLabel.textContent = 'í™”ë©´ ê³µìœ ';
    } else {
        slideImg.style.display = 'none';
        shareDisplay.style.display = 'block';
        pipImg.src = slides[currentIndex];
        pipLabel.textContent = 'ìŠ¬ë¼ì´ë“œ';
    }
}

function showShareToast(started, instructorName) {
    var existing = document.querySelector('.share-toast');
    if (existing) existing.remove();

    var toast = document.createElement('div');
    toast.className = 'share-toast ' + (started ? 'started' : 'stopped');
    if (started) {
        toast.innerHTML = '<i class="bi bi-display-fill"></i>' +
            (instructorName ? instructorName + ' ë‹˜ì´ ' : '') + 'í™”ë©´ ê³µìœ ë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤';
    } else {
        toast.innerHTML = '<i class="bi bi-display"></i>í™”ë©´ ê³µìœ ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤';
    }
    document.body.appendChild(toast);
    setTimeout(function() {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.4s';
        setTimeout(function() { toast.remove(); }, 400);
    }, 4000);
}

function updateSlideDisplay() {
    if (currentIndex >= 0 && currentIndex < totalSlides) {
        if (!isScreenSharing) {
            document.getElementById('currentSlideImage').src = slides[currentIndex];
            document.getElementById('slideIndicator').textContent = 'ìŠ¬ë¼ì´ë“œ ' + (currentIndex + 1) + ' / ' + totalSlides;
        } else {
            document.getElementById('pipImage').src = slides[currentIndex];
            document.getElementById('slideIndicator').innerHTML =
                '<i class="bi bi-display me-1"></i>ê°•ì‚¬ í™”ë©´ ê³µìœ  ì¤‘ <span class="text-muted ms-2">ìŠ¬ë¼ì´ë“œ ' + (currentIndex + 1) + ' / ' + totalSlides + '</span>';
        }
    }
}

function loadMyReaction() {
    currentReaction = myReactions[currentIndex] || null;
    updateReactionButtons();
}

function setReaction(reaction) {
    if (currentReaction === reaction) {
        currentReaction = null;
        myReactions[currentIndex] = null;
        socket.emit('set_slide_reaction', { deck_id: deckId, slide_index: currentIndex, reaction: 'none' });
    } else {
        currentReaction = reaction;
        myReactions[currentIndex] = reaction;
        socket.emit('set_slide_reaction', { deck_id: deckId, slide_index: currentIndex, reaction: reaction });
    }
    updateReactionButtons();
}

function updateReactionButtons() {
    const btnU = document.getElementById('btnUnderstood');
    const btnQ = document.getElementById('btnQuestion');
    const btnH = document.getElementById('btnHard');

    btnU.className = 'reaction-btn' + (currentReaction === 'understood' ? ' active-understood' : '');
    btnQ.className = 'reaction-btn' + (currentReaction === 'question' ? ' active-question' : '');
    btnH.className = 'reaction-btn' + (currentReaction === 'hard' ? ' active-hard' : '');
}

function updateAggregates(counts) {
    document.getElementById('aggUnderstood').textContent = counts.understood || 0;
    document.getElementById('aggQuestion').textContent = counts.question || 0;
    document.getElementById('aggHard').textContent = counts.hard || 0;
}

updateSlideDisplay();
</script>
{% endblock %}
