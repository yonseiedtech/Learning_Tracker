{% extends "base.html" %}

{% block title %}라이브 세션 - {{ course.title }}{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">대시보드</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('courses.view', course_id=course.id) }}">{{ course.title }}</a></li>
        <li class="breadcrumb-item active">라이브 세션</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <div>
        <h2 class="fw-bold mb-1"><i class="bi bi-broadcast text-success me-2"></i>라이브 세션</h2>
        <p class="text-muted mb-0">{{ course.title }} - 실시간 진도 추적</p>
    </div>
    <div class="d-flex gap-2 align-items-center">
        <span class="badge connection-badge bg-success" id="connectionStatus">
            <i class="bi bi-circle-fill me-1"></i>연결됨
        </span>
        <div class="btn-group">
            <button class="btn btn-outline-primary active" id="gridViewBtn" onclick="setView('grid')">
                <i class="bi bi-grid-3x3-gap"></i>
            </button>
            <button class="btn btn-outline-primary" id="listViewBtn" onclick="setView('list')">
                <i class="bi bi-list"></i>
            </button>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-4">
        <div class="glass-card p-4 mb-4">
            <h5 class="fw-bold mb-3"><i class="bi bi-bar-chart me-2 text-primary"></i>체크포인트별 진행률</h5>
            <canvas id="progressChart" height="250"></canvas>
        </div>
        
        <div class="glass-card p-4">
            <h5 class="fw-bold mb-3"><i class="bi bi-flag me-2 text-primary"></i>체크포인트</h5>
            <div class="list-group list-group-modern">
                {% for cp in checkpoints %}
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <span>{{ cp.order }}. {{ cp.title[:20] }}{{ '...' if cp.title|length > 20 else '' }}</span>
                    <span class="badge bg-primary bg-opacity-10 text-primary" id="cp-{{ cp.id }}-badge">0/{{ students|length }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-8">
        <div class="glass-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-bold mb-0"><i class="bi bi-people me-2 text-primary"></i>학생 진도</h5>
                <span class="badge bg-primary bg-opacity-10 text-primary" id="studentCount">{{ students|length }}명</span>
            </div>
            
            <div id="gridView" class="row g-3">
                {% for student in students %}
                <div class="col-md-4 col-lg-4">
                    <div class="student-card" id="student-{{ student.id }}">
                        <div class="avatar-lg mx-auto mb-2">{{ student.username[0]|upper }}</div>
                        <h6 class="mb-2">{{ student.username }}</h6>
                        <div class="progress progress-modern mb-2">
                            <div class="progress-bar bg-gradient-primary" style="width: 0%" id="student-{{ student.id }}-progress"></div>
                        </div>
                        <small class="text-muted" id="student-{{ student.id }}-text">0/{{ checkpoints|length }}</small>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div id="listView" class="d-none">
                <div class="table-responsive">
                    <table class="table table-modern">
                        <thead>
                            <tr>
                                <th>학생</th>
                                {% for cp in checkpoints %}
                                <th class="text-center" title="{{ cp.title }}">{{ cp.order }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            <tr id="student-row-{{ student.id }}">
                                <td>{{ student.username }}</td>
                                {% for cp in checkpoints %}
                                <td class="text-center" id="cell-{{ student.id }}-{{ cp.id }}">
                                    <i class="bi bi-circle text-muted"></i>
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
const courseId = {{ course.id }};
const checkpoints = {{ checkpoints|map(attribute='id')|list|tojson }};
const studentIds = {{ students|map(attribute='id')|list|tojson }};
const totalCheckpoints = {{ checkpoints|length }};
const totalStudents = {{ students|length }};

let studentProgress = {};
studentIds.forEach(id => {
    studentProgress[id] = {};
    checkpoints.forEach(cpId => {
        studentProgress[id][cpId] = false;
    });
});

const socket = io();

socket.on('connect', function() {
    document.getElementById('connectionStatus').innerHTML = '<i class="bi bi-circle-fill me-1"></i>연결됨';
    document.getElementById('connectionStatus').className = 'badge connection-badge bg-success';
    socket.emit('join_course', { course_id: courseId, mode: 'live' });
});

socket.on('disconnect', function() {
    document.getElementById('connectionStatus').innerHTML = '<i class="bi bi-circle-fill me-1"></i>연결 끊김';
    document.getElementById('connectionStatus').className = 'badge connection-badge bg-danger';
});

socket.on('progress_update', function(data) {
    const { user_id, checkpoint_id, status } = data;
    if (status === 'completed') {
        studentProgress[user_id][checkpoint_id] = true;
        updateStudentDisplay(user_id);
        updateCell(user_id, checkpoint_id, true);
    }
});

socket.on('session_stats', function(data) {
    const { completion_rates } = data;
    for (const cpId in completion_rates) {
        const stats = completion_rates[cpId];
        const badge = document.getElementById(`cp-${cpId}-badge`);
        if (badge) {
            badge.textContent = `${stats.completed}/${stats.total}`;
        }
    }
    updateChart(completion_rates);
});

function updateStudentDisplay(userId) {
    const completed = Object.values(studentProgress[userId]).filter(v => v).length;
    const percent = (completed / totalCheckpoints) * 100;
    
    const progressBar = document.getElementById(`student-${userId}-progress`);
    const text = document.getElementById(`student-${userId}-text`);
    const card = document.getElementById(`student-${userId}`);
    
    if (progressBar) {
        progressBar.style.width = `${percent}%`;
    }
    if (text) {
        text.textContent = `${completed}/${totalCheckpoints}`;
    }
    if (card && percent === 100) {
        card.classList.add('completed');
    }
}

function updateCell(userId, checkpointId, completed) {
    const cell = document.getElementById(`cell-${userId}-${checkpointId}`);
    if (cell) {
        cell.innerHTML = completed 
            ? '<i class="bi bi-check-circle-fill text-success"></i>'
            : '<i class="bi bi-circle text-muted"></i>';
    }
}

function setView(view) {
    if (view === 'grid') {
        document.getElementById('gridView').classList.remove('d-none');
        document.getElementById('listView').classList.add('d-none');
        document.getElementById('gridViewBtn').classList.add('active');
        document.getElementById('listViewBtn').classList.remove('active');
    } else {
        document.getElementById('gridView').classList.add('d-none');
        document.getElementById('listView').classList.remove('d-none');
        document.getElementById('gridViewBtn').classList.remove('active');
        document.getElementById('listViewBtn').classList.add('active');
    }
}

let progressChart;
function updateChart(completionRates) {
    const labels = [];
    const data = [];
    
    checkpoints.forEach((cpId, index) => {
        labels.push(`CP ${index + 1}`);
        const stats = completionRates[cpId];
        data.push(stats ? (stats.completed / stats.total * 100).toFixed(1) : 0);
    });
    
    if (progressChart) {
        progressChart.data.datasets[0].data = data;
        progressChart.update();
    } else {
        const ctx = document.getElementById('progressChart').getContext('2d');
        progressChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '완료율 %',
                    data: data,
                    backgroundColor: 'rgba(102, 126, 234, 0.7)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 1,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, max: 100 }
                }
            }
        });
    }
}

setInterval(function() {
    socket.emit('request_stats', { course_id: courseId, mode: 'live' });
}, 3000);
</script>
{% endblock %}
{% endblock %}
