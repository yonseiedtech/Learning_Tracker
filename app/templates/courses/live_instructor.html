{% extends "base.html" %}

{% block title %}ÎùºÏù¥Î∏å ÏÑ∏ÏÖò - {{ course.title }}{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">ÎåÄÏãúÎ≥¥Îìú</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('courses.view', course_id=course.id) }}">{{ course.title }}</a></li>
        <li class="breadcrumb-item active">ÎùºÏù¥Î∏å ÏÑ∏ÏÖò</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <div>
        <h2 class="fw-bold mb-1"><i class="bi bi-broadcast text-success me-2"></i>ÎùºÏù¥Î∏å ÏÑ∏ÏÖò</h2>
        <p class="text-muted mb-0">{{ course.title }} - Ïã§ÏãúÍ∞Ñ ÏßÑÎèÑ Ï∂îÏ†Å</p>
    </div>
    <div class="d-flex gap-2 align-items-center">
        <div class="glass-card px-3 py-2 d-flex align-items-center gap-2">
            <i class="bi bi-clock text-primary"></i>
            <span id="currentTime">--:--:--</span>
        </div>
        <span class="badge connection-badge bg-success" id="connectionStatus">
            <i class="bi bi-circle-fill me-1"></i>Ïó∞Í≤∞Îê®
        </span>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="glass-card p-4 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold mb-0"><i class="bi bi-flag-fill me-2 text-primary"></i>Ï≤¥ÌÅ¨Ìè¨Ïù∏Ìä∏ ÏßÑÌñâ</h5>
                <div class="d-flex gap-2 align-items-center">
                    <small class="text-muted">ÌÅ¥Î¶≠: ÏßÑÌñâÏ§ë | ÎçîÎ∏îÌÅ¥Î¶≠: ÏôÑÎ£å</small>
                </div>
            </div>
            
            <div class="overall-progress-container mb-4 p-3 rounded-3" style="background: rgba(102, 126, 234, 0.05);">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-bold text-primary"><i class="bi bi-graph-up-arrow me-2"></i>Ï†ÑÏ≤¥ ÏàòÏóÖ ÏßÑÌñâÏú®</span>
                    <span class="badge bg-primary fs-6" id="overallProgressPercent">0%</span>
                </div>
                <div class="progress progress-modern" style="height: 12px;">
                    <div class="progress-bar bg-gradient-primary" role="progressbar" style="width: 0%" id="overallProgressBar"></div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted" id="completedCheckpointsText">ÏôÑÎ£å: 0 / {{ checkpoints|length }}</small>
                    <small class="text-muted" id="remainingCheckpointsText">ÎÇ®ÏùÄ Ï≤¥ÌÅ¨Ìè¨Ïù∏Ìä∏: {{ checkpoints|length }}Í∞ú</small>
                </div>
            </div>
            
            <div class="checkpoint-list">
                {% for cp in checkpoints %}
                <div class="checkpoint-item-instructor p-3 mb-2 rounded-3" id="checkpoint-{{ cp.id }}" 
                     onclick="setCurrentCheckpoint({{ cp.id }})" 
                     ondblclick="toggleCheckpointComplete({{ cp.id }})">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="checkpoint-order me-3">
                                <span class="badge checkpoint-number fs-6 px-3 py-2" id="cp-num-{{ cp.id }}">{{ cp.order }}</span>
                            </div>
                            <div>
                                <strong>{{ cp.title }}</strong>
                                {% if cp.description %}
                                <p class="mb-0 small text-muted">{{ cp.description[:50] }}{{ '...' if cp.description|length > 50 else '' }}</p>
                                {% endif %}
                                <div class="d-flex gap-3 mt-1">
                                    {% if cp.estimated_minutes %}
                                    <small class="text-primary"><i class="bi bi-hourglass me-1"></i>ÏòàÏÉÅ {{ cp.estimated_minutes }}Î∂Ñ</small>
                                    {% endif %}
                                    <small class="text-success" id="actual-time-{{ cp.id }}"><i class="bi bi-stopwatch me-1"></i>Ïã§Ï†ú 00:00</small>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="timer-controls btn-group btn-group-sm" id="timer-{{ cp.id }}">
                                <button class="btn btn-outline-success btn-sm timer-start" onclick="event.stopPropagation(); startTimer({{ cp.id }})" title="ÏãúÏûë">
                                    <i class="bi bi-play-fill"></i>
                                </button>
                                <button class="btn btn-outline-warning btn-sm timer-pause d-none" onclick="event.stopPropagation(); pauseTimer({{ cp.id }})" title="ÏùºÏãúÏ§ëÎã®">
                                    <i class="bi bi-pause-fill"></i>
                                </button>
                                <button class="btn btn-outline-primary btn-sm timer-resume d-none" onclick="event.stopPropagation(); resumeTimer({{ cp.id }})" title="Ïû¨Í∞ú">
                                    <i class="bi bi-play-circle"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm timer-stop d-none" onclick="event.stopPropagation(); stopTimer({{ cp.id }})" title="Ï¢ÖÎ£å">
                                    <i class="bi bi-stop-fill"></i>
                                </button>
                            </div>
                            <div class="understanding-stats d-flex gap-2">
                                <span class="badge bg-success bg-opacity-10 text-success" id="understood-{{ cp.id }}">
                                    <i class="bi bi-emoji-smile me-1"></i><span>0</span>
                                </span>
                                <span class="badge bg-warning bg-opacity-10 text-warning" id="confused-{{ cp.id }}">
                                    <i class="bi bi-emoji-frown me-1"></i><span>0</span>
                                </span>
                            </div>
                            <div class="progress-badge">
                                <span class="badge bg-primary bg-opacity-10 text-primary" id="cp-{{ cp.id }}-badge">
                                    <i class="bi bi-people me-1"></i>0/{{ students|length }}
                                </span>
                            </div>
                            <div class="status-indicators">
                                <span class="badge bg-success pulse-animation d-none" id="current-{{ cp.id }}"><i class="bi bi-play-circle-fill me-1"></i>ÏßÑÌñâÏ§ë</span>
                                <span class="badge bg-primary d-none" id="complete-{{ cp.id }}"><i class="bi bi-check-circle-fill me-1"></i>ÏôÑÎ£å</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="glass-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold mb-0"><i class="bi bi-people me-2 text-primary"></i>ÌïôÏÉù ÏßÑÎèÑ</h5>
                <div class="d-flex gap-2 align-items-center">
                    <span class="badge bg-primary bg-opacity-10 text-primary" id="studentCount">{{ students|length }}Î™Ö</span>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary active" id="gridViewBtn" onclick="setView('grid')">
                            <i class="bi bi-grid-3x3-gap"></i>
                        </button>
                        <button class="btn btn-outline-primary" id="listViewBtn" onclick="setView('list')">
                            <i class="bi bi-list"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="gridView" class="row g-3">
                {% for student in students %}
                <div class="col-6 col-md-4 col-lg-3">
                    <div class="student-card" id="student-{{ student.id }}">
                        <div class="avatar-lg mx-auto mb-2">{{ student.username[0]|upper }}</div>
                        <h6 class="mb-2 small">{{ student.username }}</h6>
                        <div class="progress progress-modern mb-2" style="height: 6px;">
                            <div class="progress-bar bg-gradient-primary" style="width: 0%" id="student-{{ student.id }}-progress"></div>
                        </div>
                        <small class="text-muted" id="student-{{ student.id }}-text">0/{{ checkpoints|length }}</small>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div id="listView" class="d-none">
                <div class="table-responsive">
                    <table class="table table-modern table-sm">
                        <thead>
                            <tr>
                                <th>ÌïôÏÉù</th>
                                {% for cp in checkpoints %}
                                <th class="text-center" title="{{ cp.title }}">{{ cp.order }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            <tr id="student-row-{{ student.id }}">
                                <td>{{ student.username }}</td>
                                {% for cp in checkpoints %}
                                <td class="text-center" id="cell-{{ student.id }}-{{ cp.id }}">
                                    <i class="bi bi-circle text-muted"></i>
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="glass-card p-4 mb-4">
            <h5 class="fw-bold mb-3"><i class="bi bi-bar-chart me-2 text-primary"></i>ÏôÑÎ£åÏú®</h5>
            <canvas id="progressChart" height="200"></canvas>
        </div>
        
        <div class="glass-card p-4">
            <h5 class="fw-bold mb-3"><i class="bi bi-chat-dots me-2 text-primary"></i>ÎùºÏù¥Î∏å Ï±ÑÌåÖ</h5>
            <div class="chat-container" id="chatMessages" style="height: 300px; overflow-y: auto;">
                {% for msg in messages %}
                <div class="chat-message mb-2 {% if msg.user.role == 'instructor' %}instructor-msg{% endif %}" id="msg-{{ msg.id }}" data-user-id="{{ msg.user_id }}" data-msg-id="{{ msg.id }}">
                    <div class="d-flex align-items-start gap-2">
                        <div class="avatar-sm">{{ msg.user.username[0]|upper }}</div>
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center gap-2">
                                <strong class="small chat-username" onclick="mentionUser('{{ msg.user.username }}')">{{ msg.user.username }}</strong>
                                {% if msg.user.role == 'instructor' %}
                                <span class="badge bg-primary bg-opacity-10 text-primary" style="font-size: 10px;">Í∞ïÏÇ¨</span>
                                {% endif %}
                                <small class="text-muted">{{ msg.created_at.strftime('%H:%M') }}</small>
                                <div class="chat-actions ms-auto">
                                    <button class="btn btn-link btn-sm p-0 text-muted" onclick="mentionUser('{{ msg.user.username }}')" title="Ïñ∏Í∏â"><i class="bi bi-at"></i></button>
                                    {% if msg.user_id == current_user.id or current_user.is_instructor() %}
                                    <button class="btn btn-link btn-sm p-0 text-muted" onclick="editMessage({{ msg.id }}, '{{ msg.message|e }}')" title="ÏàòÏ†ï"><i class="bi bi-pencil"></i></button>
                                    <button class="btn btn-link btn-sm p-0 text-danger" onclick="deleteMessage({{ msg.id }})" title="ÏÇ≠Ï†ú"><i class="bi bi-trash"></i></button>
                                    {% endif %}
                                </div>
                            </div>
                            <p class="mb-0 small msg-content">{{ msg.message }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="mt-3">
                <div class="mentions-dropdown d-none" id="mentionsDropdown">
                    {% for student in students %}
                    <div class="mention-item" onclick="insertMention('{{ student.username }}')">@{{ student.username }}</div>
                    {% endfor %}
                </div>
                <div class="input-group">
                    <input type="text" class="form-control" id="chatInput" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî... (@Î°ú Ïñ∏Í∏â)" onkeypress="handleChatKeyPress(event)" oninput="handleChatInput(event)">
                    <button class="btn btn-outline-secondary" onclick="callAllStudents()" title="Ï†ÑÏ≤¥ Ìò∏Ï∂ú">
                        <i class="bi bi-megaphone"></i>
                    </button>
                    <button class="btn btn-primary" onclick="sendChatMessage()">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.checkpoint-item-instructor {
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(255,255,255,0.5);
    border: 2px solid transparent;
}
.checkpoint-item-instructor:hover {
    background: rgba(102, 126, 234, 0.1);
    border-color: rgba(102, 126, 234, 0.3);
}
.checkpoint-item-instructor.current {
    background: rgba(102, 126, 234, 0.15);
    border-color: var(--primary-color);
}
.checkpoint-item-instructor.completed {
    background: linear-gradient(135deg, rgba(40, 167, 69, 0.15), rgba(32, 201, 151, 0.15));
    border-color: #28a745;
}
.checkpoint-item-instructor.completed .checkpoint-number {
    background: linear-gradient(135deg, #28a745, #20c997) !important;
    color: white !important;
}
.checkpoint-number {
    background: rgba(102, 126, 234, 0.1);
    color: var(--primary-color);
    transition: all 0.3s ease;
}
.pulse-animation {
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.6; }
    100% { opacity: 1; }
}
.avatar-sm {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
}
.chat-message {
    padding: 8px 12px;
    background: rgba(255,255,255,0.5);
    border-radius: 12px;
}
.chat-message.instructor-msg {
    background: rgba(102, 126, 234, 0.1);
}
.timer-controls .btn {
    padding: 2px 6px;
    font-size: 12px;
}
.chat-username {
    cursor: pointer;
}
.chat-username:hover {
    text-decoration: underline;
}
.chat-actions {
    opacity: 0;
    transition: opacity 0.2s;
}
.chat-message:hover .chat-actions {
    opacity: 1;
}
.chat-actions .btn {
    font-size: 10px;
    margin-left: 4px;
}
.mentions-dropdown {
    position: absolute;
    bottom: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 8px;
    max-height: 150px;
    overflow-y: auto;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
    z-index: 100;
}
.mention-item {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 14px;
}
.mention-item:hover {
    background: rgba(102, 126, 234, 0.1);
}
.mention-highlight {
    background: rgba(102, 126, 234, 0.2);
    color: var(--primary-color);
    padding: 1px 4px;
    border-radius: 4px;
    font-weight: 500;
}
.system-message {
    background: rgba(255, 193, 7, 0.1) !important;
    border-left: 3px solid #ffc107;
}
.chat-message.deleted {
    opacity: 0.5;
    text-decoration: line-through;
}
</style>

{% endblock %}

{% block scripts %}
<script>
const courseId = {{ course.id }};
const checkpoints = {{ checkpoints|map(attribute='id')|list|tojson }};
const checkpointEstimates = {{ checkpoints|map(attribute='estimated_minutes')|list|tojson }};
const studentIds = {{ students|map(attribute='id')|list|tojson }};
const totalCheckpoints = {{ checkpoints|length }};
const totalStudents = {{ students|length }};
const sessionStartTime = new Date('{{ session.started_at.isoformat() }}');
let currentCheckpointId = {{ session.current_checkpoint_id or 'null' }};

let studentProgress = {};
studentIds.forEach(id => {
    studentProgress[id] = {};
    checkpoints.forEach(cpId => {
        studentProgress[id][cpId] = false;
    });
});

let completedCheckpoints = new Set();
let checkpointTimers = {};

checkpoints.forEach(cpId => {
    checkpointTimers[cpId] = {
        elapsedSeconds: 0,
        isRunning: false,
        intervalId: null
    };
});

function updateClock() {
    const now = new Date();
    document.getElementById('currentTime').textContent = now.toLocaleTimeString('ko-KR');
}
setInterval(updateClock, 1000);
updateClock();

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
}

function updateTimerDisplay(cpId) {
    const timer = checkpointTimers[cpId];
    const display = document.getElementById(`actual-time-${cpId}`);
    if (display) {
        display.innerHTML = `<i class="bi bi-stopwatch me-1"></i>Ïã§Ï†ú ${formatTime(timer.elapsedSeconds)}`;
    }
}

function startTimer(cpId) {
    const timer = checkpointTimers[cpId];
    if (timer.isRunning) return;
    
    timer.isRunning = true;
    timer.intervalId = setInterval(() => {
        timer.elapsedSeconds++;
        updateTimerDisplay(cpId);
    }, 1000);
    
    const timerEl = document.getElementById(`timer-${cpId}`);
    timerEl.querySelector('.timer-start').classList.add('d-none');
    timerEl.querySelector('.timer-pause').classList.remove('d-none');
    timerEl.querySelector('.timer-stop').classList.remove('d-none');
    timerEl.querySelector('.timer-resume').classList.add('d-none');
    
    socket.emit('checkpoint_timer_action', { 
        course_id: courseId, 
        checkpoint_id: cpId, 
        action: 'start',
        elapsed_seconds: timer.elapsedSeconds
    });
}

function pauseTimer(cpId) {
    const timer = checkpointTimers[cpId];
    if (!timer.isRunning) return;
    
    timer.isRunning = false;
    clearInterval(timer.intervalId);
    timer.intervalId = null;
    
    const timerEl = document.getElementById(`timer-${cpId}`);
    timerEl.querySelector('.timer-pause').classList.add('d-none');
    timerEl.querySelector('.timer-resume').classList.remove('d-none');
    
    socket.emit('checkpoint_timer_action', { 
        course_id: courseId, 
        checkpoint_id: cpId, 
        action: 'pause',
        elapsed_seconds: timer.elapsedSeconds
    });
}

function resumeTimer(cpId) {
    const timer = checkpointTimers[cpId];
    if (timer.isRunning) return;
    
    timer.isRunning = true;
    timer.intervalId = setInterval(() => {
        timer.elapsedSeconds++;
        updateTimerDisplay(cpId);
    }, 1000);
    
    const timerEl = document.getElementById(`timer-${cpId}`);
    timerEl.querySelector('.timer-start').classList.add('d-none');
    timerEl.querySelector('.timer-pause').classList.remove('d-none');
    timerEl.querySelector('.timer-stop').classList.remove('d-none');
    timerEl.querySelector('.timer-resume').classList.add('d-none');
    
    socket.emit('checkpoint_timer_action', { 
        course_id: courseId, 
        checkpoint_id: cpId, 
        action: 'resume',
        elapsed_seconds: timer.elapsedSeconds
    });
}

function stopTimer(cpId) {
    const timer = checkpointTimers[cpId];
    timer.isRunning = false;
    if (timer.intervalId) {
        clearInterval(timer.intervalId);
        timer.intervalId = null;
    }
    
    const timerEl = document.getElementById(`timer-${cpId}`);
    timerEl.querySelector('.timer-start').classList.remove('d-none');
    timerEl.querySelector('.timer-pause').classList.add('d-none');
    timerEl.querySelector('.timer-resume').classList.add('d-none');
    timerEl.querySelector('.timer-stop').classList.add('d-none');
    
    socket.emit('checkpoint_timer_action', { 
        course_id: courseId, 
        checkpoint_id: cpId, 
        action: 'stop',
        elapsed_seconds: timer.elapsedSeconds
    });
}

function toggleCheckpointComplete(cpId) {
    const item = document.getElementById(`checkpoint-${cpId}`);
    const completeIndicator = document.getElementById(`complete-${cpId}`);
    const currentIndicator = document.getElementById(`current-${cpId}`);
    
    if (completedCheckpoints.has(cpId)) {
        completedCheckpoints.delete(cpId);
        item.classList.remove('completed');
        completeIndicator.classList.add('d-none');
    } else {
        completedCheckpoints.add(cpId);
        item.classList.add('completed');
        item.classList.remove('current');
        completeIndicator.classList.remove('d-none');
        currentIndicator.classList.add('d-none');
        
        stopTimer(cpId);
    }
    
    updateOverallProgress();
    
    socket.emit('instructor_checkpoint_complete', { 
        course_id: courseId, 
        checkpoint_id: cpId, 
        completed: completedCheckpoints.has(cpId),
        elapsed_seconds: checkpointTimers[cpId].elapsedSeconds
    });
}

function updateOverallProgress() {
    const completed = completedCheckpoints.size;
    const percent = totalCheckpoints > 0 ? Math.round((completed / totalCheckpoints) * 100) : 0;
    
    document.getElementById('overallProgressPercent').textContent = `${percent}%`;
    document.getElementById('overallProgressBar').style.width = `${percent}%`;
    document.getElementById('completedCheckpointsText').textContent = `ÏôÑÎ£å: ${completed} / ${totalCheckpoints}`;
    document.getElementById('remainingCheckpointsText').textContent = `ÎÇ®ÏùÄ Ï≤¥ÌÅ¨Ìè¨Ïù∏Ìä∏: ${totalCheckpoints - completed}Í∞ú`;
}

if (currentCheckpointId) {
    document.getElementById(`checkpoint-${currentCheckpointId}`).classList.add('current');
    document.getElementById(`current-${currentCheckpointId}`).classList.remove('d-none');
}

const socket = io();

socket.on('connect', function() {
    document.getElementById('connectionStatus').innerHTML = '<i class="bi bi-circle-fill me-1"></i>Ïó∞Í≤∞Îê®';
    document.getElementById('connectionStatus').className = 'badge connection-badge bg-success';
    socket.emit('join_course', { course_id: courseId, mode: 'live' });
});

socket.on('disconnect', function() {
    document.getElementById('connectionStatus').innerHTML = '<i class="bi bi-circle-fill me-1"></i>Ïó∞Í≤∞ ÎÅäÍπÄ';
    document.getElementById('connectionStatus').className = 'badge connection-badge bg-danger';
});

socket.on('progress_update', function(data) {
    const { user_id, checkpoint_id, status } = data;
    if (status === 'completed') {
        studentProgress[user_id][checkpoint_id] = true;
        updateStudentDisplay(user_id);
        updateCell(user_id, checkpoint_id, true);
    }
});

socket.on('session_stats', function(data) {
    const { completion_rates } = data;
    for (const cpId in completion_rates) {
        const stats = completion_rates[cpId];
        const badge = document.getElementById(`cp-${cpId}-badge`);
        if (badge) {
            badge.innerHTML = `<i class="bi bi-people me-1"></i>${stats.completed}/${stats.total}`;
        }
    }
    updateChart(completion_rates);
});

socket.on('new_chat_message', function(data) {
    appendChatMessage(data);
});

socket.on('understanding_updated', function(data) {
    const { checkpoint_id, understood, confused } = data;
    const understoodEl = document.querySelector(`#understood-${checkpoint_id} span`);
    const confusedEl = document.querySelector(`#confused-${checkpoint_id} span`);
    if (understoodEl) understoodEl.textContent = understood;
    if (confusedEl) confusedEl.textContent = confused;
});

socket.on('timer_sync', function(data) {
    const { checkpoint_id, elapsed_seconds, is_running } = data;
    const timer = checkpointTimers[checkpoint_id];
    timer.elapsedSeconds = elapsed_seconds;
    updateTimerDisplay(checkpoint_id);
});

function setCurrentCheckpoint(checkpointId) {
    if (completedCheckpoints.has(checkpointId)) return;
    
    checkpoints.forEach(cpId => {
        if (!completedCheckpoints.has(cpId)) {
            document.getElementById(`checkpoint-${cpId}`).classList.remove('current');
            document.getElementById(`current-${cpId}`).classList.add('d-none');
        }
    });
    
    document.getElementById(`checkpoint-${checkpointId}`).classList.add('current');
    document.getElementById(`current-${checkpointId}`).classList.remove('d-none');
    currentCheckpointId = checkpointId;
    
    socket.emit('set_current_checkpoint', { course_id: courseId, checkpoint_id: checkpointId });
}

function appendChatMessage(data) {
    const container = document.getElementById('chatMessages');
    const isInstructor = data.role === 'instructor';
    const formattedMessage = formatMentions(data.message);
    const html = `
        <div class="chat-message mb-2 ${isInstructor ? 'instructor-msg' : ''}" id="msg-${data.id}" data-user-id="${data.user_id}" data-msg-id="${data.id}">
            <div class="d-flex align-items-start gap-2">
                <div class="avatar-sm">${data.username[0].toUpperCase()}</div>
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2">
                        <strong class="small chat-username" onclick="mentionUser('${data.username}')">${data.username}</strong>
                        ${isInstructor ? '<span class="badge bg-primary bg-opacity-10 text-primary" style="font-size: 10px;">Í∞ïÏÇ¨</span>' : ''}
                        <small class="text-muted">${data.created_at}</small>
                        <div class="chat-actions ms-auto">
                            <button class="btn btn-link btn-sm p-0 text-muted" onclick="mentionUser('${data.username}')" title="Ïñ∏Í∏â"><i class="bi bi-at"></i></button>
                            <button class="btn btn-link btn-sm p-0 text-muted" onclick="editMessage(${data.id}, '${data.message.replace(/'/g, "\\'")}')" title="ÏàòÏ†ï"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-link btn-sm p-0 text-danger" onclick="deleteMessage(${data.id})" title="ÏÇ≠Ï†ú"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                    <p class="mb-0 small msg-content">${formattedMessage}</p>
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
    container.scrollTop = container.scrollHeight;
}

function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (message) {
        socket.emit('send_chat_message', { course_id: courseId, message: message });
        input.value = '';
    }
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendChatMessage();
    }
}

function updateStudentDisplay(userId) {
    const completed = Object.values(studentProgress[userId]).filter(v => v).length;
    const percent = (completed / totalCheckpoints) * 100;
    
    const progressBar = document.getElementById(`student-${userId}-progress`);
    const text = document.getElementById(`student-${userId}-text`);
    const card = document.getElementById(`student-${userId}`);
    
    if (progressBar) progressBar.style.width = `${percent}%`;
    if (text) text.textContent = `${completed}/${totalCheckpoints}`;
    if (card && percent === 100) card.classList.add('completed');
}

function updateCell(userId, checkpointId, completed) {
    const cell = document.getElementById(`cell-${userId}-${checkpointId}`);
    if (cell) {
        cell.innerHTML = completed 
            ? '<i class="bi bi-check-circle-fill text-success"></i>'
            : '<i class="bi bi-circle text-muted"></i>';
    }
}

function setView(view) {
    if (view === 'grid') {
        document.getElementById('gridView').classList.remove('d-none');
        document.getElementById('listView').classList.add('d-none');
        document.getElementById('gridViewBtn').classList.add('active');
        document.getElementById('listViewBtn').classList.remove('active');
    } else {
        document.getElementById('gridView').classList.add('d-none');
        document.getElementById('listView').classList.remove('d-none');
        document.getElementById('gridViewBtn').classList.remove('active');
        document.getElementById('listViewBtn').classList.add('active');
    }
}

let progressChart;
function updateChart(completionRates) {
    const labels = [];
    const data = [];
    
    checkpoints.forEach((cpId, index) => {
        labels.push(`${index + 1}`);
        const stats = completionRates[cpId];
        data.push(stats ? (stats.completed / stats.total * 100).toFixed(1) : 0);
    });
    
    if (progressChart) {
        progressChart.data.datasets[0].data = data;
        progressChart.update();
    } else {
        const ctx = document.getElementById('progressChart').getContext('2d');
        progressChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ÏôÑÎ£åÏú® %',
                    data: data,
                    backgroundColor: 'rgba(102, 126, 234, 0.7)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 1,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, max: 100 } }
            }
        });
    }
}

setInterval(function() {
    socket.emit('request_stats', { course_id: courseId, mode: 'live' });
}, 3000);

const studentUsernames = {{ students|map(attribute='username')|list|tojson }};
let editingMessageId = null;

function mentionUser(username) {
    const input = document.getElementById('chatInput');
    input.value = `@${username} ` + input.value;
    input.focus();
}

function insertMention(username) {
    const input = document.getElementById('chatInput');
    const cursorPos = input.selectionStart;
    const textBefore = input.value.substring(0, cursorPos);
    const textAfter = input.value.substring(cursorPos);
    const lastAtIndex = textBefore.lastIndexOf('@');
    
    if (lastAtIndex !== -1) {
        input.value = textBefore.substring(0, lastAtIndex) + `@${username} ` + textAfter;
    } else {
        input.value = `@${username} ` + input.value;
    }
    
    document.getElementById('mentionsDropdown').classList.add('d-none');
    input.focus();
}

function handleChatInput(event) {
    const input = event.target;
    const value = input.value;
    const cursorPos = input.selectionStart;
    const textBeforeCursor = value.substring(0, cursorPos);
    const lastAtIndex = textBeforeCursor.lastIndexOf('@');
    
    if (lastAtIndex !== -1 && lastAtIndex === textBeforeCursor.length - 1) {
        document.getElementById('mentionsDropdown').classList.remove('d-none');
    } else if (lastAtIndex !== -1) {
        const searchTerm = textBeforeCursor.substring(lastAtIndex + 1).toLowerCase();
        const dropdown = document.getElementById('mentionsDropdown');
        const items = dropdown.querySelectorAll('.mention-item');
        let hasVisible = false;
        
        items.forEach(item => {
            const username = item.textContent.substring(1).toLowerCase();
            if (username.includes(searchTerm)) {
                item.style.display = 'block';
                hasVisible = true;
            } else {
                item.style.display = 'none';
            }
        });
        
        if (hasVisible && searchTerm.length > 0) {
            dropdown.classList.remove('d-none');
        } else {
            dropdown.classList.add('d-none');
        }
    } else {
        document.getElementById('mentionsDropdown').classList.add('d-none');
    }
}

function editMessage(msgId, currentText) {
    const newText = prompt('Î©îÏãúÏßÄ ÏàòÏ†ï:', currentText);
    if (newText && newText.trim() !== currentText) {
        socket.emit('edit_chat_message', { 
            course_id: courseId, 
            message_id: msgId, 
            new_message: newText.trim() 
        });
    }
}

function deleteMessage(msgId) {
    if (confirm('Ïù¥ Î©îÏãúÏßÄÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        socket.emit('delete_chat_message', { 
            course_id: courseId, 
            message_id: msgId 
        });
    }
}

function callAllStudents() {
    const mentions = studentUsernames.map(u => `@${u}`).join(' ');
    socket.emit('send_chat_message', { 
        course_id: courseId, 
        message: `üì¢ Ï†ÑÏ≤¥ Ìò∏Ï∂ú: ${mentions} - Ï£ºÎ™©Ìï¥ Ï£ºÏÑ∏Ïöî!` 
    });
}

socket.on('chat_message_edited', function(data) {
    const msgEl = document.getElementById(`msg-${data.message_id}`);
    if (msgEl) {
        const contentEl = msgEl.querySelector('.msg-content');
        if (contentEl) {
            contentEl.innerHTML = formatMentions(data.new_message) + ' <small class="text-muted">(ÏàòÏ†ïÎê®)</small>';
        }
    }
});

socket.on('chat_message_deleted', function(data) {
    const msgEl = document.getElementById(`msg-${data.message_id}`);
    if (msgEl) {
        msgEl.classList.add('deleted');
        const contentEl = msgEl.querySelector('.msg-content');
        if (contentEl) {
            contentEl.textContent = 'ÏÇ≠Ï†úÎêú Î©îÏãúÏßÄÏûÖÎãàÎã§';
        }
        const actionsEl = msgEl.querySelector('.chat-actions');
        if (actionsEl) actionsEl.remove();
    }
});

function formatMentions(text) {
    return text.replace(/@(\w+)/g, '<span class="mention-highlight">@$1</span>');
}

document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
</script>
{% endblock %}
