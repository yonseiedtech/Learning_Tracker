{% extends "base.html" %}

{% block title %}ë¼ì´ë¸Œ ì„¸ì…˜ - {{ course.title }}{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">ëŒ€ì‹œë³´ë“œ</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('courses.view', course_id=course.id) }}">{{ course.title }}</a></li>
        <li class="breadcrumb-item active">ë¼ì´ë¸Œ ì„¸ì…˜</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <div>
        <h2 class="fw-bold mb-1"><i class="bi bi-broadcast text-success me-2"></i>ë¼ì´ë¸Œ ì„¸ì…˜</h2>
        <p class="text-muted mb-0">{{ course.title }} - ì‹¤ì‹œê°„ ì§„ë„ ì¶”ì </p>
    </div>
    <div class="d-flex gap-2 align-items-center flex-wrap">
        <div class="glass-card px-3 py-2 d-flex align-items-center gap-2">
            <i class="bi bi-clock text-primary"></i>
            <span id="currentTime">--:--:--</span>
        </div>
        <span class="badge connection-badge bg-success" id="connectionStatus">
            <i class="bi bi-circle-fill me-1"></i>ì—°ê²°ë¨
        </span>
        <div class="glass-card px-3 py-2">
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">ë¼ì´ë¸Œ ìƒíƒœ:</span>
                <span class="badge fs-6" id="liveStatusBadge" 
                      data-status="{{ session.live_status }}"
                      style="background: {% if session.live_status == 'live' %}#dc3545{% elif session.live_status == 'preparing' %}#ffc107{% else %}#6c757d{% endif %}; color: {% if session.live_status == 'preparing' %}#212529{% else %}white{% endif %}">
                    {% if session.live_status == 'live' %}
                    <i class="bi bi-broadcast-pin me-1"></i>ë¼ì´ë¸Œ ì¤‘
                    {% elif session.live_status == 'preparing' %}
                    <i class="bi bi-hourglass-split me-1"></i>ì¤€ë¹„ì¤‘
                    {% else %}
                    <i class="bi bi-stop-circle me-1"></i>ì¢…ë£Œ
                    {% endif %}
                </span>
            </div>
        </div>
        <div class="btn-group" role="group" aria-label="ë¼ì´ë¸Œ ìƒíƒœ ì œì–´">
            <button type="button" class="btn btn-sm btn-outline-warning" onclick="setLiveStatus('preparing')" title="ì¤€ë¹„ì¤‘">
                <i class="bi bi-hourglass-split"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="setLiveStatus('live')" title="ë¼ì´ë¸Œ ì‹œì‘">
                <i class="bi bi-broadcast-pin"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setLiveStatus('ended')" title="ë¼ì´ë¸Œ ì¢…ë£Œ">
                <i class="bi bi-stop-circle"></i>
            </button>
        </div>
    </div>
</div>

<div class="glass-card p-4 mb-4" id="slideSection">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold mb-0"><i class="bi bi-easel me-2 text-info"></i>ìŠ¬ë¼ì´ë“œ ë°©ì†¡</h5>
        <div class="d-flex gap-2 flex-wrap">
            {% if active_deck %}
            <button class="btn btn-info btn-sm rounded-pill" id="toggleSlidePresenter" onclick="toggleSlidePresenter()">
                <i class="bi bi-eye me-1"></i>ìŠ¬ë¼ì´ë“œ í‘œì‹œ
            </button>
            <a href="{{ url_for('slides.presenter_view', deck_id=active_deck.id) }}" class="btn btn-outline-primary btn-sm rounded-pill" target="_blank">
                <i class="bi bi-arrows-fullscreen me-1"></i>ì „ì²´í™”ë©´
            </a>
            <a href="{{ url_for('slides.review_view', deck_id=active_deck.id) }}" class="btn btn-outline-secondary btn-sm rounded-pill" target="_blank">
                <i class="bi bi-journal-text me-1"></i>ë¦¬ë·°
            </a>
            {% endif %}
            <button class="btn btn-outline-info btn-sm rounded-pill" data-bs-toggle="collapse" data-bs-target="#pptUploadSection">
                <i class="bi bi-upload me-1"></i>íŒŒì¼ ì—…ë¡œë“œ
            </button>
        </div>
    </div>
    
    <div class="collapse {% if not active_deck %}show{% endif %}" id="pptUploadSection">
        <div class="p-3 rounded-3 mb-3" style="background: rgba(13, 27, 62, 0.05);">
            <form id="pptUploadForm" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="d-flex align-items-center gap-3 flex-wrap">
                    <div class="flex-grow-1">
                        <input type="file" class="form-control" id="pptxFile" name="pptx_file" accept=".pptx,.ppt,.pdf">
                        <div class="form-text">PPT/PPTX/PDF íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ìŠ¬ë¼ì´ë“œ ì´ë¯¸ì§€ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.</div>
                    </div>
                    <button type="submit" class="btn btn-info rounded-pill" id="pptUploadBtn">
                        <i class="bi bi-cloud-upload me-1"></i>ë³€í™˜ ì‹œì‘
                    </button>
                </div>
            </form>
            <div class="progress mt-2 d-none" id="pptConvertProgress" style="height: 6px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width: 100%"></div>
            </div>
        </div>
    </div>

    {% if active_deck %}
    <div id="inlinePresenter" class="d-none">
        <div class="lecture-timer-bar mb-2 p-2 rounded-3 d-flex align-items-center gap-3 flex-wrap" style="background: rgba(59,130,246,0.06); border: 1px solid rgba(59,130,246,0.15);">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-stopwatch text-primary"></i>
                <span class="fw-bold small" id="lectureElapsed">00:00:00</span>
                <span class="text-muted small">/</span>
                <span class="small text-muted" id="lectureTotalTime">--:--</span>
            </div>
            <div class="flex-grow-1" style="max-width: 300px;">
                <div class="d-flex align-items-center gap-2">
                    <div class="flex-grow-1 position-relative" style="height: 16px; background: var(--app-input-bg, #e9ecef); border-radius: 8px; overflow: hidden;">
                        <div id="lectureProgressFill" style="height: 100%; width: 0%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 8px; transition: width 0.5s;"></div>
                        <div id="lectureProgressMarker" style="position: absolute; top: 0; width: 3px; height: 100%; background: #fff; border-radius: 1px; box-shadow: 0 0 4px rgba(0,0,0,0.4); left: 0%; transition: left 0.5s;"></div>
                    </div>
                    <span class="fw-bold small text-primary" id="lectureProgressPct">0%</span>
                </div>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span class="small text-muted"><i class="bi bi-flag me-1"></i>ìŠ¬ë¼ì´ë“œ <span id="slideTimeDisplay">00:00</span></span>
                <span class="badge bg-opacity-10 small" id="slideTimePace" style="display: none;">
                    <i class="bi bi-speedometer2 me-1"></i><span id="slideTimePaceText"></span>
                </span>
            </div>
            <div class="d-flex align-items-center gap-2 ms-auto">
                <span class="small text-muted"><i class="bi bi-clock-history me-1"></i>ì˜ˆìƒ ì¢…ë£Œ:</span>
                <span class="fw-bold small" id="estimatedEndTime">--:--</span>
            </div>
        </div>

        <div class="engagement-alert-bar d-none mb-2 p-2 rounded-3 d-flex align-items-center gap-2" id="engagementAlert">
            <i class="bi bi-lightbulb fs-5" id="engagementAlertIcon"></i>
            <div class="flex-grow-1">
                <strong class="small" id="engagementAlertTitle"></strong>
                <span class="small ms-2" id="engagementAlertMsg"></span>
            </div>
            <button class="btn btn-sm btn-outline-light rounded-pill" onclick="dismissEngagementAlert()" style="font-size: 0.7rem;">
                <i class="bi bi-x"></i>
            </button>
        </div>

        <div class="d-flex gap-3" style="height: 420px;">
            <div class="slide-thumb-sidebar" id="slideThumbSidebar">
                <div class="slide-search-box mb-2">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text" style="border:none; background: transparent; padding: 2px 6px;"><i class="bi bi-search" style="font-size:0.75rem;"></i></span>
                        <input type="text" class="form-control form-control-sm" id="slideSearchInput" placeholder="ìŠ¬ë¼ì´ë“œ ê²€ìƒ‰..." oninput="filterSlides(this.value)" style="font-size:0.75rem; padding: 2px 6px; border-radius: 4px;">
                    </div>
                </div>
                {% for url in active_slides %}
                <div class="inline-slide-thumb {% if loop.index0 == 0 %}active{% endif %} {% if loop.index0 in active_bookmarks %}flagged{% endif %}"
                     data-index="{{ loop.index0 }}" onclick="goToSlide({{ loop.index0 }})" title="ìŠ¬ë¼ì´ë“œ {{ loop.index }}">
                    <img src="{{ url }}" alt="{{ loop.index }}">
                    <span class="thumb-num">{{ loop.index }}</span>
                    <span class="thumb-flag {% if loop.index0 not in active_bookmarks %}d-none{% endif %}" id="thumbFlag{{ loop.index0 }}">ğŸ”–</span>
                    <span class="thumb-time d-none" id="thumbTime{{ loop.index0 }}"></span>
                </div>
                {% endfor %}
            </div>
            <div class="flex-grow-1 d-flex flex-column min-width-0">
                <div class="inline-slide-main">
                    <img src="{{ active_slides[0] if active_slides else '' }}" id="inlineSlideImage" alt="í˜„ì¬ ìŠ¬ë¼ì´ë“œ">
                </div>
                <div class="slide-jumpbar mt-1" id="slideJumpBar">
                    {% for url in active_slides %}
                    <div class="jumpbar-segment {% if loop.index0 == 0 %}active{% endif %}" data-index="{{ loop.index0 }}" onclick="goToSlide({{ loop.index0 }})" title="ìŠ¬ë¼ì´ë“œ {{ loop.index }}">
                        <div class="jumpbar-fill" id="jumpFill{{ loop.index0 }}"></div>
                    </div>
                    {% endfor %}
                </div>
                <div class="inline-slide-controls mt-2">
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-sm btn-outline-primary rounded-pill" id="prevSlideBtn" onclick="prevSlide()">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <span class="fw-bold small" id="slideCounter">1 / {{ active_slides|length }}</span>
                        <button class="btn btn-sm btn-outline-primary rounded-pill" id="nextSlideBtn" onclick="nextSlide()">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>

                    <div class="engagement-dashboard flex-grow-1">
                        <div class="d-flex align-items-center gap-3">
                            <div class="reaction-donut-container" id="reactionDonut">
                                <canvas id="reactionDonutChart" width="60" height="60"></canvas>
                                <span class="donut-center-text" id="donutCenterText">0</span>
                            </div>
                            <div class="reaction-bars-compact flex-grow-1">
                                <div class="d-flex align-items-center gap-1 mb-1">
                                    <span style="width: 20px; text-align: center; font-size: 0.8rem;">ğŸ‘</span>
                                    <div class="flex-grow-1" style="height: 10px; background: var(--app-input-bg, #e9ecef); border-radius: 5px; overflow: hidden;">
                                        <div id="barUnderstood" style="height: 100%; width: 0%; background: #22c55e; border-radius: 5px; transition: width 0.3s;"></div>
                                    </div>
                                    <span class="fw-bold" style="width: 28px; font-size: 0.7rem;" id="countUnderstood">0</span>
                                    <span class="text-muted" style="width: 32px; font-size: 0.65rem;" id="pctUnderstood">0%</span>
                                </div>
                                <div class="d-flex align-items-center gap-1 mb-1">
                                    <span style="width: 20px; text-align: center; font-size: 0.8rem;">â“</span>
                                    <div class="flex-grow-1" style="height: 10px; background: var(--app-input-bg, #e9ecef); border-radius: 5px; overflow: hidden;">
                                        <div id="barQuestion" style="height: 100%; width: 0%; background: #f59e0b; border-radius: 5px; transition: width 0.3s;"></div>
                                    </div>
                                    <span class="fw-bold" style="width: 28px; font-size: 0.7rem;" id="countQuestion">0</span>
                                    <span class="text-muted" style="width: 32px; font-size: 0.65rem;" id="pctQuestion">0%</span>
                                </div>
                                <div class="d-flex align-items-center gap-1">
                                    <span style="width: 20px; text-align: center; font-size: 0.8rem;">ğŸ˜µ</span>
                                    <div class="flex-grow-1" style="height: 10px; background: var(--app-input-bg, #e9ecef); border-radius: 5px; overflow: hidden;">
                                        <div id="barHard" style="height: 100%; width: 0%; background: #ef4444; border-radius: 5px; transition: width 0.3s;"></div>
                                    </div>
                                    <span class="fw-bold" style="width: 28px; font-size: 0.7rem;" id="countHard">0</span>
                                    <span class="text-muted" style="width: 32px; font-size: 0.65rem;" id="pctHard">0%</span>
                                </div>
                            </div>
                            <div class="trend-mini-charts position-relative" id="trendChartsContainer">
                                <canvas id="trendMiniChart" width="100" height="55"></canvas>
                                <div class="trend-tooltip d-none" id="trendTooltip"></div>
                            </div>
                        </div>
                        <div class="engagement-guide mt-1 d-none" id="engagementGuide">
                            <small class="text-muted"><i class="bi bi-info-circle me-1"></i><span id="engagementGuideText"></span></small>
                        </div>
                    </div>

                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-sm btn-outline-secondary rounded-pill" id="bookmarkToggle" onclick="toggleBookmark()">
                            <i class="bi bi-bookmark" id="bookmarkIcon"></i>
                        </button>
                        <span class="badge bg-info bg-opacity-10 text-info" id="participantBadge">
                            <i class="bi bi-people-fill me-1"></i><span id="participantCount">0</span>ëª…
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="slideDeckInfo" class="{% if not active_deck %}d-none{% endif %}">
        <div class="d-flex align-items-center gap-3 p-3 rounded-3" style="background: rgba(59, 130, 246, 0.08);">
            <i class="bi bi-file-earmark-slides fs-4 text-info"></i>
            <div class="flex-grow-1">
                <strong>{{ active_deck.file_name }}</strong>
                <br><small class="text-muted">{{ active_deck.slide_count }}ê°œ ìŠ¬ë¼ì´ë“œ | í˜„ì¬: <span id="currentSlideNum">{{ active_deck.current_slide_index + 1 }}</span>ë²ˆ ìŠ¬ë¼ì´ë“œ</small>
            </div>
            <span class="badge bg-success">ë³€í™˜ ì™„ë£Œ</span>
        </div>
    </div>
    {% endif %}
    
    {% if slide_decks %}
    <div class="mt-3">
        <small class="text-muted">ì—…ë¡œë“œëœ ìŠ¬ë¼ì´ë“œ ë± ëª©ë¡:</small>
        <div class="list-group list-group-flush mt-1">
            {% for deck in slide_decks %}
            <div class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent">
                <div>
                    <i class="bi bi-file-earmark-slides text-info me-2"></i>
                    {{ deck.file_name }} <small class="text-muted">({{ deck.slide_count }}ìŠ¬ë¼ì´ë“œ)</small>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('slides.presenter_view', deck_id=deck.id) }}" class="btn btn-sm btn-outline-primary" target="_blank" title="ì „ì²´í™”ë©´ í”„ë ˆì  í„°">
                        <i class="bi bi-arrows-fullscreen"></i>
                    </a>
                    <a href="{{ url_for('slides.review_view', deck_id=deck.id) }}" class="btn btn-sm btn-outline-secondary" target="_blank" title="ë¦¬ë·° í˜ì´ì§€">
                        <i class="bi bi-journal-text"></i>
                    </a>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteDeck({{ deck.id }})" title="ì‚­ì œ">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="glass-card p-4 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold mb-0"><i class="bi bi-flag-fill me-2 text-primary"></i>ì²´í¬í¬ì¸íŠ¸ ì§„í–‰</h5>
                <div class="d-flex gap-2 align-items-center">
                    <small class="text-muted">í´ë¦­: ì§„í–‰ì¤‘ | ë”ë¸”í´ë¦­: ì™„ë£Œ</small>
                </div>
            </div>
            
            <div class="overall-progress-container mb-4 p-3 rounded-3" style="background: rgba(13, 27, 62, 0.05);">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-bold text-primary"><i class="bi bi-graph-up-arrow me-2"></i>ì „ì²´ ìˆ˜ì—… ì§„í–‰ìœ¨</span>
                    <span class="badge bg-primary fs-6" id="overallProgressPercent">0%</span>
                </div>
                <div class="progress progress-modern" style="height: 12px;">
                    <div class="progress-bar bg-gradient-primary" role="progressbar" style="width: 0%" id="overallProgressBar"></div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted" id="completedCheckpointsText">ì™„ë£Œ: 0 / {{ checkpoints|length }}</small>
                    <small class="text-muted" id="remainingCheckpointsText">ë‚¨ì€ ì²´í¬í¬ì¸íŠ¸: {{ checkpoints|length }}ê°œ</small>
                </div>
            </div>
            
            <div class="checkpoint-list">
                {% for cp in checkpoints %}
                <div class="checkpoint-item-instructor p-3 mb-2 rounded-3" id="checkpoint-{{ cp.id }}" 
                     onclick="setCurrentCheckpoint({{ cp.id }})" 
                     ondblclick="toggleCheckpointComplete({{ cp.id }})">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="checkpoint-order me-3">
                                <span class="badge checkpoint-number fs-6 px-3 py-2" id="cp-num-{{ cp.id }}">{{ cp.order }}</span>
                            </div>
                            <div>
                                <strong>{{ cp.title }}</strong>
                                {% if cp.description %}
                                <p class="mb-0 small text-muted">{{ cp.description[:50] }}{{ '...' if cp.description|length > 50 else '' }}</p>
                                {% endif %}
                                <div class="d-flex gap-3 mt-1">
                                    {% if cp.estimated_minutes %}
                                    <small class="text-primary"><i class="bi bi-hourglass me-1"></i>ì˜ˆìƒ {{ cp.estimated_minutes }}ë¶„</small>
                                    {% endif %}
                                    <small class="text-success" id="actual-time-{{ cp.id }}"><i class="bi bi-stopwatch me-1"></i>ì‹¤ì œ 00:00</small>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="timer-controls btn-group btn-group-sm" id="timer-{{ cp.id }}">
                                <button class="btn btn-outline-success btn-sm timer-start" onclick="event.stopPropagation(); startTimer({{ cp.id }})" title="ì‹œì‘">
                                    <i class="bi bi-play-fill"></i>
                                </button>
                                <button class="btn btn-outline-warning btn-sm timer-pause d-none" onclick="event.stopPropagation(); pauseTimer({{ cp.id }})" title="ì¼ì‹œì¤‘ë‹¨">
                                    <i class="bi bi-pause-fill"></i>
                                </button>
                                <button class="btn btn-outline-primary btn-sm timer-resume d-none" onclick="event.stopPropagation(); resumeTimer({{ cp.id }})" title="ì¬ê°œ">
                                    <i class="bi bi-play-circle"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm timer-stop d-none" onclick="event.stopPropagation(); stopTimer({{ cp.id }})" title="ì¢…ë£Œ">
                                    <i class="bi bi-stop-fill"></i>
                                </button>
                            </div>
                            <div class="understanding-stats d-flex gap-2">
                                <span class="badge bg-success bg-opacity-10 text-success" id="understood-{{ cp.id }}">
                                    <i class="bi bi-emoji-smile me-1"></i><span>0</span>
                                </span>
                                <span class="badge bg-warning bg-opacity-10 text-warning" id="confused-{{ cp.id }}">
                                    <i class="bi bi-emoji-frown me-1"></i><span>0</span>
                                </span>
                            </div>
                            <div class="progress-badge">
                                <span class="badge bg-primary bg-opacity-10 text-primary" id="cp-{{ cp.id }}-badge">
                                    <i class="bi bi-people me-1"></i>0/{{ students|length }}
                                </span>
                            </div>
                            <div class="status-indicators">
                                <span class="badge bg-primary pulse-animation d-none" id="current-{{ cp.id }}"><i class="bi bi-play-circle-fill me-1"></i>ì§„í–‰ì¤‘</span>
                                <span class="badge bg-primary d-none" id="complete-{{ cp.id }}"><i class="bi bi-check-circle-fill me-1"></i>ì™„ë£Œ</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="glass-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold mb-0"><i class="bi bi-people me-2 text-primary"></i>í•™ìƒ ì§„ë„</h5>
                <div class="d-flex gap-2 align-items-center">
                    <span class="badge bg-primary bg-opacity-10 text-primary" id="studentCount">{{ students|length }}ëª…</span>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary active" id="gridViewBtn" onclick="setView('grid')">
                            <i class="bi bi-grid-3x3-gap"></i>
                        </button>
                        <button class="btn btn-outline-primary" id="listViewBtn" onclick="setView('list')">
                            <i class="bi bi-list"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="gridView" class="row g-3">
                {% for student in students %}
                <div class="col-6 col-md-4 col-lg-3">
                    <div class="student-card" id="student-{{ student.id }}">
                        <div class="avatar-lg mx-auto mb-2">{{ student.initial }}</div>
                        <h6 class="mb-2 small">{{ student.display_name }}</h6>
                        <div class="progress progress-modern mb-2" style="height: 6px;">
                            <div class="progress-bar bg-gradient-primary" style="width: 0%" id="student-{{ student.id }}-progress"></div>
                        </div>
                        <small class="text-muted" id="student-{{ student.id }}-text">0/{{ checkpoints|length }}</small>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div id="listView" class="d-none">
                <div class="table-responsive">
                    <table class="table table-modern table-sm">
                        <thead>
                            <tr>
                                <th>í•™ìƒ</th>
                                {% for cp in checkpoints %}
                                <th class="text-center" title="{{ cp.title }}">{{ cp.order }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            <tr id="student-row-{{ student.id }}">
                                <td>{{ student.display_name }}</td>
                                {% for cp in checkpoints %}
                                <td class="text-center" id="cell-{{ student.id }}-{{ cp.id }}">
                                    <i class="bi bi-circle text-muted"></i>
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="glass-card p-4 mb-4">
            <h5 class="fw-bold mb-3"><i class="bi bi-bar-chart me-2 text-primary"></i>ì™„ë£Œìœ¨</h5>
            <canvas id="progressChart" height="200"></canvas>
        </div>
        
        <div class="glass-card p-4">
            <h5 class="fw-bold mb-3"><i class="bi bi-chat-dots me-2 text-primary"></i>ë¼ì´ë¸Œ ì±„íŒ…</h5>
            <div class="chat-container" id="chatMessages" style="height: 300px; overflow-y: auto;">
                {% for msg in messages %}
                <div class="chat-message mb-2 {% if msg.user.role == 'instructor' %}instructor-msg{% endif %}" id="msg-{{ msg.id }}" data-user-id="{{ msg.user_id }}" data-msg-id="{{ msg.id }}">
                    <div class="d-flex align-items-start gap-2">
                        <div class="avatar-sm">{{ msg.user.initial }}</div>
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center gap-2">
                                <strong class="small chat-username" onclick="mentionUser('{{ msg.user.username }}')">{{ msg.user.display_name }}</strong>
                                {% if msg.user.role == 'instructor' %}
                                <span class="badge bg-primary bg-opacity-10 text-primary" style="font-size: 10px;">ê°•ì‚¬</span>
                                {% endif %}
                                <small class="text-muted">{{ msg.created_at.strftime('%H:%M') }}</small>
                                <div class="chat-actions ms-auto">
                                    <button class="btn btn-link btn-sm p-0 text-muted" onclick="mentionUser('{{ msg.user.display_name }}')" title="ì–¸ê¸‰"><i class="bi bi-at"></i></button>
                                    {% if msg.user_id == current_user.id or current_user.is_instructor() %}
                                    <button class="btn btn-link btn-sm p-0 text-muted" onclick="editMessage({{ msg.id }}, '{{ msg.message|e }}')" title="ìˆ˜ì •"><i class="bi bi-pencil"></i></button>
                                    <button class="btn btn-link btn-sm p-0 text-danger" onclick="deleteMessage({{ msg.id }})" title="ì‚­ì œ"><i class="bi bi-trash"></i></button>
                                    {% endif %}
                                </div>
                            </div>
                            <p class="mb-0 small msg-content">{{ msg.message }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="mt-3">
                <div class="mentions-dropdown d-none" id="mentionsDropdown">
                    {% for student in students %}
                    <div class="mention-item" onclick="insertMention('{{ student.display_name }}')">@{{ student.display_name }}</div>
                    {% endfor %}
                </div>
                <div class="input-group">
                    <input type="text" class="form-control" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (@ë¡œ ì–¸ê¸‰)" onkeypress="handleChatKeyPress(event)" oninput="handleChatInput(event)">
                    <button class="btn btn-outline-secondary" onclick="callAllStudents()" title="ì „ì²´ í˜¸ì¶œ">
                        <i class="bi bi-megaphone"></i>
                    </button>
                    <button class="btn btn-primary" onclick="sendChatMessage()">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="glass-card p-4 mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold mb-0"><i class="bi bi-clipboard-plus me-2 text-primary"></i>ë¼ì´ë¸Œ ê²Œì‹œíŒ</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="togglePostForm()">
                    <i class="bi bi-plus-lg me-1"></i>ê³µì§€ ì‘ì„±
                </button>
            </div>
            
            <div class="d-none mb-3" id="postFormContainer">
                <form action="{{ url_for('courses.create_session_post', course_id=course.id) }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-2">
                        <input type="text" class="form-control form-control-sm" name="title" placeholder="ì œëª©" required>
                    </div>
                    <div class="mb-2">
                        <textarea class="form-control form-control-sm" name="content" rows="2" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="pinned" id="pinnedCheck">
                            <label class="form-check-label small" for="pinnedCheck">ìƒë‹¨ ê³ ì •</label>
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="togglePostForm()">ì·¨ì†Œ</button>
                            <button type="submit" class="btn btn-sm btn-primary">ë“±ë¡</button>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="session-posts" id="sessionPosts" style="max-height: 250px; overflow-y: auto;">
                {% if session.posts %}
                {% for post in session.posts|sort(attribute='pinned', reverse=true) %}
                <div class="session-post p-2 mb-2 rounded {% if post.pinned %}bg-warning bg-opacity-10 border-start border-warning border-3{% else %}bg-light{% endif %}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong class="small">
                                {% if post.pinned %}<i class="bi bi-pin-fill text-warning me-1"></i>{% endif %}
                                {{ post.title }}
                            </strong>
                            <p class="mb-0 small text-muted">{{ post.content[:100] }}{% if post.content|length > 100 %}...{% endif %}</p>
                        </div>
                        <small class="text-muted">{{ post.created_at.strftime('%H:%M') }}</small>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center text-muted py-3">
                    <i class="bi bi-clipboard-x fs-4"></i>
                    <p class="small mb-0">ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.slide-thumb-sidebar {
    width: 160px;
    min-width: 160px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding-right: 8px;
}
.slide-search-box .input-group {
    background: var(--app-input-bg, #f8f9fa);
    border-radius: 6px;
    border: 1px solid var(--app-border, #dee2e6);
}
.slide-search-box .form-control { border: none; background: transparent; }
.slide-search-box .form-control:focus { box-shadow: none; }
.inline-slide-thumb {
    position: relative;
    cursor: pointer;
    border-radius: 6px;
    overflow: hidden;
    border: 2px solid transparent;
    transition: all 0.2s ease;
    flex-shrink: 0;
}
.inline-slide-thumb:hover { border-color: var(--primary-color, #3b82f6); }
.inline-slide-thumb.active { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.3); }
.inline-slide-thumb.flagged { border-color: #ef4444; }
.inline-slide-thumb.search-hidden { display: none; }
.inline-slide-thumb img { width: 100%; aspect-ratio: 16/9; object-fit: cover; display: block; }
.thumb-num {
    position: absolute; bottom: 2px; left: 2px;
    background: rgba(0,0,0,0.7); color: #fff; font-size: 0.65rem;
    padding: 0px 5px; border-radius: 3px;
}
.thumb-flag {
    position: absolute; top: 2px; right: 2px; font-size: 0.65rem;
}
.thumb-time {
    position: absolute; bottom: 2px; right: 2px;
    background: rgba(0,0,0,0.7); color: #fff; font-size: 0.55rem;
    padding: 0px 4px; border-radius: 3px;
}
.inline-slide-main {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--app-bg, #f0f2f5);
    border-radius: 10px;
    overflow: hidden;
    min-height: 0;
}
.inline-slide-main img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 8px;
}
.slide-jumpbar {
    display: flex;
    gap: 2px;
    height: 8px;
    border-radius: 4px;
    overflow: hidden;
}
.jumpbar-segment {
    flex: 1;
    background: var(--app-input-bg, #e0e3e8);
    cursor: pointer;
    position: relative;
    transition: all 0.2s;
    border-radius: 2px;
}
.jumpbar-segment:hover { background: rgba(59,130,246,0.3); transform: scaleY(1.5); }
.jumpbar-segment.active { background: #3b82f6; }
.jumpbar-segment.visited { background: rgba(59,130,246,0.5); }
.jumpbar-fill {
    position: absolute; bottom: 0; left: 0; right: 0;
    height: 0%; background: rgba(239,68,68,0.6); transition: height 0.3s;
}
.inline-slide-controls {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0;
    flex-wrap: wrap;
}
.engagement-dashboard { min-width: 280px; }
.reaction-donut-container {
    position: relative; width: 60px; height: 60px; flex-shrink: 0;
}
.donut-center-text {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    font-size: 0.75rem; font-weight: 700; color: var(--app-text, #333);
}
.reaction-bars-compact { min-width: 140px; }
.trend-mini-charts { flex-shrink: 0; }
.trend-tooltip {
    position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
    background: rgba(0,0,0,0.85); color: #fff; padding: 4px 8px;
    border-radius: 6px; font-size: 0.65rem; white-space: nowrap; z-index: 10;
}
.engagement-alert-bar {
    animation: slideDown 0.3s ease;
}
.engagement-alert-bar.alert-warning-custom {
    background: rgba(245,158,11,0.12) !important; border: 1px solid rgba(245,158,11,0.4) !important; color: #92400e;
}
.engagement-alert-bar.alert-danger-custom {
    background: rgba(239,68,68,0.12) !important; border: 1px solid rgba(239,68,68,0.4) !important; color: #991b1b;
}
.engagement-alert-bar.alert-success-custom {
    background: rgba(34,197,94,0.12) !important; border: 1px solid rgba(34,197,94,0.4) !important; color: #166534;
}
@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
.lecture-timer-bar .time-over { color: #ef4444 !important; animation: pulse 1.5s infinite; }
@media (max-width: 768px) {
    #inlinePresenter > .d-flex:last-child { flex-direction: column; height: auto !important; }
    .slide-thumb-sidebar {
        width: 100%; min-width: 100%; flex-direction: row;
        overflow-x: auto; overflow-y: hidden; height: 80px;
        padding-right: 0; padding-bottom: 4px;
    }
    .inline-slide-thumb { min-width: 100px; }
    .inline-slide-main { min-height: 250px; }
    .inline-slide-controls { flex-wrap: wrap; }
    .engagement-dashboard { min-width: 100%; width: 100%; }
    .lecture-timer-bar { font-size: 0.8rem; }
    .slide-jumpbar { height: 6px; }
}
.checkpoint-item-instructor {
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(255,255,255,0.5);
    border: 2px solid transparent;
}
.checkpoint-item-instructor:hover {
    background: rgba(13, 27, 62, 0.1);
    border-color: rgba(13, 27, 62, 0.3);
}
.checkpoint-item-instructor.current {
    background: rgba(13, 27, 62, 0.15);
    border-color: var(--primary-color);
}
.checkpoint-item-instructor.completed {
    background: linear-gradient(135deg, rgba(40, 167, 69, 0.15), rgba(32, 201, 151, 0.15));
    border-color: #28a745;
}
.checkpoint-item-instructor.completed .checkpoint-number {
    background: linear-gradient(135deg, #28a745, #20c997) !important;
    color: white !important;
}
.checkpoint-number {
    background: rgba(13, 27, 62, 0.1);
    color: var(--primary-color);
    transition: all 0.3s ease;
}
.pulse-animation {
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.6; }
    100% { opacity: 1; }
}
.avatar-sm {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
}
.chat-message {
    padding: 8px 12px;
    background: rgba(255,255,255,0.5);
    border-radius: 12px;
}
.chat-message.instructor-msg {
    background: rgba(13, 27, 62, 0.1);
}
.timer-controls .btn {
    padding: 2px 6px;
    font-size: 12px;
}
.chat-username {
    cursor: pointer;
}
.chat-username:hover {
    text-decoration: underline;
}
.chat-actions {
    opacity: 0;
    transition: opacity 0.2s;
}
.chat-message:hover .chat-actions {
    opacity: 1;
}
.chat-actions .btn {
    font-size: 10px;
    margin-left: 4px;
}
.mentions-dropdown {
    position: absolute;
    bottom: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 8px;
    max-height: 150px;
    overflow-y: auto;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
    z-index: 100;
}
.mention-item {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 14px;
}
.mention-item:hover {
    background: rgba(13, 27, 62, 0.1);
}
.mention-highlight {
    background: rgba(13, 27, 62, 0.2);
    color: var(--primary-color);
    padding: 1px 4px;
    border-radius: 4px;
    font-weight: 500;
}
.system-message {
    background: rgba(255, 193, 7, 0.1) !important;
    border-left: 3px solid #ffc107;
}
.chat-message.deleted {
    opacity: 0.5;
    text-decoration: line-through;
}
</style>

{% endblock %}

{% block scripts %}
<script>
function showToast(message, type) {
    const alertType = (type === 'success') ? 'success' : (type === 'warning') ? 'warning' : (type === 'danger') ? 'danger' : 'info';
    const icon = (type === 'success') ? 'check-circle' : (type === 'warning') ? 'exclamation-triangle' : (type === 'danger') ? 'exclamation-circle' : 'info-circle';
    const toastEl = document.createElement('div');
    toastEl.style.cssText = 'position:fixed;top:20px;right:20px;z-index:9999;animation:slideIn 0.3s ease';
    toastEl.innerHTML = '<div class="alert alert-' + alertType + ' d-flex align-items-center shadow-lg border-0" style="min-width:250px;"><i class="bi bi-' + icon + ' me-2"></i>' + message + '<button type="button" class="btn-close ms-auto" onclick="this.closest(\'div\').parentElement.remove()"></button></div>';
    document.body.appendChild(toastEl);
    setTimeout(() => { if (toastEl.parentElement) toastEl.remove(); }, 5000);
}
const courseId = {{ course.id }};
const checkpoints = {{ checkpoints|map(attribute='id')|list|tojson }};
const checkpointEstimates = {{ checkpoints|map(attribute='estimated_minutes')|list|tojson }};
const studentIds = {{ students|map(attribute='id')|list|tojson }};
const totalCheckpoints = {{ checkpoints|length }};
const totalStudents = {{ students|length }};
const sessionStartTime = new Date('{{ session.started_at.isoformat() }}Z');
let currentCheckpointId = {{ session.current_checkpoint_id or 'null' }};

let studentProgress = {};
studentIds.forEach(id => {
    studentProgress[id] = {};
    checkpoints.forEach(cpId => {
        studentProgress[id][cpId] = false;
    });
});

let completedCheckpoints = new Set();
let checkpointTimers = {};

checkpoints.forEach(cpId => {
    checkpointTimers[cpId] = {
        elapsedSeconds: 0,
        isRunning: false,
        intervalId: null
    };
});

function updateClock() {
    const now = new Date();
    document.getElementById('currentTime').textContent = now.toLocaleTimeString('ko-KR');
}
setInterval(updateClock, 1000);
updateClock();

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
}

function updateTimerDisplay(cpId) {
    const timer = checkpointTimers[cpId];
    const display = document.getElementById(`actual-time-${cpId}`);
    if (display) {
        display.innerHTML = `<i class="bi bi-stopwatch me-1"></i>ì‹¤ì œ ${formatTime(timer.elapsedSeconds)}`;
    }
}

function startTimer(cpId) {
    const timer = checkpointTimers[cpId];
    if (timer.isRunning) return;
    
    timer.isRunning = true;
    timer.intervalId = setInterval(() => {
        timer.elapsedSeconds++;
        updateTimerDisplay(cpId);
    }, 1000);
    
    const timerEl = document.getElementById(`timer-${cpId}`);
    timerEl.querySelector('.timer-start').classList.add('d-none');
    timerEl.querySelector('.timer-pause').classList.remove('d-none');
    timerEl.querySelector('.timer-stop').classList.remove('d-none');
    timerEl.querySelector('.timer-resume').classList.add('d-none');
    
    socket.emit('checkpoint_timer_action', { 
        course_id: courseId, 
        checkpoint_id: cpId, 
        action: 'start',
        elapsed_seconds: timer.elapsedSeconds
    });
}

function pauseTimer(cpId) {
    const timer = checkpointTimers[cpId];
    if (!timer.isRunning) return;
    
    timer.isRunning = false;
    clearInterval(timer.intervalId);
    timer.intervalId = null;
    
    const timerEl = document.getElementById(`timer-${cpId}`);
    timerEl.querySelector('.timer-pause').classList.add('d-none');
    timerEl.querySelector('.timer-resume').classList.remove('d-none');
    
    socket.emit('checkpoint_timer_action', { 
        course_id: courseId, 
        checkpoint_id: cpId, 
        action: 'pause',
        elapsed_seconds: timer.elapsedSeconds
    });
}

function resumeTimer(cpId) {
    const timer = checkpointTimers[cpId];
    if (timer.isRunning) return;
    
    timer.isRunning = true;
    timer.intervalId = setInterval(() => {
        timer.elapsedSeconds++;
        updateTimerDisplay(cpId);
    }, 1000);
    
    const timerEl = document.getElementById(`timer-${cpId}`);
    timerEl.querySelector('.timer-start').classList.add('d-none');
    timerEl.querySelector('.timer-pause').classList.remove('d-none');
    timerEl.querySelector('.timer-stop').classList.remove('d-none');
    timerEl.querySelector('.timer-resume').classList.add('d-none');
    
    socket.emit('checkpoint_timer_action', { 
        course_id: courseId, 
        checkpoint_id: cpId, 
        action: 'resume',
        elapsed_seconds: timer.elapsedSeconds
    });
}

function stopTimer(cpId) {
    const timer = checkpointTimers[cpId];
    timer.isRunning = false;
    if (timer.intervalId) {
        clearInterval(timer.intervalId);
        timer.intervalId = null;
    }
    
    const timerEl = document.getElementById(`timer-${cpId}`);
    timerEl.querySelector('.timer-start').classList.remove('d-none');
    timerEl.querySelector('.timer-pause').classList.add('d-none');
    timerEl.querySelector('.timer-resume').classList.add('d-none');
    timerEl.querySelector('.timer-stop').classList.add('d-none');
    
    socket.emit('checkpoint_timer_action', { 
        course_id: courseId, 
        checkpoint_id: cpId, 
        action: 'stop',
        elapsed_seconds: timer.elapsedSeconds
    });
}

function toggleCheckpointComplete(cpId) {
    const item = document.getElementById(`checkpoint-${cpId}`);
    const completeIndicator = document.getElementById(`complete-${cpId}`);
    const currentIndicator = document.getElementById(`current-${cpId}`);
    
    if (completedCheckpoints.has(cpId)) {
        completedCheckpoints.delete(cpId);
        item.classList.remove('completed');
        completeIndicator.classList.add('d-none');
    } else {
        completedCheckpoints.add(cpId);
        item.classList.add('completed');
        item.classList.remove('current');
        completeIndicator.classList.remove('d-none');
        currentIndicator.classList.add('d-none');
        
        stopTimer(cpId);
    }
    
    updateOverallProgress();
    
    socket.emit('instructor_checkpoint_complete', { 
        course_id: courseId, 
        checkpoint_id: cpId, 
        completed: completedCheckpoints.has(cpId),
        elapsed_seconds: checkpointTimers[cpId].elapsedSeconds
    });
}

function updateOverallProgress() {
    const completed = completedCheckpoints.size;
    const percent = totalCheckpoints > 0 ? Math.round((completed / totalCheckpoints) * 100) : 0;
    
    document.getElementById('overallProgressPercent').textContent = `${percent}%`;
    document.getElementById('overallProgressBar').style.width = `${percent}%`;
    document.getElementById('completedCheckpointsText').textContent = `ì™„ë£Œ: ${completed} / ${totalCheckpoints}`;
    document.getElementById('remainingCheckpointsText').textContent = `ë‚¨ì€ ì²´í¬í¬ì¸íŠ¸: ${totalCheckpoints - completed}ê°œ`;
}

if (currentCheckpointId) {
    document.getElementById(`checkpoint-${currentCheckpointId}`).classList.add('current');
    document.getElementById(`current-${currentCheckpointId}`).classList.remove('d-none');
}

const socket = io();

socket.on('connect', function() {
    document.getElementById('connectionStatus').innerHTML = '<i class="bi bi-circle-fill me-1"></i>ì—°ê²°ë¨';
    document.getElementById('connectionStatus').className = 'badge connection-badge bg-success';
    socket.emit('join_course', { course_id: courseId, mode: 'live' });
});

socket.on('disconnect', function() {
    document.getElementById('connectionStatus').innerHTML = '<i class="bi bi-circle-fill me-1"></i>ì—°ê²° ëŠê¹€';
    document.getElementById('connectionStatus').className = 'badge connection-badge bg-danger';
});

socket.on('progress_update', function(data) {
    const { user_id, checkpoint_id, status } = data;
    if (status === 'completed') {
        studentProgress[user_id][checkpoint_id] = true;
        updateStudentDisplay(user_id);
        updateCell(user_id, checkpoint_id, true);
    }
});

socket.on('session_stats', function(data) {
    const { completion_rates } = data;
    for (const cpId in completion_rates) {
        const stats = completion_rates[cpId];
        const badge = document.getElementById(`cp-${cpId}-badge`);
        if (badge) {
            badge.innerHTML = `<i class="bi bi-people me-1"></i>${stats.completed}/${stats.total}`;
        }
    }
    updateChart(completion_rates);
});

socket.on('new_chat_message', function(data) {
    appendChatMessage(data);
});

socket.on('understanding_updated', function(data) {
    const { checkpoint_id, understood, confused } = data;
    const understoodEl = document.querySelector(`#understood-${checkpoint_id} span`);
    const confusedEl = document.querySelector(`#confused-${checkpoint_id} span`);
    if (understoodEl) understoodEl.textContent = understood;
    if (confusedEl) confusedEl.textContent = confused;
});

socket.on('timer_sync', function(data) {
    const { checkpoint_id, elapsed_seconds, is_running } = data;
    const timer = checkpointTimers[checkpoint_id];
    timer.elapsedSeconds = elapsed_seconds;
    updateTimerDisplay(checkpoint_id);
});

function setLiveStatus(status) {
    if (status === 'ended' && !confirm('ì •ë§ ë¼ì´ë¸Œë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    fetch(`/courses/{{ course.id }}/live/set-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ status: status })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const badge = document.getElementById('liveStatusBadge');
            badge.dataset.status = status;
            
            if (status === 'live') {
                badge.style.background = '#dc3545';
                badge.style.color = 'white';
                badge.innerHTML = '<i class="bi bi-broadcast-pin me-1"></i>ë¼ì´ë¸Œ ì¤‘';
            } else if (status === 'preparing') {
                badge.style.background = '#ffc107';
                badge.style.color = '#212529';
                badge.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>ì¤€ë¹„ì¤‘';
            } else {
                badge.style.background = '#6c757d';
                badge.style.color = 'white';
                badge.innerHTML = '<i class="bi bi-stop-circle me-1"></i>ì¢…ë£Œ';
                if (status === 'ended') {
                    window.location.href = '{{ url_for("courses.view", course_id=course.id) }}';
                }
            }
            
            socket.emit('live_status_changed', { 
                course_id: courseId, 
                status: status,
                status_display: data.status_display
            });
        }
    });
}

function setCurrentCheckpoint(checkpointId) {
    if (completedCheckpoints.has(checkpointId)) return;
    
    checkpoints.forEach(cpId => {
        if (!completedCheckpoints.has(cpId)) {
            document.getElementById(`checkpoint-${cpId}`).classList.remove('current');
            document.getElementById(`current-${cpId}`).classList.add('d-none');
        }
    });
    
    document.getElementById(`checkpoint-${checkpointId}`).classList.add('current');
    document.getElementById(`current-${checkpointId}`).classList.remove('d-none');
    currentCheckpointId = checkpointId;
    
    socket.emit('set_current_checkpoint', { course_id: courseId, checkpoint_id: checkpointId });
}

function appendChatMessage(data) {
    const container = document.getElementById('chatMessages');
    const isInstructor = data.role === 'instructor';
    const formattedMessage = formatMentions(data.message);
    const html = `
        <div class="chat-message mb-2 ${isInstructor ? 'instructor-msg' : ''}" id="msg-${data.id}" data-user-id="${data.user_id}" data-msg-id="${data.id}">
            <div class="d-flex align-items-start gap-2">
                <div class="avatar-sm">${data.username[0].toUpperCase()}</div>
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2">
                        <strong class="small chat-username" onclick="mentionUser('${data.username}')">${data.username}</strong>
                        ${isInstructor ? '<span class="badge bg-primary bg-opacity-10 text-primary" style="font-size: 10px;">ê°•ì‚¬</span>' : ''}
                        <small class="text-muted">${data.created_at}</small>
                        <div class="chat-actions ms-auto">
                            <button class="btn btn-link btn-sm p-0 text-muted" onclick="mentionUser('${data.username}')" title="ì–¸ê¸‰"><i class="bi bi-at"></i></button>
                            <button class="btn btn-link btn-sm p-0 text-muted" onclick="editMessage(${data.id}, '${data.message.replace(/'/g, "\\'")}')" title="ìˆ˜ì •"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-link btn-sm p-0 text-danger" onclick="deleteMessage(${data.id})" title="ì‚­ì œ"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                    <p class="mb-0 small msg-content">${formattedMessage}</p>
                </div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
    container.scrollTop = container.scrollHeight;
}

function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (message) {
        socket.emit('send_chat_message', { course_id: courseId, message: message });
        input.value = '';
    }
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendChatMessage();
    }
}

function updateStudentDisplay(userId) {
    const completed = Object.values(studentProgress[userId]).filter(v => v).length;
    const percent = (completed / totalCheckpoints) * 100;
    
    const progressBar = document.getElementById(`student-${userId}-progress`);
    const text = document.getElementById(`student-${userId}-text`);
    const card = document.getElementById(`student-${userId}`);
    
    if (progressBar) progressBar.style.width = `${percent}%`;
    if (text) text.textContent = `${completed}/${totalCheckpoints}`;
    if (card && percent === 100) card.classList.add('completed');
}

function updateCell(userId, checkpointId, completed) {
    const cell = document.getElementById(`cell-${userId}-${checkpointId}`);
    if (cell) {
        cell.innerHTML = completed 
            ? '<i class="bi bi-check-circle-fill text-success"></i>'
            : '<i class="bi bi-circle text-muted"></i>';
    }
}

function setView(view) {
    if (view === 'grid') {
        document.getElementById('gridView').classList.remove('d-none');
        document.getElementById('listView').classList.add('d-none');
        document.getElementById('gridViewBtn').classList.add('active');
        document.getElementById('listViewBtn').classList.remove('active');
    } else {
        document.getElementById('gridView').classList.add('d-none');
        document.getElementById('listView').classList.remove('d-none');
        document.getElementById('gridViewBtn').classList.remove('active');
        document.getElementById('listViewBtn').classList.add('active');
    }
}

let progressChart;
function updateChart(completionRates) {
    const labels = [];
    const data = [];
    
    checkpoints.forEach((cpId, index) => {
        labels.push(`${index + 1}`);
        const stats = completionRates[cpId];
        data.push(stats ? (stats.completed / stats.total * 100).toFixed(1) : 0);
    });
    
    if (progressChart) {
        progressChart.data.datasets[0].data = data;
        progressChart.update();
    } else {
        const ctx = document.getElementById('progressChart').getContext('2d');
        progressChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ì™„ë£Œìœ¨ %',
                    data: data,
                    backgroundColor: 'rgba(13, 27, 62, 0.7)',
                    borderColor: 'rgba(13, 27, 62, 1)',
                    borderWidth: 1,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, max: 100 } }
            }
        });
    }
}

setInterval(function() {
    socket.emit('request_stats', { course_id: courseId, mode: 'live' });
}, 3000);

const studentUsernames = {{ students|map(attribute='username')|list|tojson }};
let editingMessageId = null;

function mentionUser(username) {
    const input = document.getElementById('chatInput');
    input.value = `@${username} ` + input.value;
    input.focus();
}

function insertMention(username) {
    const input = document.getElementById('chatInput');
    const cursorPos = input.selectionStart;
    const textBefore = input.value.substring(0, cursorPos);
    const textAfter = input.value.substring(cursorPos);
    const lastAtIndex = textBefore.lastIndexOf('@');
    
    if (lastAtIndex !== -1) {
        input.value = textBefore.substring(0, lastAtIndex) + `@${username} ` + textAfter;
    } else {
        input.value = `@${username} ` + input.value;
    }
    
    document.getElementById('mentionsDropdown').classList.add('d-none');
    input.focus();
}

function handleChatInput(event) {
    const input = event.target;
    const value = input.value;
    const cursorPos = input.selectionStart;
    const textBeforeCursor = value.substring(0, cursorPos);
    const lastAtIndex = textBeforeCursor.lastIndexOf('@');
    
    if (lastAtIndex !== -1 && lastAtIndex === textBeforeCursor.length - 1) {
        document.getElementById('mentionsDropdown').classList.remove('d-none');
    } else if (lastAtIndex !== -1) {
        const searchTerm = textBeforeCursor.substring(lastAtIndex + 1).toLowerCase();
        const dropdown = document.getElementById('mentionsDropdown');
        const items = dropdown.querySelectorAll('.mention-item');
        let hasVisible = false;
        
        items.forEach(item => {
            const username = item.textContent.substring(1).toLowerCase();
            if (username.includes(searchTerm)) {
                item.style.display = 'block';
                hasVisible = true;
            } else {
                item.style.display = 'none';
            }
        });
        
        if (hasVisible && searchTerm.length > 0) {
            dropdown.classList.remove('d-none');
        } else {
            dropdown.classList.add('d-none');
        }
    } else {
        document.getElementById('mentionsDropdown').classList.add('d-none');
    }
}

function editMessage(msgId, currentText) {
    const newText = prompt('ë©”ì‹œì§€ ìˆ˜ì •:', currentText);
    if (newText && newText.trim() !== currentText) {
        socket.emit('edit_chat_message', { 
            course_id: courseId, 
            message_id: msgId, 
            new_message: newText.trim() 
        });
    }
}

function deleteMessage(msgId) {
    if (confirm('ì´ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        socket.emit('delete_chat_message', { 
            course_id: courseId, 
            message_id: msgId 
        });
    }
}

function callAllStudents() {
    const mentions = studentUsernames.map(u => `@${u}`).join(' ');
    socket.emit('send_chat_message', { 
        course_id: courseId, 
        message: `ğŸ“¢ ì „ì²´ í˜¸ì¶œ: ${mentions} - ì£¼ëª©í•´ ì£¼ì„¸ìš”!` 
    });
}

socket.on('chat_message_edited', function(data) {
    const msgEl = document.getElementById(`msg-${data.message_id}`);
    if (msgEl) {
        const contentEl = msgEl.querySelector('.msg-content');
        if (contentEl) {
            contentEl.innerHTML = formatMentions(data.new_message) + ' <small class="text-muted">(ìˆ˜ì •ë¨)</small>';
        }
    }
});

socket.on('chat_message_deleted', function(data) {
    const msgEl = document.getElementById(`msg-${data.message_id}`);
    if (msgEl) {
        msgEl.classList.add('deleted');
        const contentEl = msgEl.querySelector('.msg-content');
        if (contentEl) {
            contentEl.textContent = 'ì‚­ì œëœ ë©”ì‹œì§€ì…ë‹ˆë‹¤';
        }
        const actionsEl = msgEl.querySelector('.chat-actions');
        if (actionsEl) actionsEl.remove();
    }
});

function formatMentions(text) {
    return text.replace(/@(\w+)/g, '<span class="mention-highlight">@$1</span>');
}

document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;

function togglePostForm() {
    const container = document.getElementById('postFormContainer');
    container.classList.toggle('d-none');
}

const pptForm = document.getElementById('pptUploadForm');
if (pptForm) {
    pptForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const fileInput = document.getElementById('pptxFile');
        if (!fileInput.files.length) {
            showToast('PPT/PDF íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        const formData = new FormData();
        formData.append('pptx_file', fileInput.files[0]);
        formData.append('csrf_token', '{{ csrf_token() }}');
        
        document.getElementById('pptUploadBtn').disabled = true;
        document.getElementById('pptUploadBtn').innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>ë³€í™˜ ì¤‘...';
        document.getElementById('pptConvertProgress').classList.remove('d-none');
        
        fetch('/slides/upload/{{ course.id }}', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.error || 'ë³€í™˜ ì‹¤íŒ¨', 'danger');
                document.getElementById('pptUploadBtn').disabled = false;
                document.getElementById('pptUploadBtn').innerHTML = '<i class="bi bi-cloud-upload me-1"></i>ë³€í™˜ ì‹œì‘';
                document.getElementById('pptConvertProgress').classList.add('d-none');
            }
        })
        .catch(err => {
            showToast('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            document.getElementById('pptUploadBtn').disabled = false;
            document.getElementById('pptUploadBtn').innerHTML = '<i class="bi bi-cloud-upload me-1"></i>ë³€í™˜ ì‹œì‘';
            document.getElementById('pptConvertProgress').classList.add('d-none');
        });
    });
}

function deleteDeck(deckId) {
    if (!confirm('ì´ ìŠ¬ë¼ì´ë“œ ë±ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    fetch('/slides/delete/' + deckId, {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast('ìŠ¬ë¼ì´ë“œ ë±ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast(data.error || 'ì‚­ì œ ì‹¤íŒ¨', 'danger');
        }
    });
}

{% if active_deck and active_slides %}
const deckId = {{ active_deck.id }};
const slideUrls = {{ active_slides|tojson }};
const totalSlides = slideUrls.length;
let currentSlideIndex = Math.min({{ active_deck.current_slide_index }}, totalSlides - 1);
if (currentSlideIndex < 0) currentSlideIndex = 0;
let slideAggregates = {};
let bookmarkedSlides = new Set([{% for idx in active_bookmarks %}{{ idx }},{% endfor %}]);
let slidePresenterVisible = false;
let visitedSlides = new Set([currentSlideIndex]);

let lectureStartTime = null;
let slideStartTime = null;
let slideTimeSpent = new Array(totalSlides).fill(0);
let lectureTimerInterval = null;
let trendHistory = [];
const TREND_MAX_POINTS = 100;
let lastAlertType = null;
let alertDismissed = false;
let donutChart = null;
let trendChart = null;

function toggleSlidePresenter() {
    if (totalSlides === 0) { showToast('ìŠ¬ë¼ì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning'); return; }
    const presenter = document.getElementById('inlinePresenter');
    const deckInfo = document.getElementById('slideDeckInfo');
    const btn = document.getElementById('toggleSlidePresenter');
    slidePresenterVisible = !slidePresenterVisible;
    
    if (slidePresenterVisible) {
        presenter.classList.remove('d-none');
        deckInfo.classList.add('d-none');
        btn.innerHTML = '<i class="bi bi-eye-slash me-1"></i>ìŠ¬ë¼ì´ë“œ ìˆ¨ê¸°ê¸°';
        btn.classList.replace('btn-info', 'btn-outline-info');
        socket.emit('join_slide_session', { deck_id: deckId });
        socket.emit('request_slide_aggregates', { deck_id: deckId });
        if (!lectureStartTime) {
            lectureStartTime = new Date();
            slideStartTime = new Date();
            startLectureTimer();
        }
        initDonutChart();
        initTrendChart();
        updateSlideDisplay();
    } else {
        presenter.classList.add('d-none');
        deckInfo.classList.remove('d-none');
        btn.innerHTML = '<i class="bi bi-eye me-1"></i>ìŠ¬ë¼ì´ë“œ í‘œì‹œ';
        btn.classList.replace('btn-outline-info', 'btn-info');
    }
}

function startLectureTimer() {
    if (lectureTimerInterval) return;
    lectureTimerInterval = setInterval(function() {
        updateLectureTimerDisplay();
        updateSlideTimeDisplay();
        recordTrendPoint();
        checkEngagementAlerts();
    }, 1000);
}

function updateLectureTimerDisplay() {
    if (!lectureStartTime) return;
    const elapsed = Math.floor((Date.now() - lectureStartTime.getTime()) / 1000);
    const h = Math.floor(elapsed / 3600);
    const m = Math.floor((elapsed % 3600) / 60);
    const s = elapsed % 60;
    const el = document.getElementById('lectureElapsed');
    if (el) el.textContent = String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');

    const totalEstMin = totalSlides * 2;
    const totalEl = document.getElementById('lectureTotalTime');
    if (totalEl) totalEl.textContent = Math.floor(totalEstMin / 60) > 0 ? Math.floor(totalEstMin/60) + ':' + String(totalEstMin%60).padStart(2,'0') + ':00' : String(totalEstMin).padStart(2,'0') + ':00';

    const pct = Math.min(100, ((currentSlideIndex + 1) / totalSlides) * 100);
    const fill = document.getElementById('lectureProgressFill');
    const marker = document.getElementById('lectureProgressMarker');
    const pctEl = document.getElementById('lectureProgressPct');
    if (fill) fill.style.width = pct + '%';
    if (marker) marker.style.left = pct + '%';
    if (pctEl) pctEl.textContent = Math.round(pct) + '%';

    const avgTimePerSlide = elapsed / Math.max(currentSlideIndex + 1, 1);
    const remainingSlides = totalSlides - currentSlideIndex - 1;
    const estRemainingSeconds = Math.round(avgTimePerSlide * remainingSlides);
    const endTime = new Date(Date.now() + estRemainingSeconds * 1000);
    const endEl = document.getElementById('estimatedEndTime');
    if (endEl) endEl.textContent = String(endTime.getHours()).padStart(2,'0') + ':' + String(endTime.getMinutes()).padStart(2,'0');

    if (elapsed > totalEstMin * 60) {
        if (el) el.classList.add('time-over');
    } else {
        if (el) el.classList.remove('time-over');
    }
}

function updateSlideTimeDisplay() {
    if (!slideStartTime) return;
    const currentSlideElapsed = Math.floor((Date.now() - slideStartTime.getTime()) / 1000);
    const totalForSlide = slideTimeSpent[currentSlideIndex] + currentSlideElapsed;
    const m = Math.floor(totalForSlide / 60);
    const s = totalForSlide % 60;
    const display = document.getElementById('slideTimeDisplay');
    if (display) display.textContent = String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');

    const avgPerSlide = 120;
    const paceEl = document.getElementById('slideTimePace');
    const paceText = document.getElementById('slideTimePaceText');
    if (totalForSlide > avgPerSlide * 1.5 && paceEl && paceText) {
        paceEl.style.display = '';
        paceEl.className = 'badge bg-danger bg-opacity-10 text-danger small';
        paceText.textContent = 'ëŠë¦¼';
    } else if (totalForSlide < avgPerSlide * 0.5 && totalForSlide > 10 && paceEl && paceText) {
        paceEl.style.display = '';
        paceEl.className = 'badge bg-info bg-opacity-10 text-info small';
        paceText.textContent = 'ë¹ ë¦„';
    } else if (paceEl) {
        paceEl.style.display = 'none';
    }
}

function saveSlideTime() {
    if (slideStartTime) {
        slideTimeSpent[currentSlideIndex] += Math.floor((Date.now() - slideStartTime.getTime()) / 1000);
        const thumbTime = document.getElementById('thumbTime' + currentSlideIndex);
        if (thumbTime) {
            const t = slideTimeSpent[currentSlideIndex];
            thumbTime.textContent = Math.floor(t/60) + ':' + String(t%60).padStart(2,'0');
            thumbTime.classList.remove('d-none');
        }
    }
    slideStartTime = new Date();
}

function goToSlide(index) {
    if (index < 0 || index >= totalSlides || index === currentSlideIndex) return;
    saveSlideTime();
    currentSlideIndex = index;
    visitedSlides.add(index);
    updateSlideDisplay();
    socket.emit('change_slide', { deck_id: deckId, slide_index: currentSlideIndex });
}

function prevSlide() { if (currentSlideIndex > 0) goToSlide(currentSlideIndex - 1); }
function nextSlide() { if (currentSlideIndex < totalSlides - 1) goToSlide(currentSlideIndex + 1); }

function updateSlideDisplay() {
    const img = document.getElementById('inlineSlideImage');
    if (img) img.src = slideUrls[currentSlideIndex];
    
    const counter = document.getElementById('slideCounter');
    if (counter) counter.textContent = (currentSlideIndex + 1) + ' / ' + totalSlides;
    
    const numEl = document.getElementById('currentSlideNum');
    if (numEl) numEl.textContent = currentSlideIndex + 1;
    
    document.querySelectorAll('.inline-slide-thumb').forEach(el => {
        el.classList.toggle('active', parseInt(el.dataset.index) === currentSlideIndex);
    });
    
    const activeThumb = document.querySelector('.inline-slide-thumb.active');
    if (activeThumb) activeThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    document.querySelectorAll('.jumpbar-segment').forEach(el => {
        const idx = parseInt(el.dataset.index);
        el.classList.toggle('active', idx === currentSlideIndex);
        el.classList.toggle('visited', visitedSlides.has(idx) && idx !== currentSlideIndex);
    });
    
    updateReactionBars();
    updateBookmarkButton();
    updateDonutChart();
    updateEngagementGuide();
    
    const prevBtn = document.getElementById('prevSlideBtn');
    const nextBtn = document.getElementById('nextSlideBtn');
    if (prevBtn) prevBtn.disabled = currentSlideIndex === 0;
    if (nextBtn) nextBtn.disabled = currentSlideIndex === totalSlides - 1;
}

function updateReactionBars() {
    const agg = slideAggregates[currentSlideIndex] || { understood: 0, question: 0, hard: 0, total_reacted: 0 };
    const total = Math.max(agg.total_reacted, 1);
    
    const u = agg.understood, q = agg.question, h = agg.hard;
    const uPct = Math.round(u / total * 100), qPct = Math.round(q / total * 100), hPct = Math.round(h / total * 100);

    document.getElementById('countUnderstood').textContent = u;
    document.getElementById('countQuestion').textContent = q;
    document.getElementById('countHard').textContent = h;
    
    document.getElementById('pctUnderstood').textContent = uPct + '%';
    document.getElementById('pctQuestion').textContent = qPct + '%';
    document.getElementById('pctHard').textContent = hPct + '%';
    
    document.getElementById('barUnderstood').style.width = (u / total * 100) + '%';
    document.getElementById('barQuestion').style.width = (q / total * 100) + '%';
    document.getElementById('barHard').style.width = (h / total * 100) + '%';
    
    const pc = document.getElementById('participantCount');
    if (pc) pc.textContent = agg.total_reacted;

    const jumpFill = document.getElementById('jumpFill' + currentSlideIndex);
    if (jumpFill) {
        const hardPct = agg.total_reacted > 0 ? ((q + h) / agg.total_reacted * 100) : 0;
        jumpFill.style.height = hardPct + '%';
    }
}

function initDonutChart() {
    const canvas = document.getElementById('reactionDonutChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (donutChart) { donutChart.destroy(); }
    donutChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['ì´í•´', 'ì§ˆë¬¸', 'ì–´ë ¤ì›€'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: ['#22c55e', '#f59e0b', '#ef4444'],
                borderWidth: 0,
                cutout: '70%'
            }]
        },
        options: {
            responsive: false,
            maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: { enabled: true, bodyFont: { size: 10 } } },
            animation: { duration: 300 }
        }
    });
}

function updateDonutChart() {
    if (!donutChart) return;
    const agg = slideAggregates[currentSlideIndex] || { understood: 0, question: 0, hard: 0, total_reacted: 0 };
    donutChart.data.datasets[0].data = [agg.understood, agg.question, agg.hard];
    donutChart.update('none');
    const center = document.getElementById('donutCenterText');
    if (center) center.textContent = agg.total_reacted;
}

function initTrendChart() {
    const canvas = document.getElementById('trendMiniChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (trendChart) { trendChart.destroy(); }
    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                { label: 'ğŸ‘', data: [], borderColor: '#22c55e', borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3 },
                { label: 'â“', data: [], borderColor: '#f59e0b', borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3 },
                { label: 'ğŸ˜µ', data: [], borderColor: '#ef4444', borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.3 }
            ]
        },
        options: {
            responsive: false,
            maintainAspectRatio: false,
            scales: {
                x: { display: false },
                y: { display: false, beginAtZero: true }
            },
            plugins: { legend: { display: false }, tooltip: { enabled: true, bodyFont: { size: 9 } } },
            animation: { duration: 200 }
        }
    });
}

function recordTrendPoint() {
    if (!trendChart || !slidePresenterVisible) return;
    const agg = slideAggregates[currentSlideIndex] || { understood: 0, question: 0, hard: 0, total_reacted: 0 };
    const now = new Date();
    const label = String(now.getMinutes()).padStart(2,'0') + ':' + String(now.getSeconds()).padStart(2,'0');
    
    trendHistory.push({ t: label, u: agg.understood, q: agg.question, h: agg.hard });
    if (trendHistory.length > TREND_MAX_POINTS) trendHistory.shift();
    
    if (Date.now() % 3000 < 1100) {
        trendChart.data.labels = trendHistory.map(p => p.t);
        trendChart.data.datasets[0].data = trendHistory.map(p => p.u);
        trendChart.data.datasets[1].data = trendHistory.map(p => p.q);
        trendChart.data.datasets[2].data = trendHistory.map(p => p.h);
        trendChart.update('none');
    }
}

function updateEngagementGuide() {
    const agg = slideAggregates[currentSlideIndex] || { understood: 0, question: 0, hard: 0, total_reacted: 0 };
    const total = Math.max(agg.total_reacted, 1);
    const uPct = agg.understood / total * 100;
    const qPct = agg.question / total * 100;
    const hPct = agg.hard / total * 100;
    
    const guideEl = document.getElementById('engagementGuide');
    const guideText = document.getElementById('engagementGuideText');
    if (!guideEl || !guideText) return;
    
    if (agg.total_reacted === 0) {
        guideEl.classList.add('d-none');
        return;
    }
    
    guideEl.classList.remove('d-none');
    if (uPct >= 70) {
        guideText.textContent = 'í•™ìŠµìì˜ ' + Math.round(uPct) + '%ê°€ ì´í•´í–ˆìŠµë‹ˆë‹¤. í˜„ì¬ ì§„í–‰ ì†ë„ë¥¼ ìœ ì§€í•˜ì„¸ìš”.';
    } else if (hPct >= 30) {
        guideText.textContent = 'ì–´ë ¤ì›€ ë°˜ì‘ì´ ' + Math.round(hPct) + '%ì…ë‹ˆë‹¤. ì¶”ê°€ ì„¤ëª…ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
    } else if (qPct >= 30) {
        guideText.textContent = 'ì§ˆë¬¸ ë°˜ì‘ì´ ' + Math.round(qPct) + '%ì…ë‹ˆë‹¤. Q&A ì‹œê°„ì„ ê³ ë ¤í•˜ì„¸ìš”.';
    } else {
        guideText.textContent = 'ì´í•´ ' + Math.round(uPct) + '% | ì§ˆë¬¸ ' + Math.round(qPct) + '% | ì–´ë ¤ì›€ ' + Math.round(hPct) + '%';
    }
}

function checkEngagementAlerts() {
    if (alertDismissed) return;
    const agg = slideAggregates[currentSlideIndex] || { understood: 0, question: 0, hard: 0, total_reacted: 0 };
    if (agg.total_reacted < 2) return;
    
    const total = agg.total_reacted;
    const uPct = agg.understood / total * 100;
    const hPct = agg.hard / total * 100;
    const qPct = agg.question / total * 100;
    
    const alertEl = document.getElementById('engagementAlert');
    const alertIcon = document.getElementById('engagementAlertIcon');
    const alertTitle = document.getElementById('engagementAlertTitle');
    const alertMsg = document.getElementById('engagementAlertMsg');
    if (!alertEl) return;

    let newAlertType = null;
    
    if (hPct > 30) {
        newAlertType = 'hard';
        alertEl.className = 'engagement-alert-bar mb-2 p-2 rounded-3 d-flex align-items-center gap-2 alert-danger-custom';
        alertIcon.className = 'bi bi-exclamation-triangle-fill fs-5 text-danger';
        alertTitle.textContent = 'âš ï¸ ì–´ë ¤ì›€ ë°˜ì‘ ' + Math.round(hPct) + '%';
        alertMsg.textContent = 'ì´ ì‹œì ì—ì„œ ê°œë… ì„¤ëª…ì„ ì¶”ê°€í•˜ì„¸ìš”. ì˜ˆì œë¥¼ í†µí•œ ë³´ì¶© ì„¤ëª…ì„ ê¶Œì¥í•©ë‹ˆë‹¤.';
    } else if (qPct > 40) {
        newAlertType = 'question';
        alertEl.className = 'engagement-alert-bar mb-2 p-2 rounded-3 d-flex align-items-center gap-2 alert-warning-custom';
        alertIcon.className = 'bi bi-question-circle-fill fs-5 text-warning';
        alertTitle.textContent = 'â“ ì§ˆë¬¸ ë°˜ì‘ ' + Math.round(qPct) + '%';
        alertMsg.textContent = 'Q&A ì‹œê°„ì„ ê°€ì§€ì„¸ìš”. í•™ìŠµìë“¤ì˜ ê¶ê¸ˆì¦ì„ í•´ì†Œí•  í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤.';
    } else if (uPct > 80) {
        newAlertType = 'positive';
        alertEl.className = 'engagement-alert-bar mb-2 p-2 rounded-3 d-flex align-items-center gap-2 alert-success-custom';
        alertIcon.className = 'bi bi-check-circle-fill fs-5 text-success';
        alertTitle.textContent = 'âœ… ê¸ì • ë°˜ì‘ ' + Math.round(uPct) + '%';
        alertMsg.textContent = 'í•™ìŠµìë“¤ì´ ì˜ ì´í•´í•˜ê³  ìˆìŠµë‹ˆë‹¤. í˜„ì¬ ì§„í–‰ ì†ë„ë¥¼ ìœ ì§€í•˜ì„¸ìš”.';
    } else {
        alertEl.classList.add('d-none');
        lastAlertType = null;
        return;
    }
    
    if (newAlertType !== lastAlertType) {
        lastAlertType = newAlertType;
        alertDismissed = false;
        alertEl.classList.remove('d-none');
    }
}

function dismissEngagementAlert() {
    const alertEl = document.getElementById('engagementAlert');
    if (alertEl) alertEl.classList.add('d-none');
    alertDismissed = true;
    setTimeout(() => { alertDismissed = false; }, 30000);
}

function filterSlides(query) {
    query = query.toLowerCase().trim();
    document.querySelectorAll('.inline-slide-thumb').forEach(el => {
        const idx = parseInt(el.dataset.index);
        const slideNum = String(idx + 1);
        if (!query || slideNum.includes(query)) {
            el.classList.remove('search-hidden');
        } else {
            el.classList.add('search-hidden');
        }
    });
}

function updateBookmarkButton() {
    const btn = document.getElementById('bookmarkToggle');
    const icon = document.getElementById('bookmarkIcon');
    if (!btn || !icon) return;
    if (bookmarkedSlides.has(currentSlideIndex)) {
        btn.classList.add('active');
        icon.className = 'bi bi-bookmark-fill';
    } else {
        btn.classList.remove('active');
        icon.className = 'bi bi-bookmark';
    }
}

function toggleBookmark() {
    socket.emit('toggle_slide_bookmark', { deck_id: deckId, slide_index: currentSlideIndex });
}

function updateThumbFlag(slideIndex, isFlagged) {
    const flag = document.getElementById('thumbFlag' + slideIndex);
    const wrapper = document.querySelector(`.inline-slide-thumb[data-index="${slideIndex}"]`);
    if (flag) flag.classList.toggle('d-none', !isFlagged);
    if (wrapper) wrapper.classList.toggle('flagged', isFlagged);
}

socket.on('all_slide_aggregates', function(data) {
    slideAggregates = data.aggregates;
    bookmarkedSlides = new Set();
    if (data.flagged_slides) {
        data.flagged_slides.forEach(function(fs) {
            bookmarkedSlides.add(fs.slide_index);
            updateThumbFlag(fs.slide_index, true);
        });
    }
    updateReactionBars();
    updateBookmarkButton();
    updateDonutChart();
    updateEngagementGuide();
    
    Object.keys(slideAggregates).forEach(function(idx) {
        const a = slideAggregates[idx];
        const jf = document.getElementById('jumpFill' + idx);
        if (jf && a.total_reacted > 0) {
            jf.style.height = ((a.question + a.hard) / a.total_reacted * 100) + '%';
        }
    });
});

socket.on('slide_aggregate_updated', function(data) {
    slideAggregates[data.slide_index] = data.counts;
    if (data.slide_index === currentSlideIndex) {
        updateReactionBars();
        updateDonutChart();
        updateEngagementGuide();
    }
    if (data.flagged) {
        bookmarkedSlides.add(data.slide_index);
        updateThumbFlag(data.slide_index, true);
    }
    const jf = document.getElementById('jumpFill' + data.slide_index);
    if (jf && data.counts.total_reacted > 0) {
        jf.style.height = ((data.counts.question + data.counts.hard) / data.counts.total_reacted * 100) + '%';
    }
});

socket.on('bookmark_updated', function(data) {
    if (data.is_bookmarked) {
        bookmarkedSlides.add(data.slide_index);
    } else {
        bookmarkedSlides.delete(data.slide_index);
    }
    updateThumbFlag(data.slide_index, data.is_bookmarked);
    if (data.slide_index === currentSlideIndex) updateBookmarkButton();
});

document.addEventListener('keydown', function(e) {
    if (!slidePresenterVisible) return;
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    if (e.key === 'ArrowLeft' || e.key === 'PageUp') { e.preventDefault(); prevSlide(); }
    if (e.key === 'ArrowRight' || e.key === 'PageDown') { e.preventDefault(); nextSlide(); }
    if (e.key === 'Home') { e.preventDefault(); goToSlide(0); }
    if (e.key === 'End') { e.preventDefault(); goToSlide(totalSlides - 1); }
});
{% endif %}
</script>
{% endblock %}
