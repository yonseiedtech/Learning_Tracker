{% extends "base.html" %}

{% block title %}{{ course.title }} - 학습 진도 트래커{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">대시보드</a></li>
        <li class="breadcrumb-item active">{{ course.title }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-start mb-4 flex-wrap gap-3">
    <div>
        <h2 class="fw-bold mb-2">{{ course.title }}</h2>
        <p class="text-muted mb-0">{{ course.description or '설명이 없습니다' }}</p>
        {% if active_session %}
        <div class="mt-2">
            {% if active_session.live_status == 'live' %}
            <span class="badge bg-danger fs-6"><i class="bi bi-broadcast-pin me-1"></i>라이브 중</span>
            {% elif active_session.live_status == 'preparing' %}
            <span class="badge bg-warning text-dark fs-6"><i class="bi bi-hourglass-split me-1"></i>라이브 준비중</span>
            {% else %}
            <span class="badge bg-secondary fs-6"><i class="bi bi-stop-circle me-1"></i>라이브 종료</span>
            {% endif %}
        </div>
        {% else %}
        <div class="mt-2">
            <span class="badge bg-secondary fs-6"><i class="bi bi-circle me-1"></i>대기중</span>
        </div>
        {% endif %}
    </div>
    <div class="d-flex gap-2 flex-wrap">
        <a href="{{ url_for('courses.live_mode', course_id=course.id) }}" class="btn btn-success rounded-pill">
            <i class="bi bi-broadcast me-2"></i>라이브 시작
        </a>
        <a href="{{ url_for('courses.self_study_progress', course_id=course.id) }}" class="btn btn-primary rounded-pill">
            <i class="bi bi-book me-2"></i>자습 진도
        </a>
        <a href="{{ url_for('attendance.course_attendance', course_id=course.id) }}" class="btn btn-warning rounded-pill">
            <i class="bi bi-calendar-check me-2"></i>출석
        </a>
        <a href="{{ url_for('forum.list_posts', course_id=course.id) }}" class="btn btn-secondary rounded-pill">
            <i class="bi bi-chat-square-text me-2"></i>게시판
        </a>
        <a href="{{ url_for('analytics.instructor_dashboard', course_id=course.id) }}" class="btn btn-info text-white rounded-pill">
            <i class="bi bi-graph-up me-2"></i>분석
        </a>
        <a href="{{ url_for('courses.settings', course_id=course.id) }}" class="btn btn-outline-secondary rounded-pill">
            <i class="bi bi-gear me-2"></i>설정
        </a>
        <a href="{{ url_for('courses.edit', course_id=course.id) }}" class="btn btn-outline-primary rounded-pill">
            <i class="bi bi-pencil me-2"></i>수정
        </a>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-4">
        <div class="glass-card p-4 mb-4">
            <h5 class="fw-bold mb-3"><i class="bi bi-key me-2 text-primary"></i>초대 코드</h5>
            <div class="invite-code-box text-center p-3">
                <code class="fs-3 fw-bold text-primary" id="inviteCode" style="letter-spacing: 4px;">{{ course.invite_code }}</code>
            </div>
            <button class="btn btn-outline-primary w-100 mt-3 rounded-pill" onclick="copyInviteCode()">
                <i class="bi bi-clipboard me-2"></i>코드 복사
            </button>
            <small class="text-muted d-block text-center mt-2">학생들에게 이 코드를 공유하세요</small>
        </div>
        
        <div class="glass-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold mb-0"><i class="bi bi-people me-2 text-primary"></i>수강생</h5>
                <div class="d-flex gap-2 align-items-center">
                    <span class="badge bg-primary bg-opacity-10 text-primary">{{ students|length }}명</span>
                    <a href="{{ url_for('courses.members', course_id=course.id) }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-gear me-1"></i>관리
                    </a>
                </div>
            </div>
            {% if students %}
            <div class="list-group list-group-modern">
                {% for student in students %}
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="avatar-sm me-2 bg-light text-primary">{{ student.initial }}</div>
                        <span>{{ student.display_name }}</span>
                    </div>
                    <small class="text-muted">{{ student.email }}</small>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted text-center mb-0 py-3">아직 수강생이 없습니다</p>
            {% endif %}
        </div>
    </div>
    
    <div class="col-lg-8">
        <div class="glass-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-bold mb-0"><i class="bi bi-flag me-2 text-primary"></i>체크포인트</h5>
                <div class="btn-group">
                    <a href="{{ url_for('checkpoints.ai_generate', course_id=course.id) }}" class="btn btn-outline-primary btn-sm rounded-start-pill">
                        <i class="bi bi-robot me-1"></i>AI 생성
                    </a>
                    <a href="{{ url_for('checkpoints.create', course_id=course.id) }}" class="btn btn-primary btn-sm rounded-end-pill">
                        <i class="bi bi-plus-lg me-1"></i>수기 추가
                    </a>
                </div>
            </div>
            {% if checkpoints %}
            <div class="d-flex justify-content-between align-items-center mb-3 bulk-actions" id="bulkActions">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                    <label class="form-check-label small" for="selectAll">전체 선택</label>
                </div>
                <div class="d-none" id="bulkDeleteBtns">
                    <span class="text-muted small me-2"><span id="selectedCount">0</span>개 선택됨</span>
                    <button class="btn btn-outline-danger btn-sm" onclick="bulkDeleteSelected()">
                        <i class="bi bi-trash me-1"></i>선택 삭제
                    </button>
                    <button class="btn btn-danger btn-sm ms-1" onclick="bulkDeleteAll()">
                        <i class="bi bi-trash-fill me-1"></i>전체 삭제
                    </button>
                </div>
            </div>
            <div class="checkpoint-list">
                {% for cp in checkpoints %}
                <div class="checkpoint-item d-flex justify-content-between align-items-center" data-checkpoint-id="{{ cp.id }}">
                    <div class="d-flex align-items-center flex-grow-1">
                        <div class="form-check me-2">
                            <input class="form-check-input checkpoint-checkbox" type="checkbox" value="{{ cp.id }}" onchange="updateBulkActions()">
                        </div>
                        <div class="checkpoint-number me-3">{{ cp.order }}</div>
                        <div>
                            <strong>{{ cp.title }}</strong>
                            {% if cp.description %}
                            <p class="mb-0 small text-muted">{{ cp.description[:80] }}{{ '...' if cp.description|length > 80 else '' }}</p>
                            {% endif %}
                            {% if cp.estimated_minutes %}
                            <small class="text-primary"><i class="bi bi-clock me-1"></i>{{ cp.estimated_minutes }}분</small>
                            {% endif %}
                        </div>
                    </div>
                    <div class="btn-group">
                        <a href="{{ url_for('checkpoints.edit', checkpoint_id=cp.id) }}" class="btn btn-sm btn-outline-primary rounded-start-pill">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <form method="POST" action="{{ url_for('checkpoints.delete', checkpoint_id=cp.id) }}" class="d-inline" onsubmit="return confirm('이 체크포인트를 삭제하시겠습니까?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger rounded-end-pill">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5">
                <div class="empty-icon mb-3" style="width: 80px; height: 80px; font-size: 2rem;">
                    <i class="bi bi-flag"></i>
                </div>
                <h6 class="fw-bold mb-2">체크포인트가 없습니다</h6>
                <p class="text-muted mb-3">학습 진도를 추적할 체크포인트를 추가하세요</p>
                <div class="d-flex gap-2 justify-content-center">
                    <a href="{{ url_for('checkpoints.ai_generate', course_id=course.id) }}" class="btn btn-outline-primary rounded-pill">
                        <i class="bi bi-robot me-2"></i>AI로 자동 생성
                    </a>
                    <a href="{{ url_for('checkpoints.create', course_id=course.id) }}" class="btn btn-primary rounded-pill">
                        <i class="bi bi-plus-lg me-2"></i>수기 추가
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.checkpoint-number {
    width: 32px;
    height: 32px;
    background: var(--primary-gradient);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
}
</style>

<script>
const csrfToken = '{{ csrf_token() }}';
const courseId = {{ course.id }};

function copyInviteCode() {
    const code = document.getElementById('inviteCode').textContent;
    navigator.clipboard.writeText(code).then(() => {
        alert('초대 코드가 복사되었습니다!');
    });
}

function toggleSelectAll(checkbox) {
    document.querySelectorAll('.checkpoint-checkbox').forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateBulkActions();
}

function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.checkpoint-checkbox:checked');
    const count = checkboxes.length;
    const bulkBtns = document.getElementById('bulkDeleteBtns');
    const selectedCount = document.getElementById('selectedCount');
    const selectAll = document.getElementById('selectAll');
    
    if (count > 0) {
        bulkBtns.classList.remove('d-none');
        selectedCount.textContent = count;
    } else {
        bulkBtns.classList.add('d-none');
    }
    
    const allCheckboxes = document.querySelectorAll('.checkpoint-checkbox');
    selectAll.checked = allCheckboxes.length > 0 && count === allCheckboxes.length;
    selectAll.indeterminate = count > 0 && count < allCheckboxes.length;
}

async function bulkDeleteSelected() {
    const checkboxes = document.querySelectorAll('.checkpoint-checkbox:checked');
    const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    if (ids.length === 0) {
        alert('삭제할 체크포인트를 선택해주세요.');
        return;
    }
    
    if (!confirm(`선택한 ${ids.length}개의 체크포인트를 삭제하시겠습니까?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/checkpoints/course/${courseId}/bulk-delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ checkpoint_ids: ids })
        });
        
        const data = await response.json();
        if (data.success) {
            alert(`${data.deleted_count}개의 체크포인트가 삭제되었습니다.`);
            location.reload();
        } else {
            alert('오류: ' + (data.error || '알 수 없는 오류'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('삭제 중 오류가 발생했습니다.');
    }
}

async function bulkDeleteAll() {
    const totalCount = document.querySelectorAll('.checkpoint-checkbox').length;
    
    if (!confirm(`정말로 모든 체크포인트(${totalCount}개)를 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/checkpoints/course/${courseId}/bulk-delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ delete_all: true })
        });
        
        const data = await response.json();
        if (data.success) {
            alert(`${data.deleted_count}개의 체크포인트가 삭제되었습니다.`);
            location.reload();
        } else {
            alert('오류: ' + (data.error || '알 수 없는 오류'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('삭제 중 오류가 발생했습니다.');
    }
}
</script>
{% endblock %}
