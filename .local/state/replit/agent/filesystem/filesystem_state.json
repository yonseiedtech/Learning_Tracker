{"file_contents":{"app/routes/sessions.py":{"content":"from flask import Blueprint, render_template, redirect, url_for, flash, request, jsonify, send_file\nfrom flask_login import login_required, current_user\nfrom app import db\nfrom app.models import Course, Enrollment, VideoWatchLog, SessionCompletion, PageTimeLog, AssignmentSubmission, QuizQuestion, QuizAttempt, SubjectMember\nfrom datetime import datetime\nimport base64\nimport io\nimport re\n\nbp = Blueprint('sessions', __name__, url_prefix='/sessions')\n\ndef has_course_access(course, user, roles=['instructor', 'assistant']):\n    if course.instructor_id == user.id:\n        return True\n    if course.subject_id:\n        member = SubjectMember.query.filter_by(subject_id=course.subject_id, user_id=user.id).first()\n        if member and member.role in roles:\n            return True\n    return False\n\ndef get_youtube_video_id(url):\n    if not url:\n        return None\n    patterns = [\n        r'(?:youtube\\.com\\/watch\\?v=|youtu\\.be\\/|youtube\\.com\\/embed\\/)([a-zA-Z0-9_-]{11})',\n        r'youtube\\.com\\/shorts\\/([a-zA-Z0-9_-]{11})'\n    ]\n    for pattern in patterns:\n        match = re.search(pattern, url)\n        if match:\n            return match.group(1)\n    return None\n\n@bp.route('/<int:course_id>/video')\n@login_required\ndef video_session(course_id):\n    course = Course.query.get_or_404(course_id)\n    \n    if course.session_type not in ['video', 'video_external']:\n        flash('동영상 세션이 아닙니다.', 'warning')\n        return redirect(url_for('courses.view', course_id=course_id))\n    \n    if not current_user.is_instructor() and not current_user.is_enrolled(course):\n        flash('이 세션에 접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    is_instructor = has_course_access(course, current_user)\n    \n    watch_log = VideoWatchLog.query.filter_by(\n        course_id=course_id,\n        user_id=current_user.id\n    ).first()\n    \n    completion = SessionCompletion.query.filter_by(\n        course_id=course_id,\n        user_id=current_user.id\n    ).first()\n    \n    youtube_id = get_youtube_video_id(course.video_url) if course.video_url else None\n    is_youtube = youtube_id is not None\n    \n    page_time = PageTimeLog.query.filter_by(\n        course_id=course_id,\n        user_id=current_user.id\n    ).first()\n    \n    return render_template('sessions/video.html',\n                         course=course,\n                         watch_log=watch_log,\n                         completion=completion,\n                         is_instructor=is_instructor,\n                         is_youtube=is_youtube,\n                         youtube_id=youtube_id,\n                         page_time=page_time)\n\n@bp.route('/<int:course_id>/video/stream')\n@login_required\ndef video_stream(course_id):\n    course = Course.query.get_or_404(course_id)\n    \n    if not course.video_file_path:\n        return jsonify({'error': '동영상 파일이 없습니다.'}), 404\n    \n    if not current_user.is_instructor() and not current_user.is_enrolled(course):\n        return jsonify({'error': '접근 권한이 없습니다.'}), 403\n    \n    try:\n        video_data = base64.b64decode(course.video_file_path)\n        return send_file(\n            io.BytesIO(video_data),\n            mimetype='video/mp4',\n            as_attachment=False\n        )\n    except Exception as e:\n        return jsonify({'error': str(e)}), 500\n\n@bp.route('/<int:course_id>/video/log', methods=['POST'])\n@login_required\ndef log_video_watch(course_id):\n    course = Course.query.get_or_404(course_id)\n    \n    if not current_user.is_enrolled(course) and not has_course_access(course, current_user):\n        return jsonify({'error': '접근 권한이 없습니다.'}), 403\n    \n    data = request.get_json()\n    watched_seconds = data.get('watched_seconds', 0)\n    total_duration = data.get('total_duration', 0)\n    last_position = data.get('last_position', 0)\n    \n    watch_log = VideoWatchLog.query.filter_by(\n        course_id=course_id,\n        user_id=current_user.id\n    ).first()\n    \n    if not watch_log:\n        watch_log = VideoWatchLog(\n            course_id=course_id,\n            user_id=current_user.id\n        )\n        db.session.add(watch_log)\n    \n    watch_log.watched_seconds = max(watch_log.watched_seconds, watched_seconds)\n    watch_log.total_duration = total_duration\n    watch_log.last_position = last_position\n    watch_log.play_count += 1 if data.get('is_new_play') else 0\n    \n    if total_duration > 0:\n        watch_log.watch_percentage = min(100.0, (watch_log.watched_seconds / total_duration) * 100)\n    \n    db.session.commit()\n    \n    return jsonify({\n        'success': True,\n        'watch_percentage': watch_log.watch_percentage,\n        'watched_seconds': watch_log.watched_seconds\n    })\n\n@bp.route('/<int:course_id>/material')\n@login_required\ndef material_session(course_id):\n    course = Course.query.get_or_404(course_id)\n    \n    if course.session_type != 'material':\n        flash('학습 자료 세션이 아닙니다.', 'warning')\n        return redirect(url_for('courses.view', course_id=course_id))\n    \n    if not current_user.is_instructor() and not current_user.is_enrolled(course):\n        flash('이 세션에 접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    is_instructor = has_course_access(course, current_user)\n    \n    completion = SessionCompletion.query.filter_by(\n        course_id=course_id,\n        user_id=current_user.id\n    ).first()\n    \n    page_time = PageTimeLog.query.filter_by(\n        course_id=course_id,\n        user_id=current_user.id\n    ).first()\n    \n    return render_template('sessions/material.html',\n                         course=course,\n                         completion=completion,\n                         page_time=page_time,\n                         is_instructor=is_instructor)\n\n@bp.route('/<int:course_id>/material/download')\n@login_required\ndef material_download(course_id):\n    course = Course.query.get_or_404(course_id)\n    \n    if not course.material_file_path:\n        flash('파일이 없습니다.', 'warning')\n        return redirect(url_for('sessions.material_session', course_id=course_id))\n    \n    if not current_user.is_instructor() and not current_user.is_enrolled(course):\n        flash('접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    try:\n        file_data = base64.b64decode(course.material_file_path)\n        return send_file(\n            io.BytesIO(file_data),\n            mimetype=course.material_file_type or 'application/octet-stream',\n            as_attachment=True,\n            download_name=course.material_file_name or 'material'\n        )\n    except Exception as e:\n        flash(f'파일 다운로드 오류: {str(e)}', 'danger')\n        return redirect(url_for('sessions.material_session', course_id=course_id))\n\n@bp.route('/<int:course_id>/assignment')\n@login_required\ndef assignment_session(course_id):\n    course = Course.query.get_or_404(course_id)\n    \n    if course.session_type != 'assignment':\n        flash('과제 세션이 아닙니다.', 'warning')\n        return redirect(url_for('courses.view', course_id=course_id))\n    \n    if not current_user.is_instructor() and not current_user.is_enrolled(course):\n        flash('이 세션에 접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    is_instructor = has_course_access(course, current_user)\n    \n    completion = SessionCompletion.query.filter_by(\n        course_id=course_id,\n        user_id=current_user.id\n    ).first()\n    \n    submission = AssignmentSubmission.query.filter_by(\n        course_id=course_id,\n        user_id=current_user.id\n    ).first()\n    \n    all_submissions = None\n    if is_instructor:\n        all_submissions = AssignmentSubmission.query.filter_by(course_id=course_id).all()\n    \n    page_time = PageTimeLog.query.filter_by(\n        course_id=course_id,\n        user_id=current_user.id\n    ).first()\n    \n    return render_template('sessions/assignment.html',\n                         course=course,\n                         completion=completion,\n                         submission=submission,\n                         is_instructor=is_instructor,\n                         all_submissions=all_submissions,\n                         page_time=page_time,\n                         now=datetime.utcnow())\n\n@bp.route('/<int:course_id>/assignment/submit', methods=['POST'])\n@login_required\ndef submit_assignment(course_id):\n    course = Course.query.get_or_404(course_id)\n    \n    if course.session_type != 'assignment':\n        return jsonify({'error': '과제 세션이 아닙니다.'}), 400\n    \n    if not current_user.is_enrolled(course):\n        return jsonify({'error': '접근 권한이 없습니다.'}), 403\n    \n    content = request.form.get('content', '')\n    file = request.files.get('file')\n    \n    submission = AssignmentSubmission.query.filter_by(\n        course_id=course_id,\n        user_id=current_user.id\n    ).first()\n    \n    if not submission:\n        submission = AssignmentSubmission(\n            course_id=course_id,\n            user_id=current_user.id\n        )\n        db.session.add(submission)\n    \n    submission.content = content\n    submission.submitted_at = datetime.utcnow()\n    \n    if file and file.filename:\n        file_data = file.read()\n        if len(file_data) > 100 * 1024 * 1024:\n            return jsonify({'error': '파일 크기가 100MB를 초과합니다.'}), 400\n        submission.file_path = base64.b64encode(file_data).decode('utf-8')\n        submission.file_name = file.filename\n    \n    db.session.commit()\n    \n    flash('과제가 제출되었습니다.', 'success')\n    return redirect(url_for('sessions.assignment_session', course_id=course_id))\n\n@bp.route('/<int:course_id>/quiz')\n@login_required\ndef quiz_session(course_id):\n    course = Course.query.get_or_404(course_id)\n    \n    if course.session_type != 'quiz':\n        flash('퀴즈 세션이 아닙니다.', 'warning')\n        return redirect(url_for('courses.view', course_id=course_id))\n    \n    if not current_user.is_instructor() and not current_user.is_enrolled(course):\n        flash('이 세션에 접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    is_instructor = has_course_access(course, current_user)\n    \n    completion = SessionCompletion.query.filter_by(\n        course_id=course_id,\n        user_id=current_user.id\n    ).first()\n    \n    questions = QuizQuestion.query.filter_by(course_id=course_id).order_by(QuizQuestion.order).all()\n    \n    attempt = QuizAttempt.query.filter_by(\n        course_id=course_id,\n        user_id=current_user.id\n    ).order_by(QuizAttempt.started_at.desc()).first()\n    \n    all_attempts = None\n    if is_instructor:\n        all_attempts = QuizAttempt.query.filter_by(course_id=course_id).all()\n    \n    return render_template('sessions/quiz.html',\n                         course=course,\n                         completion=completion,\n                         questions=questions,\n                         attempt=attempt,\n                         is_instructor=is_instructor,\n                         all_attempts=all_attempts)\n\n@bp.route('/<int:course_id>/quiz/start', methods=['POST'])\n@login_required\ndef start_quiz(course_id):\n    course = Course.query.get_or_404(course_id)\n    \n    if course.session_type != 'quiz':\n        return jsonify({'error': '퀴즈 세션이 아닙니다.'}), 400\n    \n    if not current_user.is_enrolled(course):\n        return jsonify({'error': '접근 권한이 없습니다.'}), 403\n    \n    existing = QuizAttempt.query.filter_by(\n        course_id=course_id,\n        user_id=current_user.id,\n        completed_at=None\n    ).first()\n    \n    if existing:\n        return jsonify({'success': True, 'attempt_id': existing.id})\n    \n    questions = QuizQuestion.query.filter_by(course_id=course_id).all()\n    max_score = sum(q.points for q in questions)\n    \n    attempt = QuizAttempt(\n        course_id=course_id,\n        user_id=current_user.id,\n        max_score=max_score\n    )\n    db.session.add(attempt)\n    db.session.commit()\n    \n    return jsonify({'success': True, 'attempt_id': attempt.id})\n\n@bp.route('/<int:course_id>/quiz/submit', methods=['POST'])\n@login_required\ndef submit_quiz(course_id):\n    course = Course.query.get_or_404(course_id)\n    \n    if course.session_type != 'quiz':\n        return jsonify({'error': '퀴즈 세션이 아닙니다.'}), 400\n    \n    if not current_user.is_enrolled(course):\n        return jsonify({'error': '접근 권한이 없습니다.'}), 403\n    \n    attempt = QuizAttempt.query.filter_by(\n        course_id=course_id,\n        user_id=current_user.id,\n        completed_at=None\n    ).first()\n    \n    if not attempt:\n        return jsonify({'error': '진행 중인 퀴즈가 없습니다.'}), 400\n    \n    answers = request.get_json().get('answers', {})\n    questions = QuizQuestion.query.filter_by(course_id=course_id).all()\n    \n    score = 0\n    for q in questions:\n        user_answer = answers.get(str(q.id), '')\n        if user_answer.strip().lower() == q.correct_answer.strip().lower():\n            score += q.points\n    \n    import json\n    attempt.answers = json.dumps(answers)\n    attempt.score = score\n    attempt.completed_at = datetime.utcnow()\n    \n    db.session.commit()\n    \n    passed = False\n    if course.quiz_pass_score:\n        passed = score >= course.quiz_pass_score\n    else:\n        passed = score >= (attempt.max_score * 0.6)\n    \n    if passed:\n        completion = SessionCompletion.query.filter_by(\n            course_id=course_id,\n            user_id=current_user.id\n        ).first()\n        if not completion:\n            completion = SessionCompletion(\n                course_id=course_id,\n                user_id=current_user.id,\n                completion_type='quiz_pass'\n            )\n            db.session.add(completion)\n            db.session.commit()\n    \n    return jsonify({\n        'success': True,\n        'score': score,\n        'max_score': attempt.max_score,\n        'passed': passed,\n        'attempt_id': attempt.id\n    })\n\n@bp.route('/<int:course_id>/quiz/result/<int:attempt_id>')\n@login_required\ndef quiz_result(course_id, attempt_id):\n    course = Course.query.get_or_404(course_id)\n    attempt = QuizAttempt.query.get_or_404(attempt_id)\n    \n    if attempt.course_id != course_id:\n        flash('잘못된 접근입니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    if attempt.user_id != current_user.id and not has_course_access(course, current_user):\n        flash('접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    if not attempt.completed_at:\n        flash('아직 완료되지 않은 퀴즈입니다.', 'warning')\n        return redirect(url_for('sessions.quiz_session', course_id=course_id))\n    \n    questions = QuizQuestion.query.filter_by(course_id=course_id).all()\n    \n    import json\n    user_answers = json.loads(attempt.answers) if attempt.answers else {}\n    \n    correct_count = 0\n    question_results = []\n    for q in questions:\n        user_answer = user_answers.get(str(q.id), '')\n        is_correct = user_answer.strip().lower() == q.correct_answer.strip().lower()\n        if is_correct:\n            correct_count += 1\n        question_results.append({\n            'question': q,\n            'user_answer': user_answer,\n            'is_correct': is_correct\n        })\n    \n    passed = False\n    if course.quiz_pass_score:\n        passed = attempt.score >= course.quiz_pass_score\n    else:\n        passed = attempt.score >= (attempt.max_score * 0.6)\n    \n    if passed:\n        comment = \"축하합니다! 퀴즈를 통과했습니다. 다음 학습으로 진행하세요.\"\n    else:\n        wrong_count = len(questions) - correct_count\n        if wrong_count <= len(questions) * 0.2:\n            comment = \"조금만 더 노력하면 합격할 수 있습니다! 틀린 문제를 다시 확인해보세요.\"\n        elif wrong_count <= len(questions) * 0.5:\n            comment = \"학습 내용을 한 번 더 복습하고 다시 도전해보세요. 핵심 개념 위주로 정리하면 도움이 됩니다.\"\n        else:\n            comment = \"학습 자료를 처음부터 다시 꼼꼼하게 살펴보세요. 필요하다면 관련 보충 자료도 함께 학습해보세요.\"\n    \n    return render_template('sessions/quiz_result.html',\n                         course=course,\n                         attempt=attempt,\n                         questions=questions,\n                         question_results=question_results,\n                         correct_count=correct_count,\n                         passed=passed,\n                         comment=comment)\n\n@bp.route('/<int:course_id>/complete', methods=['POST'])\n@login_required\ndef mark_complete(course_id):\n    course = Course.query.get_or_404(course_id)\n    \n    if not current_user.is_enrolled(course) and not has_course_access(course, current_user):\n        return jsonify({'error': '접근 권한이 없습니다.'}), 403\n    \n    data = request.get_json() or {}\n    time_spent = data.get('time_spent_seconds', 0)\n    \n    completion = SessionCompletion.query.filter_by(\n        course_id=course_id,\n        user_id=current_user.id\n    ).first()\n    \n    if completion:\n        return jsonify({'success': True, 'message': '이미 완료되었습니다.'})\n    \n    completion = SessionCompletion(\n        course_id=course_id,\n        user_id=current_user.id,\n        completion_type='manual',\n        time_spent_seconds=time_spent\n    )\n    db.session.add(completion)\n    db.session.commit()\n    \n    return jsonify({'success': True, 'message': '완료 처리되었습니다.'})\n\n@bp.route('/<int:course_id>/uncomplete', methods=['POST'])\n@login_required\ndef mark_uncomplete(course_id):\n    course = Course.query.get_or_404(course_id)\n    \n    if not current_user.is_enrolled(course) and not has_course_access(course, current_user):\n        return jsonify({'error': '접근 권한이 없습니다.'}), 403\n    \n    completion = SessionCompletion.query.filter_by(\n        course_id=course_id,\n        user_id=current_user.id\n    ).first()\n    \n    if completion:\n        db.session.delete(completion)\n        db.session.commit()\n    \n    return jsonify({'success': True, 'message': '완료 취소되었습니다.'})\n\n@bp.route('/<int:course_id>/log-time', methods=['POST'])\n@login_required\ndef log_page_time(course_id):\n    course = Course.query.get_or_404(course_id)\n    \n    if not current_user.is_enrolled(course) and not has_course_access(course, current_user):\n        return jsonify({'error': '접근 권한이 없습니다.'}), 403\n    \n    data = request.get_json() or {}\n    seconds = data.get('seconds', 0)\n    \n    page_time = PageTimeLog.query.filter_by(\n        course_id=course_id,\n        user_id=current_user.id\n    ).first()\n    \n    if not page_time:\n        page_time = PageTimeLog(\n            course_id=course_id,\n            user_id=current_user.id\n        )\n        db.session.add(page_time)\n    \n    page_time.total_seconds += seconds\n    page_time.last_active_at = datetime.utcnow()\n    \n    db.session.commit()\n    \n    auto_completed = False\n    min_time = course.min_completion_time or 60\n    \n    if course.session_type in ['video', 'video_external'] and page_time.total_seconds >= min_time:\n        completion = SessionCompletion.query.filter_by(\n            course_id=course_id,\n            user_id=current_user.id\n        ).first()\n        if not completion:\n            completion = SessionCompletion(\n                course_id=course_id,\n                user_id=current_user.id,\n                completion_type='auto_time',\n                time_spent_seconds=page_time.total_seconds\n            )\n            db.session.add(completion)\n            db.session.commit()\n            auto_completed = True\n    \n    return jsonify({\n        'success': True,\n        'total_seconds': page_time.total_seconds,\n        'auto_completed': auto_completed,\n        'min_completion_time': min_time\n    })\n","path":null,"size_bytes":20163,"size_tokens":null},"app/models.py":{"content":"from datetime import datetime\nfrom flask_login import UserMixin\nfrom app import db, login_manager, bcrypt\nimport secrets\nimport string\n\n@login_manager.user_loader\ndef load_user(user_id):\n    return User.query.get(int(user_id))\n\nclass Organization(db.Model):\n    __tablename__ = 'organizations'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    name = db.Column(db.String(200), nullable=False)\n    description = db.Column(db.Text)\n    logo = db.Column(db.Text, nullable=True)\n    is_active = db.Column(db.Boolean, default=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    members = db.relationship('User', backref='org', lazy='dynamic')\n    subjects = db.relationship('Subject', backref='org', lazy='dynamic')\n\nclass User(db.Model, UserMixin):\n    __tablename__ = 'users'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    username = db.Column(db.String(80), unique=True, nullable=False)\n    email = db.Column(db.String(120), unique=True, nullable=False)\n    password_hash = db.Column(db.String(255), nullable=False)\n    role = db.Column(db.String(20), nullable=False, default='student')\n    organization_id = db.Column(db.Integer, db.ForeignKey('organizations.id'), nullable=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    # Profile fields\n    profile_image = db.Column(db.Text, nullable=True)\n    nickname = db.Column(db.String(80), nullable=True)\n    full_name = db.Column(db.String(120), nullable=True)\n    profile_url = db.Column(db.String(255), nullable=True)\n    bio = db.Column(db.Text, nullable=True)\n    \n    # Basic info\n    phone = db.Column(db.String(20), nullable=True)\n    \n    # Additional info\n    organization_name = db.Column(db.String(200), nullable=True)\n    position = db.Column(db.String(100), nullable=True)\n    job_title = db.Column(db.String(100), nullable=True)\n    \n    # Instructor verification\n    instructor_verified = db.Column(db.Boolean, default=False)\n    verification_requested_at = db.Column(db.DateTime, nullable=True)\n    \n    courses_taught = db.relationship('Course', backref='instructor', lazy='dynamic')\n    enrollments = db.relationship('Enrollment', backref='user', lazy='dynamic')\n    progress_records = db.relationship('Progress', backref='user', lazy='dynamic')\n    \n    def set_password(self, password):\n        self.password_hash = bcrypt.generate_password_hash(password).decode('utf-8')\n    \n    def check_password(self, password):\n        return bcrypt.check_password_hash(self.password_hash, password)\n    \n    def is_student(self):\n        return self.role == 'student'\n    \n    def is_instructor(self):\n        return self.role in ['instructor', 'org_admin', 'system_admin']\n    \n    def is_org_admin(self):\n        return self.role == 'org_admin'\n    \n    def is_system_admin(self):\n        return self.role == 'system_admin'\n    \n    @property\n    def display_name(self):\n        if self.nickname:\n            return self.nickname\n        if self.full_name:\n            return self.full_name\n        return self.username\n    \n    @property\n    def initial(self):\n        name = self.display_name\n        if name:\n            return name[0].upper()\n        return '?'\n    \n    def can_access_subject(self, subject):\n        if self.is_system_admin():\n            return True\n        if self.is_org_admin() and subject.organization_id == self.organization_id:\n            return True\n        if subject.instructor_id == self.id:\n            return True\n        return False\n    \n    def is_enrolled(self, course):\n        return Enrollment.query.filter_by(user_id=self.id, course_id=course.id).first() is not None\n\nclass Subject(db.Model):\n    __tablename__ = 'subjects'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    title = db.Column(db.String(200), nullable=False)\n    description = db.Column(db.Text)\n    instructor_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    organization_id = db.Column(db.Integer, db.ForeignKey('organizations.id'), nullable=True)\n    invite_code = db.Column(db.String(10), unique=True, nullable=False)\n    is_visible = db.Column(db.Boolean, default=True)\n    deleted_at = db.Column(db.DateTime, nullable=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    instructor = db.relationship('User', backref='subjects_taught')\n    courses = db.relationship('Course', backref='subject', lazy='dynamic', cascade='all, delete-orphan')\n    members = db.relationship('SubjectMember', backref='member_subject', lazy='dynamic')\n    \n    @staticmethod\n    def generate_invite_code():\n        chars = string.ascii_uppercase + string.digits\n        while True:\n            code = ''.join(secrets.choice(chars) for _ in range(8))\n            if not Subject.query.filter_by(invite_code=code).first():\n                return code\n    \n    def get_enrolled_students(self):\n        return User.query.join(Enrollment).join(Course).filter(\n            Course.subject_id == self.id,\n            User.role == 'student'\n        ).distinct().all()\n\nclass Course(db.Model):\n    __tablename__ = 'courses'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    subject_id = db.Column(db.Integer, db.ForeignKey('subjects.id'), nullable=True)\n    title = db.Column(db.String(200), nullable=False)\n    description = db.Column(db.Text)\n    week_number = db.Column(db.Integer, nullable=True)  # deprecated, use order_number\n    session_number = db.Column(db.Integer, nullable=True)  # deprecated, use order_number\n    order_number = db.Column(db.Integer, nullable=True)\n    instructor_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    invite_code = db.Column(db.String(10), unique=True, nullable=False)\n    deleted_at = db.Column(db.DateTime, nullable=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    session_type = db.Column(db.String(30), default='live_session')\n    \n    start_date = db.Column(db.DateTime, nullable=True)\n    end_date = db.Column(db.DateTime, nullable=True)\n    attendance_start = db.Column(db.DateTime, nullable=True)\n    attendance_end = db.Column(db.DateTime, nullable=True)\n    late_allowed = db.Column(db.Boolean, default=False)\n    late_end = db.Column(db.DateTime, nullable=True)\n    visibility = db.Column(db.String(20), default='public')\n    prerequisite_course_id = db.Column(db.Integer, db.ForeignKey('courses.id'), nullable=True)\n    \n    video_url = db.Column(db.Text, nullable=True)\n    video_file_path = db.Column(db.Text, nullable=True)\n    video_file_name = db.Column(db.String(255), nullable=True)\n    \n    material_file_path = db.Column(db.Text, nullable=True)\n    material_file_name = db.Column(db.String(255), nullable=True)\n    material_file_type = db.Column(db.String(50), nullable=True)\n    \n    assignment_description = db.Column(db.Text, nullable=True)\n    assignment_due_date = db.Column(db.DateTime, nullable=True)\n    \n    quiz_time_limit = db.Column(db.Integer, nullable=True)\n    quiz_pass_score = db.Column(db.Integer, nullable=True)\n    \n    min_completion_time = db.Column(db.Integer, nullable=True)\n    \n    preparation_status = db.Column(db.String(30), default='not_ready')\n    \n    prerequisite = db.relationship('Course', remote_side=[id], backref='dependent_courses')\n    \n    enrollments = db.relationship('Enrollment', backref='course', lazy='dynamic', cascade='all, delete-orphan')\n    checkpoints = db.relationship('Checkpoint', backref='course', lazy='dynamic', cascade='all, delete-orphan')\n    active_sessions = db.relationship('ActiveSession', backref='course', lazy='dynamic', cascade='all, delete-orphan')\n    \n    @staticmethod\n    def generate_invite_code():\n        chars = string.ascii_uppercase + string.digits\n        while True:\n            code = ''.join(secrets.choice(chars) for _ in range(8))\n            if not Course.query.filter_by(invite_code=code).first():\n                return code\n    \n    def get_enrolled_students(self):\n        return User.query.join(Enrollment).filter(\n            Enrollment.course_id == self.id,\n            User.role == 'student'\n        ).all()\n    \n    def is_accessible_by(self, user):\n        if self.instructor_id == user.id:\n            return True\n        if not user.is_enrolled(self):\n            return False\n        if self.visibility == 'public':\n            return True\n        if self.visibility == 'private':\n            return False\n        if self.visibility == 'date_based':\n            now = datetime.utcnow()\n            if self.start_date and now < self.start_date:\n                return False\n            if self.end_date and now > self.end_date:\n                return False\n            return True\n        if self.visibility == 'prerequisite':\n            if not self.prerequisite_course_id:\n                return True\n            prereq_completed = Progress.query.join(Checkpoint).filter(\n                Progress.user_id == user.id,\n                Progress.completed_at.isnot(None),\n                Checkpoint.course_id == self.prerequisite_course_id\n            ).count()\n            total_checkpoints = Checkpoint.query.filter_by(\n                course_id=self.prerequisite_course_id,\n                deleted_at=None\n            ).count()\n            return prereq_completed >= total_checkpoints and total_checkpoints > 0\n        return True\n\nclass Enrollment(db.Model):\n    __tablename__ = 'enrollments'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    course_id = db.Column(db.Integer, db.ForeignKey('courses.id'), nullable=False, index=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False, index=True)\n    enrolled_at = db.Column(db.DateTime, default=datetime.utcnow)\n    status = db.Column(db.String(20), default='approved')\n    \n    __table_args__ = (db.UniqueConstraint('course_id', 'user_id', name='unique_enrollment'),)\n\nclass Checkpoint(db.Model):\n    __tablename__ = 'checkpoints'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    course_id = db.Column(db.Integer, db.ForeignKey('courses.id'), nullable=False, index=True)\n    title = db.Column(db.String(200), nullable=False)\n    description = db.Column(db.Text)\n    order = db.Column(db.Integer, nullable=False, default=0)\n    estimated_minutes = db.Column(db.Integer)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    deleted_at = db.Column(db.DateTime, nullable=True)\n    \n    progress_records = db.relationship('Progress', backref='checkpoint', lazy='dynamic', cascade='all, delete-orphan')\n    \n    def is_deleted(self):\n        return self.deleted_at is not None\n\nclass Progress(db.Model):\n    __tablename__ = 'progress'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False, index=True)\n    checkpoint_id = db.Column(db.Integer, db.ForeignKey('checkpoints.id'), nullable=False, index=True)\n    mode = db.Column(db.String(20), nullable=False, default='self_paced')\n    started_at = db.Column(db.DateTime)\n    completed_at = db.Column(db.DateTime)\n    duration_seconds = db.Column(db.Integer)\n    paused_at = db.Column(db.DateTime, nullable=True)\n    accumulated_seconds = db.Column(db.Integer, default=0)\n    is_paused = db.Column(db.Boolean, default=False)\n    \n    __table_args__ = (db.UniqueConstraint('user_id', 'checkpoint_id', 'mode', name='unique_progress'),)\n    \n    def calculate_duration(self):\n        if self.started_at and self.completed_at:\n            delta = self.completed_at - self.started_at\n            self.duration_seconds = int(delta.total_seconds())\n    \n    def get_elapsed_seconds(self):\n        accumulated = self.accumulated_seconds or 0\n        \n        if self.completed_at:\n            return self.duration_seconds or accumulated\n        \n        if not self.started_at:\n            return accumulated\n        \n        if self.is_paused:\n            return accumulated\n        \n        current_session = (datetime.utcnow() - self.started_at).total_seconds()\n        return int(accumulated + current_session)\n\nclass ActiveSession(db.Model):\n    __tablename__ = 'active_sessions'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    course_id = db.Column(db.Integer, db.ForeignKey('courses.id'), nullable=False, index=True)\n    mode = db.Column(db.String(20), nullable=False, default='live')\n    session_type = db.Column(db.String(20), nullable=False, default='immediate')\n    live_status = db.Column(db.String(20), default='preparing')\n    scheduled_at = db.Column(db.DateTime, nullable=True)\n    started_at = db.Column(db.DateTime, default=datetime.utcnow)\n    ended_at = db.Column(db.DateTime, nullable=True)\n    current_checkpoint_id = db.Column(db.Integer, db.ForeignKey('checkpoints.id'), nullable=True)\n    \n    def is_scheduled(self):\n        return self.session_type == 'scheduled'\n    \n    def can_start(self):\n        if self.session_type == 'immediate':\n            return True\n        if self.scheduled_at:\n            return datetime.utcnow() >= self.scheduled_at\n        return False\n    \n    def get_live_status_display(self):\n        status_map = {\n            'preparing': '라이브 준비중',\n            'live': '라이브 중',\n            'ended': '라이브 종료'\n        }\n        return status_map.get(self.live_status, '대기중')\n\nclass UnderstandingStatus(db.Model):\n    __tablename__ = 'understanding_status'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    checkpoint_id = db.Column(db.Integer, db.ForeignKey('checkpoints.id'), nullable=False)\n    session_id = db.Column(db.Integer, db.ForeignKey('active_sessions.id'), nullable=False)\n    status = db.Column(db.String(20), nullable=False)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    \n    user = db.relationship('User', backref='understanding_records')\n    checkpoint = db.relationship('Checkpoint', backref='understanding_records')\n\nclass ChatMessage(db.Model):\n    __tablename__ = 'chat_messages'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    course_id = db.Column(db.Integer, db.ForeignKey('courses.id'), nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    message = db.Column(db.Text, nullable=False)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    \n    user = db.relationship('User', backref='chat_messages')\n    course = db.relationship('Course', backref='chat_messages')\n\nclass ForumPost(db.Model):\n    __tablename__ = 'forum_posts'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    course_id = db.Column(db.Integer, db.ForeignKey('courses.id'), nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    title = db.Column(db.String(200), nullable=False)\n    content = db.Column(db.Text, nullable=False)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    user = db.relationship('User', backref='forum_posts')\n    course = db.relationship('Course', backref='forum_posts')\n    comments = db.relationship('ForumComment', backref='post', lazy='dynamic', cascade='all, delete-orphan')\n\nclass ForumComment(db.Model):\n    __tablename__ = 'forum_comments'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    post_id = db.Column(db.Integer, db.ForeignKey('forum_posts.id'), nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    content = db.Column(db.Text, nullable=False)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    \n    user = db.relationship('User', backref='forum_comments')\n\nclass LiveSessionPost(db.Model):\n    __tablename__ = 'live_session_posts'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    session_id = db.Column(db.Integer, db.ForeignKey('active_sessions.id'), nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    title = db.Column(db.String(200), nullable=False)\n    content = db.Column(db.Text, nullable=False)\n    pinned = db.Column(db.Boolean, default=False)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    user = db.relationship('User', backref='live_session_posts')\n    session = db.relationship('ActiveSession', backref='posts')\n    comments = db.relationship('LiveSessionComment', backref='post', lazy='dynamic', cascade='all, delete-orphan')\n\nclass LiveSessionComment(db.Model):\n    __tablename__ = 'live_session_comments'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    post_id = db.Column(db.Integer, db.ForeignKey('live_session_posts.id'), nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    content = db.Column(db.Text, nullable=False)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    \n    user = db.relationship('User', backref='live_session_comments')\n\nclass Attendance(db.Model):\n    __tablename__ = 'attendance'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    course_id = db.Column(db.Integer, db.ForeignKey('courses.id'), nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    session_id = db.Column(db.Integer, db.ForeignKey('active_sessions.id'), nullable=True)\n    status = db.Column(db.String(20), default='present')\n    checked_at = db.Column(db.DateTime, default=datetime.utcnow)\n    checked_by_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=True)\n    notes = db.Column(db.Text, nullable=True)\n    \n    course = db.relationship('Course', backref='attendance_records')\n    user = db.relationship('User', foreign_keys=[user_id], backref='attendance_records')\n    session = db.relationship('ActiveSession', backref='attendance_records')\n    checked_by = db.relationship('User', foreign_keys=[checked_by_id])\n    \n    __table_args__ = (db.UniqueConstraint('course_id', 'user_id', 'session_id', name='unique_attendance'),)\n\n\n# Community Models\nclass LearningReview(db.Model):\n    __tablename__ = 'learning_reviews'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    course_id = db.Column(db.Integer, db.ForeignKey('courses.id'), nullable=True)\n    subject_id = db.Column(db.Integer, db.ForeignKey('subjects.id'), nullable=True)\n    title = db.Column(db.String(200), nullable=False)\n    content = db.Column(db.Text, nullable=False)\n    rating = db.Column(db.Integer, default=5)\n    likes_count = db.Column(db.Integer, default=0)\n    views_count = db.Column(db.Integer, default=0)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    user = db.relationship('User', backref='learning_reviews')\n    course = db.relationship('Course', backref='reviews')\n    subject = db.relationship('Subject', backref='reviews')\n    comments = db.relationship('ReviewComment', backref='review', lazy='dynamic', cascade='all, delete-orphan')\n\nclass ReviewComment(db.Model):\n    __tablename__ = 'review_comments'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    review_id = db.Column(db.Integer, db.ForeignKey('learning_reviews.id'), nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    content = db.Column(db.Text, nullable=False)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    \n    user = db.relationship('User', backref='review_comments')\n\nclass QnAPost(db.Model):\n    __tablename__ = 'qna_posts'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    course_id = db.Column(db.Integer, db.ForeignKey('courses.id'), nullable=True)\n    subject_id = db.Column(db.Integer, db.ForeignKey('subjects.id'), nullable=True)\n    title = db.Column(db.String(200), nullable=False)\n    content = db.Column(db.Text, nullable=False)\n    is_resolved = db.Column(db.Boolean, default=False)\n    views_count = db.Column(db.Integer, default=0)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    user = db.relationship('User', backref='qna_posts')\n    course = db.relationship('Course', backref='qna_posts')\n    subject = db.relationship('Subject', backref='qna_posts')\n    answers = db.relationship('QnAAnswer', backref='post', lazy='dynamic', cascade='all, delete-orphan')\n\nclass QnAAnswer(db.Model):\n    __tablename__ = 'qna_answers'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    post_id = db.Column(db.Integer, db.ForeignKey('qna_posts.id'), nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    content = db.Column(db.Text, nullable=False)\n    is_accepted = db.Column(db.Boolean, default=False)\n    likes_count = db.Column(db.Integer, default=0)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    user = db.relationship('User', backref='qna_answers')\n\nclass StudyGroup(db.Model):\n    __tablename__ = 'study_groups'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    creator_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    title = db.Column(db.String(200), nullable=False)\n    description = db.Column(db.Text, nullable=False)\n    category = db.Column(db.String(50), default='general')\n    max_members = db.Column(db.Integer, default=10)\n    current_members = db.Column(db.Integer, default=1)\n    status = db.Column(db.String(20), default='recruiting')\n    meeting_type = db.Column(db.String(20), default='online')\n    meeting_schedule = db.Column(db.String(200), nullable=True)\n    tags = db.Column(db.Text, nullable=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    creator = db.relationship('User', backref='created_study_groups')\n    members = db.relationship('StudyGroupMember', backref='group', lazy='dynamic', cascade='all, delete-orphan')\n\nclass StudyGroupMember(db.Model):\n    __tablename__ = 'study_group_members'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    group_id = db.Column(db.Integer, db.ForeignKey('study_groups.id'), nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    status = db.Column(db.String(20), default='pending')\n    joined_at = db.Column(db.DateTime, default=datetime.utcnow)\n    \n    user = db.relationship('User', backref='study_group_memberships')\n    \n    __table_args__ = (db.UniqueConstraint('group_id', 'user_id', name='unique_group_member'),)\n\n\nclass SubjectEnrollment(db.Model):\n    __tablename__ = 'subject_enrollments'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    subject_id = db.Column(db.Integer, db.ForeignKey('subjects.id'), nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    status = db.Column(db.String(20), default='pending')  # pending, approved, rejected\n    role = db.Column(db.String(20), default='student')  # student, ta, auditor\n    enrolled_at = db.Column(db.DateTime, default=datetime.utcnow)\n    approved_at = db.Column(db.DateTime, nullable=True)\n    rejected_at = db.Column(db.DateTime, nullable=True)\n    \n    user = db.relationship('User', backref='subject_enrollments')\n    subject = db.relationship('Subject', backref='subject_enrollment_list')\n    \n    __table_args__ = (db.UniqueConstraint('subject_id', 'user_id', name='unique_subject_enrollment'),)\n\n\nclass GuidePost(db.Model):\n    __tablename__ = 'guide_posts'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    category = db.Column(db.String(50), nullable=False)\n    title = db.Column(db.String(300), nullable=False)\n    content = db.Column(db.Text, nullable=False)\n    author_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    is_pinned = db.Column(db.Boolean, default=False)\n    is_answered = db.Column(db.Boolean, default=False)\n    view_count = db.Column(db.Integer, default=0)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    author = db.relationship('User', backref='guide_posts')\n    comments = db.relationship('GuideComment', backref='post', lazy='dynamic', cascade='all, delete-orphan')\n    attachments = db.relationship('GuideAttachment', backref='post', lazy='dynamic', cascade='all, delete-orphan')\n\n\nclass GuideComment(db.Model):\n    __tablename__ = 'guide_comments'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    post_id = db.Column(db.Integer, db.ForeignKey('guide_posts.id'), nullable=False)\n    author_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    content = db.Column(db.Text, nullable=False)\n    is_admin_reply = db.Column(db.Boolean, default=False)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    \n    author = db.relationship('User', backref='guide_comments')\n\n\nclass GuideAttachment(db.Model):\n    __tablename__ = 'guide_attachments'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    post_id = db.Column(db.Integer, db.ForeignKey('guide_posts.id'), nullable=False)\n    filename = db.Column(db.String(255), nullable=False)\n    original_filename = db.Column(db.String(255), nullable=False)\n    file_size = db.Column(db.Integer)\n    file_type = db.Column(db.String(100))\n    file_data = db.Column(db.Text)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n\nclass SubjectMember(db.Model):\n    __tablename__ = 'subject_members'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    subject_id = db.Column(db.Integer, db.ForeignKey('subjects.id'), nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    role = db.Column(db.String(30), nullable=False, default='student')\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    \n    user = db.relationship('User', backref=db.backref('subject_memberships', lazy='dynamic'))\n    \n    __table_args__ = (db.UniqueConstraint('subject_id', 'user_id', name='unique_subject_member'),)\n    \n    @staticmethod\n    def get_role_display(role):\n        role_map = {\n            'instructor': '강사',\n            'assistant': '조교',\n            'student': '학습자'\n        }\n        return role_map.get(role, role)\n\nclass QuizQuestion(db.Model):\n    __tablename__ = 'quiz_questions'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    course_id = db.Column(db.Integer, db.ForeignKey('courses.id'), nullable=False)\n    question_text = db.Column(db.Text, nullable=False)\n    question_type = db.Column(db.String(30), default='multiple_choice')\n    options = db.Column(db.Text)\n    correct_answer = db.Column(db.Text)\n    points = db.Column(db.Integer, default=1)\n    order = db.Column(db.Integer, default=0)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    \n    course = db.relationship('Course', backref=db.backref('quiz_questions', lazy='dynamic'))\n\nclass QuizAttempt(db.Model):\n    __tablename__ = 'quiz_attempts'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    course_id = db.Column(db.Integer, db.ForeignKey('courses.id'), nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    score = db.Column(db.Integer, default=0)\n    max_score = db.Column(db.Integer, default=0)\n    started_at = db.Column(db.DateTime, default=datetime.utcnow)\n    completed_at = db.Column(db.DateTime, nullable=True)\n    answers = db.Column(db.Text)\n    \n    course = db.relationship('Course', backref=db.backref('quiz_attempts', lazy='dynamic'))\n    user = db.relationship('User', backref=db.backref('quiz_attempts', lazy='dynamic'))\n\nclass AssignmentSubmission(db.Model):\n    __tablename__ = 'assignment_submissions'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    course_id = db.Column(db.Integer, db.ForeignKey('courses.id'), nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    content = db.Column(db.Text)\n    file_path = db.Column(db.Text, nullable=True)\n    file_name = db.Column(db.String(255), nullable=True)\n    submitted_at = db.Column(db.DateTime, default=datetime.utcnow)\n    score = db.Column(db.Integer, nullable=True)\n    feedback = db.Column(db.Text, nullable=True)\n    graded_at = db.Column(db.DateTime, nullable=True)\n    graded_by = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=True)\n    \n    course = db.relationship('Course', backref=db.backref('submissions', lazy='dynamic'))\n    user = db.relationship('User', foreign_keys=[user_id], backref=db.backref('submissions', lazy='dynamic'))\n    grader = db.relationship('User', foreign_keys=[graded_by])\n\nclass VideoWatchLog(db.Model):\n    __tablename__ = 'video_watch_logs'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    course_id = db.Column(db.Integer, db.ForeignKey('courses.id'), nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    watched_seconds = db.Column(db.Integer, default=0)\n    total_duration = db.Column(db.Integer, nullable=True)\n    watch_percentage = db.Column(db.Float, default=0.0)\n    last_position = db.Column(db.Integer, default=0)\n    play_count = db.Column(db.Integer, default=0)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    course = db.relationship('Course', backref=db.backref('watch_logs', lazy='dynamic'))\n    user = db.relationship('User', backref=db.backref('video_watch_logs', lazy='dynamic'))\n    \n    __table_args__ = (db.UniqueConstraint('course_id', 'user_id', name='unique_video_watch'),)\n    \n    @property\n    def is_completed(self):\n        return self.watch_percentage >= 80.0\n\nclass SessionCompletion(db.Model):\n    __tablename__ = 'session_completions'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    course_id = db.Column(db.Integer, db.ForeignKey('courses.id'), nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    completed_at = db.Column(db.DateTime, default=datetime.utcnow)\n    completion_type = db.Column(db.String(30), default='manual')\n    time_spent_seconds = db.Column(db.Integer, default=0)\n    notes = db.Column(db.Text, nullable=True)\n    \n    course = db.relationship('Course', backref=db.backref('completions', lazy='dynamic'))\n    user = db.relationship('User', backref=db.backref('session_completions', lazy='dynamic'))\n    \n    __table_args__ = (db.UniqueConstraint('course_id', 'user_id', name='unique_session_completion'),)\n\nclass PageTimeLog(db.Model):\n    __tablename__ = 'page_time_logs'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    course_id = db.Column(db.Integer, db.ForeignKey('courses.id'), nullable=False)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    total_seconds = db.Column(db.Integer, default=0)\n    last_active_at = db.Column(db.DateTime, default=datetime.utcnow)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    course = db.relationship('Course', backref=db.backref('page_time_logs', lazy='dynamic'))\n    user = db.relationship('User', backref=db.backref('page_time_logs', lazy='dynamic'))\n    \n    __table_args__ = (db.UniqueConstraint('course_id', 'user_id', name='unique_page_time'),)\n\n\nclass SlideDeck(db.Model):\n    __tablename__ = 'slide_decks'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    course_id = db.Column(db.Integer, db.ForeignKey('courses.id'), nullable=False, index=True)\n    session_id = db.Column(db.Integer, db.ForeignKey('active_sessions.id'), nullable=True)\n    file_name = db.Column(db.String(255), nullable=False)\n    slide_count = db.Column(db.Integer, default=0)\n    current_slide_index = db.Column(db.Integer, default=0)\n    conversion_status = db.Column(db.String(20), default='pending')\n    conversion_error = db.Column(db.Text, nullable=True)\n    slides_dir = db.Column(db.String(500), nullable=True)\n    estimated_duration_minutes = db.Column(db.Integer, nullable=True)\n    flag_threshold_count = db.Column(db.Integer, default=5)\n    flag_threshold_rate = db.Column(db.Float, default=0.25)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    \n    course = db.relationship('Course', backref=db.backref('slide_decks', lazy='dynamic'))\n    active_session = db.relationship('ActiveSession', backref=db.backref('session_slide_decks', lazy='dynamic'))\n    reactions = db.relationship('SlideReaction', backref='deck', lazy='dynamic', cascade='all, delete-orphan')\n    bookmarks = db.relationship('SlideBookmark', backref='deck', lazy='dynamic', cascade='all, delete-orphan')\n    \n    def get_slide_urls(self):\n        if not self.slides_dir or self.slide_count == 0:\n            return []\n        return [f'/slides/{self.id}/{i}.png' for i in range(self.slide_count)]\n\n\nclass SlideReaction(db.Model):\n    __tablename__ = 'slide_reactions'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    deck_id = db.Column(db.Integer, db.ForeignKey('slide_decks.id'), nullable=False, index=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)\n    slide_index = db.Column(db.Integer, nullable=False)\n    reaction = db.Column(db.String(20), default='none')\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    user = db.relationship('User', backref=db.backref('slide_reactions', lazy='dynamic'))\n    \n    __table_args__ = (db.UniqueConstraint('deck_id', 'user_id', 'slide_index', name='unique_slide_reaction'),)\n\n\nclass SlideBookmark(db.Model):\n    __tablename__ = 'slide_bookmarks'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    deck_id = db.Column(db.Integer, db.ForeignKey('slide_decks.id'), nullable=False, index=True)\n    slide_index = db.Column(db.Integer, nullable=False)\n    is_auto = db.Column(db.Boolean, default=False)\n    is_manual = db.Column(db.Boolean, default=False)\n    reason = db.Column(db.String(100), nullable=True)\n    memo = db.Column(db.Text, nullable=True)\n    supplement_url = db.Column(db.Text, nullable=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)\n    \n    __table_args__ = (db.UniqueConstraint('deck_id', 'slide_index', name='unique_slide_bookmark'),)\n\n\nclass Notification(db.Model):\n    __tablename__ = 'notifications'\n    \n    id = db.Column(db.Integer, primary_key=True)\n    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False, index=True)\n    type = db.Column(db.String(50), nullable=False, index=True)\n    title = db.Column(db.String(255), nullable=False)\n    message = db.Column(db.Text)\n    data = db.Column(db.JSON)\n    is_read = db.Column(db.Boolean, default=False, index=True)\n    created_at = db.Column(db.DateTime, default=datetime.utcnow)\n    \n    user = db.relationship('User', backref=db.backref('notifications', lazy='dynamic'))\n    \n    @staticmethod\n    def create_enrollment_invite(user_id, subject, role='student'):\n        notification = Notification(\n            user_id=user_id,\n            type='enrollment_invite',\n            title=f'{subject.title} 과목 등록 초대',\n            message=f'{subject.instructor.display_name} 강사님이 {subject.title} 과목에 {Notification.get_role_display(role)}(으)로 초대했습니다.',\n            data={'subject_id': subject.id, 'role': role}\n        )\n        db.session.add(notification)\n        return notification\n    \n    @staticmethod\n    def get_role_display(role):\n        role_map = {'student': '학습자', 'ta': '조교', 'auditor': '청강생'}\n        return role_map.get(role, '학습자')\n    \n    @staticmethod\n    def create_enrollment_approved(user_id, subject, role='student'):\n        notification = Notification(\n            user_id=user_id,\n            type='enrollment_approved',\n            title=f'{subject.title} 과목 등록 승인',\n            message=f'{subject.title} 과목에 {Notification.get_role_display(role)}(으)로 등록이 승인되었습니다.',\n            data={'subject_id': subject.id, 'role': role}\n        )\n        db.session.add(notification)\n        return notification\n    \n    @staticmethod\n    def create_enrollment_rejected(user_id, subject, role='student'):\n        notification = Notification(\n            user_id=user_id,\n            type='enrollment_rejected',\n            title=f'{subject.title} 과목 등록 거절',\n            message=f'{subject.title} 과목 등록 신청이 거절되었습니다.',\n            data={'subject_id': subject.id, 'role': role}\n        )\n        db.session.add(notification)\n        return notification\n","path":null,"size_bytes":37757,"size_tokens":null},"pyproject.toml":{"content":"[project]\nname = \"repl-nix-workspace\"\nversion = \"0.1.0\"\ndescription = \"Add your description here\"\nrequires-python = \">=3.11\"\ndependencies = [\n    \"email-validator>=2.3.0\",\n    \"eventlet>=0.40.4\",\n    \"flask>=3.1.2\",\n    \"flask-bcrypt>=1.0.1\",\n    \"flask-login>=0.6.3\",\n    \"flask-migrate>=4.1.0\",\n    \"flask-socketio>=5.6.0\",\n    \"flask-sqlalchemy>=3.1.1\",\n    \"flask-wtf>=1.2.2\",\n    \"google-genai>=1.60.0\",\n    \"gunicorn>=24.1.1\",\n    \"openpyxl>=3.1.5\",\n    \"pdf2image>=1.17.0\",\n    \"pillow>=12.1.0\",\n    \"psycopg2-binary>=2.9.11\",\n    \"python-dotenv>=1.2.1\",\n    \"python-pptx>=1.0.2\",\n]\n","path":null,"size_bytes":590,"size_tokens":null},"app/routes/courses.py":{"content":"from flask import Blueprint, render_template, redirect, url_for, flash, request, jsonify\nfrom flask_login import login_required, current_user\nfrom app import db\nfrom app.models import Course, Enrollment, Checkpoint, Progress, ActiveSession, ChatMessage, LiveSessionPost, SubjectMember, User, Notification, SlideDeck, SlideBookmark, SlideReaction\nfrom app.forms import CourseForm, EnrollForm\nfrom datetime import datetime\n\nbp = Blueprint('courses', __name__, url_prefix='/courses')\n\ndef has_course_access(course, user, roles=['instructor', 'assistant']):\n    if course.instructor_id == user.id:\n        return True\n    if course.subject_id:\n        member = SubjectMember.query.filter_by(subject_id=course.subject_id, user_id=user.id).first()\n        if member and member.role in roles:\n            return True\n    return False\n\n@bp.route('/')\n@login_required\ndef list_courses():\n    is_instructor = current_user.is_instructor()\n    \n    if is_instructor:\n        my_courses = Course.query.filter_by(instructor_id=current_user.id).filter(\n            Course.deleted_at.is_(None),\n            Course.subject_id.is_(None)\n        ).order_by(Course.created_at.desc()).all()\n        enrolled_courses = []\n        public_courses = []\n    else:\n        enrollments = Enrollment.query.filter_by(user_id=current_user.id).all()\n        enrolled_course_ids = [e.course_id for e in enrollments]\n        enrolled_courses = [e.course for e in enrollments \n                          if not e.course.deleted_at \n                          and not e.course.subject_id]\n        \n        public_courses = Course.query.filter(\n            Course.deleted_at.is_(None),\n            Course.subject_id.is_(None),\n            Course.visibility == 'public',\n            ~Course.id.in_(enrolled_course_ids) if enrolled_course_ids else True\n        ).order_by(Course.created_at.desc()).all()\n        my_courses = []\n    \n    return render_template('courses/list.html', \n                          my_courses=my_courses,\n                          enrolled_courses=enrolled_courses,\n                          public_courses=public_courses,\n                          is_instructor=is_instructor)\n\n@bp.route('/create', methods=['GET', 'POST'])\n@login_required\ndef create():\n    if not current_user.is_instructor():\n        flash('강사만 세미나를 생성할 수 있습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    form = CourseForm()\n    if form.validate_on_submit():\n        course = Course(\n            title=form.title.data,\n            description=form.description.data,\n            instructor_id=current_user.id,\n            invite_code=Course.generate_invite_code()\n        )\n        db.session.add(course)\n        db.session.commit()\n        flash('세미나가 생성되었습니다!', 'success')\n        return redirect(url_for('courses.view', course_id=course.id))\n    \n    return render_template('courses/create.html', form=form)\n\n@bp.route('/<int:course_id>')\n@login_required\ndef view(course_id):\n    course = Course.query.get_or_404(course_id)\n    \n    if course.deleted_at:\n        if not has_course_access(course, current_user):\n            flash('해당 세션을 찾을 수 없습니다.', 'danger')\n            return redirect(url_for('main.dashboard'))\n    \n    if course.session_type in ['video', 'video_external']:\n        return redirect(url_for('sessions.video_session', course_id=course_id))\n    elif course.session_type == 'material':\n        return redirect(url_for('sessions.material_session', course_id=course_id))\n    elif course.session_type == 'assignment':\n        return redirect(url_for('sessions.assignment_session', course_id=course_id))\n    elif course.session_type == 'quiz':\n        return redirect(url_for('sessions.quiz_session', course_id=course_id))\n    \n    if current_user.is_instructor():\n        if not has_course_access(course, current_user):\n            flash('이 세미나에 접근 권한이 없습니다.', 'danger')\n            return redirect(url_for('main.dashboard'))\n        students = course.get_enrolled_students()\n        checkpoints = Checkpoint.query.filter_by(course_id=course.id, deleted_at=None).order_by(Checkpoint.order).all()\n        return render_template('courses/view_instructor.html', course=course, students=students, checkpoints=checkpoints)\n    else:\n        if not current_user.is_enrolled(course):\n            flash('이 세미나에 등록되어 있지 않습니다.', 'danger')\n            return redirect(url_for('main.dashboard'))\n        \n        if not course.is_accessible_by(current_user):\n            if course.visibility == 'private':\n                flash('이 세션은 현재 비공개 상태입니다.', 'warning')\n            elif course.visibility == 'date_based':\n                if course.start_date and datetime.utcnow() < course.start_date:\n                    flash(f'이 세션은 {course.start_date.strftime(\"%Y-%m-%d %H:%M\")}에 공개됩니다.', 'info')\n                elif course.end_date and datetime.utcnow() > course.end_date:\n                    flash('이 세션의 공개 기간이 종료되었습니다.', 'warning')\n            elif course.visibility == 'prerequisite':\n                prereq = Course.query.get(course.prerequisite_course_id)\n                if prereq:\n                    flash(f'이 세션에 접근하려면 먼저 \"{prereq.title}\" 세션을 완료해야 합니다.', 'info')\n            return redirect(url_for('main.dashboard'))\n        \n        checkpoints = Checkpoint.query.filter_by(course_id=course.id, deleted_at=None).order_by(Checkpoint.order).all()\n        \n        live_progress = {p.checkpoint_id: p for p in Progress.query.filter_by(\n            user_id=current_user.id, mode='live'\n        ).all()}\n        self_progress = {p.checkpoint_id: p for p in Progress.query.filter_by(\n            user_id=current_user.id, mode='self_paced'\n        ).all()}\n        \n        active_session = ActiveSession.query.filter_by(\n            course_id=course.id, ended_at=None\n        ).first()\n        \n        return render_template('courses/view_student.html', \n                             course=course, \n                             checkpoints=checkpoints, \n                             live_progress=live_progress,\n                             self_progress=self_progress,\n                             active_session=active_session)\n\n@bp.route('/<int:course_id>/edit', methods=['GET', 'POST'])\n@login_required\ndef edit(course_id):\n    course = Course.query.get_or_404(course_id)\n    if not has_course_access(course, current_user):\n        flash('이 세미나를 수정할 권한이 없습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    form = CourseForm(obj=course)\n    if form.validate_on_submit():\n        course.title = form.title.data\n        course.description = form.description.data\n        db.session.commit()\n        flash('세미나가 수정되었습니다!', 'success')\n        return redirect(url_for('courses.view', course_id=course.id))\n    \n    return render_template('courses/edit.html', form=form, course=course)\n\n@bp.route('/<int:course_id>/delete', methods=['POST'])\n@login_required\ndef delete(course_id):\n    course = Course.query.get_or_404(course_id)\n    if not has_course_access(course, current_user):\n        flash('이 세미나를 삭제할 권한이 없습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    course.deleted_at = datetime.utcnow()\n    db.session.commit()\n    flash('세미나가 삭제되었습니다!', 'success')\n    return redirect(url_for('main.dashboard'))\n\n@bp.route('/enroll', methods=['GET', 'POST'])\n@login_required\ndef enroll():\n    if current_user.is_instructor():\n        flash('강사는 수강 신청을 할 수 없습니다.', 'warning')\n        return redirect(url_for('main.dashboard'))\n    \n    form = EnrollForm()\n    if form.validate_on_submit():\n        course = Course.query.filter_by(invite_code=form.invite_code.data.upper()).first()\n        if not course:\n            flash('유효하지 않은 초대 코드입니다.', 'danger')\n            return render_template('courses/enroll.html', form=form)\n        \n        if course.deleted_at or course.visibility == 'private':\n            flash('해당 세션에 등록할 수 없습니다.', 'danger')\n            return render_template('courses/enroll.html', form=form)\n        \n        if current_user.is_enrolled(course):\n            flash('이미 이 세미나에 등록되어 있습니다.', 'warning')\n            return redirect(url_for('courses.view', course_id=course.id))\n        \n        enrollment = Enrollment(course_id=course.id, user_id=current_user.id)\n        db.session.add(enrollment)\n        db.session.commit()\n        flash(f'{course.title} 세미나에 등록되었습니다!', 'success')\n        return redirect(url_for('courses.view', course_id=course.id))\n    \n    return render_template('courses/enroll.html', form=form)\n\n@bp.route('/<int:course_id>/enroll', methods=['POST'])\n@login_required\ndef enroll_course(course_id):\n    if current_user.is_instructor():\n        flash('강사는 수강 신청을 할 수 없습니다.', 'warning')\n        return redirect(url_for('courses.list_courses'))\n    \n    course = Course.query.get_or_404(course_id)\n    \n    if course.deleted_at or course.visibility == 'private':\n        flash('해당 세션에 등록할 수 없습니다.', 'danger')\n        return redirect(url_for('courses.list_courses'))\n    \n    if current_user.is_enrolled(course):\n        flash('이미 이 세션에 등록되어 있습니다.', 'warning')\n        return redirect(url_for('courses.view', course_id=course.id))\n    \n    enrollment = Enrollment(course_id=course.id, user_id=current_user.id)\n    db.session.add(enrollment)\n    db.session.commit()\n    flash(f'{course.title} 세션에 등록되었습니다!', 'success')\n    return redirect(url_for('courses.view', course_id=course.id))\n\n@bp.route('/<int:course_id>/start-session', methods=['GET', 'POST'])\n@login_required\ndef start_session(course_id):\n    course = Course.query.get_or_404(course_id)\n    if not has_course_access(course, current_user):\n        flash('강사만 세션을 시작할 수 있습니다.', 'danger')\n        return redirect(url_for('courses.view', course_id=course_id))\n    \n    existing_session = ActiveSession.query.filter_by(course_id=course.id, ended_at=None).first()\n    if existing_session:\n        flash('이미 진행 중인 세션이 있습니다.', 'warning')\n        return redirect(url_for('courses.live_mode', course_id=course_id))\n    \n    from app.forms import SessionScheduleForm\n    form = SessionScheduleForm()\n    \n    if request.method == 'POST':\n        session_type = request.form.get('session_type', 'immediate')\n        scheduled_at = None\n        \n        if session_type == 'scheduled':\n            scheduled_str = request.form.get('scheduled_at')\n            if not scheduled_str:\n                flash('예약 시간을 입력하세요.', 'danger')\n                return render_template('courses/start_session.html', course=course, form=form)\n            try:\n                scheduled_at = datetime.strptime(scheduled_str, '%Y-%m-%dT%H:%M')\n                if scheduled_at <= datetime.utcnow():\n                    flash('예약 시간은 현재 시간 이후여야 합니다.', 'danger')\n                    return render_template('courses/start_session.html', course=course, form=form)\n            except ValueError:\n                flash('올바른 날짜/시간 형식을 입력하세요.', 'danger')\n                return render_template('courses/start_session.html', course=course, form=form)\n        \n        session = ActiveSession(\n            course_id=course.id,\n            mode='live',\n            session_type=session_type,\n            scheduled_at=scheduled_at,\n            started_at=datetime.utcnow() if session_type == 'immediate' else None\n        )\n        db.session.add(session)\n        db.session.commit()\n        \n        if session_type == 'immediate':\n            flash('라이브 세션이 시작되었습니다.', 'success')\n            return redirect(url_for('courses.live_mode', course_id=course_id))\n        else:\n            flash(f'세션이 {scheduled_at.strftime(\"%Y-%m-%d %H:%M\")}에 예약되었습니다.', 'success')\n            return redirect(url_for('courses.view', course_id=course_id))\n    \n    return render_template('courses/start_session.html', course=course, form=form)\n\n@bp.route('/<int:course_id>/live')\n@login_required\ndef live_mode(course_id):\n    course = Course.query.get_or_404(course_id)\n    \n    if course.deleted_at:\n        if not has_course_access(course, current_user):\n            flash('해당 세션을 찾을 수 없습니다.', 'danger')\n            return redirect(url_for('main.dashboard'))\n    \n    checkpoints = Checkpoint.query.filter_by(course_id=course.id, deleted_at=None).order_by(Checkpoint.order).all()\n    \n    session = ActiveSession.query.filter_by(course_id=course.id, ended_at=None).first()\n    if not session:\n        if has_course_access(course, current_user):\n            return redirect(url_for('courses.start_session', course_id=course_id))\n        else:\n            flash('현재 진행 중인 세션이 없습니다.', 'warning')\n            return redirect(url_for('courses.view', course_id=course_id))\n    \n    if session.session_type == 'scheduled' and session.scheduled_at:\n        if datetime.utcnow() < session.scheduled_at:\n            if not current_user.is_instructor():\n                flash(f'세션이 {session.scheduled_at.strftime(\"%Y-%m-%d %H:%M\")}에 시작될 예정입니다.', 'info')\n                return redirect(url_for('courses.view', course_id=course_id))\n        elif not session.started_at:\n            session.started_at = datetime.utcnow()\n            db.session.commit()\n    \n    recent_messages = ChatMessage.query.filter_by(course_id=course.id).order_by(ChatMessage.created_at.desc()).limit(50).all()\n    recent_messages = list(reversed(recent_messages))\n    \n    if current_user.is_instructor():\n        if not has_course_access(course, current_user):\n            flash('접근 권한이 없습니다.', 'danger')\n            return redirect(url_for('main.dashboard'))\n        students = course.get_enrolled_students()\n        slide_decks = SlideDeck.query.filter_by(course_id=course.id, conversion_status='completed').order_by(SlideDeck.created_at.desc()).all()\n        active_deck = slide_decks[0] if slide_decks else None\n        active_slides = active_deck.get_slide_urls() if active_deck else []\n        active_bookmarks = {}\n        if active_deck:\n            for b in SlideBookmark.query.filter_by(deck_id=active_deck.id).all():\n                active_bookmarks[b.slide_index] = b\n        return render_template('courses/live_instructor.html', course=course, checkpoints=checkpoints, students=students, session=session, messages=recent_messages, slide_decks=slide_decks, active_deck=active_deck, active_slides=active_slides, active_bookmarks=active_bookmarks)\n    else:\n        if not current_user.is_enrolled(course):\n            flash('이 세미나에 등록되어 있지 않습니다.', 'danger')\n            return redirect(url_for('main.dashboard'))\n        \n        if not course.is_accessible_by(current_user):\n            flash('이 세션에 접근할 수 없습니다.', 'warning')\n            return redirect(url_for('main.dashboard'))\n        \n        from app.models import Attendance\n        attendance_checked = Attendance.query.filter_by(\n            course_id=course_id,\n            user_id=current_user.id,\n            session_id=session.id\n        ).first() is not None if session else False\n        \n        progress_records = {p.checkpoint_id: p for p in Progress.query.filter_by(user_id=current_user.id, mode='live').all()}\n        enrollments = Enrollment.query.filter_by(course_id=course_id).all()\n        active_deck = SlideDeck.query.filter_by(course_id=course.id, conversion_status='completed').order_by(SlideDeck.created_at.desc()).first()\n        active_slides = active_deck.get_slide_urls() if active_deck else []\n        my_reactions = {}\n        if active_deck:\n            for r in SlideReaction.query.filter_by(deck_id=active_deck.id, user_id=current_user.id).all():\n                my_reactions[r.slide_index] = r.reaction\n        return render_template('courses/live_student.html', course=course, checkpoints=checkpoints, progress=progress_records, session=session, messages=recent_messages, enrollments=enrollments, attendance_checked=attendance_checked, active_deck=active_deck, active_slides=active_slides, my_reactions=my_reactions)\n\n@bp.route('/<int:course_id>/regenerate-code', methods=['POST'])\n@login_required\ndef regenerate_code(course_id):\n    course = Course.query.get_or_404(course_id)\n    if not has_course_access(course, current_user):\n        return jsonify({'error': '권한이 없습니다'}), 403\n    \n    course.invite_code = Course.generate_invite_code()\n    db.session.commit()\n    return jsonify({'invite_code': course.invite_code})\n\n@bp.route('/<int:course_id>/settings', methods=['GET', 'POST'])\n@login_required\ndef settings(course_id):\n    course = Course.query.get_or_404(course_id)\n    if not has_course_access(course, current_user):\n        flash('설정 권한이 없습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    if request.method == 'POST':\n        setting_type = request.form.get('setting_type', 'basic')\n        \n        if setting_type == 'basic':\n            course.title = request.form.get('title', course.title)\n            course.description = request.form.get('description', course.description)\n            \n            order_num = request.form.get('order_number')\n            course.order_number = int(order_num) if order_num else None\n            \n            start_date_str = request.form.get('start_date')\n            if start_date_str:\n                course.start_date = datetime.strptime(start_date_str, '%Y-%m-%dT%H:%M')\n            else:\n                course.start_date = None\n            \n            end_date_str = request.form.get('end_date')\n            if end_date_str:\n                course.end_date = datetime.strptime(end_date_str, '%Y-%m-%dT%H:%M')\n            else:\n                course.end_date = None\n            \n            attendance_start_str = request.form.get('attendance_start')\n            if attendance_start_str:\n                course.attendance_start = datetime.strptime(attendance_start_str, '%Y-%m-%dT%H:%M')\n            else:\n                course.attendance_start = None\n            \n            attendance_end_str = request.form.get('attendance_end')\n            if attendance_end_str:\n                course.attendance_end = datetime.strptime(attendance_end_str, '%Y-%m-%dT%H:%M')\n            else:\n                course.attendance_end = None\n            \n            course.late_allowed = 'late_allowed' in request.form\n            late_end_str = request.form.get('late_end')\n            if late_end_str and course.late_allowed:\n                course.late_end = datetime.strptime(late_end_str, '%Y-%m-%dT%H:%M')\n            else:\n                course.late_end = None\n            \n            db.session.commit()\n            flash('기본 설정이 저장되었습니다.', 'success')\n        \n        elif setting_type == 'visibility':\n            visibility = request.form.get('visibility', 'public')\n            course.visibility = visibility\n            \n            prerequisite_id = request.form.get('prerequisite_course_id')\n            if prerequisite_id and prerequisite_id != '0':\n                course.prerequisite_course_id = int(prerequisite_id)\n            else:\n                course.prerequisite_course_id = None\n            \n            db.session.commit()\n            flash('공개 설정이 저장되었습니다.', 'success')\n        \n        return redirect(url_for('courses.settings', course_id=course_id))\n    \n    other_courses = Course.query.filter(\n        Course.instructor_id == current_user.id,\n        Course.id != course_id,\n        Course.deleted_at.is_(None)\n    ).all()\n    \n    return render_template('courses/settings.html', course=course, other_courses=other_courses)\n\n@bp.route('/<int:course_id>/self-study-progress')\n@login_required\ndef self_study_progress(course_id):\n    course = Course.query.get_or_404(course_id)\n    if not has_course_access(course, current_user):\n        flash('접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    students = course.get_enrolled_students()\n    checkpoints = Checkpoint.query.filter_by(course_id=course.id, deleted_at=None).order_by(Checkpoint.order).all()\n    \n    progress_data = {}\n    for student in students:\n        progress_data[student.id] = {}\n        for cp in checkpoints:\n            p = Progress.query.filter_by(\n                user_id=student.id,\n                checkpoint_id=cp.id,\n                mode='self_paced'\n            ).first()\n            progress_data[student.id][cp.id] = p\n    \n    return render_template('courses/self_study_progress.html', \n                         course=course, \n                         students=students, \n                         checkpoints=checkpoints,\n                         progress_data=progress_data)\n\n@bp.route('/<int:course_id>/session-post', methods=['POST'])\n@login_required\ndef create_session_post(course_id):\n    course = Course.query.get_or_404(course_id)\n    session = ActiveSession.query.filter_by(course_id=course.id, ended_at=None).first()\n    \n    if not session:\n        flash('현재 진행 중인 세션이 없습니다.', 'danger')\n        return redirect(url_for('courses.view', course_id=course_id))\n    \n    if not has_course_access(course, current_user):\n        flash('강사만 공지를 작성할 수 있습니다.', 'danger')\n        return redirect(url_for('courses.live_mode', course_id=course_id))\n    \n    title = request.form.get('title', '').strip()\n    content = request.form.get('content', '').strip()\n    pinned = request.form.get('pinned') == 'on'\n    \n    if not title or not content:\n        flash('제목과 내용을 입력하세요.', 'danger')\n        return redirect(url_for('courses.live_mode', course_id=course_id))\n    \n    post = LiveSessionPost(\n        session_id=session.id,\n        user_id=current_user.id,\n        title=title,\n        content=content,\n        pinned=pinned\n    )\n    db.session.add(post)\n    db.session.commit()\n    \n    flash('공지가 등록되었습니다.', 'success')\n    return redirect(url_for('courses.live_mode', course_id=course_id))\n\n\n@bp.route('/<int:course_id>/live/set-status', methods=['POST'])\n@login_required\ndef set_live_status(course_id):\n    course = Course.query.get_or_404(course_id)\n    if not has_course_access(course, current_user):\n        return jsonify({'success': False, 'message': '권한이 없습니다.'}), 403\n    \n    session = ActiveSession.query.filter_by(course_id=course.id, ended_at=None).first()\n    if not session:\n        return jsonify({'success': False, 'message': '진행 중인 세션이 없습니다.'}), 404\n    \n    status = request.json.get('status', 'preparing')\n    if status not in ['preparing', 'live', 'ended']:\n        return jsonify({'success': False, 'message': '유효하지 않은 상태입니다.'}), 400\n    \n    session.live_status = status\n    if status == 'ended':\n        session.ended_at = datetime.utcnow()\n    db.session.commit()\n    \n    return jsonify({\n        'success': True,\n        'status': status,\n        'status_display': session.get_live_status_display()\n    })\n\n\n\n@bp.route('/<int:course_id>/members')\n@login_required\ndef members(course_id):\n    course = Course.query.get_or_404(course_id)\n    if not has_course_access(course, current_user):\n        flash('접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('courses.view', course_id=course_id))\n    \n    enrollments = Enrollment.query.filter_by(course_id=course_id).all()\n    \n    enrollment_data = {\n        'approved': [],\n        'pending': [],\n        'rejected': []\n    }\n    \n    for enrollment in enrollments:\n        user = User.query.get(enrollment.user_id)\n        if user:\n            item = {'user': user, 'enrollment': enrollment}\n            status = enrollment.status if hasattr(enrollment, 'status') and enrollment.status else 'approved'\n            if status in enrollment_data:\n                enrollment_data[status].append(item)\n            else:\n                enrollment_data['approved'].append(item)\n    \n    return render_template('courses/members.html', course=course, enrollment_data=enrollment_data)\n\n\n@bp.route('/<int:course_id>/members/add', methods=['POST'])\n@login_required\ndef add_course_member(course_id):\n    course = Course.query.get_or_404(course_id)\n    if not has_course_access(course, current_user):\n        flash('접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('courses.members', course_id=course_id))\n    \n    email = request.form.get('email', '').strip()\n    user = User.query.filter_by(email=email).first()\n    \n    if not user:\n        flash('해당 이메일로 등록된 사용자가 없습니다.', 'danger')\n        return redirect(url_for('courses.members', course_id=course_id))\n    \n    existing = Enrollment.query.filter_by(course_id=course_id, user_id=user.id).first()\n    if existing:\n        flash('이미 등록된 사용자입니다.', 'warning')\n        return redirect(url_for('courses.members', course_id=course_id))\n    \n    enrollment = Enrollment(course_id=course_id, user_id=user.id, status='approved')\n    db.session.add(enrollment)\n    db.session.commit()\n    \n    flash(f'{user.display_name}님이 등록되었습니다.', 'success')\n    return redirect(url_for('courses.members', course_id=course_id))\n\n\n@bp.route('/<int:course_id>/members/change-status/<int:user_id>', methods=['POST'])\n@login_required\ndef change_course_enrollment_status(course_id, user_id):\n    course = Course.query.get_or_404(course_id)\n    if not has_course_access(course, current_user):\n        flash('접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('courses.members', course_id=course_id))\n    \n    enrollment = Enrollment.query.filter_by(course_id=course_id, user_id=user_id).first()\n    if not enrollment:\n        flash('등록 정보를 찾을 수 없습니다.', 'warning')\n        return redirect(url_for('courses.members', course_id=course_id))\n    \n    new_status = request.form.get('status')\n    user = User.query.get(user_id)\n    \n    if new_status and new_status in ['approved', 'pending', 'rejected']:\n        enrollment.status = new_status\n        flash(f'{user.display_name}의 상태가 변경되었습니다.', 'success')\n    \n    db.session.commit()\n    return redirect(url_for('courses.members', course_id=course_id))\n\n\n@bp.route('/<int:course_id>/members/remove/<int:user_id>', methods=['POST'])\n@login_required\ndef remove_course_member(course_id, user_id):\n    course = Course.query.get_or_404(course_id)\n    if not has_course_access(course, current_user):\n        flash('접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('courses.members', course_id=course_id))\n    \n    enrollment = Enrollment.query.filter_by(course_id=course_id, user_id=user_id).first()\n    if not enrollment:\n        flash('등록 정보를 찾을 수 없습니다.', 'warning')\n        return redirect(url_for('courses.members', course_id=course_id))\n    \n    user = User.query.get(user_id)\n    db.session.delete(enrollment)\n    db.session.commit()\n    \n    flash(f'{user.display_name}님이 제외되었습니다.', 'info')\n    return redirect(url_for('courses.members', course_id=course_id))\n\n\n@bp.route('/<int:course_id>/members/approve/<int:user_id>', methods=['POST'])\n@login_required\ndef approve_course_enrollment(course_id, user_id):\n    course = Course.query.get_or_404(course_id)\n    if not has_course_access(course, current_user):\n        flash('접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('courses.members', course_id=course_id))\n    \n    enrollment = Enrollment.query.filter_by(course_id=course_id, user_id=user_id, status='pending').first()\n    if not enrollment:\n        flash('대기 중인 등록 요청이 없습니다.', 'warning')\n        return redirect(url_for('courses.members', course_id=course_id))\n    \n    enrollment.status = 'approved'\n    db.session.commit()\n    \n    user = User.query.get(user_id)\n    flash(f'{user.display_name}의 등록 신청을 승인했습니다.', 'success')\n    return redirect(url_for('courses.members', course_id=course_id))\n\n\n@bp.route('/<int:course_id>/members/reject/<int:user_id>', methods=['POST'])\n@login_required\ndef reject_course_enrollment(course_id, user_id):\n    course = Course.query.get_or_404(course_id)\n    if not has_course_access(course, current_user):\n        flash('접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('courses.members', course_id=course_id))\n    \n    enrollment = Enrollment.query.filter_by(course_id=course_id, user_id=user_id, status='pending').first()\n    if not enrollment:\n        flash('대기 중인 등록 요청이 없습니다.', 'warning')\n        return redirect(url_for('courses.members', course_id=course_id))\n    \n    enrollment.status = 'rejected'\n    db.session.commit()\n    \n    user = User.query.get(user_id)\n    flash(f'{user.display_name}의 등록 신청을 거절했습니다.', 'info')\n    return redirect(url_for('courses.members', course_id=course_id))\n","path":null,"size_bytes":29629,"size_tokens":null},"replit.md":{"content":"# 학습 진도 트래커 (Learning Progress Tracking Platform)\n\n## Overview\n학습 진도 트래커는 실시간 학습 진도 모니터링 시스템으로, 라이브 강의실 추적 및 자기주도 학습 분석 기능을 제공합니다. 이 플랫폼은 강사와 학생 모두에게 최적화된 학습 경험을 제공하며, Python Flask, Socket.IO, PostgreSQL을 기반으로 구축되었습니다. 주요 목표는 학습 효율성을 극대화하고, 개인화된 학습 경로를 지원하며, 교육 기관의 운영 효율성을 높이는 것입니다.\n\n주요 기능은 다음과 같습니다:\n- **과목/세션/세미나 계층 구조**: \n  - 과목(Subject): 여러 주차별 세션을 포함하는 상위 컨테이너\n  - 세션(Course within Subject): 과목 내 개별 활동 (라이브, 영상, 자료, 과제, 퀴즈)\n  - 세미나(Standalone Course): 과목에 속하지 않는 독립적인 1회성 강의\n- **라이브 세션 예약**: 즉시 시작 또는 특정 시간 예약 기능\n- **실시간 채팅 및 게시판**: 세션 중 실시간 소통 및 공지사항 관리\n- **PPT/PDF 실시간 슬라이드 방송**: PPTX/PDF 업로드→이미지 변환, 강사-학습자 슬라이드 동기화, 이해도 피드백(👍/❓/😵), 문제 슬라이드 자동 북마크, 강의 후 리뷰 페이지, 인라인 프레젠터/뷰어 통합\n- **실시간 Engagement Dashboard**: 반응 원형차트/막대 그래프 시각화, 추이 미니 라인차트, 해석 가이드, 임계값 기반 Smart Alert\n- **Smart Slide Navigator**: 슬라이드 점프 바(미니맵), 검색 기능, 키보드 네비게이션(화살표/PageUp/Down/Home/End)\n- **Lecture Progress & Time Manager**: 강의 타이머, 슬라이드별 소요 시간 추적, 예상 종료 시간 자동 계산, 시간 초과 알림\n- **AI 기반 체크포인트 생성**: PPT/PDF, 영상, 음성 분석을 통한 자동 체크포인트 생성 및 전사문 편집 기능\n- **역할 기반 접근 제어**: 시스템 관리자, 기관 관리자, 강사, 학습자로 구분된 권한 관리\n- **자기주도 학습 모드**: 개인별 진도 및 학습 시간 측정, 체크포인트 완료 토글\n- **통합 이용 안내 및 커뮤니티 기능**: 공지사항, FAQ, Q&A, 스터디 모집, 학습 리뷰 등\n\n## User Preferences\nI prefer the entire UI, messages, and labels to be in Korean.\nI want the design to feature Glassmorphism effects with a navy gradient color scheme (`#0d1b3e` to `#1a3a5c`), using the Noto Sans KR font, rounded corners (12-24px border-radius), and floating card animations. The login page should have a learning-themed background image with a glass card overlay.\nI want an integrated navigation system that includes a user dropdown menu (avatar + name + role), notification links, and theme toggle support across all pages.\nI expect the system to support a light/dark theme toggle, with the preference saved locally.\nFor notifications, I prefer toast-style alerts in the top right corner with category-specific colors and icons, disappearing automatically after 5 seconds but also offering a manual close button, and having slide animations.\n\n## System Architecture\nThe application is built with a Flask factory pattern, using SQLAlchemy for ORM with PostgreSQL as the database. Real-time functionalities like live session tracking and chat are handled via Flask-SocketIO with Eventlet for asynchronous support. User authentication is managed by Flask-Login with bcrypt for password hashing, supporting role-based access control (system_admin, org_admin, instructor, student).\n\n### UI/UX Decisions\n- **Design Language**: Glassmorphism with a navy gradient theme (`#0d1b3e` to `#1a3a5c`), Noto Sans KR font, rounded corners (12-24px border-radius), and floating card animations.\n- **Brand Identity**: Modern dark theme with blue-purple gradients (`#3b82f6` → `#8b5cf6`) for a sleek, contemporary feel.\n- **Responsiveness**: Mobile-optimized with responsive CSS and touch-friendly buttons.\n- **Theming**: Light/Dark theme toggle available across all pages, preserving user preference via local storage.\n- **Login Page**: Learning-themed background image with a glass card overlay.\n- **Dashboards**: Personalized dashboards with learning statistics widgets (completion rate, study time, streak) and gamification elements (streaks, badges).\n- **Notifications**: Toast-style notifications (success/error/warning/info) with auto-hide and manual close, slide animations.\n- **Navigation**: Integrated navigation bar across all pages, including a user dropdown menu showing avatar, name, and role.\n\n### Technical Implementations & Features\n- **Core Structure**:\n    - Subject-Course-Session hierarchy: `Subject` (main course) contains multiple `Course` (weekly sessions/modules).\n    - `SubjectEnrollment` model for managing student registrations to subjects and their associated sessions.\n- **Authentication & Authorization**:\n    - Role-based access control: `system_admin`, `org_admin`, `instructor`, `student`.\n    - Flask-Login for user sessions, `remember me` functionality for persistent login.\n    - User account settings for profile management (image, nickname, personal info), password changes, and instructor verification requests.\n- **Course & Session Management**:\n    - Creation, deletion (soft delete), visibility toggling (public/private).\n    - Diverse session types with dedicated UIs:\n      - `live_session`: Real-time synchronized learning with checkpoints\n      - `video`: Video player with watch log tracking (auto-complete at 80% for uploads, manual completion with page time tracking for YouTube)\n      - `material`: Learning materials with file download and page time tracking\n      - `assignment`: Assignment submission with file upload and grading workflow\n      - `quiz`: Timed quizzes with multiple choice, true/false, and short answer questions\n    - File uploads (base64 storage, 100MB limit) for video/material sessions.\n    - Attendance tracking with configurable periods and tardiness allowances.\n    - `LiveStatus` (`preparing`, `live`, `ended`) for real-time session state management.\n    - `SessionCompletion` model for tracking manual completion across all non-live session types.\n    - `VideoWatchLog` model for tracking video viewing progress and auto-completion.\n    - `PageTimeLog` model for tracking time spent on pages (YouTube videos, materials).\n- **Checkpoint System**:\n    - Sequential learning objectives with estimated completion times.\n    - AI-powered generation of checkpoints from PPT, PDF, video, and audio content using Gemini AI.\n    - Manual completion toggling for students.\n- **Live Mode**:\n    - WebSocket-based real-time progress tracking for synchronous learning.\n    - Real-time chat with message editing/deletion and mentions.\n    - Live bulletin board for announcements during sessions.\n- **Self-Study Mode**:\n    - Independent progress tracking and time measurement.\n    - Start/pause/resume/stop/reset timer functionality.\n    - Pause elapsed time display showing how long paused.\n    - Auto-end feature: Timer automatically ends and saves progress after 30 minutes of pause.\n    - Auto-save: Timer saves progress on stop or reset actions.\n- **Standalone Sessions (Seminars)**:\n    - Independent sessions not attached to any Subject (subject_id is None).\n    - Direct enrollment via invite codes from session list page.\n    - Separate sections for instructors, enrolled, and public sessions.\n- **Community & Support**:\n    - `Community` section for learning reviews, Q&A (with adoption and resolution status), and study group recruitment.\n    - `Guide` section including announcements, FAQ, Q&A, resources, updates, and suggestions.\n- **Data Analytics**:\n    - Completion rates, time spent analysis, CSV export.\n\n### System Design Choices\n- **PPT 슬라이드 방송 시스템**:\n    - `SlideDeck` model: PPTX/PDF 파일 업로드 및 이미지 변환 관리 (course_id, session_id, slide_count, current_slide_index, conversion_status, estimated_duration_minutes)\n    - `SlideReaction` model: 슬라이드별 학습자 이해도 피드백 (understood/question/hard/none)\n    - `SlideBookmark` model: 문제 슬라이드 자동/수동 북마크 (is_auto, is_manual, memo, supplement_url)\n    - PPTX→PDF→PNG 변환 파이프라인 (LibreOffice headless + pdf2image)\n    - Socket.IO events: slide_changed, set_slide_reaction, slide_aggregate_updated, bookmark_updated\n    - 프레젠터 뷰 (강사), 뷰어 (학습자), 리뷰 페이지\n    - Routes: `/slides/` blueprint (upload, delete, presenter, viewer, review)\n    - 파일 크기 제한: 50MB, 최대 슬라이드 수: 100장\n- **Database Schema**: Utilizes `Subject`, `Course`, `Checkpoint`, `Progress`, `Attendance`, `User`, `SubjectMember`, `Notification`, `Guide`, `Community`, `SlideDeck`, `SlideReaction`, `SlideBookmark` models for comprehensive data management.\n- **Asynchronous Operations**: Leverages Socket.IO and Eventlet for handling real-time, concurrent user interactions efficiently.\n- **Modularity**: Application organized into blueprints (`auth.py`, `main.py`, `courses.py`, `checkpoints.py`, `progress.py`, `analytics.py`, `slides.py`) for better maintainability and scalability.\n\n## External Dependencies\n- **Flask**: Web framework\n- **Flask-SocketIO**: WebSocket communication\n- **PostgreSQL**: Relational database\n- **SQLAlchemy**: ORM for database interactions\n- **Flask-Login**: User session management\n- **bcrypt**: Password hashing\n- **Bootstrap 5**: Frontend framework for responsive design\n- **Chart.js**: Data visualization\n- **Eventlet**: Asynchronous I/O library\n- **Noto Sans KR**: Custom font\n- **Google Gemini AI**: For AI checkpoint generation and content analysis (via Replit AI Integrations)","path":null,"size_bytes":9760,"size_tokens":null},"app/events.py":{"content":"from flask_socketio import emit, join_room, leave_room\nfrom flask_login import current_user\nfrom app import socketio, db\nfrom app.models import Progress, Course, Checkpoint, Enrollment, ActiveSession, ChatMessage, UnderstandingStatus, SlideDeck, SlideReaction, SlideBookmark\nfrom datetime import datetime\n\ndef user_has_course_access(user, course):\n    if not course:\n        return False\n    if user.is_instructor() and course.instructor_id == user.id:\n        return True\n    return Enrollment.query.filter_by(user_id=user.id, course_id=course.id).first() is not None\n\n@socketio.on('connect')\ndef handle_connect():\n    if current_user.is_authenticated:\n        emit('connected', {'user_id': current_user.id, 'username': current_user.username})\n\n@socketio.on('join_course')\ndef handle_join_course(data):\n    if not current_user.is_authenticated:\n        return\n    \n    course_id = data.get('course_id')\n    mode = data.get('mode', 'live')\n    \n    if not course_id:\n        return\n    \n    course = Course.query.get(course_id)\n    if not course or not user_has_course_access(current_user, course):\n        emit('error', {'message': 'Access denied to this course'})\n        return\n    \n    room = f'course_{course_id}'\n    join_room(room)\n    emit('student_joined', {\n        'user_id': current_user.id,\n        'username': current_user.username\n    }, room=room)\n    \n    checkpoints = Checkpoint.query.filter_by(course_id=course_id, deleted_at=None).all()\n    students = course.get_enrolled_students()\n    \n    stats = {}\n    for cp in checkpoints:\n        completed = Progress.query.filter(\n            Progress.checkpoint_id == cp.id,\n            Progress.completed_at.isnot(None),\n            Progress.mode == mode\n        ).count()\n        stats[cp.id] = {\n            'completed': completed,\n            'total': len(students)\n        }\n    \n    emit('session_stats', {'completion_rates': stats})\n\n@socketio.on('leave_course')\ndef handle_leave_course(data):\n    if not current_user.is_authenticated:\n        emit('error', {'message': 'Authentication required'})\n        return\n    \n    course_id = data.get('course_id')\n    if not course_id:\n        emit('error', {'message': 'Course ID required'})\n        return\n    \n    course = Course.query.get(course_id)\n    if not course or not user_has_course_access(current_user, course):\n        emit('error', {'message': 'Access denied to this course'})\n        return\n    \n    room = f'course_{course_id}'\n    leave_room(room)\n    emit('student_left', {\n        'user_id': current_user.id,\n        'username': current_user.username\n    }, room=room)\n\n@socketio.on('checkpoint_completed')\ndef handle_checkpoint_completed(data):\n    if not current_user.is_authenticated:\n        return\n    \n    checkpoint_id = data.get('checkpoint_id')\n    mode = data.get('mode', 'live')\n    \n    checkpoint = Checkpoint.query.get(checkpoint_id)\n    if not checkpoint:\n        return\n    \n    course = checkpoint.course\n    if not user_has_course_access(current_user, course):\n        emit('error', {'message': 'Access denied to this course'})\n        return\n    \n    if current_user.is_instructor():\n        emit('error', {'message': 'Instructors cannot mark checkpoints complete'})\n        return\n    \n    room = f'course_{course.id}'\n    \n    progress = Progress.query.filter_by(\n        user_id=current_user.id,\n        checkpoint_id=checkpoint_id,\n        mode=mode\n    ).first()\n    \n    if not progress:\n        progress = Progress(\n            user_id=current_user.id,\n            checkpoint_id=checkpoint_id,\n            mode=mode,\n            started_at=datetime.utcnow(),\n            completed_at=datetime.utcnow()\n        )\n        db.session.add(progress)\n    else:\n        progress.completed_at = datetime.utcnow()\n    \n    progress.calculate_duration()\n    db.session.commit()\n    \n    emit('progress_update', {\n        'user_id': current_user.id,\n        'username': current_user.username,\n        'checkpoint_id': checkpoint_id,\n        'status': 'completed'\n    }, room=room)\n    \n    checkpoints = Checkpoint.query.filter_by(course_id=course.id, deleted_at=None).all()\n    students = course.get_enrolled_students()\n    \n    stats = {}\n    for cp in checkpoints:\n        completed = Progress.query.filter(\n            Progress.checkpoint_id == cp.id,\n            Progress.completed_at.isnot(None),\n            Progress.mode == mode\n        ).count()\n        stats[cp.id] = {\n            'completed': completed,\n            'total': len(students)\n        }\n    \n    emit('session_stats', {'completion_rates': stats}, room=room)\n\n@socketio.on('request_stats')\ndef handle_request_stats(data):\n    if not current_user.is_authenticated:\n        return\n    \n    course_id = data.get('course_id')\n    mode = data.get('mode', 'live')\n    \n    course = Course.query.get(course_id)\n    if not course or not user_has_course_access(current_user, course):\n        emit('error', {'message': 'Access denied to this course'})\n        return\n    \n    checkpoints = Checkpoint.query.filter_by(course_id=course_id, deleted_at=None).all()\n    students = course.get_enrolled_students()\n    \n    stats = {}\n    for cp in checkpoints:\n        completed = Progress.query.filter(\n            Progress.checkpoint_id == cp.id,\n            Progress.completed_at.isnot(None),\n            Progress.mode == mode\n        ).count()\n        stats[cp.id] = {\n            'completed': completed,\n            'total': len(students)\n        }\n    \n    emit('session_stats', {'completion_rates': stats})\n\n@socketio.on('send_chat_message')\ndef handle_send_chat_message(data):\n    if not current_user.is_authenticated:\n        return\n    \n    course_id = data.get('course_id')\n    message_text = data.get('message', '').strip()\n    \n    if not course_id or not message_text:\n        return\n    \n    course = Course.query.get(course_id)\n    if not course or not user_has_course_access(current_user, course):\n        emit('error', {'message': 'Access denied to this course'})\n        return\n    \n    chat_msg = ChatMessage(\n        course_id=course_id,\n        user_id=current_user.id,\n        message=message_text\n    )\n    db.session.add(chat_msg)\n    db.session.commit()\n    \n    room = f'course_{course_id}'\n    emit('new_chat_message', {\n        'id': chat_msg.id,\n        'user_id': current_user.id,\n        'username': current_user.username,\n        'role': current_user.role,\n        'message': message_text,\n        'created_at': chat_msg.created_at.strftime('%H:%M')\n    }, room=room)\n\n@socketio.on('edit_chat_message')\ndef handle_edit_chat_message(data):\n    if not current_user.is_authenticated:\n        return\n    \n    course_id = data.get('course_id')\n    message_id = data.get('message_id')\n    new_message = data.get('new_message', '').strip()\n    \n    if not message_id or not new_message:\n        return\n    \n    chat_msg = ChatMessage.query.get(message_id)\n    if not chat_msg:\n        return\n    \n    if chat_msg.course_id != course_id:\n        emit('error', {'message': 'Invalid course'})\n        return\n    \n    course = Course.query.get(chat_msg.course_id)\n    if not course or not user_has_course_access(current_user, course):\n        return\n    \n    if chat_msg.user_id != current_user.id and not (current_user.is_instructor() and course.instructor_id == current_user.id):\n        emit('error', {'message': 'Permission denied'})\n        return\n    \n    chat_msg.message = new_message\n    db.session.commit()\n    \n    room = f'course_{chat_msg.course_id}'\n    emit('chat_message_edited', {\n        'message_id': message_id,\n        'new_message': new_message\n    }, room=room)\n\n@socketio.on('delete_chat_message')\ndef handle_delete_chat_message(data):\n    if not current_user.is_authenticated:\n        return\n    \n    course_id = data.get('course_id')\n    message_id = data.get('message_id')\n    \n    if not message_id:\n        return\n    \n    chat_msg = ChatMessage.query.get(message_id)\n    if not chat_msg:\n        return\n    \n    if chat_msg.course_id != course_id:\n        emit('error', {'message': 'Invalid course'})\n        return\n    \n    course = Course.query.get(chat_msg.course_id)\n    if not course or not user_has_course_access(current_user, course):\n        return\n    \n    if chat_msg.user_id != current_user.id and not (current_user.is_instructor() and course.instructor_id == current_user.id):\n        emit('error', {'message': 'Permission denied'})\n        return\n    \n    db.session.delete(chat_msg)\n    db.session.commit()\n    \n    room = f'course_{chat_msg.course_id}'\n    emit('chat_message_deleted', {\n        'message_id': message_id\n    }, room=room)\n\n@socketio.on('set_current_checkpoint')\ndef handle_set_current_checkpoint(data):\n    if not current_user.is_authenticated or not current_user.is_instructor():\n        return\n    \n    course_id = data.get('course_id')\n    checkpoint_id = data.get('checkpoint_id')\n    \n    course = Course.query.get(course_id)\n    if not course or course.instructor_id != current_user.id:\n        emit('error', {'message': 'Access denied'})\n        return\n    \n    session = ActiveSession.query.filter_by(course_id=course_id, ended_at=None).first()\n    if session:\n        session.current_checkpoint_id = checkpoint_id\n        db.session.commit()\n    \n    room = f'course_{course_id}'\n    emit('current_checkpoint_changed', {\n        'checkpoint_id': checkpoint_id\n    }, room=room)\n\n@socketio.on('checkpoint_timer_action')\ndef handle_checkpoint_timer_action(data):\n    if not current_user.is_authenticated or not current_user.is_instructor():\n        return\n    \n    course_id = data.get('course_id')\n    checkpoint_id = data.get('checkpoint_id')\n    action = data.get('action')\n    elapsed_seconds = data.get('elapsed_seconds', 0)\n    \n    course = Course.query.get(course_id)\n    if not course or course.instructor_id != current_user.id:\n        return\n    \n    room = f'course_{course_id}'\n    emit('timer_sync', {\n        'checkpoint_id': checkpoint_id,\n        'elapsed_seconds': elapsed_seconds,\n        'action': action,\n        'is_running': action in ['start', 'resume']\n    }, room=room)\n\n@socketio.on('instructor_checkpoint_complete')\ndef handle_instructor_checkpoint_complete(data):\n    if not current_user.is_authenticated or not current_user.is_instructor():\n        return\n    \n    course_id = data.get('course_id')\n    checkpoint_id = data.get('checkpoint_id')\n    completed = data.get('completed', False)\n    elapsed_seconds = data.get('elapsed_seconds', 0)\n    \n    course = Course.query.get(course_id)\n    if not course or course.instructor_id != current_user.id:\n        return\n    \n    room = f'course_{course_id}'\n    emit('instructor_checkpoint_status', {\n        'checkpoint_id': checkpoint_id,\n        'completed': completed,\n        'elapsed_seconds': elapsed_seconds\n    }, room=room)\n\n@socketio.on('submit_understanding')\ndef handle_submit_understanding(data):\n    if not current_user.is_authenticated or current_user.is_instructor():\n        return\n    \n    course_id = data.get('course_id')\n    checkpoint_id = data.get('checkpoint_id')\n    status = data.get('status')\n    \n    if status not in ['understood', 'confused']:\n        return\n    \n    course = Course.query.get(course_id)\n    if not course or not user_has_course_access(current_user, course):\n        emit('error', {'message': 'Access denied'})\n        return\n    \n    session = ActiveSession.query.filter_by(course_id=course_id, ended_at=None).first()\n    if not session:\n        return\n    \n    existing = UnderstandingStatus.query.filter_by(\n        user_id=current_user.id,\n        checkpoint_id=checkpoint_id,\n        session_id=session.id\n    ).first()\n    \n    if existing:\n        existing.status = status\n        existing.created_at = datetime.utcnow()\n    else:\n        understanding = UnderstandingStatus(\n            user_id=current_user.id,\n            checkpoint_id=checkpoint_id,\n            session_id=session.id,\n            status=status\n        )\n        db.session.add(understanding)\n    \n    db.session.commit()\n    \n    understood_count = UnderstandingStatus.query.filter_by(\n        checkpoint_id=checkpoint_id,\n        session_id=session.id,\n        status='understood'\n    ).count()\n    \n    confused_count = UnderstandingStatus.query.filter_by(\n        checkpoint_id=checkpoint_id,\n        session_id=session.id,\n        status='confused'\n    ).count()\n    \n    room = f'course_{course_id}'\n    emit('understanding_updated', {\n        'checkpoint_id': checkpoint_id,\n        'understood': understood_count,\n        'confused': confused_count\n    }, room=room)\n\n\n@socketio.on('join_slide_session')\ndef handle_join_slide_session(data):\n    if not current_user.is_authenticated:\n        return\n    \n    deck_id = data.get('deck_id')\n    deck = SlideDeck.query.get(deck_id)\n    if not deck:\n        return\n    \n    course = Course.query.get(deck.course_id)\n    if not course or not user_has_course_access(current_user, course):\n        return\n    \n    room = f'slide_deck_{deck_id}'\n    join_room(room)\n    \n    emit('slide_session_state', {\n        'current_slide_index': deck.current_slide_index,\n        'slide_count': deck.slide_count\n    })\n\n\n@socketio.on('leave_slide_session')\ndef handle_leave_slide_session(data):\n    if not current_user.is_authenticated:\n        return\n    deck_id = data.get('deck_id')\n    room = f'slide_deck_{deck_id}'\n    leave_room(room)\n\n\n@socketio.on('change_slide')\ndef handle_change_slide(data):\n    if not current_user.is_authenticated or not current_user.is_instructor():\n        return\n    \n    deck_id = data.get('deck_id')\n    slide_index = data.get('slide_index')\n    \n    deck = SlideDeck.query.get(deck_id)\n    if not deck:\n        return\n    \n    course = Course.query.get(deck.course_id)\n    if not course or course.instructor_id != current_user.id:\n        return\n    \n    if slide_index < 0 or slide_index >= deck.slide_count:\n        return\n    \n    deck.current_slide_index = slide_index\n    db.session.commit()\n    \n    room = f'slide_deck_{deck_id}'\n    emit('slide_changed', {\n        'slide_index': slide_index\n    }, room=room)\n\n\ndef get_slide_aggregate(deck_id, slide_index):\n    understood = SlideReaction.query.filter_by(deck_id=deck_id, slide_index=slide_index, reaction='understood').count()\n    question = SlideReaction.query.filter_by(deck_id=deck_id, slide_index=slide_index, reaction='question').count()\n    hard = SlideReaction.query.filter_by(deck_id=deck_id, slide_index=slide_index, reaction='hard').count()\n    return {\n        'understood': understood,\n        'question': question,\n        'hard': hard,\n        'total_reacted': understood + question + hard\n    }\n\n\ndef check_and_update_flag(deck, slide_index, counts):\n    problem_count = counts['question'] + counts['hard']\n    total = counts['total_reacted']\n    \n    flagged = False\n    reason = ''\n    \n    if problem_count >= deck.flag_threshold_count:\n        flagged = True\n        reason = f'어려움+질문 {problem_count}명 (기준: {deck.flag_threshold_count}명)'\n    elif total > 0 and (problem_count / total) >= deck.flag_threshold_rate:\n        flagged = True\n        reason = f'어려움+질문 비율 {int(problem_count/total*100)}% (기준: {int(deck.flag_threshold_rate*100)}%)'\n    \n    if flagged:\n        bookmark = SlideBookmark.query.filter_by(deck_id=deck.id, slide_index=slide_index).first()\n        if not bookmark:\n            bookmark = SlideBookmark(deck_id=deck.id, slide_index=slide_index, is_auto=True, reason=reason)\n            db.session.add(bookmark)\n        else:\n            bookmark.is_auto = True\n            bookmark.reason = reason\n        db.session.commit()\n    else:\n        bookmark = SlideBookmark.query.filter_by(deck_id=deck.id, slide_index=slide_index).first()\n        if bookmark and bookmark.is_auto and not bookmark.is_manual:\n            db.session.delete(bookmark)\n            db.session.commit()\n        elif bookmark and bookmark.is_auto:\n            bookmark.is_auto = False\n            bookmark.reason = None\n            db.session.commit()\n    \n    return flagged, reason\n\n\n@socketio.on('set_slide_reaction')\ndef handle_set_slide_reaction(data):\n    if not current_user.is_authenticated or current_user.is_instructor():\n        return\n    \n    deck_id = data.get('deck_id')\n    slide_index = data.get('slide_index')\n    reaction = data.get('reaction', 'none')\n    \n    if reaction not in ['understood', 'question', 'hard', 'none']:\n        return\n    \n    deck = SlideDeck.query.get(deck_id)\n    if not deck:\n        return\n    \n    course = Course.query.get(deck.course_id)\n    if not course or not user_has_course_access(current_user, course):\n        return\n    \n    existing = SlideReaction.query.filter_by(\n        deck_id=deck_id,\n        user_id=current_user.id,\n        slide_index=slide_index\n    ).first()\n    \n    if reaction == 'none':\n        if existing:\n            db.session.delete(existing)\n            db.session.commit()\n    else:\n        if existing:\n            existing.reaction = reaction\n            existing.updated_at = datetime.utcnow()\n        else:\n            new_reaction = SlideReaction(\n                deck_id=deck_id,\n                user_id=current_user.id,\n                slide_index=slide_index,\n                reaction=reaction\n            )\n            db.session.add(new_reaction)\n        db.session.commit()\n    \n    counts = get_slide_aggregate(deck_id, slide_index)\n    flagged, reason = check_and_update_flag(deck, slide_index, counts)\n    \n    room = f'slide_deck_{deck_id}'\n    emit('slide_aggregate_updated', {\n        'slide_index': slide_index,\n        'counts': counts,\n        'flagged': flagged,\n        'reason': reason\n    }, room=room)\n\n\n@socketio.on('request_slide_aggregates')\ndef handle_request_slide_aggregates(data):\n    if not current_user.is_authenticated:\n        return\n    \n    deck_id = data.get('deck_id')\n    deck = SlideDeck.query.get(deck_id)\n    if not deck:\n        return\n    \n    all_aggregates = {}\n    flagged_slides = []\n    \n    for i in range(deck.slide_count):\n        counts = get_slide_aggregate(deck_id, i)\n        all_aggregates[i] = counts\n        \n        bookmark = SlideBookmark.query.filter_by(deck_id=deck_id, slide_index=i).first()\n        if bookmark:\n            flagged_slides.append({\n                'slide_index': i,\n                'is_auto': bookmark.is_auto,\n                'is_manual': bookmark.is_manual,\n                'reason': bookmark.reason\n            })\n    \n    emit('all_slide_aggregates', {\n        'aggregates': all_aggregates,\n        'flagged_slides': flagged_slides\n    })\n\n\n@socketio.on('toggle_slide_bookmark')\ndef handle_toggle_slide_bookmark(data):\n    if not current_user.is_authenticated or not current_user.is_instructor():\n        return\n    \n    deck_id = data.get('deck_id')\n    slide_index = data.get('slide_index')\n    \n    deck = SlideDeck.query.get(deck_id)\n    if not deck:\n        return\n    \n    course = Course.query.get(deck.course_id)\n    if not course or course.instructor_id != current_user.id:\n        return\n    \n    bookmark = SlideBookmark.query.filter_by(deck_id=deck_id, slide_index=slide_index).first()\n    is_bookmarked = False\n    \n    if bookmark:\n        if bookmark.is_auto and not bookmark.is_manual:\n            bookmark.is_manual = True\n            is_bookmarked = True\n        elif bookmark.is_manual and not bookmark.is_auto:\n            db.session.delete(bookmark)\n            is_bookmarked = False\n        else:\n            bookmark.is_manual = not bookmark.is_manual\n            is_bookmarked = bookmark.is_manual or bookmark.is_auto\n    else:\n        bookmark = SlideBookmark(deck_id=deck_id, slide_index=slide_index, is_manual=True)\n        db.session.add(bookmark)\n        is_bookmarked = True\n    \n    db.session.commit()\n    \n    room = f'slide_deck_{deck_id}'\n    emit('bookmark_updated', {\n        'slide_index': slide_index,\n        'is_bookmarked': is_bookmarked\n    }, room=room)\n","path":null,"size_bytes":19945,"size_tokens":null},"app/routes/progress.py":{"content":"from flask import Blueprint, jsonify, request\nfrom flask_login import login_required, current_user\nfrom app import db, socketio\nfrom app.models import Progress, Checkpoint, Enrollment\nfrom datetime import datetime\n\nbp = Blueprint('progress', __name__, url_prefix='/progress')\n\n@bp.route('/<int:checkpoint_id>/start', methods=['POST'])\n@login_required\ndef start(checkpoint_id):\n    checkpoint = Checkpoint.query.get_or_404(checkpoint_id)\n    course = checkpoint.course\n    \n    if not current_user.is_enrolled(course) and course.instructor_id != current_user.id:\n        return jsonify({'error': 'Not enrolled in this course'}), 403\n    \n    data = request.get_json() or {}\n    mode = data.get('mode', 'self_paced')\n    \n    progress = Progress.query.filter_by(\n        user_id=current_user.id,\n        checkpoint_id=checkpoint_id,\n        mode=mode\n    ).first()\n    \n    if not progress:\n        progress = Progress(\n            user_id=current_user.id,\n            checkpoint_id=checkpoint_id,\n            mode=mode,\n            started_at=datetime.utcnow(),\n            accumulated_seconds=0,\n            is_paused=False\n        )\n        db.session.add(progress)\n    elif not progress.started_at:\n        progress.started_at = datetime.utcnow()\n        if progress.completed_at:\n            progress.completed_at = None\n            progress.accumulated_seconds = 0\n            progress.duration_seconds = None\n        progress.is_paused = False\n    elif progress.is_paused:\n        pass\n    elif progress.completed_at:\n        progress.started_at = datetime.utcnow()\n        progress.completed_at = None\n        progress.accumulated_seconds = 0\n        progress.duration_seconds = None\n        progress.is_paused = False\n    \n    db.session.commit()\n    \n    return jsonify({\n        'success': True,\n        'checkpoint_id': checkpoint_id,\n        'started_at': progress.started_at.isoformat()\n    })\n\n@bp.route('/<int:checkpoint_id>/complete', methods=['POST'])\n@login_required\ndef complete(checkpoint_id):\n    checkpoint = Checkpoint.query.get_or_404(checkpoint_id)\n    course = checkpoint.course\n    \n    if not current_user.is_enrolled(course) and course.instructor_id != current_user.id:\n        return jsonify({'error': 'Not enrolled in this course'}), 403\n    \n    data = request.get_json() or {}\n    mode = data.get('mode', 'self_paced')\n    \n    progress = Progress.query.filter_by(\n        user_id=current_user.id,\n        checkpoint_id=checkpoint_id,\n        mode=mode\n    ).first()\n    \n    if not progress:\n        progress = Progress(\n            user_id=current_user.id,\n            checkpoint_id=checkpoint_id,\n            mode=mode,\n            started_at=datetime.utcnow(),\n            completed_at=datetime.utcnow(),\n            accumulated_seconds=0,\n            duration_seconds=0\n        )\n        db.session.add(progress)\n    else:\n        if not progress.is_paused and progress.started_at:\n            current_session = (datetime.utcnow() - progress.started_at).total_seconds()\n            progress.accumulated_seconds = (progress.accumulated_seconds or 0) + int(current_session)\n        \n        progress.completed_at = datetime.utcnow()\n        progress.duration_seconds = progress.accumulated_seconds if progress.accumulated_seconds else 0\n        progress.is_paused = False\n        progress.paused_at = None\n        progress.started_at = None\n    \n    db.session.commit()\n    \n    if mode == 'live':\n        socketio.emit('progress_update', {\n            'user_id': current_user.id,\n            'username': current_user.username,\n            'checkpoint_id': checkpoint_id,\n            'status': 'completed'\n        }, room=f'course_{course.id}')\n    \n    return jsonify({\n        'success': True,\n        'checkpoint_id': checkpoint_id,\n        'completed_at': progress.completed_at.isoformat(),\n        'duration_seconds': progress.duration_seconds\n    })\n\n@bp.route('/<int:checkpoint_id>/uncomplete', methods=['POST'])\n@login_required\ndef uncomplete(checkpoint_id):\n    checkpoint = Checkpoint.query.get_or_404(checkpoint_id)\n    course = checkpoint.course\n    \n    if not current_user.is_enrolled(course) and course.instructor_id != current_user.id:\n        return jsonify({'error': 'Not enrolled in this course'}), 403\n    \n    data = request.get_json() or {}\n    mode = data.get('mode', 'self_paced')\n    \n    progress = Progress.query.filter_by(\n        user_id=current_user.id,\n        checkpoint_id=checkpoint_id,\n        mode=mode\n    ).first()\n    \n    if progress and progress.completed_at:\n        progress.completed_at = None\n        progress.duration_seconds = None\n        db.session.commit()\n        \n        if mode == 'live':\n            socketio.emit('progress_update', {\n                'user_id': current_user.id,\n                'username': current_user.username,\n                'checkpoint_id': checkpoint_id,\n                'status': 'uncompleted'\n            }, room=f'course_{course.id}')\n        \n        return jsonify({\n            'success': True,\n            'checkpoint_id': checkpoint_id,\n            'status': 'uncompleted'\n        })\n    \n    return jsonify({'success': False, 'error': 'Progress not found or not completed'}), 400\n\n@bp.route('/<int:checkpoint_id>/pause', methods=['POST'])\n@login_required\ndef pause(checkpoint_id):\n    checkpoint = Checkpoint.query.get_or_404(checkpoint_id)\n    course = checkpoint.course\n    \n    if not current_user.is_enrolled(course) and course.instructor_id != current_user.id:\n        return jsonify({'error': 'Not enrolled in this course'}), 403\n    \n    data = request.get_json() or {}\n    mode = data.get('mode', 'self_paced')\n    \n    progress = Progress.query.filter_by(\n        user_id=current_user.id,\n        checkpoint_id=checkpoint_id,\n        mode=mode\n    ).first()\n    \n    if progress and progress.started_at and not progress.is_paused and not progress.completed_at:\n        current_session = (datetime.utcnow() - progress.started_at).total_seconds()\n        progress.accumulated_seconds = (progress.accumulated_seconds or 0) + int(current_session)\n        progress.paused_at = datetime.utcnow()\n        progress.is_paused = True\n        db.session.commit()\n        \n        return jsonify({\n            'success': True,\n            'checkpoint_id': checkpoint_id,\n            'status': 'paused',\n            'elapsed_seconds': progress.accumulated_seconds\n        })\n    \n    return jsonify({'success': False, 'error': 'Cannot pause'}), 400\n\n@bp.route('/<int:checkpoint_id>/resume', methods=['POST'])\n@login_required\ndef resume(checkpoint_id):\n    checkpoint = Checkpoint.query.get_or_404(checkpoint_id)\n    course = checkpoint.course\n    \n    if not current_user.is_enrolled(course) and course.instructor_id != current_user.id:\n        return jsonify({'error': 'Not enrolled in this course'}), 403\n    \n    data = request.get_json() or {}\n    mode = data.get('mode', 'self_paced')\n    \n    progress = Progress.query.filter_by(\n        user_id=current_user.id,\n        checkpoint_id=checkpoint_id,\n        mode=mode\n    ).first()\n    \n    if progress and progress.is_paused and not progress.completed_at:\n        progress.started_at = datetime.utcnow()\n        progress.paused_at = None\n        progress.is_paused = False\n        db.session.commit()\n        \n        return jsonify({\n            'success': True,\n            'checkpoint_id': checkpoint_id,\n            'status': 'resumed',\n            'elapsed_seconds': progress.accumulated_seconds or 0\n        })\n    \n    return jsonify({'success': False, 'error': 'Cannot resume'}), 400\n\n@bp.route('/<int:checkpoint_id>/stop', methods=['POST'])\n@login_required\ndef stop(checkpoint_id):\n    checkpoint = Checkpoint.query.get_or_404(checkpoint_id)\n    course = checkpoint.course\n    \n    if not current_user.is_enrolled(course) and course.instructor_id != current_user.id:\n        return jsonify({'error': 'Not enrolled in this course'}), 403\n    \n    data = request.get_json() or {}\n    mode = data.get('mode', 'self_paced')\n    \n    progress = Progress.query.filter_by(\n        user_id=current_user.id,\n        checkpoint_id=checkpoint_id,\n        mode=mode\n    ).first()\n    \n    if progress and progress.started_at and not progress.completed_at:\n        if not progress.is_paused:\n            current_session = (datetime.utcnow() - progress.started_at).total_seconds()\n            progress.accumulated_seconds = (progress.accumulated_seconds or 0) + int(current_session)\n        \n        progress.duration_seconds = progress.accumulated_seconds\n        progress.started_at = None\n        progress.paused_at = None\n        progress.is_paused = False\n        db.session.commit()\n        \n        return jsonify({\n            'success': True,\n            'checkpoint_id': checkpoint_id,\n            'status': 'stopped',\n            'duration_seconds': progress.duration_seconds\n        })\n    \n    return jsonify({'success': False, 'error': 'Cannot stop'}), 400\n\n@bp.route('/student/<int:user_id>')\n@login_required\ndef student_progress(user_id):\n    if current_user.id != user_id and not current_user.is_instructor():\n        return jsonify({'error': 'Access denied'}), 403\n    \n    progress_records = Progress.query.filter_by(user_id=user_id).all()\n    return jsonify([{\n        'checkpoint_id': p.checkpoint_id,\n        'mode': p.mode,\n        'started_at': p.started_at.isoformat() if p.started_at else None,\n        'completed_at': p.completed_at.isoformat() if p.completed_at else None,\n        'duration_seconds': p.duration_seconds\n    } for p in progress_records])\n\n@bp.route('/<int:checkpoint_id>/reset', methods=['POST'])\n@login_required\ndef reset(checkpoint_id):\n    checkpoint = Checkpoint.query.get_or_404(checkpoint_id)\n    course = checkpoint.course\n    \n    if not current_user.is_enrolled(course) and course.instructor_id != current_user.id:\n        return jsonify({'error': 'Not enrolled in this course'}), 403\n    \n    data = request.get_json() or {}\n    mode = data.get('mode', 'self_paced')\n    \n    progress = Progress.query.filter_by(\n        user_id=current_user.id,\n        checkpoint_id=checkpoint_id,\n        mode=mode\n    ).first()\n    \n    if progress:\n        progress.started_at = None\n        progress.completed_at = None\n        progress.paused_at = None\n        progress.accumulated_seconds = 0\n        progress.duration_seconds = None\n        progress.is_paused = False\n        db.session.commit()\n        \n        return jsonify({\n            'success': True,\n            'checkpoint_id': checkpoint_id,\n            'status': 'reset'\n        })\n    \n    return jsonify({'success': True, 'checkpoint_id': checkpoint_id, 'status': 'no_progress'})\n\n@bp.route('/course/<int:course_id>')\n@login_required\ndef course_progress(course_id):\n    from app.models import Course, Checkpoint\n    \n    course = Course.query.get_or_404(course_id)\n    \n    if course.instructor_id != current_user.id and not current_user.is_enrolled(course):\n        return jsonify({'error': 'Access denied'}), 403\n    \n    checkpoints = Checkpoint.query.filter_by(course_id=course_id, deleted_at=None).order_by(Checkpoint.order).all()\n    students = course.get_enrolled_students()\n    \n    data = request.args\n    mode = data.get('mode', 'all')\n    \n    result = []\n    for student in students:\n        student_progress = {}\n        for cp in checkpoints:\n            if mode == 'all':\n                live_progress = Progress.query.filter_by(user_id=student.id, checkpoint_id=cp.id, mode='live').first()\n                self_progress = Progress.query.filter_by(user_id=student.id, checkpoint_id=cp.id, mode='self_paced').first()\n                student_progress[cp.id] = {\n                    'live': {\n                        'started': live_progress.started_at is not None if live_progress else False,\n                        'completed': live_progress.completed_at is not None if live_progress else False,\n                        'duration_seconds': live_progress.duration_seconds if live_progress else None\n                    },\n                    'self_paced': {\n                        'started': self_progress.started_at is not None if self_progress else False,\n                        'completed': self_progress.completed_at is not None if self_progress else False,\n                        'duration_seconds': self_progress.duration_seconds if self_progress else None,\n                        'is_paused': self_progress.is_paused if self_progress else False,\n                        'elapsed_seconds': self_progress.get_elapsed_seconds() if self_progress else 0\n                    }\n                }\n            else:\n                progress = Progress.query.filter_by(user_id=student.id, checkpoint_id=cp.id, mode=mode).first()\n                student_progress[cp.id] = {\n                    'started': progress.started_at is not None if progress else False,\n                    'completed': progress.completed_at is not None if progress else False,\n                    'duration_seconds': progress.duration_seconds if progress else None\n                }\n        result.append({\n            'user_id': student.id,\n            'username': student.username,\n            'email': student.email,\n            'progress': student_progress\n        })\n    \n    return jsonify(result)\n","path":null,"size_bytes":13273,"size_tokens":null},"app/services/slide_converter.py":{"content":"import os\nimport subprocess\nimport tempfile\nimport shutil\nfrom pdf2image import convert_from_path\n\n\nSLIDES_BASE_DIR = os.path.join(os.path.dirname(os.path.dirname(os.path.dirname(__file__))), 'static', 'slides')\n\nALLOWED_EXTENSIONS = {'.pptx', '.ppt', '.pdf'}\n\n\ndef ensure_slides_dir():\n    os.makedirs(SLIDES_BASE_DIR, exist_ok=True)\n\n\ndef is_pdf(file_path):\n    return file_path.lower().endswith('.pdf')\n\n\ndef convert_file_to_images(file_path, deck_id):\n    deck_dir = os.path.join(SLIDES_BASE_DIR, str(deck_id))\n    os.makedirs(deck_dir, exist_ok=True)\n\n    if is_pdf(file_path):\n        pdf_path = file_path\n    else:\n        with tempfile.TemporaryDirectory() as tmp_dir:\n            result = subprocess.run([\n                'libreoffice',\n                '--headless',\n                '--convert-to', 'pdf',\n                '--outdir', tmp_dir,\n                file_path\n            ], capture_output=True, text=True, timeout=120)\n\n            if result.returncode != 0:\n                raise Exception(f'LibreOffice 변환 실패: {result.stderr}')\n\n            pdf_files = [f for f in os.listdir(tmp_dir) if f.endswith('.pdf')]\n            if not pdf_files:\n                raise Exception('PDF 변환 결과를 찾을 수 없습니다.')\n\n            tmp_pdf = os.path.join(tmp_dir, pdf_files[0])\n            pdf_path = os.path.join(deck_dir, '_source.pdf')\n            shutil.copy2(tmp_pdf, pdf_path)\n\n    images = convert_from_path(pdf_path, dpi=150, fmt='png')\n\n    if pdf_path.endswith('_source.pdf'):\n        os.unlink(pdf_path)\n\n    max_slides = 100\n    if len(images) > max_slides:\n        raise Exception(f'슬라이드가 {len(images)}장입니다. 최대 {max_slides}장까지 지원됩니다.')\n\n    slide_count = 0\n    for i, image in enumerate(images):\n        image_path = os.path.join(deck_dir, f'{i}.png')\n        image.save(image_path, 'PNG', optimize=True, quality=85)\n        slide_count += 1\n\n    return slide_count, deck_dir\n\n\ndef convert_pptx_to_images(file_path, deck_id):\n    return convert_file_to_images(file_path, deck_id)\n\n\ndef delete_deck_images(deck_dir):\n    if deck_dir and os.path.exists(deck_dir):\n        shutil.rmtree(deck_dir, ignore_errors=True)\n","path":null,"size_bytes":2194,"size_tokens":null},"app/routes/subjects.py":{"content":"from flask import Blueprint, render_template, redirect, url_for, flash, request, jsonify\nfrom flask_login import login_required, current_user\nfrom app import db\nfrom app.models import Subject, Course, Enrollment, SubjectEnrollment, SubjectMember, User, Notification\nfrom app.forms import SubjectForm\nfrom datetime import datetime\nimport io\nfrom openpyxl import Workbook, load_workbook\n\nbp = Blueprint('subjects', __name__, url_prefix='/subjects')\n\nMAX_FILE_SIZE = 100 * 1024 * 1024\n\ndef has_subject_access(subject, user, roles=['instructor', 'assistant']):\n    if subject.instructor_id == user.id:\n        return True\n    member = SubjectMember.query.filter_by(subject_id=subject.id, user_id=user.id).first()\n    if member and member.role in roles:\n        return True\n    return False\n\n@bp.route('/')\n@login_required\ndef list_subjects():\n    if current_user.is_instructor():\n        enrolled_subjects = Subject.query.filter_by(instructor_id=current_user.id).filter(Subject.deleted_at.is_(None)).order_by(Subject.created_at.desc()).all()\n        all_subjects = []\n    else:\n        enrolled_subject_ids = db.session.query(SubjectEnrollment.subject_id).filter(\n            SubjectEnrollment.user_id == current_user.id\n        ).all()\n        enrolled_ids = [s[0] for s in enrolled_subject_ids]\n        enrolled_subjects = Subject.query.filter(Subject.id.in_(enrolled_ids), Subject.deleted_at.is_(None), Subject.is_visible == True).all() if enrolled_ids else []\n        all_subjects = Subject.query.filter(\n            ~Subject.id.in_(enrolled_ids) if enrolled_ids else True,\n            Subject.deleted_at.is_(None),\n            Subject.is_visible == True\n        ).order_by(Subject.created_at.desc()).all()\n    \n    return render_template('subjects/list.html', \n                          enrolled_subjects=enrolled_subjects, \n                          all_subjects=all_subjects,\n                          is_instructor=current_user.is_instructor())\n\n@bp.route('/create', methods=['GET', 'POST'])\n@login_required\ndef create():\n    if not current_user.is_instructor():\n        flash('강사만 과목을 생성할 수 있습니다.', 'danger')\n        return redirect(url_for('subjects.list_subjects'))\n    \n    form = SubjectForm()\n    if form.validate_on_submit():\n        subject = Subject(\n            title=form.title.data,\n            description=form.description.data,\n            instructor_id=current_user.id,\n            invite_code=Subject.generate_invite_code()\n        )\n        db.session.add(subject)\n        db.session.flush()\n        \n        member = SubjectMember(\n            subject_id=subject.id,\n            user_id=current_user.id,\n            role='instructor'\n        )\n        db.session.add(member)\n        db.session.commit()\n        flash('과목이 생성되었습니다.', 'success')\n        return redirect(url_for('subjects.view', subject_id=subject.id))\n    return render_template('subjects/create.html', form=form)\n\n@bp.route('/<int:subject_id>')\n@login_required\ndef view(subject_id):\n    subject = Subject.query.get_or_404(subject_id)\n    \n    if subject.deleted_at:\n        if not (current_user.is_instructor() and subject.instructor_id == current_user.id):\n            flash('해당 과목을 찾을 수 없습니다.', 'danger')\n            return redirect(url_for('subjects.list_subjects'))\n    \n    if not subject.is_visible:\n        if not (current_user.is_instructor() and subject.instructor_id == current_user.id):\n            flash('해당 과목은 비공개 상태입니다.', 'warning')\n            return redirect(url_for('subjects.list_subjects'))\n    \n    courses = subject.courses.filter(Course.deleted_at.is_(None)).order_by(Course.order_number.asc().nullslast(), Course.week_number.asc().nullslast(), Course.created_at.asc()).all()\n    \n    is_enrolled = False\n    if not current_user.is_instructor():\n        subject_enrollment = SubjectEnrollment.query.filter_by(\n            subject_id=subject_id, \n            user_id=current_user.id\n        ).first()\n        is_enrolled = subject_enrollment is not None\n    \n    enrolled_count = SubjectEnrollment.query.filter_by(subject_id=subject_id, status='approved').count()\n    pending_count = SubjectEnrollment.query.filter_by(subject_id=subject_id, status='pending').count()\n    \n    return render_template('subjects/view.html', subject=subject, courses=courses, is_enrolled=is_enrolled, enrolled_count=enrolled_count, pending_count=pending_count)\n\n@bp.route('/<int:subject_id>/edit', methods=['GET', 'POST'])\n@login_required\ndef edit(subject_id):\n    subject = Subject.query.get_or_404(subject_id)\n    if not has_subject_access(subject, current_user):\n        flash('접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('subjects.list_subjects'))\n    \n    form = SubjectForm(obj=subject)\n    if form.validate_on_submit():\n        subject.title = form.title.data\n        subject.description = form.description.data\n        db.session.commit()\n        flash('과목이 수정되었습니다.', 'success')\n        return redirect(url_for('subjects.view', subject_id=subject.id))\n    return render_template('subjects/edit.html', form=form, subject=subject)\n\n@bp.route('/<int:subject_id>/add-course', methods=['GET', 'POST'])\n@login_required\ndef add_course(subject_id):\n    subject = Subject.query.get_or_404(subject_id)\n    if not has_subject_access(subject, current_user):\n        flash('접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('subjects.view', subject_id=subject_id))\n    \n    from app.forms import CourseForm\n    import base64\n    \n    form = CourseForm()\n    \n    if form.validate_on_submit():\n        order_num = form.order_number.data if form.order_number.data else subject.courses.count() + 1\n        \n        course = Course(\n            title=form.title.data,\n            description=form.description.data,\n            instructor_id=current_user.id,\n            subject_id=subject.id,\n            order_number=order_num,\n            session_type=form.session_type.data,\n            visibility=form.visibility.data,\n            video_url=form.video_url.data if form.session_type.data == 'video_external' else None,\n            assignment_description=form.assignment_description.data if form.session_type.data == 'assignment' else None,\n            quiz_time_limit=form.quiz_time_limit.data if form.session_type.data == 'quiz' else None,\n            quiz_pass_score=form.quiz_pass_score.data if form.session_type.data == 'quiz' else None,\n            invite_code=Course.generate_invite_code()\n        )\n        \n        if form.start_date.data:\n            course.start_date = datetime.strptime(form.start_date.data, '%Y-%m-%dT%H:%M')\n        if form.end_date.data:\n            course.end_date = datetime.strptime(form.end_date.data, '%Y-%m-%dT%H:%M')\n        if form.attendance_start.data:\n            course.attendance_start = datetime.strptime(form.attendance_start.data, '%Y-%m-%dT%H:%M')\n        if form.attendance_end.data:\n            course.attendance_end = datetime.strptime(form.attendance_end.data, '%Y-%m-%dT%H:%M')\n        if form.late_allowed.data and form.late_end.data:\n            course.late_allowed = True\n            course.late_end = datetime.strptime(form.late_end.data, '%Y-%m-%dT%H:%M')\n        if form.assignment_due_date.data:\n            course.assignment_due_date = datetime.strptime(form.assignment_due_date.data, '%Y-%m-%dT%H:%M')\n        \n        prereq_id = request.form.get('prerequisite_course_id')\n        if prereq_id and form.visibility.data == 'prerequisite':\n            course.prerequisite_course_id = int(prereq_id)\n        \n        if form.session_type.data == 'video' and 'video_file' in request.files:\n            video_file = request.files['video_file']\n            if video_file and video_file.filename:\n                file_content = video_file.read()\n                if len(file_content) > MAX_FILE_SIZE:\n                    flash('파일 크기가 100MB를 초과합니다.', 'danger')\n                    return render_template('subjects/add_course.html', form=form, subject=subject)\n                course.video_file_name = video_file.filename\n                course.video_file_path = base64.b64encode(file_content).decode('utf-8')\n                course.preparation_status = 'ready'\n        elif form.session_type.data == 'video_external' and form.video_url.data:\n            course.preparation_status = 'ready'\n        \n        if form.session_type.data == 'material' and 'material_file' in request.files:\n            material_file = request.files['material_file']\n            if material_file and material_file.filename:\n                file_content = material_file.read()\n                if len(file_content) > MAX_FILE_SIZE:\n                    flash('파일 크기가 100MB를 초과합니다.', 'danger')\n                    return render_template('subjects/add_course.html', form=form, subject=subject)\n                course.material_file_name = material_file.filename\n                ext = material_file.filename.rsplit('.', 1)[-1].lower() if '.' in material_file.filename else ''\n                course.material_file_type = ext\n                course.material_file_path = base64.b64encode(file_content).decode('utf-8')\n                course.preparation_status = 'ready'\n        \n        if form.session_type.data == 'live_session':\n            course.preparation_status = 'ready'\n        \n        db.session.add(course)\n        db.session.commit()\n        \n        session_type_names = {\n            'live_session': '라이브 세션',\n            'video': '동영상 시청',\n            'material': '학습 자료',\n            'assignment': '과제 제출',\n            'quiz': '퀴즈'\n        }\n        flash(f'{session_type_names.get(form.session_type.data, \"세션\")}이(가) 추가되었습니다.', 'success')\n        return redirect(url_for('subjects.view', subject_id=subject.id))\n    \n    return render_template('subjects/add_course.html', form=form, subject=subject)\n\n@bp.route('/<int:subject_id>/regenerate-code', methods=['POST'])\n@login_required\ndef regenerate_code(subject_id):\n    subject = Subject.query.get_or_404(subject_id)\n    if not has_subject_access(subject, current_user):\n        return jsonify({'success': False, 'message': '권한이 없습니다.'}), 403\n    \n    subject.invite_code = Subject.generate_invite_code()\n    db.session.commit()\n    return jsonify({'success': True, 'invite_code': subject.invite_code})\n\n@bp.route('/<int:subject_id>/enroll', methods=['POST'])\n@login_required\ndef enroll_subject(subject_id):\n    if current_user.is_instructor():\n        flash('강사는 과목 등록을 할 수 없습니다.', 'warning')\n        return redirect(url_for('subjects.view', subject_id=subject_id))\n    \n    subject = Subject.query.get_or_404(subject_id)\n    \n    if subject.deleted_at or not subject.is_visible:\n        flash('해당 과목에 등록할 수 없습니다.', 'danger')\n        return redirect(url_for('subjects.list_subjects'))\n    \n    existing_enrollment = SubjectEnrollment.query.filter_by(\n        subject_id=subject_id,\n        user_id=current_user.id\n    ).first()\n    \n    if existing_enrollment:\n        flash('이미 해당 과목에 등록되어 있습니다.', 'info')\n        return redirect(url_for('subjects.view', subject_id=subject_id))\n    \n    subject_enrollment = SubjectEnrollment(\n        subject_id=subject_id,\n        user_id=current_user.id\n    )\n    db.session.add(subject_enrollment)\n    \n    courses = subject.courses.filter(Course.deleted_at.is_(None), Course.visibility != 'private').all()\n    enrolled_count = 0\n    for course in courses:\n        if not current_user.is_enrolled(course):\n            enrollment = Enrollment(user_id=current_user.id, course_id=course.id)\n            db.session.add(enrollment)\n            enrolled_count += 1\n    \n    db.session.commit()\n    flash(f'{subject.title} 과목에 등록되었습니다. ({enrolled_count}개 세션 자동 등록)', 'success')\n    return redirect(url_for('subjects.view', subject_id=subject_id))\n\n\n@bp.route('/<int:subject_id>/unenroll', methods=['POST'])\n@login_required\ndef unenroll_subject(subject_id):\n    if current_user.is_instructor():\n        flash('강사는 과목 등록 취소를 할 수 없습니다.', 'warning')\n        return redirect(url_for('subjects.view', subject_id=subject_id))\n    \n    subject = Subject.query.get_or_404(subject_id)\n    \n    subject_enrollment = SubjectEnrollment.query.filter_by(\n        subject_id=subject_id,\n        user_id=current_user.id\n    ).first()\n    \n    if not subject_enrollment:\n        flash('해당 과목에 등록되어 있지 않습니다.', 'warning')\n        return redirect(url_for('subjects.view', subject_id=subject_id))\n    \n    db.session.delete(subject_enrollment)\n    \n    courses = subject.courses.all()\n    for course in courses:\n        enrollment = Enrollment.query.filter_by(\n            course_id=course.id,\n            user_id=current_user.id\n        ).first()\n        if enrollment:\n            db.session.delete(enrollment)\n    \n    db.session.commit()\n    flash(f'{subject.title} 과목 등록이 취소되었습니다.', 'success')\n    return redirect(url_for('subjects.list_subjects'))\n\n\n@bp.route('/enroll-by-code', methods=['POST'])\n@login_required\ndef enroll_by_code():\n    if current_user.is_instructor():\n        flash('강사는 과목 등록을 할 수 없습니다.', 'warning')\n        return redirect(url_for('main.dashboard'))\n    \n    invite_code = request.form.get('invite_code', '').strip().upper()\n    if not invite_code:\n        flash('초대 코드를 입력하세요.', 'danger')\n        return redirect(url_for('subjects.list_subjects'))\n    \n    subject = Subject.query.filter_by(invite_code=invite_code).first()\n    if subject and not subject.deleted_at and subject.is_visible:\n        existing_enrollment = SubjectEnrollment.query.filter_by(\n            subject_id=subject.id,\n            user_id=current_user.id\n        ).first()\n        \n        if existing_enrollment:\n            flash('이미 해당 과목에 등록되어 있습니다.', 'info')\n            return redirect(url_for('subjects.view', subject_id=subject.id))\n        \n        subject_enrollment = SubjectEnrollment(\n            subject_id=subject.id,\n            user_id=current_user.id\n        )\n        db.session.add(subject_enrollment)\n        \n        courses = subject.courses.filter(Course.deleted_at.is_(None), Course.visibility != 'private').all()\n        enrolled_count = 0\n        for course in courses:\n            if not current_user.is_enrolled(course):\n                enrollment = Enrollment(user_id=current_user.id, course_id=course.id)\n                db.session.add(enrollment)\n                enrolled_count += 1\n        \n        db.session.commit()\n        flash(f'{subject.title} 과목에 등록되었습니다. ({enrolled_count}개 세션 자동 등록)', 'success')\n        return redirect(url_for('subjects.view', subject_id=subject.id))\n    \n    flash('유효하지 않은 초대 코드입니다.', 'danger')\n    return redirect(url_for('subjects.list_subjects'))\n\n\n@bp.route('/<int:subject_id>/delete', methods=['POST'])\n@login_required\ndef delete_subject(subject_id):\n    subject = Subject.query.get_or_404(subject_id)\n    if not has_subject_access(subject, current_user):\n        flash('접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('subjects.list_subjects'))\n    \n    subject.deleted_at = datetime.now()\n    db.session.commit()\n    flash(f'{subject.title} 과목이 삭제되었습니다.', 'success')\n    return redirect(url_for('subjects.list_subjects'))\n\n\n@bp.route('/<int:subject_id>/toggle-visibility', methods=['POST'])\n@login_required\ndef toggle_subject_visibility(subject_id):\n    subject = Subject.query.get_or_404(subject_id)\n    if not has_subject_access(subject, current_user):\n        flash('접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('subjects.view', subject_id=subject_id))\n    \n    subject.is_visible = not subject.is_visible\n    db.session.commit()\n    status = '공개' if subject.is_visible else '비공개'\n    flash(f'{subject.title} 과목이 {status}로 변경되었습니다.', 'success')\n    return redirect(url_for('subjects.view', subject_id=subject_id))\n\n\n@bp.route('/course/<int:course_id>/delete', methods=['POST'])\n@login_required\ndef delete_course(course_id):\n    course = Course.query.get_or_404(course_id)\n    if course.instructor_id != current_user.id:\n        flash('접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('subjects.list_subjects'))\n    \n    subject_id = course.subject_id\n    course.deleted_at = datetime.now()\n    db.session.commit()\n    flash(f'{course.title} 세션이 삭제되었습니다.', 'success')\n    \n    if subject_id:\n        return redirect(url_for('subjects.view', subject_id=subject_id))\n    return redirect(url_for('subjects.list_subjects'))\n\n\n@bp.route('/course/<int:course_id>/toggle-visibility', methods=['POST'])\n@login_required\ndef toggle_course_visibility(course_id):\n    course = Course.query.get_or_404(course_id)\n    if course.instructor_id != current_user.id:\n        flash('접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('subjects.list_subjects'))\n    \n    if course.visibility == 'private':\n        course.visibility = 'public'\n        status = '공개'\n    else:\n        course.visibility = 'private'\n        status = '비공개'\n    db.session.commit()\n    flash(f'{course.title} 세션이 {status}로 변경되었습니다.', 'success')\n    \n    if course.subject_id:\n        return redirect(url_for('subjects.view', subject_id=course.subject_id))\n    return redirect(url_for('courses.view', course_id=course_id))\n\n\n@bp.route('/course/<int:course_id>/get', methods=['GET'])\n@login_required\ndef get_course(course_id):\n    course = Course.query.get_or_404(course_id)\n    if course.instructor_id != current_user.id:\n        return jsonify({'success': False, 'message': '강사만 세션을 수정할 수 있습니다.'}), 403\n    \n    return jsonify({\n        'success': True,\n        'course': {\n            'id': course.id,\n            'title': course.title,\n            'description': course.description or '',\n            'session_type': course.session_type,\n            'order_number': course.order_number or course.week_number or 1,\n            'visibility': course.visibility,\n            'video_url': course.video_url or '',\n            'video_file_name': course.video_file_name or '',\n            'material_file_name': course.material_file_name or '',\n            'assignment_description': course.assignment_description or '',\n            'assignment_due_date': course.assignment_due_date.strftime('%Y-%m-%dT%H:%M') if course.assignment_due_date else '',\n            'quiz_time_limit': course.quiz_time_limit or 30,\n            'quiz_pass_score': course.quiz_pass_score or 60,\n            'start_date': course.start_date.strftime('%Y-%m-%dT%H:%M') if course.start_date else '',\n            'end_date': course.end_date.strftime('%Y-%m-%dT%H:%M') if course.end_date else '',\n            'attendance_start': course.attendance_start.strftime('%Y-%m-%dT%H:%M') if course.attendance_start else '',\n            'attendance_end': course.attendance_end.strftime('%Y-%m-%dT%H:%M') if course.attendance_end else '',\n            'late_allowed': course.late_allowed or False,\n            'late_end': course.late_end.strftime('%Y-%m-%dT%H:%M') if course.late_end else '',\n        }\n    })\n\n\n@bp.route('/course/<int:course_id>/update', methods=['POST'])\n@login_required\ndef update_course(course_id):\n    import base64\n    \n    course = Course.query.get_or_404(course_id)\n    if course.instructor_id != current_user.id:\n        return jsonify({'success': False, 'message': '강사만 세션을 수정할 수 있습니다.'}), 403\n    \n    try:\n        data = request.form\n        \n        course.title = data.get('title', course.title)\n        course.description = data.get('description', course.description)\n        if data.get('order_number'):\n            course.order_number = int(data.get('order_number'))\n        course.visibility = data.get('visibility', course.visibility)\n        \n        if course.session_type == 'video_external':\n            new_url = data.get('video_url', '')\n            if new_url:\n                course.video_url = new_url\n                course.preparation_status = 'ready'\n        \n        if course.session_type == 'video' and 'video_file' in request.files:\n            video_file = request.files['video_file']\n            if video_file and video_file.filename:\n                file_content = video_file.read()\n                if len(file_content) > MAX_FILE_SIZE:\n                    return jsonify({'success': False, 'message': '파일 크기가 100MB를 초과합니다.'}), 400\n                course.video_file_name = video_file.filename\n                course.video_file_path = base64.b64encode(file_content).decode('utf-8')\n                course.preparation_status = 'ready'\n        \n        if course.session_type == 'material' and 'material_file' in request.files:\n            material_file = request.files['material_file']\n            if material_file and material_file.filename:\n                file_content = material_file.read()\n                if len(file_content) > MAX_FILE_SIZE:\n                    return jsonify({'success': False, 'message': '파일 크기가 100MB를 초과합니다.'}), 400\n                course.material_file_name = material_file.filename\n                ext = material_file.filename.rsplit('.', 1)[-1].lower() if '.' in material_file.filename else ''\n                course.material_file_type = ext\n                course.material_file_path = base64.b64encode(file_content).decode('utf-8')\n                course.preparation_status = 'ready'\n        \n        if course.session_type == 'assignment':\n            course.assignment_description = data.get('assignment_description', course.assignment_description)\n            if data.get('assignment_due_date'):\n                course.assignment_due_date = datetime.strptime(data.get('assignment_due_date'), '%Y-%m-%dT%H:%M')\n        \n        if course.session_type == 'quiz':\n            course.quiz_time_limit = int(data.get('quiz_time_limit', 30))\n            course.quiz_pass_score = int(data.get('quiz_pass_score', 60))\n        \n        if data.get('start_date'):\n            course.start_date = datetime.strptime(data.get('start_date'), '%Y-%m-%dT%H:%M')\n        if data.get('end_date'):\n            course.end_date = datetime.strptime(data.get('end_date'), '%Y-%m-%dT%H:%M')\n        if data.get('attendance_start'):\n            course.attendance_start = datetime.strptime(data.get('attendance_start'), '%Y-%m-%dT%H:%M')\n        if data.get('attendance_end'):\n            course.attendance_end = datetime.strptime(data.get('attendance_end'), '%Y-%m-%dT%H:%M')\n        if data.get('late_allowed') == 'on' and data.get('late_end'):\n            course.late_allowed = True\n            course.late_end = datetime.strptime(data.get('late_end'), '%Y-%m-%dT%H:%M')\n        else:\n            course.late_allowed = False\n            course.late_end = None\n        \n        db.session.commit()\n        \n        return jsonify({'success': True, 'message': '세션이 성공적으로 수정되었습니다.'})\n    except Exception as e:\n        db.session.rollback()\n        return jsonify({'success': False, 'message': str(e)}), 500\n\n\n@bp.route('/<int:subject_id>/members')\n@login_required\ndef members(subject_id):\n    subject = Subject.query.get_or_404(subject_id)\n    if not has_subject_access(subject, current_user):\n        flash('접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('subjects.view', subject_id=subject_id))\n    \n    members_list = SubjectMember.query.filter_by(subject_id=subject_id).all()\n    \n    member_data = {\n        'instructors': [],\n        'assistants': [],\n        'students': []\n    }\n    \n    for member in members_list:\n        user = member.user\n        data = {'member': member, 'user': user}\n        if member.role == 'instructor':\n            member_data['instructors'].append(data)\n        elif member.role == 'assistant':\n            member_data['assistants'].append(data)\n        else:\n            member_data['students'].append(data)\n    \n    enrollments = SubjectEnrollment.query.filter_by(subject_id=subject_id).all()\n    \n    enrollment_data = {\n        'approved': [],\n        'pending': [],\n        'rejected': []\n    }\n    \n    for enrollment in enrollments:\n        data = {'enrollment': enrollment, 'user': enrollment.user}\n        status = enrollment.status or 'approved'\n        if status in enrollment_data:\n            enrollment_data[status].append(data)\n        else:\n            enrollment_data['approved'].append(data)\n    \n    return render_template('subjects/members.html', \n                          subject=subject, \n                          member_data=member_data,\n                          enrollment_data=enrollment_data)\n\n\n@bp.route('/<int:subject_id>/members/add', methods=['POST'])\n@login_required\ndef add_member(subject_id):\n    subject = Subject.query.get_or_404(subject_id)\n    if not has_subject_access(subject, current_user):\n        return jsonify({'success': False, 'message': '권한이 없습니다.'}), 403\n    \n    email = request.form.get('email')\n    role = request.form.get('role', 'student')\n    require_approval = request.form.get('require_approval', 'true') == 'true'\n    \n    if role not in ['instructor', 'assistant', 'student', 'ta', 'auditor']:\n        flash('잘못된 역할입니다.', 'danger')\n        return redirect(url_for('subjects.members', subject_id=subject_id))\n    \n    user = User.query.filter_by(email=email).first()\n    if not user:\n        flash('해당 이메일의 사용자를 찾을 수 없습니다.', 'danger')\n        return redirect(url_for('subjects.members', subject_id=subject_id))\n    \n    existing = SubjectMember.query.filter_by(subject_id=subject_id, user_id=user.id).first()\n    if existing:\n        existing.role = role\n        db.session.commit()\n        flash(f'{user.display_name}의 역할이 {SubjectMember.get_role_display(role)}(으)로 변경되었습니다.', 'success')\n    else:\n        subject_enrollment = SubjectEnrollment.query.filter_by(\n            subject_id=subject_id, user_id=user.id\n        ).first()\n        \n        enrollment_role = 'student' if role in ['student', 'instructor', 'assistant'] else role\n        \n        if subject_enrollment:\n            if subject_enrollment.status == 'approved':\n                flash('이미 등록된 사용자입니다.', 'info')\n                return redirect(url_for('subjects.members', subject_id=subject_id))\n            subject_enrollment.status = 'pending' if require_approval else 'approved'\n            subject_enrollment.role = enrollment_role\n        else:\n            subject_enrollment = SubjectEnrollment(\n                subject_id=subject_id, \n                user_id=user.id,\n                status='pending' if require_approval else 'approved',\n                role=enrollment_role\n            )\n            db.session.add(subject_enrollment)\n        \n        if require_approval:\n            Notification.create_enrollment_invite(user.id, subject, enrollment_role)\n            db.session.commit()\n            flash(f'{user.display_name}에게 등록 초대를 발송했습니다. 승인 대기 중입니다.', 'success')\n        else:\n            subject_enrollment.approved_at = datetime.utcnow()\n            \n            member = SubjectMember(subject_id=subject_id, user_id=user.id, role=role)\n            db.session.add(member)\n            \n            courses = Course.query.filter_by(subject_id=subject_id, deleted_at=None).filter(\n                Course.visibility != 'private'\n            ).all()\n            for course in courses:\n                existing_enrollment = Enrollment.query.filter_by(\n                    course_id=course.id, user_id=user.id\n                ).first()\n                if not existing_enrollment:\n                    enrollment = Enrollment(course_id=course.id, user_id=user.id)\n                    db.session.add(enrollment)\n            \n            db.session.commit()\n            flash(f'{user.display_name}이(가) {SubjectMember.get_role_display(role)}(으)로 추가되었습니다.', 'success')\n    \n    return redirect(url_for('subjects.members', subject_id=subject_id))\n\n\n@bp.route('/<int:subject_id>/members/<int:member_id>/remove', methods=['POST'])\n@login_required\ndef remove_member(subject_id, member_id):\n    subject = Subject.query.get_or_404(subject_id)\n    if not has_subject_access(subject, current_user):\n        flash('권한이 없습니다.', 'danger')\n        return redirect(url_for('subjects.members', subject_id=subject_id))\n    \n    member = SubjectMember.query.get_or_404(member_id)\n    if member.subject_id != subject_id:\n        flash('잘못된 요청입니다.', 'danger')\n        return redirect(url_for('subjects.members', subject_id=subject_id))\n    \n    user_email = member.user.email\n    db.session.delete(member)\n    db.session.commit()\n    flash(f'{user_email}이(가) 역할에서 제외되었습니다.', 'success')\n    return redirect(url_for('subjects.members', subject_id=subject_id))\n\n\n@bp.route('/<int:subject_id>/members/<int:member_id>/change-role', methods=['POST'])\n@login_required\ndef change_member_role(subject_id, member_id):\n    subject = Subject.query.get_or_404(subject_id)\n    if not has_subject_access(subject, current_user):\n        return jsonify({'success': False, 'message': '권한이 없습니다.'}), 403\n    \n    member = SubjectMember.query.get_or_404(member_id)\n    if member.subject_id != subject_id:\n        return jsonify({'success': False, 'message': '잘못된 요청입니다.'}), 400\n    \n    new_role = request.form.get('role')\n    if new_role not in ['instructor', 'assistant', 'student']:\n        return jsonify({'success': False, 'message': '잘못된 역할입니다.'}), 400\n    \n    member.role = new_role\n    db.session.commit()\n    flash(f'{member.user.email}의 역할이 {SubjectMember.get_role_display(new_role)}(으)로 변경되었습니다.', 'success')\n    return redirect(url_for('subjects.members', subject_id=subject_id))\n\n\n@bp.route('/<int:subject_id>/members/excel-template')\n@login_required\ndef download_member_template(subject_id):\n    from flask import Response\n    subject = Subject.query.get_or_404(subject_id)\n    if not has_subject_access(subject, current_user):\n        flash('권한이 없습니다.', 'danger')\n        return redirect(url_for('subjects.view', subject_id=subject_id))\n    \n    wb = Workbook()\n    ws = wb.active\n    ws.title = '사용자 등록'\n    \n    ws['A1'] = '이메일 (필수)'\n    ws['B1'] = '역할 (선택: instructor/assistant/student)'\n    ws['C1'] = '이름 (신규 사용자시 필수)'\n    \n    from openpyxl.styles import Font, PatternFill\n    header_font = Font(bold=True)\n    header_fill = PatternFill(start_color='E0E0E0', end_color='E0E0E0', fill_type='solid')\n    for col in ['A', 'B', 'C']:\n        ws[f'{col}1'].font = header_font\n        ws[f'{col}1'].fill = header_fill\n        ws.column_dimensions[col].width = 40\n    \n    example_font = Font(italic=True, color='888888')\n    ws['A2'] = '(예시) example@email.com'\n    ws['B2'] = '(예시) student'\n    ws['C2'] = '(예시) 홍길동'\n    for col in ['A', 'B', 'C']:\n        ws[f'{col}2'].font = example_font\n    \n    output = io.BytesIO()\n    wb.save(output)\n    output.seek(0)\n    \n    return Response(\n        output.getvalue(),\n        mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n        headers={'Content-Disposition': f'attachment;filename=member_template_{subject_id}.xlsx'}\n    )\n\n\n@bp.route('/<int:subject_id>/members/upload-excel', methods=['POST'])\n@login_required\ndef upload_members_excel(subject_id):\n    subject = Subject.query.get_or_404(subject_id)\n    if not has_subject_access(subject, current_user):\n        flash('권한이 없습니다.', 'danger')\n        return redirect(url_for('subjects.members', subject_id=subject_id))\n    \n    if 'excel_file' not in request.files:\n        flash('파일을 선택해주세요.', 'danger')\n        return redirect(url_for('subjects.members', subject_id=subject_id))\n    \n    file = request.files['excel_file']\n    if file.filename == '':\n        flash('파일을 선택해주세요.', 'danger')\n        return redirect(url_for('subjects.members', subject_id=subject_id))\n    \n    if not file.filename.endswith(('.xlsx', '.xls')):\n        flash('엑셀 파일(.xlsx, .xls)만 업로드 가능합니다.', 'danger')\n        return redirect(url_for('subjects.members', subject_id=subject_id))\n    \n    try:\n        wb = load_workbook(file)\n        ws = wb.active\n        \n        added_count = 0\n        updated_count = 0\n        skipped_count = 0\n        error_messages = []\n        \n        for row_num, row in enumerate(ws.iter_rows(min_row=3, values_only=True), start=3):\n            if not row or not row[0]:\n                continue\n                \n            email = str(row[0]).strip()\n            role = str(row[1]).strip().lower() if row[1] else 'student'\n            name = str(row[2]).strip() if len(row) > 2 and row[2] else None\n            \n            import re\n            email_pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$'\n            if not re.match(email_pattern, email):\n                skipped_count += 1\n                error_messages.append(f'행 {row_num}: {email} - 잘못된 이메일 형식')\n                continue\n            \n            if role not in ['instructor', 'assistant', 'student']:\n                role = 'student'\n            \n            user = User.query.filter_by(email=email).first()\n            if not user:\n                if not name:\n                    skipped_count += 1\n                    error_messages.append(f'행 {row_num}: {email} - 등록되지 않은 사용자 (신규 등록시 이름 필수)')\n                    continue\n                \n                import secrets\n                username = email.split('@')[0]\n                base_username = username\n                counter = 1\n                while User.query.filter_by(username=username).first():\n                    username = f\"{base_username}{counter}\"\n                    counter += 1\n                \n                temp_password = secrets.token_urlsafe(8)\n                user = User(\n                    username=username,\n                    email=email,\n                    full_name=name,\n                    role='student' if role == 'student' else 'instructor'\n                )\n                user.set_password(temp_password)\n                db.session.add(user)\n                db.session.flush()\n                error_messages.append(f'행 {row_num}: {email} - 신규 사용자 생성 (임시 비밀번호: {temp_password})')\n            \n            existing = SubjectMember.query.filter_by(subject_id=subject_id, user_id=user.id).first()\n            if existing:\n                if existing.role != role:\n                    existing.role = role\n                    updated_count += 1\n                else:\n                    skipped_count += 1\n            else:\n                member = SubjectMember(subject_id=subject_id, user_id=user.id, role=role)\n                db.session.add(member)\n                \n                subject_enrollment = SubjectEnrollment.query.filter_by(\n                    subject_id=subject_id, user_id=user.id\n                ).first()\n                if not subject_enrollment:\n                    subject_enrollment = SubjectEnrollment(subject_id=subject_id, user_id=user.id)\n                    db.session.add(subject_enrollment)\n                \n                if role == 'student':\n                    courses = Course.query.filter_by(subject_id=subject_id, deleted_at=None).filter(\n                        Course.visibility != 'private'\n                    ).all()\n                    for course in courses:\n                        existing_enrollment = Enrollment.query.filter_by(\n                            course_id=course.id, user_id=user.id\n                        ).first()\n                        if not existing_enrollment:\n                            enrollment = Enrollment(course_id=course.id, user_id=user.id)\n                            db.session.add(enrollment)\n                \n                added_count += 1\n        \n        db.session.commit()\n        \n        message_parts = []\n        if added_count > 0:\n            message_parts.append(f'{added_count}명 추가')\n        if updated_count > 0:\n            message_parts.append(f'{updated_count}명 역할 변경')\n        if skipped_count > 0:\n            message_parts.append(f'{skipped_count}명 건너뜀')\n        \n        if message_parts:\n            flash(f'엑셀 업로드 완료: {\", \".join(message_parts)}', 'success')\n        else:\n            flash('처리할 데이터가 없습니다.', 'info')\n        \n        if error_messages and len(error_messages) <= 5:\n            for msg in error_messages:\n                flash(msg, 'warning')\n        elif error_messages:\n            flash(f'{len(error_messages)}개의 행에서 오류가 발생했습니다.', 'warning')\n            \n    except Exception as e:\n        db.session.rollback()\n        flash(f'파일 처리 중 오류가 발생했습니다: {str(e)}', 'danger')\n    \n    return redirect(url_for('subjects.members', subject_id=subject_id))\n\n\n@bp.route('/<int:subject_id>/enrollment/approve', methods=['POST'])\n@login_required\ndef approve_enrollment(subject_id):\n    subject = Subject.query.get_or_404(subject_id)\n    \n    enrollment = SubjectEnrollment.query.filter_by(\n        subject_id=subject_id,\n        user_id=current_user.id,\n        status='pending'\n    ).first()\n    \n    if not enrollment:\n        flash('대기 중인 등록 요청이 없습니다.', 'warning')\n        return redirect(url_for('main.dashboard'))\n    \n    enrollment.status = 'approved'\n    enrollment.approved_at = datetime.utcnow()\n    \n    member = SubjectMember.query.filter_by(subject_id=subject_id, user_id=current_user.id).first()\n    if not member:\n        member = SubjectMember(\n            subject_id=subject_id, \n            user_id=current_user.id, \n            role=enrollment.role if enrollment.role in ['ta', 'auditor'] else 'student'\n        )\n        db.session.add(member)\n    \n    courses = Course.query.filter_by(subject_id=subject_id, deleted_at=None).filter(\n        Course.visibility != 'private'\n    ).all()\n    for course in courses:\n        existing_enrollment = Enrollment.query.filter_by(\n            course_id=course.id, user_id=current_user.id\n        ).first()\n        if not existing_enrollment:\n            course_enrollment = Enrollment(course_id=course.id, user_id=current_user.id)\n            db.session.add(course_enrollment)\n    \n    db.session.commit()\n    flash(f'{subject.title} 과목에 등록되었습니다.', 'success')\n    return redirect(url_for('subjects.view', subject_id=subject_id))\n\n\n@bp.route('/<int:subject_id>/enrollment/reject', methods=['POST'])\n@login_required\ndef reject_enrollment(subject_id):\n    subject = Subject.query.get_or_404(subject_id)\n    \n    enrollment = SubjectEnrollment.query.filter_by(\n        subject_id=subject_id,\n        user_id=current_user.id,\n        status='pending'\n    ).first()\n    \n    if not enrollment:\n        flash('대기 중인 등록 요청이 없습니다.', 'warning')\n        return redirect(url_for('main.dashboard'))\n    \n    enrollment.status = 'rejected'\n    enrollment.rejected_at = datetime.utcnow()\n    db.session.commit()\n    \n    flash(f'{subject.title} 과목 등록을 거절했습니다.', 'info')\n    return redirect(url_for('main.dashboard'))\n\n\n@bp.route('/<int:subject_id>/enrollment/<int:user_id>/admin-approve', methods=['POST'])\n@login_required\ndef admin_approve_enrollment(subject_id, user_id):\n    subject = Subject.query.get_or_404(subject_id)\n    \n    if not has_subject_access(subject, current_user):\n        flash('권한이 없습니다.', 'danger')\n        return redirect(url_for('subjects.members', subject_id=subject_id))\n    \n    enrollment = SubjectEnrollment.query.filter_by(\n        subject_id=subject_id,\n        user_id=user_id,\n        status='pending'\n    ).first()\n    \n    if not enrollment:\n        flash('대기 중인 등록 요청이 없습니다.', 'warning')\n        return redirect(url_for('subjects.members', subject_id=subject_id))\n    \n    enrollment.status = 'approved'\n    enrollment.approved_at = datetime.utcnow()\n    \n    member = SubjectMember.query.filter_by(subject_id=subject_id, user_id=user_id).first()\n    if not member:\n        member = SubjectMember(\n            subject_id=subject_id, \n            user_id=user_id, \n            role=enrollment.role if enrollment.role in ['ta', 'auditor'] else 'student'\n        )\n        db.session.add(member)\n    \n    courses = Course.query.filter_by(subject_id=subject_id, deleted_at=None).filter(\n        Course.visibility != 'private'\n    ).all()\n    for course in courses:\n        existing_enrollment = Enrollment.query.filter_by(\n            course_id=course.id, user_id=user_id\n        ).first()\n        if not existing_enrollment:\n            course_enrollment = Enrollment(course_id=course.id, user_id=user_id)\n            db.session.add(course_enrollment)\n    \n    Notification.create_enrollment_approved(user_id, subject, enrollment.role or 'student')\n    db.session.commit()\n    \n    user = User.query.get(user_id)\n    flash(f'{user.display_name}의 등록 신청을 승인했습니다.', 'success')\n    return redirect(url_for('subjects.members', subject_id=subject_id))\n\n\n@bp.route('/<int:subject_id>/enrollment/<int:user_id>/admin-reject', methods=['POST'])\n@login_required\ndef admin_reject_enrollment(subject_id, user_id):\n    subject = Subject.query.get_or_404(subject_id)\n    \n    if not has_subject_access(subject, current_user):\n        flash('권한이 없습니다.', 'danger')\n        return redirect(url_for('subjects.members', subject_id=subject_id))\n    \n    enrollment = SubjectEnrollment.query.filter_by(\n        subject_id=subject_id,\n        user_id=user_id,\n        status='pending'\n    ).first()\n    \n    if not enrollment:\n        flash('대기 중인 등록 요청이 없습니다.', 'warning')\n        return redirect(url_for('subjects.members', subject_id=subject_id))\n    \n    enrollment.status = 'rejected'\n    enrollment.rejected_at = datetime.utcnow()\n    \n    Notification.create_enrollment_rejected(user_id, subject, enrollment.role or 'student')\n    db.session.commit()\n    \n    user = User.query.get(user_id)\n    flash(f'{user.display_name}의 등록 신청을 거절했습니다.', 'info')\n    return redirect(url_for('subjects.members', subject_id=subject_id))\n\n\n@bp.route('/<int:subject_id>/change-enrollment-status/<int:user_id>', methods=['POST'])\n@login_required\ndef change_enrollment_status(subject_id, user_id):\n    subject = Subject.query.get_or_404(subject_id)\n    \n    if not has_subject_access(subject, current_user):\n        flash('권한이 없습니다.', 'danger')\n        return redirect(url_for('subjects.members', subject_id=subject_id))\n    \n    enrollment = SubjectEnrollment.query.filter_by(\n        subject_id=subject_id,\n        user_id=user_id\n    ).first()\n    \n    if not enrollment:\n        flash('등록 정보를 찾을 수 없습니다.', 'warning')\n        return redirect(url_for('subjects.members', subject_id=subject_id))\n    \n    new_status = request.form.get('status')\n    new_role = request.form.get('role')\n    \n    user = User.query.get(user_id)\n    \n    if new_status and new_status in ['approved', 'pending', 'rejected']:\n        old_status = enrollment.status\n        enrollment.status = new_status\n        if new_status == 'rejected':\n            enrollment.rejected_at = datetime.utcnow()\n        elif new_status == 'approved' and old_status != 'approved':\n            enrollment.rejected_at = None\n        flash(f'{user.display_name}의 상태가 변경되었습니다.', 'success')\n    \n    if new_role and new_role in ['student', 'ta']:\n        enrollment.role = new_role\n        flash(f'{user.display_name}의 역할이 변경되었습니다.', 'success')\n    \n    db.session.commit()\n    return redirect(url_for('subjects.members', subject_id=subject_id))\n\n\n@bp.route('/my-pending-enrollments')\n@login_required\ndef my_pending_enrollments():\n    pending_enrollments = SubjectEnrollment.query.filter_by(\n        user_id=current_user.id,\n        status='pending'\n    ).all()\n    \n    return render_template('subjects/pending_enrollments.html', \n                          pending_enrollments=pending_enrollments)\n\n\n@bp.route('/apply-role', methods=['POST'])\n@login_required\ndef apply_role():\n    subject_id = request.form.get('subject_id', type=int)\n    role = request.form.get('role')\n    \n    if role not in ['ta', 'auditor']:\n        flash('잘못된 역할입니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    subject = Subject.query.get_or_404(subject_id)\n    \n    existing = SubjectEnrollment.query.filter_by(\n        subject_id=subject_id, user_id=current_user.id\n    ).first()\n    \n    if existing and existing.status == 'approved':\n        flash('이미 해당 과목에 등록되어 있습니다.', 'info')\n        return redirect(url_for('subjects.view', subject_id=subject_id))\n    \n    if existing and existing.status == 'pending':\n        flash('이미 등록 요청이 대기 중입니다.', 'info')\n        return redirect(url_for('main.dashboard'))\n    \n    if existing:\n        existing.status = 'pending'\n        existing.role = role\n    else:\n        enrollment = SubjectEnrollment(\n            subject_id=subject_id,\n            user_id=current_user.id,\n            status='pending',\n            role=role\n        )\n        db.session.add(enrollment)\n    \n    notification = Notification(\n        user_id=subject.instructor_id,\n        type='role_application',\n        title=f'{Notification.get_role_display(role)} 신청',\n        message=f'{current_user.display_name}님이 {subject.title} 과목에 {Notification.get_role_display(role)}(으)로 신청했습니다.',\n        data={'subject_id': subject_id, 'user_id': current_user.id, 'role': role}\n    )\n    db.session.add(notification)\n    db.session.commit()\n    \n    flash(f'{subject.title} 과목에 {Notification.get_role_display(role)}(으)로 신청했습니다. 승인을 기다려주세요.', 'success')\n    return redirect(url_for('main.dashboard'))\n","path":null,"size_bytes":46720,"size_tokens":null},"app/static/css/style.css":{"content":":root {\n    --primary-gradient: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);\n    --secondary-gradient: linear-gradient(135deg, #10b981 0%, #34d399 100%);\n    --tertiary-gradient: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);\n    --primary-color: #3b82f6;\n    --primary-hover: #2563eb;\n    --accent-color: #8b5cf6;\n    --success-color: #10b981;\n    --warning-color: #f59e0b;\n    --danger-color: #ef4444;\n    --navy-primary: #0f172a;\n    --navy-secondary: #1e293b;\n    --navy-light: #334155;\n    --navy-accent: #3b82f6;\n    --glass-bg: rgba(255, 255, 255, 0.98);\n    --glass-border: rgba(0, 0, 0, 0.06);\n    --shadow-soft: 0 4px 24px rgba(0, 0, 0, 0.06);\n    --shadow-hover: 0 12px 40px rgba(0, 0, 0, 0.1);\n    --border-radius: 14px;\n    --border-radius-lg: 20px;\n    --border-radius-sm: 10px;\n    --transition-fast: 0.15s ease;\n    --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n* {\n    font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n}\n\nbody {\n    min-height: 100vh;\n    display: flex;\n    flex-direction: column;\n    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);\n    background-attachment: fixed;\n}\n\nmain {\n    flex: 1;\n}\n\n.glass-nav {\n    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);\n    backdrop-filter: blur(12px);\n    border-bottom: 1px solid rgba(255, 255, 255, 0.06);\n    padding: 0.75rem 0;\n}\n\n.btn-primary {\n    background: var(--primary-gradient);\n    border: none;\n    border-radius: var(--border-radius-sm);\n    font-weight: 500;\n    transition: var(--transition-normal);\n    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);\n}\n\n.btn-primary:hover {\n    transform: translateY(-1px);\n    box-shadow: 0 4px 16px rgba(59, 130, 246, 0.35);\n    background: var(--primary-gradient);\n}\n\n.btn-success {\n    background: var(--secondary-gradient);\n    border: none;\n    border-radius: var(--border-radius-sm);\n    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);\n}\n\n.btn-success:hover {\n    transform: translateY(-1px);\n    box-shadow: 0 4px 16px rgba(16, 185, 129, 0.35);\n}\n\n.btn-outline-primary {\n    border-color: var(--primary-color);\n    color: var(--primary-color);\n    border-radius: var(--border-radius-sm);\n}\n\n.btn-outline-primary:hover {\n    background: var(--primary-color);\n    border-color: var(--primary-color);\n}\n\n.form-control:focus, .form-select:focus {\n    border-color: var(--primary-color);\n    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);\n}\n\n.glass-card {\n    background: var(--glass-bg);\n    border-radius: var(--border-radius);\n    border: 1px solid var(--glass-border);\n    box-shadow: var(--shadow-soft);\n    transition: var(--transition-normal);\n}\n\n.glass-card:hover {\n    transform: translateY(-2px);\n    box-shadow: var(--shadow-hover);\n}\n\n.glass-card.no-hover:hover {\n    transform: none;\n    box-shadow: var(--shadow-soft);\n}\n\n.glass-dropdown {\n    background: var(--glass-bg);\n    backdrop-filter: blur(10px);\n    border: 1px solid var(--glass-border);\n    border-radius: var(--border-radius-sm);\n    box-shadow: var(--shadow-soft);\n}\n\n.glass-alert {\n    background: var(--glass-bg);\n    border: none;\n    border-radius: var(--border-radius-sm);\n    box-shadow: var(--shadow-soft);\n}\n\n.avatar-sm {\n    width: 32px;\n    height: 32px;\n    background: rgba(255, 255, 255, 0.2);\n    border-radius: 50%;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-weight: 600;\n    font-size: 14px;\n}\n\n.avatar-lg {\n    width: 48px;\n    height: 48px;\n    background: var(--primary-gradient);\n    color: white;\n    border-radius: 12px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-weight: 700;\n    font-size: 18px;\n}\n\n.hero-section {\n    padding: 2rem 0;\n}\n\n.min-vh-75 {\n    min-height: 75vh;\n}\n\n.gradient-text {\n    background: var(--primary-gradient);\n    -webkit-background-clip: text;\n    -webkit-text-fill-color: transparent;\n    background-clip: text;\n}\n\n.badge-gradient {\n    background: var(--primary-gradient);\n    color: white;\n    font-weight: 500;\n    padding: 0.5rem 1rem;\n    border-radius: 20px;\n}\n\n.hero-visual {\n    position: relative;\n    height: 400px;\n}\n\n.floating-card {\n    position: absolute;\n    background: white;\n    padding: 1rem 1.5rem;\n    border-radius: var(--border-radius-sm);\n    box-shadow: var(--shadow-soft);\n    display: flex;\n    align-items: center;\n    gap: 0.75rem;\n    font-weight: 500;\n    animation: float 3s ease-in-out infinite;\n}\n\n.floating-card i {\n    font-size: 1.25rem;\n}\n\n.floating-card.card-1 {\n    top: 10%;\n    right: 10%;\n    animation-delay: 0s;\n}\n\n.floating-card.card-2 {\n    top: 50%;\n    right: 5%;\n    animation-delay: 0.5s;\n}\n\n.floating-card.card-3 {\n    bottom: 15%;\n    right: 20%;\n    animation-delay: 1s;\n}\n\n@keyframes float {\n    0%, 100% { transform: translateY(0); }\n    50% { transform: translateY(-10px); }\n}\n\n.hero-main-card {\n    position: absolute;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    width: 320px;\n    padding: 1.5rem;\n    animation: heroFloat 3s ease-in-out infinite;\n}\n\n.hero-main-card:hover {\n    transform: translate(-50%, -50%);\n    box-shadow: var(--shadow-hover);\n}\n\n@keyframes heroFloat {\n    0%, 100% { transform: translate(-50%, -50%); }\n    50% { transform: translate(-50%, calc(-50% - 10px)); }\n}\n\n.progress-modern {\n    height: 8px;\n    border-radius: 10px;\n    background: #e9ecef;\n    overflow: hidden;\n}\n\n.bg-gradient-primary {\n    background: var(--primary-gradient);\n}\n\n.feature-card {\n    padding: 2rem;\n    text-align: center;\n}\n\n.feature-icon {\n    width: 80px;\n    height: 80px;\n    background: var(--primary-gradient);\n    border-radius: 20px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    margin: 0 auto;\n    font-size: 2rem;\n    color: white;\n}\n\n.feature-icon-secondary {\n    background: var(--secondary-gradient);\n}\n\n.feature-icon-tertiary {\n    background: var(--tertiary-gradient);\n}\n\n.auth-icon {\n    width: 80px;\n    height: 80px;\n    background: var(--primary-gradient);\n    border-radius: 50%;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    margin: 0 auto;\n    font-size: 2rem;\n    color: white;\n}\n\n.auth-icon-register {\n    background: var(--secondary-gradient);\n}\n\n.input-group-modern {\n    border-radius: var(--border-radius-sm);\n    overflow: hidden;\n    background: #f8f9fa;\n    border: 2px solid transparent;\n    transition: all 0.3s ease;\n}\n\n.input-group-modern:focus-within {\n    border-color: var(--navy-light);\n    background: white;\n}\n\n.input-group-modern .input-group-text {\n    background: transparent;\n    border: none;\n    color: #6c757d;\n}\n\n.input-group-modern .form-control {\n    background: transparent;\n    border: none;\n    box-shadow: none;\n}\n\n.input-group-modern .form-control:focus {\n    box-shadow: none;\n}\n\n.btn-primary {\n    background: var(--primary-gradient);\n    border: none;\n    font-weight: 500;\n}\n\n.btn-primary:hover {\n    transform: translateY(-2px);\n    box-shadow: 0 8px 24px rgba(13, 27, 62, 0.4);\n}\n\n.course-card {\n    overflow: hidden;\n}\n\n.course-icon {\n    width: 48px;\n    height: 48px;\n    background: var(--primary-gradient);\n    border-radius: 12px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    color: white;\n    font-size: 1.25rem;\n}\n\n.course-icon-student {\n    background: var(--secondary-gradient);\n}\n\n.invite-code-box {\n    background: #f8f9fa;\n    border-radius: var(--border-radius-sm);\n    padding: 0.75rem 1rem;\n    text-align: center;\n}\n\n.empty-state {\n    padding: 3rem;\n}\n\n.empty-icon {\n    width: 100px;\n    height: 100px;\n    background: linear-gradient(135deg, #e0e5ec 0%, #c3cfe2 100%);\n    border-radius: 50%;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    margin: 0 auto;\n    font-size: 2.5rem;\n    color: #6c757d;\n}\n\n.footer-modern {\n    background: rgba(255, 255, 255, 0.8);\n    backdrop-filter: blur(10px);\n}\n\n.checkpoint-item {\n    background: white;\n    border-radius: var(--border-radius-sm);\n    margin-bottom: 0.75rem;\n    padding: 1rem 1.25rem;\n    border: 1px solid #e9ecef;\n    transition: all 0.2s ease;\n}\n\n.checkpoint-item:hover {\n    border-color: var(--navy-light);\n    box-shadow: var(--shadow-soft);\n}\n\n.stat-card {\n    padding: 1.5rem;\n    text-align: center;\n    border-radius: var(--border-radius);\n    color: white;\n}\n\n.stat-card.primary {\n    background: var(--primary-gradient);\n}\n\n.stat-card.success {\n    background: var(--secondary-gradient);\n}\n\n.stat-card.info {\n    background: linear-gradient(135deg, var(--navy-primary) 0%, var(--navy-secondary) 100%);\n}\n\n.stat-card.warning {\n    background: var(--tertiary-gradient);\n}\n\n.role-select {\n    display: flex;\n    gap: 1rem;\n}\n\n.role-option {\n    flex: 1;\n    padding: 1rem;\n    background: #f8f9fa;\n    border-radius: var(--border-radius-sm);\n    text-align: center;\n    cursor: pointer;\n    transition: all 0.2s ease;\n}\n\n.role-option:hover {\n    background: #e9ecef;\n}\n\n.role-option .form-check-input:checked ~ .form-check-label {\n    color: var(--navy-light);\n    font-weight: 600;\n}\n\n.student-card {\n    background: white;\n    border-radius: var(--border-radius-sm);\n    padding: 1rem;\n    text-align: center;\n    border: 2px solid transparent;\n    transition: all 0.3s ease;\n}\n\n.student-card.completed {\n    border-color: #38ef7d;\n    background: rgba(56, 239, 125, 0.05);\n}\n\n.connection-badge {\n    padding: 0.5rem 1rem;\n    border-radius: 20px;\n    font-weight: 500;\n}\n\n@media (max-width: 768px) {\n    .hero-visual {\n        display: none;\n    }\n    \n    .display-3 {\n        font-size: 2rem;\n    }\n    \n    .floating-card {\n        display: none;\n    }\n}\n\n.table-modern {\n    border-collapse: separate;\n    border-spacing: 0;\n}\n\n.table-modern thead th {\n    background: #f8f9fa;\n    font-weight: 600;\n    border: none;\n    padding: 1rem;\n}\n\n.table-modern tbody td {\n    padding: 1rem;\n    border-bottom: 1px solid #e9ecef;\n    vertical-align: middle;\n}\n\n.progress {\n    border-radius: 10px;\n    overflow: hidden;\n    height: 8px;\n}\n\n.progress-bar {\n    border-radius: 10px;\n    transition: width 0.5s ease;\n}\n\n.breadcrumb {\n    background: transparent;\n    padding: 0;\n    margin-bottom: 0;\n}\n\n.breadcrumb-item a {\n    color: var(--navy-light);\n    text-decoration: none;\n}\n\n.list-group-modern .list-group-item {\n    border: none;\n    border-radius: var(--border-radius-sm);\n    margin-bottom: 0.5rem;\n    padding: 1rem;\n    background: #f8f9fa;\n    transition: all 0.2s ease;\n}\n\n.list-group-modern .list-group-item:hover {\n    background: #e9ecef;\n}\n\n.timeline-item {\n    position: relative;\n    padding-left: 2rem;\n}\n\n.timeline-item::before {\n    content: '';\n    position: absolute;\n    left: 5px;\n    top: 20px;\n    bottom: -20px;\n    width: 2px;\n    background: #e9ecef;\n}\n\n.timeline-item:last-child::before {\n    display: none;\n}\n\n.timeline-marker {\n    position: absolute;\n    left: 0;\n    width: 12px;\n    height: 12px;\n    border-radius: 50%;\n    background: #38ef7d;\n}\n\n:root {\n    --primary-color: #0d1b3e;\n    --secondary-color: #1a3a5c;\n}\n\n@media (max-width: 768px) {\n    .hero-section h1 {\n        font-size: 2rem !important;\n    }\n    \n    .glass-card .card-body {\n        padding: 1rem !important;\n    }\n    \n    .stat-card {\n        padding: 1rem !important;\n    }\n    \n    .stat-card .stat-value {\n        font-size: 1.5rem !important;\n    }\n    \n    .stat-icon {\n        width: 40px !important;\n        height: 40px !important;\n    }\n    \n    .btn-sm {\n        padding: 0.4rem 0.75rem;\n        font-size: 0.75rem;\n    }\n    \n    .course-card .card-footer .d-flex {\n        flex-wrap: wrap;\n        gap: 0.5rem !important;\n    }\n    \n    .course-card .card-footer .btn {\n        flex: 1 1 100% !important;\n    }\n    \n    .d-flex.gap-2 {\n        gap: 0.5rem !important;\n    }\n    \n    .navbar-brand {\n        font-size: 1rem;\n    }\n    \n    .quick-start-item {\n        padding: 0.75rem !important;\n    }\n    \n    .step-number {\n        width: 28px !important;\n        height: 28px !important;\n        font-size: 0.875rem;\n    }\n    \n    .activity-feed {\n        max-height: 200px !important;\n    }\n}\n\n@media (max-width: 576px) {\n    .container {\n        padding-left: 1rem;\n        padding-right: 1rem;\n    }\n    \n    .d-flex.justify-content-between {\n        flex-direction: column;\n        gap: 1rem;\n    }\n    \n    .d-flex.justify-content-between .btn {\n        width: 100%;\n    }\n    \n    .empty-state {\n        padding: 2rem 1rem !important;\n    }\n    \n    .quick-start-item {\n        margin-bottom: 0.5rem;\n    }\n}\n\n/* Comprehensive Responsive Styles */\n@media (max-width: 992px) {\n    .glass-nav .container {\n        padding: 0 1rem;\n    }\n    \n    .navbar-brand {\n        font-size: 1rem;\n    }\n    \n    .hero-section h1 {\n        font-size: 2rem;\n    }\n    \n    .feature-card {\n        padding: 1.5rem;\n    }\n    \n    .stat-card {\n        padding: 1rem;\n    }\n}\n\n@media (max-width: 768px) {\n    body {\n        font-size: 14px;\n    }\n    \n    .glass-nav {\n        padding: 0.5rem 0;\n    }\n    \n    .navbar-brand i {\n        font-size: 1.2rem;\n    }\n    \n    main.container {\n        padding: 1rem;\n    }\n    \n    .glass-card {\n        border-radius: 12px;\n        padding: 1rem;\n    }\n    \n    h1 { font-size: 1.75rem; }\n    h2 { font-size: 1.5rem; }\n    h3 { font-size: 1.25rem; }\n    h4 { font-size: 1.1rem; }\n    \n    .btn-lg {\n        padding: 0.6rem 1.2rem;\n        font-size: 0.95rem;\n    }\n    \n    .table-responsive {\n        font-size: 0.85rem;\n    }\n    \n    .table td, .table th {\n        padding: 0.5rem;\n        white-space: nowrap;\n    }\n    \n    .modal-dialog {\n        margin: 0.5rem;\n    }\n    \n    .modal-content {\n        border-radius: 12px;\n    }\n    \n    .checkpoint-item {\n        padding: 1rem;\n        flex-direction: column;\n        align-items: flex-start;\n        gap: 0.75rem;\n    }\n    \n    .checkpoint-item .d-flex {\n        width: 100%;\n        justify-content: space-between;\n    }\n    \n    .chat-container {\n        height: 300px;\n    }\n    \n    .avatar-lg {\n        width: 40px;\n        height: 40px;\n        font-size: 1rem;\n    }\n    \n    .badge {\n        font-size: 0.7rem;\n        padding: 0.35em 0.6em;\n    }\n    \n    .form-control, .form-select {\n        font-size: 16px;\n    }\n    \n    .input-group-text {\n        padding: 0.5rem 0.75rem;\n    }\n    \n    .nav-tabs {\n        flex-wrap: nowrap;\n        overflow-x: auto;\n        -webkit-overflow-scrolling: touch;\n    }\n    \n    .nav-tabs .nav-link {\n        white-space: nowrap;\n        padding: 0.5rem 1rem;\n        font-size: 0.9rem;\n    }\n    \n    .list-group-item {\n        padding: 0.75rem;\n    }\n    \n    .footer-modern {\n        padding: 1.5rem 1rem;\n    }\n}\n\n@media (max-width: 480px) {\n    .navbar-brand span {\n        display: none;\n    }\n    \n    .btn {\n        padding: 0.5rem 0.75rem;\n        font-size: 0.85rem;\n    }\n    \n    .btn i {\n        margin-right: 0.25rem !important;\n    }\n    \n    .card-header {\n        padding: 0.75rem;\n    }\n    \n    .card-body {\n        padding: 1rem;\n    }\n    \n    .progress {\n        height: 6px;\n    }\n    \n    .dropdown-menu {\n        font-size: 0.9rem;\n    }\n    \n    .alert {\n        padding: 0.75rem;\n        font-size: 0.85rem;\n    }\n    \n    .alert i {\n        font-size: 1rem;\n    }\n}\n\n.notification-toast {\n    position: fixed;\n    top: 80px;\n    right: 20px;\n    z-index: 1050;\n    max-width: 350px;\n    animation: slideInRight 0.3s ease-out;\n}\n\n@keyframes slideInRight {\n    from {\n        transform: translateX(100%);\n        opacity: 0;\n    }\n    to {\n        transform: translateX(0);\n        opacity: 1;\n    }\n}\n\n.notification-badge {\n    position: absolute;\n    top: -5px;\n    right: -5px;\n    background: #dc3545;\n    color: white;\n    border-radius: 50%;\n    width: 18px;\n    height: 18px;\n    font-size: 10px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-weight: 600;\n}\n\n.session-reminder {\n    background: linear-gradient(135deg, var(--navy-primary) 0%, var(--navy-secondary) 100%);\n    color: white;\n    border-radius: 12px;\n    padding: 1rem;\n    margin-bottom: 1rem;\n    animation: pulse-bg 2s infinite;\n}\n\n@keyframes pulse-bg {\n    0%, 100% { opacity: 1; }\n    50% { opacity: 0.9; }\n}\n\n.focus-ring:focus {\n    outline: 3px solid rgba(13, 27, 62, 0.5);\n    outline-offset: 2px;\n}\n\n.skip-link {\n    position: absolute;\n    top: -40px;\n    left: 0;\n    background: var(--primary-gradient);\n    color: white;\n    padding: 8px 16px;\n    z-index: 9999;\n    transition: top 0.3s;\n}\n\n.skip-link:focus {\n    top: 0;\n}\n\n.btn:focus-visible,\n.form-control:focus-visible {\n    box-shadow: 0 0 0 3px rgba(13, 27, 62, 0.25);\n}\n\n[data-tooltip] {\n    position: relative;\n    cursor: help;\n}\n\n[data-tooltip]::after {\n    content: attr(data-tooltip);\n    position: absolute;\n    bottom: 100%;\n    left: 50%;\n    transform: translateX(-50%);\n    background: #333;\n    color: white;\n    padding: 4px 8px;\n    border-radius: 4px;\n    font-size: 12px;\n    white-space: nowrap;\n    opacity: 0;\n    visibility: hidden;\n    transition: all 0.2s;\n}\n\n[data-tooltip]:hover::after {\n    opacity: 1;\n    visibility: visible;\n}\n\n.streak-badge {\n    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);\n    color: white;\n    padding: 0.25rem 0.75rem;\n    border-radius: 20px;\n    font-size: 0.75rem;\n    font-weight: 600;\n    display: inline-flex;\n    align-items: center;\n    gap: 0.25rem;\n}\n\n.progress-ring {\n    transform: rotate(-90deg);\n}\n\n.progress-ring-circle {\n    transition: stroke-dashoffset 0.5s ease;\n}\n\n.achievement-unlock {\n    animation: achievementPop 0.5s ease-out;\n}\n\n@keyframes achievementPop {\n    0% {\n        transform: scale(0);\n        opacity: 0;\n    }\n    50% {\n        transform: scale(1.2);\n    }\n    100% {\n        transform: scale(1);\n        opacity: 1;\n    }\n}\n\n/* Dark Mode Styles */\n[data-theme=\"dark\"] {\n    --glass-bg: rgba(30, 35, 45, 0.95);\n    --glass-border: rgba(255, 255, 255, 0.08);\n    --shadow-soft: 0 8px 32px rgba(0, 0, 0, 0.3);\n    --shadow-hover: 0 16px 48px rgba(0, 0, 0, 0.4);\n}\n\n[data-theme=\"dark\"] body {\n    background: linear-gradient(135deg, #0f1419 0%, #1a2332 100%);\n    background-attachment: fixed;\n    color: #e4e6eb;\n}\n\n[data-theme=\"dark\"] .glass-card {\n    background: rgba(30, 35, 45, 0.95);\n    border-color: rgba(255, 255, 255, 0.08);\n}\n\n[data-theme=\"dark\"] .glass-dropdown {\n    background: rgba(30, 35, 45, 0.98);\n    border-color: rgba(255, 255, 255, 0.08);\n}\n\n[data-theme=\"dark\"] .dropdown-item {\n    color: #e4e6eb;\n}\n\n[data-theme=\"dark\"] .dropdown-item:hover {\n    background: rgba(255, 255, 255, 0.08);\n    color: #ffffff;\n}\n\n[data-theme=\"dark\"] .text-muted {\n    color: rgba(255, 255, 255, 0.5) !important;\n}\n\n[data-theme=\"dark\"] .text-dark {\n    color: #e4e6eb !important;\n}\n\n[data-theme=\"dark\"] h1, \n[data-theme=\"dark\"] h2, \n[data-theme=\"dark\"] h3, \n[data-theme=\"dark\"] h4, \n[data-theme=\"dark\"] h5, \n[data-theme=\"dark\"] h6 {\n    color: #ffffff;\n}\n\n[data-theme=\"dark\"] .card {\n    background: rgba(30, 35, 45, 0.95);\n    border-color: rgba(255, 255, 255, 0.08);\n    color: #e4e6eb;\n}\n\n[data-theme=\"dark\"] .table {\n    color: #e4e6eb;\n}\n\n[data-theme=\"dark\"] .table-hover tbody tr:hover {\n    background: rgba(255, 255, 255, 0.05);\n}\n\n[data-theme=\"dark\"] .form-control,\n[data-theme=\"dark\"] .form-select {\n    background: rgba(20, 25, 35, 0.9);\n    border-color: rgba(255, 255, 255, 0.1);\n    color: #e4e6eb;\n}\n\n[data-theme=\"dark\"] .form-control:focus,\n[data-theme=\"dark\"] .form-select:focus {\n    background: rgba(25, 30, 40, 0.95);\n    border-color: var(--navy-accent);\n    color: #ffffff;\n}\n\n[data-theme=\"dark\"] .form-control::placeholder {\n    color: rgba(255, 255, 255, 0.4);\n}\n\n[data-theme=\"dark\"] .input-group-text {\n    background: rgba(20, 25, 35, 0.9);\n    border-color: rgba(255, 255, 255, 0.1);\n    color: rgba(255, 255, 255, 0.6);\n}\n\n[data-theme=\"dark\"] .list-group-item {\n    background: rgba(30, 35, 45, 0.8);\n    border-color: rgba(255, 255, 255, 0.08);\n    color: #e4e6eb;\n}\n\n[data-theme=\"dark\"] .modal-content {\n    background: rgba(30, 35, 45, 0.98);\n    border-color: rgba(255, 255, 255, 0.1);\n    color: #e4e6eb;\n}\n\n[data-theme=\"dark\"] .modal-header {\n    border-color: rgba(255, 255, 255, 0.1);\n}\n\n[data-theme=\"dark\"] .modal-footer {\n    border-color: rgba(255, 255, 255, 0.1);\n}\n\n[data-theme=\"dark\"] .btn-close {\n    filter: invert(1);\n}\n\n[data-theme=\"dark\"] .footer-modern {\n    background: rgba(15, 20, 25, 0.9);\n    border-top-color: rgba(255, 255, 255, 0.05);\n}\n\n[data-theme=\"dark\"] .nav-tabs .nav-link {\n    color: rgba(255, 255, 255, 0.6);\n}\n\n[data-theme=\"dark\"] .nav-tabs .nav-link.active {\n    background: rgba(30, 35, 45, 0.95);\n    border-color: rgba(255, 255, 255, 0.1);\n    color: #ffffff;\n}\n\n[data-theme=\"dark\"] .tab-content {\n    background: rgba(30, 35, 45, 0.5);\n    border-color: rgba(255, 255, 255, 0.08);\n}\n\n[data-theme=\"dark\"] .alert {\n    background: rgba(30, 35, 45, 0.95);\n    border-color: rgba(255, 255, 255, 0.1);\n}\n\n[data-theme=\"dark\"] .progress {\n    background: rgba(255, 255, 255, 0.1);\n}\n\n[data-theme=\"dark\"] .badge.bg-light {\n    background: rgba(255, 255, 255, 0.15) !important;\n    color: #e4e6eb !important;\n}\n\n[data-theme=\"dark\"] .btn-outline-secondary {\n    color: rgba(255, 255, 255, 0.7);\n    border-color: rgba(255, 255, 255, 0.2);\n}\n\n[data-theme=\"dark\"] .btn-outline-secondary:hover {\n    background: rgba(255, 255, 255, 0.1);\n    color: #ffffff;\n}\n\n[data-theme=\"dark\"] .checkpoint-item {\n    background: rgba(30, 35, 45, 0.8);\n    border-color: rgba(255, 255, 255, 0.08);\n}\n\n[data-theme=\"dark\"] .chat-bubble {\n    background: rgba(40, 45, 55, 0.9);\n}\n\n[data-theme=\"dark\"] .chat-bubble.own {\n    background: linear-gradient(135deg, #0d1b3e 0%, #1a3a5c 100%);\n}\n\n[data-theme=\"dark\"] #themeToggle {\n    color: #ffc107;\n}\n","path":null,"size_bytes":21752,"size_tokens":null},"app/static/js/main.js":{"content":"document.addEventListener('DOMContentLoaded', function() {\n    const alerts = document.querySelectorAll('.alert');\n    alerts.forEach(function(alert) {\n        setTimeout(function() {\n            const bsAlert = new bootstrap.Alert(alert);\n            bsAlert.close();\n        }, 5000);\n    });\n});\n\nfunction getCsrfToken() {\n    const input = document.querySelector('input[name=\"csrf_token\"]');\n    return input ? input.value : '';\n}\n\nasync function apiRequest(url, method = 'GET', data = null) {\n    const options = {\n        method: method,\n        headers: {\n            'Content-Type': 'application/json',\n            'X-CSRFToken': getCsrfToken()\n        }\n    };\n    \n    if (data) {\n        options.body = JSON.stringify(data);\n    }\n    \n    const response = await fetch(url, options);\n    return response.json();\n}\n","path":null,"size_bytes":825,"size_tokens":null},"app/services/ai_checkpoint.py":{"content":"import os\nimport json\nimport tempfile\nimport subprocess\nfrom pathlib import Path\nfrom typing import List, Optional\nfrom concurrent.futures import ThreadPoolExecutor, as_completed\nfrom tenacity import retry, stop_after_attempt, wait_exponential, retry_if_exception\n\nfrom google import genai\nfrom google.genai import types\n\nAI_INTEGRATIONS_GEMINI_API_KEY = os.environ.get(\"AI_INTEGRATIONS_GEMINI_API_KEY\")\nAI_INTEGRATIONS_GEMINI_BASE_URL = os.environ.get(\"AI_INTEGRATIONS_GEMINI_BASE_URL\")\n\nclient = genai.Client(\n    api_key=AI_INTEGRATIONS_GEMINI_API_KEY,\n    http_options={\n        'api_version': '',\n        'base_url': AI_INTEGRATIONS_GEMINI_BASE_URL   \n    }\n)\n\nCHUNK_SIZE_BYTES = 8 * 1024 * 1024\n\ndef is_rate_limit_error(exception: BaseException) -> bool:\n    error_msg = str(exception)\n    return (\n        \"429\" in error_msg \n        or \"RATELIMIT_EXCEEDED\" in error_msg\n        or \"quota\" in error_msg.lower() \n        or \"rate limit\" in error_msg.lower()\n        or (hasattr(exception, 'status') and exception.status == 429)\n    )\n\n\ndef chunk_media(buffer: bytes, mime_type: str) -> list[bytes]:\n    if len(buffer) <= CHUNK_SIZE_BYTES:\n        return [buffer]\n    \n    with tempfile.TemporaryDirectory(prefix='media-') as temp_dir:\n        ext = mime_type.split('/')[-1] or 'mp4'\n        input_path = Path(temp_dir) / f'input.{ext}'\n        input_path.write_bytes(buffer)\n        \n        result = subprocess.run(\n            [\n                'ffprobe', '-v', 'error', '-show_entries', \n                'format=duration', '-of', \n                'default=noprint_wrappers=1:nokey=1', str(input_path)\n            ],\n            capture_output=True,\n            text=True,\n            check=True\n        )\n        duration = float(result.stdout.strip())\n        \n        num_chunks = (len(buffer) + CHUNK_SIZE_BYTES - 1) // CHUNK_SIZE_BYTES\n        segment_duration = duration / num_chunks\n        \n        chunks: list[bytes] = []\n        for i in range(num_chunks):\n            output_path = Path(temp_dir) / f'chunk_{i}.{ext}'\n            subprocess.run(\n                [\n                    'ffmpeg', '-i', str(input_path),\n                    '-ss', str(i * segment_duration),\n                    '-t', str(segment_duration),\n                    '-c', 'copy',\n                    '-avoid_negative_ts', '1',\n                    '-y', str(output_path)\n                ],\n                capture_output=True,\n                check=True\n            )\n            chunks.append(output_path.read_bytes())\n        \n        return chunks\n\n\nclass CheckpointGenerator:\n    \n    CHECKPOINT_PROMPT = \"\"\"당신은 교육 전문가입니다. 제공된 강의 자료를 분석하여 학습 체크포인트를 생성해주세요.\n\n각 체크포인트는 다음 형식의 JSON 배열로 반환해주세요:\n[\n    {\n        \"order\": 1,\n        \"title\": \"체크포인트 제목 (20자 이내)\",\n        \"description\": \"학습 목표 또는 주요 내용 설명 (100자 이내)\",\n        \"estimated_minutes\": 예상 소요 시간(분)\n    }\n]\n\n규칙:\n1. 체크포인트는 5-15개 사이로 생성\n2. 각 체크포인트는 명확한 학습 목표를 포함\n3. 순서대로 학습할 수 있도록 논리적 흐름 유지\n4. 예상 시간은 현실적으로 설정 (3-15분)\n5. 제목은 간결하고 명확하게\n6. JSON 형식만 반환 (추가 설명 없이)\n\n강의 내용:\n\"\"\"\n\n    TRANSCRIPTION_PROMPT = \"\"\"다음 오디오/비디오 콘텐츠를 분석하고 전사해주세요.\n음성 내용을 정확하게 텍스트로 변환하고, 주요 토픽과 시간대를 구분해주세요.\n\n결과는 다음 형식으로 반환:\n{\n    \"transcript\": \"전체 전사문\",\n    \"segments\": [\n        {\n            \"time_marker\": \"시간 또는 순서 표시\",\n            \"content\": \"해당 구간의 내용\",\n            \"topic\": \"주요 주제\"\n        }\n    ]\n}\n\"\"\"\n\n    @staticmethod\n    @retry(\n        stop=stop_after_attempt(5),\n        wait=wait_exponential(multiplier=1, min=2, max=60),\n        retry=retry_if_exception(is_rate_limit_error),\n        reraise=True\n    )\n    def generate_from_text(text: str) -> List[dict]:\n        prompt = CheckpointGenerator.CHECKPOINT_PROMPT + text\n        \n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=prompt,\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        result_text = response.text or \"[]\"\n        try:\n            checkpoints = json.loads(result_text)\n            return checkpoints if isinstance(checkpoints, list) else []\n        except json.JSONDecodeError:\n            import re\n            json_match = re.search(r'\\[.*\\]', result_text, re.DOTALL)\n            if json_match:\n                return json.loads(json_match.group())\n            return []\n\n    @staticmethod\n    @retry(\n        stop=stop_after_attempt(5),\n        wait=wait_exponential(multiplier=1, min=2, max=60),\n        retry=retry_if_exception(is_rate_limit_error),\n        reraise=True\n    )\n    def analyze_ppt(file_data: bytes, filename: str) -> dict:\n        mime_type = \"application/vnd.openxmlformats-officedocument.presentationml.presentation\"\n        if filename.endswith('.ppt'):\n            mime_type = \"application/vnd.ms-powerpoint\"\n        elif filename.endswith('.pdf'):\n            mime_type = \"application/pdf\"\n        \n        prompt = \"\"\"이 프레젠테이션/문서를 분석하여 다음 정보를 JSON 형식으로 반환해주세요:\n{\n    \"title\": \"강의 제목\",\n    \"summary\": \"전체 내용 요약 (200자 이내)\",\n    \"slides_content\": \"각 슬라이드/페이지의 주요 내용을 순서대로 설명\",\n    \"key_topics\": [\"주요 주제1\", \"주요 주제2\", ...]\n}\"\"\"\n        \n        response = client.models.generate_content(\n            model=\"gemini-2.5-flash\",\n            contents=[\n                prompt,\n                types.Part(\n                    inline_data=types.Blob(\n                        mime_type=mime_type,\n                        data=file_data\n                    )\n                )\n            ],\n            config=types.GenerateContentConfig(\n                response_mime_type=\"application/json\"\n            )\n        )\n        \n        result_text = response.text or \"{}\"\n        try:\n            return json.loads(result_text)\n        except json.JSONDecodeError:\n            return {\"summary\": result_text, \"title\": filename, \"key_topics\": []}\n\n    @staticmethod\n    def analyze_media(buffer: bytes, mime_type: str = \"video/mp4\") -> dict:\n        chunks = chunk_media(buffer, mime_type)\n        is_video = mime_type.startswith(\"video/\")\n        \n        def process_chunk(i: int, chunk: bytes) -> tuple[int, str]:\n            prompt = (\n                f\"이 비디오의 {i + 1}/{len(chunks)} 부분을 분석하세요: 주요 내용, 핵심 개념, 설명되는 토픽을 한국어로 작성.\"\n                if is_video\n                else f\"이 오디오의 {i + 1}/{len(chunks)} 부분을 전사하세요: 음성 내용을 한국어 텍스트로 변환하고 주요 주제를 파악.\"\n            )\n            \n            @retry(\n                stop=stop_after_attempt(7),\n                wait=wait_exponential(multiplier=1, min=2, max=128),\n                retry=retry_if_exception(is_rate_limit_error),\n                reraise=True\n            )\n            def generate_chunk_analysis() -> str:\n                response = client.models.generate_content(\n                    model=\"gemini-2.5-flash\",\n                    contents=[\n                        prompt,\n                        types.Part(\n                            inline_data=types.Blob(\n                                mime_type=mime_type,\n                                data=chunk\n                            )\n                        )\n                    ]\n                )\n                return response.text or \"\"\n            \n            return (i, generate_chunk_analysis())\n        \n        analyses: list[str] = [\"\"] * len(chunks)\n        with ThreadPoolExecutor(max_workers=2) as executor:\n            futures = {executor.submit(process_chunk, i, chunk): i for i, chunk in enumerate(chunks)}\n            for future in as_completed(futures):\n                idx, analysis = future.result()\n                analyses[idx] = analysis\n        \n        combined = \"\\n\\n\".join([f\"[파트 {i + 1}]\\n{a}\" for i, a in enumerate(analyses)])\n        \n        return {\n            \"transcript\": combined,\n            \"chunk_count\": len(chunks),\n            \"is_video\": is_video\n        }\n\n    @staticmethod\n    def generate_checkpoints_from_ppt(file_data: bytes, filename: str) -> List[dict]:\n        analysis = CheckpointGenerator.analyze_ppt(file_data, filename)\n        content = f\"\"\"\n강의 제목: {analysis.get('title', '')}\n요약: {analysis.get('summary', '')}\n슬라이드 내용: {analysis.get('slides_content', '')}\n주요 주제: {', '.join(analysis.get('key_topics', []))}\n\"\"\"\n        return CheckpointGenerator.generate_from_text(content)\n\n    @staticmethod\n    def generate_checkpoints_from_media(buffer: bytes, mime_type: str) -> tuple[List[dict], str]:\n        analysis = CheckpointGenerator.analyze_media(buffer, mime_type)\n        transcript = analysis.get('transcript', '')\n        checkpoints = CheckpointGenerator.generate_from_text(transcript)\n        return checkpoints, transcript\n\n    @staticmethod\n    def transcribe_audio(buffer: bytes, mime_type: str = \"audio/mpeg\") -> str:\n        analysis = CheckpointGenerator.analyze_media(buffer, mime_type)\n        return analysis.get('transcript', '')\n","path":null,"size_bytes":9640,"size_tokens":null},"app/routes/__init__.py":{"content":"# Routes package\n","path":null,"size_bytes":17,"size_tokens":null},"app/routes/main.py":{"content":"from flask import Blueprint, render_template, redirect, url_for, jsonify, request\nfrom flask_login import login_required, current_user\nfrom app.models import Course, Enrollment, Progress, Checkpoint, ActiveSession, Subject, SubjectEnrollment, Notification\nfrom app import db\nfrom datetime import datetime, timedelta\nfrom sqlalchemy import func\n\nbp = Blueprint('main', __name__)\n\n@bp.route('/health')\ndef health():\n    return jsonify({'status': 'ok'}), 200\n\n@bp.route('/')\ndef index():\n    if request.args.get('health') == '1':\n        return 'OK', 200\n    if current_user.is_authenticated:\n        return redirect(url_for('main.dashboard'))\n    return render_template('index.html')\n\n@bp.route('/dashboard')\n@login_required\ndef dashboard():\n    if current_user.is_instructor():\n        courses = Course.query.filter_by(instructor_id=current_user.id).filter(\n            Course.deleted_at.is_(None),\n            Course.subject_id.is_(None)\n        ).all()\n        subjects = Subject.query.filter_by(instructor_id=current_user.id).filter(Subject.deleted_at.is_(None)).all()\n        \n        from sqlalchemy import union\n        \n        course_student_ids = db.session.query(Enrollment.user_id).join(Course).filter(\n            Course.instructor_id == current_user.id,\n            Course.deleted_at.is_(None),\n            Course.subject_id.is_(None)\n        )\n        \n        subject_student_ids = db.session.query(SubjectEnrollment.user_id).join(Subject).filter(\n            Subject.instructor_id == current_user.id,\n            Subject.deleted_at.is_(None),\n            SubjectEnrollment.status == 'approved'\n        )\n        \n        all_student_ids = union(course_student_ids, subject_student_ids).subquery()\n        total_students = db.session.query(func.count()).select_from(all_student_ids).scalar() or 0\n        \n        total_checkpoints = Checkpoint.query.join(Course).filter(\n            Course.instructor_id == current_user.id,\n            Checkpoint.deleted_at == None\n        ).count()\n        \n        active_sessions = ActiveSession.query.join(Course).filter(\n            Course.instructor_id == current_user.id,\n            Course.deleted_at.is_(None),\n            ActiveSession.ended_at == None\n        ).all()\n        \n        upcoming_sessions = ActiveSession.query.join(Course).filter(\n            Course.instructor_id == current_user.id,\n            Course.deleted_at.is_(None),\n            ActiveSession.session_type == 'scheduled',\n            ActiveSession.scheduled_at > datetime.utcnow(),\n            ActiveSession.ended_at == None\n        ).order_by(ActiveSession.scheduled_at).limit(5).all()\n        \n        recent_progress = Progress.query.join(Checkpoint).join(Course).filter(\n            Course.instructor_id == current_user.id,\n            Progress.completed_at != None\n        ).order_by(Progress.completed_at.desc()).limit(10).all()\n        \n        return render_template('dashboard/instructor.html', \n            courses=courses,\n            subjects=subjects,\n            total_students=total_students,\n            total_checkpoints=total_checkpoints,\n            active_sessions=active_sessions,\n            upcoming_sessions=upcoming_sessions,\n            recent_progress=recent_progress\n        )\n    else:\n        enrollments = Enrollment.query.filter_by(user_id=current_user.id).all()\n        courses = [e.course for e in enrollments if not e.course.deleted_at and e.course.visibility != 'private' and not e.course.subject_id]\n        \n        subject_enrollments = SubjectEnrollment.query.filter_by(\n            user_id=current_user.id,\n            status='approved'\n        ).all()\n        subjects = [se.subject for se in subject_enrollments if se.subject and not se.subject.deleted_at]\n        \n        pending_subject_enrollments = SubjectEnrollment.query.filter_by(\n            user_id=current_user.id,\n            status='pending'\n        ).all()\n        \n        total_completed = Progress.query.filter_by(user_id=current_user.id).filter(Progress.completed_at != None).count()\n        \n        # Count checkpoints from standalone seminars\n        total_checkpoints = 0\n        for course in courses:\n            total_checkpoints += course.checkpoints.filter_by(deleted_at=None).count()\n        \n        # Also count checkpoints from enrolled subject sessions\n        for subject in subjects:\n            subject_courses = Course.query.filter_by(subject_id=subject.id, deleted_at=None).all()\n            for course in subject_courses:\n                total_checkpoints += course.checkpoints.filter_by(deleted_at=None).count()\n        \n        completion_rate = round((total_completed / total_checkpoints * 100) if total_checkpoints > 0 else 0)\n        \n        total_minutes = db.session.query(func.sum(Progress.duration_seconds)).filter(\n            Progress.user_id == current_user.id\n        ).filter(Progress.duration_seconds != None).scalar() or 0\n        total_hours = round(total_minutes / 3600, 1)\n        \n        seven_days_ago = datetime.utcnow() - timedelta(days=7)\n        daily_progress = db.session.query(\n            func.date(Progress.completed_at),\n            func.count(Progress.id)\n        ).filter(\n            Progress.user_id == current_user.id,\n            Progress.completed_at >= seven_days_ago\n        ).group_by(func.date(Progress.completed_at)).all()\n        \n        streak_days = calculate_streak(current_user.id)\n        \n        active_sessions_for_student = []\n        # Check standalone seminars\n        for course in courses:\n            active = ActiveSession.query.filter_by(course_id=course.id, ended_at=None).first()\n            if active:\n                active_sessions_for_student.append({'course': course, 'session': active})\n        \n        # Check subject sessions\n        for subject in subjects:\n            subject_courses = Course.query.filter_by(subject_id=subject.id, deleted_at=None).all()\n            for course in subject_courses:\n                active = ActiveSession.query.filter_by(course_id=course.id, ended_at=None).first()\n                if active:\n                    active_sessions_for_student.append({'course': course, 'session': active})\n        \n        upcoming_for_student = ActiveSession.query.join(Course).join(Enrollment).filter(\n            Enrollment.user_id == current_user.id,\n            Course.deleted_at.is_(None),\n            Course.visibility != 'private',\n            ActiveSession.session_type == 'scheduled',\n            ActiveSession.scheduled_at > datetime.utcnow(),\n            ActiveSession.ended_at == None\n        ).order_by(ActiveSession.scheduled_at).limit(5).all()\n        \n        all_subjects = Subject.query.filter(\n            Subject.deleted_at.is_(None),\n            Subject.is_visible == True\n        ).all()\n        available_subjects = [s for s in all_subjects if s.id not in [se.subject_id for se in subject_enrollments + pending_subject_enrollments]]\n        \n        return render_template('dashboard/student.html', \n            courses=courses,\n            subjects=subjects,\n            pending_enrollments=pending_subject_enrollments,\n            available_subjects=available_subjects,\n            total_completed=total_completed,\n            total_checkpoints=total_checkpoints,\n            completion_rate=completion_rate,\n            total_hours=total_hours,\n            streak_days=streak_days,\n            daily_progress=daily_progress,\n            active_sessions=active_sessions_for_student,\n            upcoming_sessions=upcoming_for_student\n        )\n\n\ndef calculate_streak(user_id):\n    today = datetime.utcnow().date()\n    streak = 0\n    current_date = today\n    \n    while True:\n        has_progress = Progress.query.filter(\n            Progress.user_id == user_id,\n            func.date(Progress.completed_at) == current_date\n        ).first()\n        \n        if has_progress:\n            streak += 1\n            current_date -= timedelta(days=1)\n        else:\n            break\n        \n        if streak > 365:\n            break\n    \n    return streak\n\n@bp.route('/notifications')\n@login_required\ndef notifications():\n    user_notifications = Notification.query.filter_by(user_id=current_user.id).order_by(Notification.created_at.desc()).limit(50).all()\n    return render_template('notifications.html', notifications=user_notifications)\n\n\n@bp.route('/notifications/<int:notification_id>/read', methods=['POST'])\n@login_required\ndef mark_notification_read(notification_id):\n    notification = Notification.query.get_or_404(notification_id)\n    if notification.user_id != current_user.id:\n        return jsonify({'success': False, 'message': '권한이 없습니다.'}), 403\n    notification.is_read = True\n    db.session.commit()\n    return jsonify({'success': True})\n\n\n@bp.route('/notifications/mark-all-read', methods=['POST'])\n@login_required\ndef mark_all_notifications_read():\n    Notification.query.filter_by(user_id=current_user.id, is_read=False).update({'is_read': True})\n    db.session.commit()\n    return jsonify({'success': True})\n\n\n@bp.route('/notifications/unread-count')\n@login_required\ndef unread_notification_count():\n    count = Notification.query.filter_by(user_id=current_user.id, is_read=False).count()\n    return jsonify({'count': count})\n","path":null,"size_bytes":9238,"size_tokens":null},"app/forms.py":{"content":"from flask_wtf import FlaskForm\nfrom wtforms import StringField, PasswordField, TextAreaField, SelectField, IntegerField, SubmitField, DateTimeLocalField, BooleanField\nfrom wtforms.validators import DataRequired, Email, Length, EqualTo, ValidationError, Optional\nfrom app.models import User\n\nclass RegistrationForm(FlaskForm):\n    full_name = StringField('이름', validators=[DataRequired(message='이름을 입력하세요'), Length(min=2, max=120, message='2~120자 사이로 입력하세요')])\n    email = StringField('이메일', validators=[DataRequired(message='이메일을 입력하세요'), Email(message='올바른 이메일 형식을 입력하세요')])\n    phone = StringField('휴대폰 번호', validators=[DataRequired(message='휴대폰 번호를 입력하세요'), Length(min=10, max=20, message='올바른 휴대폰 번호를 입력하세요')])\n    password = PasswordField('비밀번호', validators=[DataRequired(message='비밀번호를 입력하세요'), Length(min=6, message='최소 6자 이상 입력하세요')])\n    confirm_password = PasswordField('비밀번호 확인', validators=[DataRequired(message='비밀번호 확인을 입력하세요'), EqualTo('password', message='비밀번호가 일치하지 않습니다')])\n    role = SelectField('역할', choices=[('student', '학생'), ('instructor', '강사')])\n    submit = SubmitField('회원가입')\n    \n    def validate_phone(self, phone):\n        cleaned = ''.join(filter(str.isdigit, phone.data))\n        if len(cleaned) < 10:\n            raise ValidationError('올바른 휴대폰 번호를 입력하세요.')\n    \n    def validate_email(self, email):\n        user = User.query.filter_by(email=email.data).first()\n        if user:\n            raise ValidationError('이미 등록된 이메일입니다.')\n\nclass LoginForm(FlaskForm):\n    email = StringField('이메일', validators=[DataRequired(message='이메일을 입력하세요'), Email(message='올바른 이메일 형식을 입력하세요')])\n    password = PasswordField('비밀번호', validators=[DataRequired(message='비밀번호를 입력하세요')])\n    remember_id = BooleanField('아이디 저장')\n    auto_login = BooleanField('자동 로그인')\n    submit = SubmitField('로그인')\n\nclass ForgotPasswordForm(FlaskForm):\n    email = StringField('이메일', validators=[DataRequired(message='이메일을 입력하세요'), Email(message='올바른 이메일 형식을 입력하세요')])\n    submit = SubmitField('비밀번호 재설정 링크 받기')\n\nclass ResetPasswordForm(FlaskForm):\n    password = PasswordField('새 비밀번호', validators=[DataRequired(message='새 비밀번호를 입력하세요'), Length(min=6, message='최소 6자 이상 입력하세요')])\n    confirm_password = PasswordField('비밀번호 확인', validators=[DataRequired(message='비밀번호 확인을 입력하세요'), EqualTo('password', message='비밀번호가 일치하지 않습니다')])\n    submit = SubmitField('비밀번호 변경')\n\nclass CourseForm(FlaskForm):\n    title = StringField('세션명', validators=[DataRequired(message='세션명을 입력하세요'), Length(max=200)])\n    description = TextAreaField('설명', validators=[Optional()])\n    order_number = IntegerField('순서', validators=[Optional()])\n    session_type = SelectField('세션 종류', choices=[\n        ('live_session', '라이브 세션'),\n        ('video', '동영상 (일반)'),\n        ('video_external', '동영상 (외부영상)'),\n        ('material', '학습 자료'),\n        ('assignment', '과제 제출'),\n        ('quiz', '퀴즈')\n    ], default='live_session')\n    start_date = StringField('시작 일시', validators=[Optional()])\n    end_date = StringField('종료 일시', validators=[Optional()])\n    attendance_start = StringField('출석 시작', validators=[Optional()])\n    attendance_end = StringField('출석 마감', validators=[Optional()])\n    late_allowed = BooleanField('지각 허용')\n    late_end = StringField('지각 마감', validators=[Optional()])\n    visibility = SelectField('공개 설정', choices=[\n        ('public', '공개'),\n        ('private', '비공개'),\n        ('date_based', '기간 기반'),\n        ('prerequisite', '선행 세션 완료')\n    ], default='public')\n    video_url = StringField('동영상 URL (유튜브)', validators=[Optional()])\n    assignment_description = TextAreaField('과제 설명', validators=[Optional()])\n    assignment_due_date = StringField('과제 제출 마감', validators=[Optional()])\n    quiz_time_limit = IntegerField('퀴즈 제한 시간 (분)', validators=[Optional()])\n    quiz_pass_score = IntegerField('퀴즈 합격 점수', validators=[Optional()])\n    submit = SubmitField('저장')\n\nclass EnrollForm(FlaskForm):\n    invite_code = StringField('초대 코드', validators=[DataRequired(message='초대 코드를 입력하세요'), Length(min=8, max=8, message='8자리 코드를 입력하세요')])\n    submit = SubmitField('수강 신청')\n\nclass CheckpointForm(FlaskForm):\n    title = StringField('제목', validators=[DataRequired(message='제목을 입력하세요'), Length(max=200)])\n    description = TextAreaField('설명', validators=[Optional()])\n    estimated_minutes = IntegerField('예상 소요 시간 (분)', validators=[Optional()])\n    submit = SubmitField('저장')\n\nclass SubjectForm(FlaskForm):\n    title = StringField('과목명', validators=[DataRequired(message='과목명을 입력하세요'), Length(max=200)])\n    description = TextAreaField('설명', validators=[Optional()])\n    submit = SubmitField('저장')\n\nclass SessionScheduleForm(FlaskForm):\n    session_type = SelectField('세션 유형', choices=[('immediate', '즉시 시작'), ('scheduled', '예약 시작')])\n    scheduled_at = StringField('예약 시간', validators=[Optional()])\n    submit = SubmitField('세션 시작')\n\nclass LiveSessionPostForm(FlaskForm):\n    title = StringField('제목', validators=[DataRequired(message='제목을 입력하세요'), Length(max=200)])\n    content = TextAreaField('내용', validators=[DataRequired(message='내용을 입력하세요')])\n    pinned = BooleanField('상단 고정')\n    submit = SubmitField('등록')\n\nclass LiveSessionCommentForm(FlaskForm):\n    content = TextAreaField('댓글', validators=[DataRequired(message='내용을 입력하세요')])\n    submit = SubmitField('댓글 작성')\n\nclass ProfileForm(FlaskForm):\n    nickname = StringField('닉네임', validators=[Optional(), Length(max=80)])\n    full_name = StringField('이름', validators=[Optional(), Length(max=120)])\n    profile_url = StringField('프로필 주소', validators=[Optional(), Length(max=255)])\n    bio = TextAreaField('자기소개', validators=[Optional(), Length(max=500)])\n    submit = SubmitField('저장')\n\nclass BasicInfoForm(FlaskForm):\n    email = StringField('이메일', validators=[DataRequired(message='이메일을 입력하세요'), Email(message='올바른 이메일 형식을 입력하세요')])\n    phone = StringField('휴대폰 번호', validators=[Optional(), Length(max=20)])\n    submit = SubmitField('저장')\n\nclass PasswordChangeForm(FlaskForm):\n    current_password = PasswordField('현재 비밀번호', validators=[DataRequired(message='현재 비밀번호를 입력하세요')])\n    new_password = PasswordField('새 비밀번호', validators=[DataRequired(message='새 비밀번호를 입력하세요'), Length(min=6, message='최소 6자 이상 입력하세요')])\n    confirm_password = PasswordField('비밀번호 확인', validators=[DataRequired(message='비밀번호 확인을 입력하세요'), EqualTo('new_password', message='비밀번호가 일치하지 않습니다')])\n    submit = SubmitField('비밀번호 변경')\n\nclass AdditionalInfoForm(FlaskForm):\n    organization = StringField('소속', validators=[Optional(), Length(max=200)])\n    position = StringField('직책', validators=[Optional(), Length(max=100)])\n    job_title = StringField('직급', validators=[Optional(), Length(max=100)])\n    submit = SubmitField('저장')\n\nclass LearningReviewForm(FlaskForm):\n    title = StringField('제목', validators=[DataRequired(message='제목을 입력하세요'), Length(max=200)])\n    content = TextAreaField('내용', validators=[DataRequired(message='내용을 입력하세요')])\n    rating = SelectField('평점', choices=[(5, '5점'), (4, '4점'), (3, '3점'), (2, '2점'), (1, '1점')], coerce=int)\n    submit = SubmitField('등록')\n\nclass QnAPostForm(FlaskForm):\n    title = StringField('제목', validators=[DataRequired(message='제목을 입력하세요'), Length(max=200)])\n    content = TextAreaField('내용', validators=[DataRequired(message='내용을 입력하세요')])\n    submit = SubmitField('질문 등록')\n\nclass QnAAnswerForm(FlaskForm):\n    content = TextAreaField('답변', validators=[DataRequired(message='답변 내용을 입력하세요')])\n    submit = SubmitField('답변 등록')\n\nclass StudyGroupForm(FlaskForm):\n    title = StringField('스터디명', validators=[DataRequired(message='스터디명을 입력하세요'), Length(max=200)])\n    description = TextAreaField('설명', validators=[DataRequired(message='설명을 입력하세요')])\n    category = SelectField('카테고리', choices=[\n        ('programming', '프로그래밍'),\n        ('data_science', '데이터 사이언스'),\n        ('design', '디자인'),\n        ('language', '외국어'),\n        ('certification', '자격증'),\n        ('general', '일반')\n    ])\n    max_members = IntegerField('최대 인원', validators=[DataRequired(message='최대 인원을 입력하세요')])\n    meeting_type = SelectField('진행 방식', choices=[\n        ('online', '온라인'),\n        ('offline', '오프라인'),\n        ('hybrid', '혼합')\n    ])\n    meeting_schedule = StringField('모임 일정', validators=[Optional(), Length(max=200)])\n    tags = StringField('태그', validators=[Optional(), Length(max=200)])\n    submit = SubmitField('스터디 만들기')\n\nclass CommentForm(FlaskForm):\n    content = TextAreaField('댓글', validators=[DataRequired(message='내용을 입력하세요')])\n    submit = SubmitField('댓글 등록')\n","path":null,"size_bytes":10165,"size_tokens":null},"app/routes/community.py":{"content":"from flask import Blueprint, render_template, redirect, url_for, flash, request\nfrom flask_login import login_required, current_user\nfrom app import db\nfrom app.models import LearningReview, ReviewComment, QnAPost, QnAAnswer, StudyGroup, StudyGroupMember, Subject, Course\nfrom app.forms import LearningReviewForm, QnAPostForm, QnAAnswerForm, StudyGroupForm, CommentForm\n\nbp = Blueprint('community', __name__, url_prefix='/community')\n\n@bp.route('/')\ndef index():\n    tab = request.args.get('tab', 'reviews')\n    \n    reviews = LearningReview.query.order_by(LearningReview.created_at.desc()).limit(10).all()\n    qna_posts = QnAPost.query.order_by(QnAPost.created_at.desc()).limit(10).all()\n    study_groups = StudyGroup.query.filter_by(status='recruiting').order_by(StudyGroup.created_at.desc()).limit(10).all()\n    \n    return render_template('community/index.html',\n                          tab=tab,\n                          reviews=reviews,\n                          qna_posts=qna_posts,\n                          study_groups=study_groups)\n\n@bp.route('/reviews')\ndef reviews_list():\n    page = request.args.get('page', 1, type=int)\n    reviews = LearningReview.query.order_by(LearningReview.created_at.desc()).paginate(page=page, per_page=12)\n    return render_template('community/reviews_list.html', reviews=reviews)\n\n@bp.route('/reviews/new', methods=['GET', 'POST'])\n@login_required\ndef create_review():\n    form = LearningReviewForm()\n    subjects = Subject.query.all()\n    \n    if form.validate_on_submit():\n        review = LearningReview(\n            user_id=current_user.id,\n            title=form.title.data,\n            content=form.content.data,\n            rating=form.rating.data,\n            subject_id=request.form.get('subject_id') or None,\n            course_id=request.form.get('course_id') or None\n        )\n        db.session.add(review)\n        db.session.commit()\n        flash('학습 리뷰가 등록되었습니다.', 'success')\n        return redirect(url_for('community.review_detail', review_id=review.id))\n    \n    return render_template('community/review_form.html', form=form, subjects=subjects)\n\n@bp.route('/reviews/<int:review_id>')\ndef review_detail(review_id):\n    review = LearningReview.query.get_or_404(review_id)\n    review.views_count += 1\n    db.session.commit()\n    \n    comment_form = CommentForm()\n    comments = review.comments.order_by(ReviewComment.created_at.asc()).all()\n    \n    return render_template('community/review_detail.html', \n                          review=review, \n                          comment_form=comment_form,\n                          comments=comments)\n\n@bp.route('/reviews/<int:review_id>/comment', methods=['POST'])\n@login_required\ndef add_review_comment(review_id):\n    review = LearningReview.query.get_or_404(review_id)\n    form = CommentForm()\n    \n    if form.validate_on_submit():\n        comment = ReviewComment(\n            review_id=review_id,\n            user_id=current_user.id,\n            content=form.content.data\n        )\n        db.session.add(comment)\n        db.session.commit()\n        flash('댓글이 등록되었습니다.', 'success')\n    \n    return redirect(url_for('community.review_detail', review_id=review_id))\n\n@bp.route('/reviews/<int:review_id>/like', methods=['POST'])\n@login_required\ndef like_review(review_id):\n    review = LearningReview.query.get_or_404(review_id)\n    review.likes_count += 1\n    db.session.commit()\n    return {'likes_count': review.likes_count}\n\n@bp.route('/qna')\ndef qna_list():\n    page = request.args.get('page', 1, type=int)\n    filter_type = request.args.get('filter', 'all')\n    \n    query = QnAPost.query\n    if filter_type == 'resolved':\n        query = query.filter_by(is_resolved=True)\n    elif filter_type == 'unresolved':\n        query = query.filter_by(is_resolved=False)\n    \n    qna_posts = query.order_by(QnAPost.created_at.desc()).paginate(page=page, per_page=12)\n    return render_template('community/qna_list.html', qna_posts=qna_posts, filter_type=filter_type)\n\n@bp.route('/qna/new', methods=['GET', 'POST'])\n@login_required\ndef create_qna():\n    form = QnAPostForm()\n    subjects = Subject.query.all()\n    \n    if form.validate_on_submit():\n        try:\n            post = QnAPost(\n                user_id=current_user.id,\n                title=form.title.data,\n                content=form.content.data,\n                subject_id=request.form.get('subject_id') or None,\n                course_id=request.form.get('course_id') or None\n            )\n            db.session.add(post)\n            db.session.commit()\n            flash('질문이 등록되었습니다.', 'success')\n            return redirect(url_for('community.qna_detail', post_id=post.id))\n        except Exception as e:\n            db.session.rollback()\n            flash('질문 등록 중 오류가 발생했습니다.', 'danger')\n    \n    return render_template('community/qna_form.html', form=form, subjects=subjects)\n\n@bp.route('/qna/<int:post_id>')\ndef qna_detail(post_id):\n    post = QnAPost.query.get_or_404(post_id)\n    post.views_count += 1\n    db.session.commit()\n    \n    answer_form = QnAAnswerForm()\n    answers = post.answers.order_by(QnAAnswer.is_accepted.desc(), QnAAnswer.likes_count.desc()).all()\n    \n    return render_template('community/qna_detail.html',\n                          post=post,\n                          answer_form=answer_form,\n                          answers=answers)\n\n@bp.route('/qna/<int:post_id>/answer', methods=['POST'])\n@login_required\ndef add_qna_answer(post_id):\n    post = QnAPost.query.get_or_404(post_id)\n    form = QnAAnswerForm()\n    \n    if form.validate_on_submit():\n        answer = QnAAnswer(\n            post_id=post_id,\n            user_id=current_user.id,\n            content=form.content.data\n        )\n        db.session.add(answer)\n        db.session.commit()\n        flash('답변이 등록되었습니다.', 'success')\n    \n    return redirect(url_for('community.qna_detail', post_id=post_id))\n\n@bp.route('/qna/<int:post_id>/accept/<int:answer_id>', methods=['POST'])\n@login_required\ndef accept_answer(post_id, answer_id):\n    post = QnAPost.query.get_or_404(post_id)\n    \n    if post.user_id != current_user.id:\n        flash('질문 작성자만 답변을 채택할 수 있습니다.', 'danger')\n        return redirect(url_for('community.qna_detail', post_id=post_id))\n    \n    answer = QnAAnswer.query.get_or_404(answer_id)\n    if answer.post_id != post_id:\n        flash('잘못된 요청입니다.', 'danger')\n        return redirect(url_for('community.qna_detail', post_id=post_id))\n    \n    answer.is_accepted = True\n    post.is_resolved = True\n    db.session.commit()\n    flash('답변이 채택되었습니다.', 'success')\n    \n    return redirect(url_for('community.qna_detail', post_id=post_id))\n\n@bp.route('/study-groups')\ndef study_groups_list():\n    page = request.args.get('page', 1, type=int)\n    category = request.args.get('category', 'all')\n    \n    query = StudyGroup.query\n    if category != 'all':\n        query = query.filter_by(category=category)\n    \n    study_groups = query.order_by(StudyGroup.created_at.desc()).paginate(page=page, per_page=12)\n    \n    categories = [\n        ('all', '전체'),\n        ('programming', '프로그래밍'),\n        ('data_science', '데이터 사이언스'),\n        ('design', '디자인'),\n        ('language', '외국어'),\n        ('certification', '자격증'),\n        ('general', '일반')\n    ]\n    \n    return render_template('community/study_groups_list.html', \n                          study_groups=study_groups,\n                          categories=categories,\n                          current_category=category)\n\n@bp.route('/study-groups/new', methods=['GET', 'POST'])\n@login_required\ndef create_study_group():\n    form = StudyGroupForm()\n    \n    if form.validate_on_submit():\n        try:\n            group = StudyGroup(\n                creator_id=current_user.id,\n                title=form.title.data,\n                description=form.description.data,\n                category=form.category.data,\n                max_members=form.max_members.data,\n                meeting_type=form.meeting_type.data,\n                meeting_schedule=form.meeting_schedule.data,\n                tags=form.tags.data\n            )\n            db.session.add(group)\n            db.session.commit()\n            \n            member = StudyGroupMember(\n                group_id=group.id,\n                user_id=current_user.id,\n                status='approved'\n            )\n            db.session.add(member)\n            db.session.commit()\n            \n            flash('스터디가 생성되었습니다.', 'success')\n            return redirect(url_for('community.study_group_detail', group_id=group.id))\n        except Exception as e:\n            db.session.rollback()\n            flash('스터디 생성 중 오류가 발생했습니다.', 'danger')\n    \n    return render_template('community/study_group_form.html', form=form)\n\n@bp.route('/study-groups/<int:group_id>')\ndef study_group_detail(group_id):\n    group = StudyGroup.query.get_or_404(group_id)\n    members = group.members.filter_by(status='approved').all()\n    pending_members = group.members.filter_by(status='pending').all()\n    \n    is_member = False\n    is_creator = group.creator_id == current_user.id if current_user.is_authenticated else False\n    pending_request = None\n    \n    if current_user.is_authenticated:\n        membership = StudyGroupMember.query.filter_by(\n            group_id=group_id,\n            user_id=current_user.id\n        ).first()\n        if membership:\n            if membership.status == 'approved':\n                is_member = True\n            elif membership.status == 'pending':\n                pending_request = membership\n    \n    return render_template('community/study_group_detail.html',\n                          group=group,\n                          members=members,\n                          pending_members=pending_members,\n                          is_member=is_member,\n                          is_creator=is_creator,\n                          pending_request=pending_request)\n\n@bp.route('/study-groups/<int:group_id>/join', methods=['POST'])\n@login_required\ndef join_study_group(group_id):\n    group = StudyGroup.query.get_or_404(group_id)\n    \n    existing = StudyGroupMember.query.filter_by(\n        group_id=group_id,\n        user_id=current_user.id\n    ).first()\n    \n    if existing:\n        if existing.status == 'approved':\n            flash('이미 스터디에 참여 중입니다.', 'warning')\n        else:\n            flash('이미 가입 신청을 했습니다.', 'warning')\n        return redirect(url_for('community.study_group_detail', group_id=group_id))\n    \n    if group.current_members >= group.max_members:\n        flash('스터디 정원이 다 찼습니다.', 'danger')\n        return redirect(url_for('community.study_group_detail', group_id=group_id))\n    \n    member = StudyGroupMember(\n        group_id=group_id,\n        user_id=current_user.id,\n        status='pending'\n    )\n    db.session.add(member)\n    db.session.commit()\n    \n    flash('가입 신청이 완료되었습니다. 스터디장의 승인을 기다려주세요.', 'success')\n    return redirect(url_for('community.study_group_detail', group_id=group_id))\n\n@bp.route('/study-groups/<int:group_id>/approve/<int:member_id>', methods=['POST'])\n@login_required\ndef approve_member(group_id, member_id):\n    group = StudyGroup.query.get_or_404(group_id)\n    \n    if group.creator_id != current_user.id:\n        flash('스터디장만 승인할 수 있습니다.', 'danger')\n        return redirect(url_for('community.study_group_detail', group_id=group_id))\n    \n    member = StudyGroupMember.query.get_or_404(member_id)\n    if member.group_id != group_id:\n        flash('잘못된 요청입니다.', 'danger')\n        return redirect(url_for('community.study_group_detail', group_id=group_id))\n    \n    member.status = 'approved'\n    group.current_members += 1\n    db.session.commit()\n    \n    flash('멤버가 승인되었습니다.', 'success')\n    return redirect(url_for('community.study_group_detail', group_id=group_id))\n\n@bp.route('/study-groups/<int:group_id>/reject/<int:member_id>', methods=['POST'])\n@login_required\ndef reject_member(group_id, member_id):\n    group = StudyGroup.query.get_or_404(group_id)\n    \n    if group.creator_id != current_user.id:\n        flash('스터디장만 거절할 수 있습니다.', 'danger')\n        return redirect(url_for('community.study_group_detail', group_id=group_id))\n    \n    member = StudyGroupMember.query.get_or_404(member_id)\n    if member.group_id != group_id:\n        flash('잘못된 요청입니다.', 'danger')\n        return redirect(url_for('community.study_group_detail', group_id=group_id))\n    \n    db.session.delete(member)\n    db.session.commit()\n    \n    flash('가입 신청이 거절되었습니다.', 'info')\n    return redirect(url_for('community.study_group_detail', group_id=group_id))\n","path":null,"size_bytes":13022,"size_tokens":null},"app/routes/attendance.py":{"content":"from flask import Blueprint, render_template, request, jsonify, flash, redirect, url_for\nfrom flask_login import login_required, current_user\nfrom app import db\nfrom app.models import Attendance, Course, ActiveSession, User, Enrollment\nfrom datetime import datetime\n\nbp = Blueprint('attendance', __name__, url_prefix='/attendance')\n\n@bp.route('/course/<int:course_id>')\n@login_required\ndef course_attendance(course_id):\n    course = Course.query.get_or_404(course_id)\n    \n    if course.instructor_id != current_user.id and not current_user.is_enrolled(course):\n        flash('접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    sessions = ActiveSession.query.filter_by(course_id=course_id).order_by(ActiveSession.started_at.desc()).all()\n    students = course.get_enrolled_students()\n    \n    attendance_data = {}\n    for session in sessions:\n        attendance_data[session.id] = {}\n        for student in students:\n            att = Attendance.query.filter_by(\n                course_id=course_id,\n                user_id=student.id,\n                session_id=session.id\n            ).first()\n            attendance_data[session.id][student.id] = att\n    \n    is_instructor = course.instructor_id == current_user.id\n    \n    return render_template('attendance/course.html', \n                         course=course, \n                         sessions=sessions, \n                         students=students,\n                         attendance_data=attendance_data,\n                         is_instructor=is_instructor)\n\n@bp.route('/mark', methods=['POST'])\n@login_required\ndef mark_attendance():\n    data = request.get_json()\n    course_id = data.get('course_id')\n    session_id = data.get('session_id')\n    user_id = data.get('user_id')\n    status = data.get('status', 'present')\n    notes = data.get('notes', '')\n    \n    course = Course.query.get_or_404(course_id)\n    \n    if course.instructor_id != current_user.id:\n        return jsonify({'error': '권한이 없습니다.'}), 403\n    \n    attendance = Attendance.query.filter_by(\n        course_id=course_id,\n        user_id=user_id,\n        session_id=session_id\n    ).first()\n    \n    if attendance:\n        attendance.status = status\n        attendance.notes = notes\n        attendance.checked_at = datetime.utcnow()\n        attendance.checked_by_id = current_user.id\n    else:\n        attendance = Attendance(\n            course_id=course_id,\n            user_id=user_id,\n            session_id=session_id,\n            status=status,\n            notes=notes,\n            checked_by_id=current_user.id\n        )\n        db.session.add(attendance)\n    \n    db.session.commit()\n    \n    return jsonify({\n        'success': True,\n        'attendance_id': attendance.id,\n        'status': status\n    })\n\n@bp.route('/self-check', methods=['POST'])\n@login_required\ndef self_check():\n    data = request.get_json()\n    course_id = data.get('course_id')\n    session_id = data.get('session_id')\n    \n    course = Course.query.get_or_404(course_id)\n    \n    if not current_user.is_enrolled(course):\n        return jsonify({'error': '등록되지 않은 세미나입니다.'}), 403\n    \n    session = ActiveSession.query.filter_by(id=session_id, ended_at=None).first()\n    if not session:\n        return jsonify({'error': '진행 중인 세션이 없습니다.'}), 400\n    \n    existing = Attendance.query.filter_by(\n        course_id=course_id,\n        user_id=current_user.id,\n        session_id=session_id\n    ).first()\n    \n    if existing:\n        return jsonify({'success': True, 'message': '이미 출석 체크되었습니다.', 'attendance_id': existing.id})\n    \n    attendance = Attendance(\n        course_id=course_id,\n        user_id=current_user.id,\n        session_id=session_id,\n        status='present'\n    )\n    db.session.add(attendance)\n    db.session.commit()\n    \n    return jsonify({\n        'success': True,\n        'message': '출석이 확인되었습니다.',\n        'attendance_id': attendance.id\n    })\n\n@bp.route('/bulk-mark', methods=['POST'])\n@login_required\ndef bulk_mark():\n    data = request.get_json()\n    course_id = data.get('course_id')\n    session_id = data.get('session_id')\n    attendances = data.get('attendances', [])\n    \n    course = Course.query.get_or_404(course_id)\n    \n    if course.instructor_id != current_user.id:\n        return jsonify({'error': '권한이 없습니다.'}), 403\n    \n    for att_data in attendances:\n        user_id = att_data.get('user_id')\n        status = att_data.get('status', 'present')\n        \n        attendance = Attendance.query.filter_by(\n            course_id=course_id,\n            user_id=user_id,\n            session_id=session_id\n        ).first()\n        \n        if attendance:\n            attendance.status = status\n            attendance.checked_at = datetime.utcnow()\n            attendance.checked_by_id = current_user.id\n        else:\n            attendance = Attendance(\n                course_id=course_id,\n                user_id=user_id,\n                session_id=session_id,\n                status=status,\n                checked_by_id=current_user.id\n            )\n            db.session.add(attendance)\n    \n    db.session.commit()\n    \n    return jsonify({'success': True, 'count': len(attendances)})\n\n@bp.route('/student/<int:user_id>/course/<int:course_id>')\n@login_required\ndef student_attendance(user_id, course_id):\n    course = Course.query.get_or_404(course_id)\n    \n    if course.instructor_id != current_user.id and current_user.id != user_id:\n        return jsonify({'error': '접근 권한이 없습니다.'}), 403\n    \n    student = User.query.get_or_404(user_id)\n    sessions = ActiveSession.query.filter_by(course_id=course_id).order_by(ActiveSession.started_at.desc()).all()\n    \n    attendance_records = []\n    for session in sessions:\n        att = Attendance.query.filter_by(\n            course_id=course_id,\n            user_id=user_id,\n            session_id=session.id\n        ).first()\n        attendance_records.append({\n            'session_id': session.id,\n            'session_started_at': session.started_at.isoformat() if session.started_at else None,\n            'status': att.status if att else 'absent',\n            'checked_at': att.checked_at.isoformat() if att and att.checked_at else None\n        })\n    \n    total_sessions = len(sessions)\n    present_count = sum(1 for r in attendance_records if r['status'] == 'present')\n    late_count = sum(1 for r in attendance_records if r['status'] == 'late')\n    absent_count = sum(1 for r in attendance_records if r['status'] == 'absent')\n    \n    return jsonify({\n        'student': {'id': student.id, 'username': student.username, 'email': student.email},\n        'total_sessions': total_sessions,\n        'present': present_count,\n        'late': late_count,\n        'absent': absent_count,\n        'attendance_rate': round(present_count / total_sessions * 100, 1) if total_sessions > 0 else 0,\n        'records': attendance_records\n    })\n","path":null,"size_bytes":7027,"size_tokens":null},"app/services/__init__.py":{"content":"","path":null,"size_bytes":0,"size_tokens":null},"app/routes/analytics.py":{"content":"from flask import Blueprint, render_template, jsonify, Response\nfrom flask_login import login_required, current_user\nfrom app import db\nfrom app.models import Course, Checkpoint, Progress, Enrollment\nimport csv\nimport io\n\nbp = Blueprint('analytics', __name__, url_prefix='/analytics')\n\n@bp.route('/instructor/<int:course_id>')\n@login_required\ndef instructor_dashboard(course_id):\n    course = Course.query.get_or_404(course_id)\n    if course.instructor_id != current_user.id:\n        return jsonify({'error': 'Access denied'}), 403\n    \n    checkpoints = Checkpoint.query.filter_by(course_id=course_id, deleted_at=None).order_by(Checkpoint.order).all()\n    students = course.get_enrolled_students()\n    total_students = len(students)\n    \n    stats = []\n    for cp in checkpoints:\n        completed_count = Progress.query.join(Enrollment, Progress.user_id == Enrollment.user_id).filter(\n            Progress.checkpoint_id == cp.id,\n            Progress.completed_at.isnot(None),\n            Enrollment.course_id == course_id\n        ).count()\n        \n        avg_duration = db.session.query(db.func.avg(Progress.duration_seconds)).filter(\n            Progress.checkpoint_id == cp.id,\n            Progress.duration_seconds.isnot(None)\n        ).scalar() or 0\n        \n        completion_rate = (completed_count / total_students * 100) if total_students > 0 else 0\n        \n        stats.append({\n            'checkpoint_id': cp.id,\n            'title': cp.title,\n            'completed_count': completed_count,\n            'total_students': total_students,\n            'completion_rate': round(completion_rate, 1),\n            'avg_duration_seconds': round(avg_duration) if avg_duration else 0,\n            'estimated_minutes': cp.estimated_minutes or 0\n        })\n    \n    student_data = []\n    for student in students:\n        completed = Progress.query.filter(\n            Progress.user_id == student.id,\n            Progress.checkpoint_id.in_([cp.id for cp in checkpoints]),\n            Progress.completed_at.isnot(None)\n        ).count()\n        \n        student_data.append({\n            'id': student.id,\n            'username': student.username,\n            'completed_checkpoints': completed,\n            'total_checkpoints': len(checkpoints),\n            'progress_percent': round(completed / len(checkpoints) * 100, 1) if checkpoints else 0\n        })\n    \n    avg_progress = sum(s['progress_percent'] for s in student_data) / len(student_data) if student_data else 0\n    lagging_students = [s for s in student_data if s['progress_percent'] < avg_progress * 0.7]\n    \n    return render_template('analytics/instructor.html', \n                         course=course, \n                         stats=stats, \n                         students=student_data,\n                         lagging_students=lagging_students,\n                         avg_progress=round(avg_progress, 1))\n\n@bp.route('/student/<int:course_id>')\n@login_required\ndef student_dashboard(course_id):\n    course = Course.query.get_or_404(course_id)\n    if not current_user.is_enrolled(course):\n        return jsonify({'error': 'Not enrolled'}), 403\n    \n    checkpoints = Checkpoint.query.filter_by(course_id=course_id, deleted_at=None).order_by(Checkpoint.order).all()\n    \n    my_progress = []\n    total_time = 0\n    completed_count = 0\n    \n    for cp in checkpoints:\n        progress = Progress.query.filter_by(\n            user_id=current_user.id,\n            checkpoint_id=cp.id\n        ).first()\n        \n        duration = progress.duration_seconds if progress and progress.duration_seconds else 0\n        total_time += duration\n        \n        if progress and progress.completed_at:\n            completed_count += 1\n        \n        my_progress.append({\n            'checkpoint_id': cp.id,\n            'title': cp.title,\n            'order': cp.order,\n            'estimated_minutes': cp.estimated_minutes or 0,\n            'started': progress.started_at is not None if progress else False,\n            'completed': progress.completed_at is not None if progress else False,\n            'started_at': progress.started_at.isoformat() if progress and progress.started_at else None,\n            'completed_at': progress.completed_at.isoformat() if progress and progress.completed_at else None,\n            'duration_seconds': duration,\n            'duration_minutes': round(duration / 60, 1) if duration else 0\n        })\n    \n    sorted_by_duration = sorted([p for p in my_progress if p['duration_seconds'] > 0], \n                                key=lambda x: x['duration_seconds'], \n                                reverse=True)\n    slowest_checkpoints = sorted_by_duration[:3]\n    \n    progress_percent = round(completed_count / len(checkpoints) * 100, 1) if checkpoints else 0\n    \n    course_avg = db.session.query(db.func.avg(Progress.duration_seconds)).join(\n        Enrollment, Progress.user_id == Enrollment.user_id\n    ).filter(\n        Enrollment.course_id == course_id,\n        Progress.checkpoint_id.in_([cp.id for cp in checkpoints]),\n        Progress.duration_seconds.isnot(None)\n    ).scalar() or 0\n    \n    return render_template('analytics/student.html',\n                         course=course,\n                         progress=my_progress,\n                         progress_percent=progress_percent,\n                         completed_count=completed_count,\n                         total_checkpoints=len(checkpoints),\n                         total_time_minutes=round(total_time / 60, 1),\n                         slowest_checkpoints=slowest_checkpoints,\n                         course_avg_seconds=round(course_avg))\n\n@bp.route('/export/<int:course_id>')\n@login_required\ndef export_csv(course_id):\n    course = Course.query.get_or_404(course_id)\n    if course.instructor_id != current_user.id:\n        return jsonify({'error': 'Access denied'}), 403\n    \n    checkpoints = Checkpoint.query.filter_by(course_id=course_id, deleted_at=None).order_by(Checkpoint.order).all()\n    students = course.get_enrolled_students()\n    \n    output = io.StringIO()\n    writer = csv.writer(output)\n    \n    header = ['Student', 'Email']\n    for cp in checkpoints:\n        header.extend([f'{cp.title} - Started', f'{cp.title} - Completed', f'{cp.title} - Duration (min)'])\n    writer.writerow(header)\n    \n    for student in students:\n        row = [student.username, student.email]\n        for cp in checkpoints:\n            progress = Progress.query.filter_by(user_id=student.id, checkpoint_id=cp.id).first()\n            if progress:\n                row.append(progress.started_at.strftime('%Y-%m-%d %H:%M') if progress.started_at else '')\n                row.append(progress.completed_at.strftime('%Y-%m-%d %H:%M') if progress.completed_at else '')\n                row.append(round(progress.duration_seconds / 60, 1) if progress.duration_seconds else '')\n            else:\n                row.extend(['', '', ''])\n        writer.writerow(row)\n    \n    output.seek(0)\n    return Response(\n        output.getvalue(),\n        mimetype='text/csv',\n        headers={'Content-Disposition': f'attachment; filename=course_{course_id}_progress.csv'}\n    )\n\n@bp.route('/api/instructor/<int:course_id>')\n@login_required\ndef instructor_api(course_id):\n    course = Course.query.get_or_404(course_id)\n    if course.instructor_id != current_user.id:\n        return jsonify({'error': 'Access denied'}), 403\n    \n    checkpoints = Checkpoint.query.filter_by(course_id=course_id, deleted_at=None).order_by(Checkpoint.order).all()\n    students = course.get_enrolled_students()\n    total_students = len(students)\n    \n    checkpoint_stats = []\n    for cp in checkpoints:\n        completed_count = Progress.query.join(Enrollment, Progress.user_id == Enrollment.user_id).filter(\n            Progress.checkpoint_id == cp.id,\n            Progress.completed_at.isnot(None),\n            Enrollment.course_id == course_id\n        ).count()\n        \n        checkpoint_stats.append({\n            'id': cp.id,\n            'title': cp.title,\n            'completed': completed_count,\n            'total': total_students,\n            'rate': round(completed_count / total_students * 100, 1) if total_students > 0 else 0\n        })\n    \n    student_progress = []\n    for student in students:\n        progress_list = []\n        for cp in checkpoints:\n            p = Progress.query.filter_by(user_id=student.id, checkpoint_id=cp.id).first()\n            progress_list.append({\n                'checkpoint_id': cp.id,\n                'completed': p.completed_at is not None if p else False\n            })\n        student_progress.append({\n            'id': student.id,\n            'username': student.username,\n            'checkpoints': progress_list\n        })\n    \n    return jsonify({\n        'checkpoint_stats': checkpoint_stats,\n        'student_progress': student_progress\n    })\n","path":null,"size_bytes":8840,"size_tokens":null},"app/routes/forum.py":{"content":"from flask import Blueprint, render_template, redirect, url_for, flash, request\nfrom flask_login import login_required, current_user\nfrom app import db\nfrom app.models import Course, Enrollment, ForumPost, ForumComment\nfrom datetime import datetime\n\nbp = Blueprint('forum', __name__, url_prefix='/forum')\n\ndef user_has_course_access(user, course):\n    if not course:\n        return False\n    if user.is_instructor() and course.instructor_id == user.id:\n        return True\n    return Enrollment.query.filter_by(user_id=user.id, course_id=course.id).first() is not None\n\n@bp.route('/course/<int:course_id>')\n@login_required\ndef list_posts(course_id):\n    course = Course.query.get_or_404(course_id)\n    if not user_has_course_access(current_user, course):\n        flash('이 세미나에 접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    posts = ForumPost.query.filter_by(course_id=course_id).order_by(ForumPost.created_at.desc()).all()\n    return render_template('forum/list.html', course=course, posts=posts)\n\n@bp.route('/course/<int:course_id>/new', methods=['GET', 'POST'])\n@login_required\ndef create_post(course_id):\n    course = Course.query.get_or_404(course_id)\n    if not user_has_course_access(current_user, course):\n        flash('이 세미나에 접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    if request.method == 'POST':\n        title = request.form.get('title', '').strip()\n        content = request.form.get('content', '').strip()\n        \n        if not title or not content:\n            flash('제목과 내용을 모두 입력해주세요.', 'danger')\n            return render_template('forum/create.html', course=course)\n        \n        try:\n            post = ForumPost(\n                course_id=course_id,\n                user_id=current_user.id,\n                title=title,\n                content=content\n            )\n            db.session.add(post)\n            db.session.commit()\n            flash('게시글이 작성되었습니다.', 'success')\n            return redirect(url_for('forum.view_post', post_id=post.id))\n        except Exception as e:\n            db.session.rollback()\n            flash('게시글 작성 중 오류가 발생했습니다.', 'danger')\n            return render_template('forum/create.html', course=course)\n    \n    return render_template('forum/create.html', course=course)\n\n@bp.route('/post/<int:post_id>')\n@login_required\ndef view_post(post_id):\n    post = ForumPost.query.get_or_404(post_id)\n    course = post.course\n    \n    if not user_has_course_access(current_user, course):\n        flash('이 게시글에 접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    comments = ForumComment.query.filter_by(post_id=post_id).order_by(ForumComment.created_at.asc()).all()\n    return render_template('forum/view.html', post=post, course=course, comments=comments)\n\n@bp.route('/post/<int:post_id>/comment', methods=['POST'])\n@login_required\ndef add_comment(post_id):\n    post = ForumPost.query.get_or_404(post_id)\n    course = post.course\n    \n    if not user_has_course_access(current_user, course):\n        flash('이 게시글에 접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    content = request.form.get('content', '').strip()\n    if not content:\n        flash('댓글 내용을 입력해주세요.', 'danger')\n        return redirect(url_for('forum.view_post', post_id=post_id))\n    \n    comment = ForumComment(\n        post_id=post_id,\n        user_id=current_user.id,\n        content=content\n    )\n    db.session.add(comment)\n    db.session.commit()\n    flash('댓글이 작성되었습니다.', 'success')\n    return redirect(url_for('forum.view_post', post_id=post_id))\n\n@bp.route('/post/<int:post_id>/delete', methods=['POST'])\n@login_required\ndef delete_post(post_id):\n    post = ForumPost.query.get_or_404(post_id)\n    course = post.course\n    \n    if post.user_id != current_user.id and course.instructor_id != current_user.id:\n        flash('이 게시글을 삭제할 권한이 없습니다.', 'danger')\n        return redirect(url_for('forum.view_post', post_id=post_id))\n    \n    db.session.delete(post)\n    db.session.commit()\n    flash('게시글이 삭제되었습니다.', 'success')\n    return redirect(url_for('forum.list_posts', course_id=course.id))\n\n@bp.route('/comment/<int:comment_id>/delete', methods=['POST'])\n@login_required\ndef delete_comment(comment_id):\n    comment = ForumComment.query.get_or_404(comment_id)\n    post = comment.post\n    course = post.course\n    \n    if comment.user_id != current_user.id and course.instructor_id != current_user.id:\n        flash('이 댓글을 삭제할 권한이 없습니다.', 'danger')\n        return redirect(url_for('forum.view_post', post_id=post.id))\n    \n    db.session.delete(comment)\n    db.session.commit()\n    flash('댓글이 삭제되었습니다.', 'success')\n    return redirect(url_for('forum.view_post', post_id=post.id))\n","path":null,"size_bytes":5085,"size_tokens":null},"app/routes/guide.py":{"content":"from flask import Blueprint, render_template, redirect, url_for, flash, request, jsonify\nfrom flask_login import login_required, current_user\nfrom app import db\nfrom app.models import GuidePost, GuideComment, GuideAttachment\nfrom datetime import datetime\n\nbp = Blueprint('guide', __name__, url_prefix='/guide')\n\nCATEGORIES = {\n    'notice': {'name': '공지사항', 'icon': 'bi-megaphone', 'admin_only': True},\n    'faq': {'name': 'FAQ', 'icon': 'bi-question-circle', 'admin_only': True},\n    'qna': {'name': 'Q&A', 'icon': 'bi-chat-dots', 'admin_only': False},\n    'resources': {'name': '자료실', 'icon': 'bi-folder', 'admin_only': True},\n    'updates': {'name': '업데이트 소식', 'icon': 'bi-newspaper', 'admin_only': True},\n    'suggestions': {'name': '제안', 'icon': 'bi-lightbulb', 'admin_only': False}\n}\n\n\ndef is_admin():\n    return current_user.is_authenticated and current_user.role == 'admin'\n\n\n@bp.route('/')\n@login_required\ndef index():\n    category = request.args.get('category', 'notice')\n    if category not in CATEGORIES:\n        category = 'notice'\n    \n    posts = GuidePost.query.filter_by(category=category).order_by(\n        GuidePost.is_pinned.desc(),\n        GuidePost.created_at.desc()\n    ).all()\n    \n    return render_template('guide/index.html',\n                          posts=posts,\n                          categories=CATEGORIES,\n                          current_category=category,\n                          is_admin=is_admin())\n\n\n@bp.route('/post/<int:post_id>')\n@login_required\ndef view_post(post_id):\n    post = GuidePost.query.get_or_404(post_id)\n    post.view_count += 1\n    db.session.commit()\n    \n    comments = post.comments.order_by(GuideComment.created_at.asc()).all()\n    \n    return render_template('guide/view.html',\n                          post=post,\n                          comments=comments,\n                          categories=CATEGORIES,\n                          is_admin=is_admin())\n\n\n@bp.route('/create', methods=['GET', 'POST'])\n@login_required\ndef create_post():\n    category = request.args.get('category', 'qna')\n    \n    if category not in CATEGORIES:\n        flash('잘못된 카테고리입니다.', 'danger')\n        return redirect(url_for('guide.index'))\n    \n    cat_info = CATEGORIES[category]\n    if cat_info['admin_only'] and not is_admin():\n        flash('해당 카테고리에 글을 작성할 권한이 없습니다.', 'danger')\n        return redirect(url_for('guide.index', category=category))\n    \n    if request.method == 'POST':\n        title = request.form.get('title', '').strip()\n        content = request.form.get('content', '').strip()\n        is_pinned = request.form.get('is_pinned') == 'on' and is_admin()\n        \n        if not title or not content:\n            flash('제목과 내용을 모두 입력해주세요.', 'danger')\n            return render_template('guide/create.html',\n                                  category=category,\n                                  categories=CATEGORIES,\n                                  is_admin=is_admin())\n        \n        post = GuidePost(\n            category=category,\n            title=title,\n            content=content,\n            author_id=current_user.id,\n            is_pinned=is_pinned\n        )\n        db.session.add(post)\n        db.session.commit()\n        \n        flash('게시글이 작성되었습니다.', 'success')\n        return redirect(url_for('guide.view_post', post_id=post.id))\n    \n    return render_template('guide/create.html',\n                          category=category,\n                          categories=CATEGORIES,\n                          is_admin=is_admin())\n\n\n@bp.route('/post/<int:post_id>/edit', methods=['GET', 'POST'])\n@login_required\ndef edit_post(post_id):\n    post = GuidePost.query.get_or_404(post_id)\n    \n    if post.author_id != current_user.id and not is_admin():\n        flash('수정 권한이 없습니다.', 'danger')\n        return redirect(url_for('guide.view_post', post_id=post_id))\n    \n    if request.method == 'POST':\n        title = request.form.get('title', '').strip()\n        content = request.form.get('content', '').strip()\n        is_pinned = request.form.get('is_pinned') == 'on' and is_admin()\n        \n        if not title or not content:\n            flash('제목과 내용을 모두 입력해주세요.', 'danger')\n            return render_template('guide/edit.html', post=post, categories=CATEGORIES, is_admin=is_admin())\n        \n        post.title = title\n        post.content = content\n        post.is_pinned = is_pinned\n        post.updated_at = datetime.utcnow()\n        db.session.commit()\n        \n        flash('게시글이 수정되었습니다.', 'success')\n        return redirect(url_for('guide.view_post', post_id=post_id))\n    \n    return render_template('guide/edit.html', post=post, categories=CATEGORIES, is_admin=is_admin())\n\n\n@bp.route('/post/<int:post_id>/delete', methods=['POST'])\n@login_required\ndef delete_post(post_id):\n    post = GuidePost.query.get_or_404(post_id)\n    \n    if post.author_id != current_user.id and not is_admin():\n        flash('삭제 권한이 없습니다.', 'danger')\n        return redirect(url_for('guide.view_post', post_id=post_id))\n    \n    category = post.category\n    db.session.delete(post)\n    db.session.commit()\n    \n    flash('게시글이 삭제되었습니다.', 'success')\n    return redirect(url_for('guide.index', category=category))\n\n\n@bp.route('/post/<int:post_id>/comment', methods=['POST'])\n@login_required\ndef add_comment(post_id):\n    post = GuidePost.query.get_or_404(post_id)\n    content = request.form.get('content', '').strip()\n    \n    if not content:\n        flash('댓글 내용을 입력해주세요.', 'danger')\n        return redirect(url_for('guide.view_post', post_id=post_id))\n    \n    comment = GuideComment(\n        post_id=post_id,\n        author_id=current_user.id,\n        content=content,\n        is_admin_reply=is_admin()\n    )\n    db.session.add(comment)\n    \n    if post.category == 'qna' and is_admin():\n        post.is_answered = True\n    \n    db.session.commit()\n    \n    flash('댓글이 등록되었습니다.', 'success')\n    return redirect(url_for('guide.view_post', post_id=post_id))\n\n\n@bp.route('/comment/<int:comment_id>/delete', methods=['POST'])\n@login_required\ndef delete_comment(comment_id):\n    comment = GuideComment.query.get_or_404(comment_id)\n    \n    if comment.author_id != current_user.id and not is_admin():\n        flash('삭제 권한이 없습니다.', 'danger')\n        return redirect(url_for('guide.view_post', post_id=comment.post_id))\n    \n    post_id = comment.post_id\n    db.session.delete(comment)\n    db.session.commit()\n    \n    flash('댓글이 삭제되었습니다.', 'success')\n    return redirect(url_for('guide.view_post', post_id=post_id))\n\n\n@bp.route('/post/<int:post_id>/toggle-answered', methods=['POST'])\n@login_required\ndef toggle_answered(post_id):\n    if not is_admin():\n        return jsonify({'success': False, 'message': '권한이 없습니다.'}), 403\n    \n    post = GuidePost.query.get_or_404(post_id)\n    post.is_answered = not post.is_answered\n    db.session.commit()\n    \n    return jsonify({'success': True, 'is_answered': post.is_answered})\n","path":null,"size_bytes":7221,"size_tokens":null},"app/routes/auth.py":{"content":"from flask import Blueprint, render_template, redirect, url_for, flash, request, make_response\nfrom flask_login import login_user, logout_user, login_required, current_user\nfrom urllib.parse import urlparse\nfrom datetime import timedelta, datetime\nimport secrets\nimport base64\nfrom app import db\nfrom app.models import User\nfrom app.forms import RegistrationForm, LoginForm, ForgotPasswordForm, ResetPasswordForm, ProfileForm, BasicInfoForm, PasswordChangeForm, AdditionalInfoForm\n\npassword_reset_tokens = {}\n\nbp = Blueprint('auth', __name__, url_prefix='/auth')\n\ndef is_safe_url(target):\n    if not target:\n        return False\n    ref_url = urlparse(request.host_url)\n    test_url = urlparse(target)\n    return test_url.scheme in ('', 'http', 'https') and ref_url.netloc == test_url.netloc\n\n@bp.route('/register', methods=['GET', 'POST'])\ndef register():\n    if current_user.is_authenticated:\n        return redirect(url_for('main.dashboard'))\n    \n    form = RegistrationForm()\n    if form.validate_on_submit():\n        username = form.email.data.split('@')[0]\n        base_username = username\n        counter = 1\n        while User.query.filter_by(username=username).first():\n            username = f\"{base_username}{counter}\"\n            counter += 1\n        \n        user = User(\n            username=username,\n            email=form.email.data,\n            full_name=form.full_name.data,\n            phone=form.phone.data,\n            role=form.role.data\n        )\n        user.set_password(form.password.data)\n        db.session.add(user)\n        db.session.commit()\n        \n        if form.role.data == 'instructor':\n            flash('회원가입이 완료되었습니다! 강사 기능을 사용하려면 로그인 후 계정 설정에서 강사 인증을 요청해주세요.', 'success')\n        else:\n            flash('회원가입이 완료되었습니다! 로그인해주세요.', 'success')\n        return redirect(url_for('auth.login'))\n    \n    return render_template('auth/register.html', form=form)\n\n@bp.route('/login', methods=['GET', 'POST'])\ndef login():\n    if current_user.is_authenticated:\n        return redirect(url_for('main.dashboard'))\n    \n    form = LoginForm()\n    \n    # 저장된 이메일 쿠키에서 불러오기\n    saved_email = request.cookies.get('saved_email', '')\n    if request.method == 'GET' and saved_email:\n        form.email.data = saved_email\n        form.remember_id.data = True\n    \n    if form.validate_on_submit():\n        user = User.query.filter_by(email=form.email.data).first()\n        if user and user.check_password(form.password.data):\n            # 자동 로그인 옵션에 따라 remember 설정\n            remember = form.auto_login.data\n            login_user(user, remember=remember, duration=timedelta(days=30) if remember else None)\n            \n            next_page = request.args.get('next')\n            if next_page and is_safe_url(next_page):\n                flash('로그인되었습니다!', 'success')\n                response = make_response(redirect(next_page))\n            else:\n                flash('로그인되었습니다!', 'success')\n                response = make_response(redirect(url_for('main.dashboard')))\n            \n            # 아이디 저장 옵션 처리\n            if form.remember_id.data:\n                response.set_cookie('saved_email', str(form.email.data), max_age=60*60*24*365)  # 1년\n            else:\n                response.delete_cookie('saved_email')\n            \n            return response\n        flash('이메일 또는 비밀번호가 올바르지 않습니다.', 'danger')\n    \n    return render_template('auth/login.html', form=form)\n\n@bp.route('/logout')\n@login_required\ndef logout():\n    logout_user()\n    flash('로그아웃되었습니다. 다음에 또 만나요!', 'success')\n    return redirect(url_for('main.index'))\n\n@bp.route('/forgot-password', methods=['GET', 'POST'])\ndef forgot_password():\n    if current_user.is_authenticated:\n        return redirect(url_for('main.dashboard'))\n    \n    form = ForgotPasswordForm()\n    if form.validate_on_submit():\n        user = User.query.filter_by(email=form.email.data).first()\n        if user:\n            token = secrets.token_urlsafe(32)\n            password_reset_tokens[token] = {\n                'user_id': user.id,\n                'email': form.email.data,\n                'expires': datetime.utcnow() + timedelta(hours=1)\n            }\n            return redirect(url_for('auth.reset_password', token=token))\n        flash('입력하신 이메일 주소로 비밀번호 재설정 안내를 확인해주세요.', 'info')\n    \n    return render_template('auth/forgot_password.html', form=form)\n\n@bp.route('/reset-password/<token>', methods=['GET', 'POST'])\ndef reset_password(token):\n    if current_user.is_authenticated:\n        return redirect(url_for('main.dashboard'))\n    \n    token_data = password_reset_tokens.get(token)\n    if not token_data:\n        flash('유효하지 않거나 만료된 링크입니다.', 'danger')\n        return redirect(url_for('auth.forgot_password'))\n    \n    if datetime.utcnow() > token_data['expires']:\n        del password_reset_tokens[token]\n        flash('링크가 만료되었습니다. 다시 시도해주세요.', 'danger')\n        return redirect(url_for('auth.forgot_password'))\n    \n    form = ResetPasswordForm()\n    if form.validate_on_submit():\n        user = User.query.get(token_data['user_id'])\n        if user:\n            user.set_password(form.password.data)\n            db.session.commit()\n            del password_reset_tokens[token]\n            flash('비밀번호가 성공적으로 변경되었습니다. 새 비밀번호로 로그인해주세요.', 'success')\n            return redirect(url_for('auth.login'))\n    \n    return render_template('auth/reset_password.html', form=form)\n\n@bp.route('/account-settings', methods=['GET', 'POST'])\n@login_required\ndef account_settings():\n    profile_form = ProfileForm(prefix='profile')\n    basic_info_form = BasicInfoForm(prefix='basic')\n    password_form = PasswordChangeForm(prefix='password')\n    additional_form = AdditionalInfoForm(prefix='additional')\n    \n    # Pre-populate forms with current data\n    if request.method == 'GET':\n        profile_form.nickname.data = current_user.nickname\n        profile_form.full_name.data = current_user.full_name\n        profile_form.profile_url.data = current_user.profile_url\n        profile_form.bio.data = current_user.bio\n        \n        basic_info_form.email.data = current_user.email\n        basic_info_form.phone.data = current_user.phone\n        \n        additional_form.organization.data = current_user.organization_name\n        additional_form.position.data = current_user.position\n        additional_form.job_title.data = current_user.job_title\n    \n    # Handle form submissions\n    if request.method == 'POST':\n        action = request.form.get('action')\n        \n        if action == 'profile':\n            if profile_form.validate_on_submit():\n                current_user.nickname = profile_form.nickname.data\n                current_user.full_name = profile_form.full_name.data\n                current_user.profile_url = profile_form.profile_url.data\n                current_user.bio = profile_form.bio.data\n                db.session.commit()\n                flash('프로필이 저장되었습니다.', 'success')\n                return redirect(url_for('auth.account_settings'))\n        \n        elif action == 'profile_image':\n            if 'profile_image' in request.files:\n                file = request.files['profile_image']\n                if file and file.filename:\n                    # Validate file type\n                    allowed_extensions = {'png', 'jpg', 'jpeg'}\n                    ext = file.filename.rsplit('.', 1)[1].lower() if '.' in file.filename else ''\n                    if ext not in allowed_extensions:\n                        flash('PNG, JPG, JPEG 형식의 이미지만 업로드 가능합니다.', 'danger')\n                        return redirect(url_for('auth.account_settings'))\n                    \n                    # Check file size (1MB limit)\n                    file.seek(0, 2)\n                    size = file.tell()\n                    file.seek(0)\n                    if size > 1 * 1024 * 1024:\n                        flash('이미지 크기는 1MB 이하여야 합니다.', 'danger')\n                        return redirect(url_for('auth.account_settings'))\n                    \n                    # Convert to base64\n                    image_data = base64.b64encode(file.read()).decode('utf-8')\n                    current_user.profile_image = f\"data:image/{ext};base64,{image_data}\"\n                    db.session.commit()\n                    flash('프로필 이미지가 업데이트되었습니다.', 'success')\n                    return redirect(url_for('auth.account_settings'))\n        \n        elif action == 'basic_info':\n            if basic_info_form.validate_on_submit():\n                # Check if email already exists for another user\n                if basic_info_form.email.data != current_user.email:\n                    existing_user = User.query.filter_by(email=basic_info_form.email.data).first()\n                    if existing_user:\n                        flash('이미 사용 중인 이메일입니다.', 'danger')\n                        return redirect(url_for('auth.account_settings'))\n                \n                current_user.email = basic_info_form.email.data\n                current_user.phone = basic_info_form.phone.data\n                db.session.commit()\n                flash('기본 정보가 저장되었습니다.', 'success')\n                return redirect(url_for('auth.account_settings'))\n        \n        elif action == 'password':\n            if password_form.validate_on_submit():\n                if not current_user.check_password(password_form.current_password.data):\n                    flash('현재 비밀번호가 올바르지 않습니다.', 'danger')\n                    return redirect(url_for('auth.account_settings'))\n                \n                current_user.set_password(password_form.new_password.data)\n                db.session.commit()\n                flash('비밀번호가 변경되었습니다.', 'success')\n                return redirect(url_for('auth.account_settings'))\n        \n        elif action == 'additional_info':\n            if additional_form.validate_on_submit():\n                current_user.organization_name = additional_form.organization.data\n                current_user.position = additional_form.position.data\n                current_user.job_title = additional_form.job_title.data\n                db.session.commit()\n                flash('추가 정보가 저장되었습니다.', 'success')\n                return redirect(url_for('auth.account_settings'))\n        \n        elif action == 'request_verification':\n            if not current_user.instructor_verified:\n                current_user.verification_requested_at = datetime.utcnow()\n                db.session.commit()\n                flash('강사 인증 요청이 접수되었습니다. 관리자 승인을 기다려주세요.', 'info')\n                return redirect(url_for('auth.account_settings'))\n    \n    return render_template('auth/account_settings.html',\n                          profile_form=profile_form,\n                          basic_info_form=basic_info_form,\n                          password_form=password_form,\n                          additional_form=additional_form)\n","path":null,"size_bytes":11562,"size_tokens":null},"app/routes/slides.py":{"content":"from flask import Blueprint, render_template, redirect, url_for, flash, request, jsonify, send_from_directory, abort\nfrom flask_login import login_required, current_user\nfrom app import db\nfrom app.models import Course, Enrollment, ActiveSession, SlideDeck, SlideReaction, SlideBookmark, SubjectMember\nfrom app.services.slide_converter import convert_file_to_images, delete_deck_images, SLIDES_BASE_DIR, ensure_slides_dir, ALLOWED_EXTENSIONS\nfrom datetime import datetime\nimport tempfile\nimport os\n\nbp = Blueprint('slides', __name__, url_prefix='/slides')\n\n\ndef has_course_access(course, user):\n    if course.instructor_id == user.id:\n        return True\n    if course.subject_id:\n        member = SubjectMember.query.filter_by(subject_id=course.subject_id, user_id=user.id).first()\n        if member and member.role in ['instructor', 'assistant']:\n            return True\n    return False\n\n\n@bp.route('/<int:deck_id>/<path:filename>')\n@login_required\ndef serve_slide_image(deck_id, filename):\n    deck = SlideDeck.query.get_or_404(deck_id)\n    course = Course.query.get(deck.course_id)\n    if not course:\n        abort(404)\n    is_enrolled = Enrollment.query.filter_by(course_id=course.id, user_id=current_user.id).first()\n    is_instructor = has_course_access(course, current_user)\n    if not is_enrolled and not is_instructor:\n        abort(403)\n    deck_dir = os.path.join(SLIDES_BASE_DIR, str(deck_id))\n    if not os.path.exists(deck_dir):\n        abort(404)\n    return send_from_directory(deck_dir, filename)\n\n\n@bp.route('/upload/<int:course_id>', methods=['POST'])\n@login_required\ndef upload_pptx(course_id):\n    course = Course.query.get_or_404(course_id)\n    if not has_course_access(course, current_user):\n        return jsonify({'error': '권한이 없습니다.'}), 403\n\n    file = request.files.get('pptx_file') or request.files.get('slide_file')\n    if not file or not file.filename:\n        return jsonify({'error': '파일을 선택해주세요.'}), 400\n\n    file_ext = os.path.splitext(file.filename)[1].lower()\n    if file_ext not in ALLOWED_EXTENSIONS:\n        return jsonify({'error': '.pptx, .ppt 또는 .pdf 파일만 업로드 가능합니다.'}), 400\n\n    file.seek(0, 2)\n    file_size = file.tell()\n    file.seek(0)\n    max_size = 50 * 1024 * 1024\n    if file_size > max_size:\n        return jsonify({'error': f'파일 크기가 50MB를 초과합니다. ({file_size // (1024*1024)}MB)'}), 400\n\n    ensure_slides_dir()\n\n    active_session = ActiveSession.query.filter_by(course_id=course_id, ended_at=None).first()\n\n    estimated_duration = request.form.get('estimated_duration_minutes', type=int)\n\n    deck = SlideDeck(\n        course_id=course_id,\n        session_id=active_session.id if active_session else None,\n        file_name=file.filename,\n        conversion_status='converting',\n        estimated_duration_minutes=estimated_duration if estimated_duration and estimated_duration > 0 else None\n    )\n    db.session.add(deck)\n    db.session.commit()\n\n    try:\n        with tempfile.NamedTemporaryFile(suffix=file_ext, delete=False) as tmp:\n            file.save(tmp.name)\n            tmp_path = tmp.name\n\n        slide_count, deck_dir = convert_file_to_images(tmp_path, deck.id)\n\n        deck.slide_count = slide_count\n        deck.slides_dir = deck_dir\n        deck.conversion_status = 'completed'\n        db.session.commit()\n\n        os.unlink(tmp_path)\n\n        return jsonify({\n            'success': True,\n            'deck_id': deck.id,\n            'slide_count': slide_count,\n            'slides': deck.get_slide_urls(),\n            'message': f'{slide_count}개의 슬라이드가 변환되었습니다.'\n        })\n\n    except Exception as e:\n        deck.conversion_status = 'failed'\n        deck.conversion_error = str(e)\n        db.session.commit()\n        if 'tmp_path' in locals() and os.path.exists(tmp_path):\n            os.unlink(tmp_path)\n        return jsonify({'error': f'변환 실패: {str(e)}'}), 500\n\n\n@bp.route('/delete/<int:deck_id>', methods=['POST'])\n@login_required\ndef delete_deck(deck_id):\n    deck = SlideDeck.query.get_or_404(deck_id)\n    course = Course.query.get(deck.course_id)\n    if not has_course_access(course, current_user):\n        return jsonify({'error': '권한이 없습니다.'}), 403\n\n    delete_deck_images(deck.slides_dir)\n    db.session.delete(deck)\n    db.session.commit()\n\n    return jsonify({'success': True, 'message': '슬라이드 덱이 삭제되었습니다.'})\n\n\n@bp.route('/presenter/<int:deck_id>')\n@login_required\ndef presenter_view(deck_id):\n    deck = SlideDeck.query.get_or_404(deck_id)\n    course = Course.query.get(deck.course_id)\n    if not has_course_access(course, current_user):\n        flash('강사만 프레젠터 뷰를 사용할 수 있습니다.', 'danger')\n        return redirect(url_for('courses.view', course_id=course.id))\n\n    slides = deck.get_slide_urls()\n    bookmarks = {b.slide_index: b for b in SlideBookmark.query.filter_by(deck_id=deck_id).all()}\n\n    return render_template('sessions/slide_presenter.html',\n                         deck=deck,\n                         course=course,\n                         slides=slides,\n                         bookmarks=bookmarks)\n\n\n@bp.route('/viewer/<int:deck_id>')\n@login_required\ndef viewer_view(deck_id):\n    deck = SlideDeck.query.get_or_404(deck_id)\n    course = Course.query.get(deck.course_id)\n\n    is_enrolled = Enrollment.query.filter_by(course_id=course.id, user_id=current_user.id).first()\n    is_instructor = has_course_access(course, current_user)\n\n    if not is_enrolled and not is_instructor:\n        flash('이 세션에 접근 권한이 없습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n\n    if is_instructor:\n        return redirect(url_for('slides.presenter_view', deck_id=deck_id))\n\n    slides = deck.get_slide_urls()\n\n    my_reactions = {}\n    reactions = SlideReaction.query.filter_by(deck_id=deck_id, user_id=current_user.id).all()\n    for r in reactions:\n        my_reactions[r.slide_index] = r.reaction\n\n    return render_template('sessions/slide_viewer.html',\n                         deck=deck,\n                         course=course,\n                         slides=slides,\n                         my_reactions=my_reactions)\n\n\n@bp.route('/review/<int:deck_id>')\n@login_required\ndef review_view(deck_id):\n    deck = SlideDeck.query.get_or_404(deck_id)\n    course = Course.query.get(deck.course_id)\n    if not has_course_access(course, current_user):\n        flash('강사만 리뷰 페이지에 접근할 수 있습니다.', 'danger')\n        return redirect(url_for('courses.view', course_id=course.id))\n\n    slides = deck.get_slide_urls()\n    bookmarks = {}\n    for b in SlideBookmark.query.filter_by(deck_id=deck_id).all():\n        bookmarks[b.slide_index] = b\n\n    aggregates = {}\n    for i in range(deck.slide_count):\n        understood = SlideReaction.query.filter_by(deck_id=deck_id, slide_index=i, reaction='understood').count()\n        question = SlideReaction.query.filter_by(deck_id=deck_id, slide_index=i, reaction='question').count()\n        hard = SlideReaction.query.filter_by(deck_id=deck_id, slide_index=i, reaction='hard').count()\n        total_reacted = understood + question + hard\n        aggregates[i] = {\n            'understood': understood,\n            'question': question,\n            'hard': hard,\n            'total_reacted': total_reacted\n        }\n\n    return render_template('sessions/slide_review.html',\n                         deck=deck,\n                         course=course,\n                         slides=slides,\n                         bookmarks=bookmarks,\n                         aggregates=aggregates)\n\n\n@bp.route('/review/<int:deck_id>/save-memo', methods=['POST'])\n@login_required\ndef save_bookmark_memo(deck_id):\n    deck = SlideDeck.query.get_or_404(deck_id)\n    course = Course.query.get(deck.course_id)\n    if not has_course_access(course, current_user):\n        return jsonify({'error': '권한이 없습니다.'}), 403\n\n    data = request.get_json()\n    slide_index = data.get('slide_index')\n    memo = data.get('memo', '')\n    supplement_url = data.get('supplement_url', '')\n\n    bookmark = SlideBookmark.query.filter_by(deck_id=deck_id, slide_index=slide_index).first()\n    if not bookmark:\n        bookmark = SlideBookmark(\n            deck_id=deck_id,\n            slide_index=slide_index,\n            is_manual=True\n        )\n        db.session.add(bookmark)\n\n    bookmark.memo = memo\n    bookmark.supplement_url = supplement_url\n    db.session.commit()\n\n    return jsonify({'success': True})\n\n\n@bp.route('/review/<int:deck_id>/toggle-bookmark', methods=['POST'])\n@login_required\ndef toggle_manual_bookmark(deck_id):\n    deck = SlideDeck.query.get_or_404(deck_id)\n    course = Course.query.get(deck.course_id)\n    if not has_course_access(course, current_user):\n        return jsonify({'error': '권한이 없습니다.'}), 403\n\n    data = request.get_json()\n    slide_index = data.get('slide_index')\n\n    bookmark = SlideBookmark.query.filter_by(deck_id=deck_id, slide_index=slide_index).first()\n    if bookmark:\n        if bookmark.is_auto and not bookmark.is_manual:\n            bookmark.is_manual = True\n        elif bookmark.is_manual and not bookmark.is_auto:\n            db.session.delete(bookmark)\n        else:\n            bookmark.is_manual = not bookmark.is_manual\n    else:\n        bookmark = SlideBookmark(\n            deck_id=deck_id,\n            slide_index=slide_index,\n            is_manual=True\n        )\n        db.session.add(bookmark)\n\n    db.session.commit()\n\n    return jsonify({'success': True})\n\n\n@bp.route('/deck/<int:course_id>')\n@login_required\ndef get_course_decks(course_id):\n    course = Course.query.get_or_404(course_id)\n    decks = SlideDeck.query.filter_by(course_id=course_id).order_by(SlideDeck.created_at.desc()).all()\n    return jsonify({\n        'decks': [{\n            'id': d.id,\n            'file_name': d.file_name,\n            'slide_count': d.slide_count,\n            'conversion_status': d.conversion_status,\n            'current_slide_index': d.current_slide_index,\n            'created_at': d.created_at.strftime('%Y-%m-%d %H:%M')\n        } for d in decks]\n    })\n","path":null,"size_bytes":10189,"size_tokens":null},"config.py":{"content":"import os\nfrom dotenv import load_dotenv\n\nload_dotenv()\n\nclass Config:\n    SECRET_KEY = os.environ.get('SESSION_SECRET') or os.environ.get('SECRET_KEY') or 'dev-secret-key-change-in-production'\n    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL')\n    SQLALCHEMY_TRACK_MODIFICATIONS = False\n    WTF_CSRF_ENABLED = True\n    WTF_CSRF_TIME_LIMIT = None\n","path":null,"size_bytes":357,"size_tokens":null},"app/__init__.py":{"content":"import os\nfrom flask import Flask\nfrom flask_sqlalchemy import SQLAlchemy\nfrom flask_migrate import Migrate\nfrom flask_login import LoginManager\nfrom flask_bcrypt import Bcrypt\nfrom flask_socketio import SocketIO\nfrom flask_wtf.csrf import CSRFProtect\nfrom config import Config\n\ndb = SQLAlchemy()\nmigrate = Migrate()\nlogin_manager = LoginManager()\nbcrypt = Bcrypt()\nsocketio = SocketIO()\ncsrf = CSRFProtect()\n\nlogin_manager.login_view = 'auth.login'\nlogin_manager.login_message_category = 'info'\n\ndef create_app(config_class=Config):\n    app = Flask(__name__)\n    app.config.from_object(config_class)\n    \n    db.init_app(app)\n    migrate.init_app(app, db)\n    login_manager.init_app(app)\n    bcrypt.init_app(app)\n    csrf.init_app(app)\n    \n    allowed_origins = []\n    replit_domains = os.environ.get('REPLIT_DOMAINS', '')\n    if replit_domains:\n        for domain in replit_domains.split(','):\n            allowed_origins.append(f'https://{domain.strip()}')\n    \n    if not allowed_origins:\n        allowed_origins = []\n        app.logger.warning('REPLIT_DOMAINS not set - WebSocket CORS restricted to same origin only')\n    \n    socketio.init_app(app, cors_allowed_origins=allowed_origins if allowed_origins else None, async_mode='eventlet')\n    \n    from app.routes import auth, courses, checkpoints, progress, analytics, main, forum, subjects, attendance, community, guide, sessions, slides\n    app.register_blueprint(auth.bp)\n    app.register_blueprint(courses.bp)\n    app.register_blueprint(checkpoints.bp)\n    app.register_blueprint(progress.bp)\n    app.register_blueprint(analytics.bp)\n    app.register_blueprint(main.bp)\n    app.register_blueprint(forum.bp)\n    app.register_blueprint(subjects.bp)\n    app.register_blueprint(attendance.bp)\n    app.register_blueprint(community.bp)\n    app.register_blueprint(guide.bp)\n    app.register_blueprint(sessions.bp)\n    app.register_blueprint(slides.bp)\n    \n    from app import events\n    \n    with app.app_context():\n        db.create_all()\n    \n    return app\n","path":null,"size_bytes":2016,"size_tokens":null},"main.py":{"content":"import os\nfrom app import create_app, socketio\n\napp = create_app()\n\nif __name__ == '__main__':\n    debug = os.environ.get('FLASK_DEBUG', 'false').lower() == 'true'\n    socketio.run(app, host='0.0.0.0', port=5000, debug=debug)\n","path":null,"size_bytes":226,"size_tokens":null},"app/routes/checkpoints.py":{"content":"from flask import Blueprint, render_template, redirect, url_for, flash, request, jsonify\nfrom flask_login import login_required, current_user\nfrom app import db\nfrom app.models import Course, Checkpoint\nfrom app.forms import CheckpointForm\nfrom datetime import datetime\nimport traceback\n\nbp = Blueprint('checkpoints', __name__, url_prefix='/checkpoints')\n\n@bp.route('/course/<int:course_id>/create', methods=['GET', 'POST'])\n@login_required\ndef create(course_id):\n    course = Course.query.get_or_404(course_id)\n    if course.instructor_id != current_user.id:\n        flash('권한이 없습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    form = CheckpointForm()\n    if form.validate_on_submit():\n        max_order = db.session.query(db.func.max(Checkpoint.order)).filter_by(course_id=course_id).scalar() or 0\n        checkpoint = Checkpoint(\n            course_id=course_id,\n            title=form.title.data,\n            description=form.description.data,\n            estimated_minutes=form.estimated_minutes.data,\n            order=max_order + 1\n        )\n        db.session.add(checkpoint)\n        db.session.commit()\n        flash('체크포인트가 추가되었습니다!', 'success')\n        return redirect(url_for('courses.view', course_id=course_id))\n    \n    return render_template('checkpoints/create.html', form=form, course=course)\n\n@bp.route('/<int:checkpoint_id>/edit', methods=['GET', 'POST'])\n@login_required\ndef edit(checkpoint_id):\n    checkpoint = Checkpoint.query.get_or_404(checkpoint_id)\n    course = checkpoint.course\n    if course.instructor_id != current_user.id:\n        flash('권한이 없습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    form = CheckpointForm(obj=checkpoint)\n    if form.validate_on_submit():\n        checkpoint.title = form.title.data\n        checkpoint.description = form.description.data\n        checkpoint.estimated_minutes = form.estimated_minutes.data\n        db.session.commit()\n        flash('체크포인트가 수정되었습니다!', 'success')\n        return redirect(url_for('courses.view', course_id=course.id))\n    \n    return render_template('checkpoints/edit.html', form=form, checkpoint=checkpoint, course=course)\n\n@bp.route('/<int:checkpoint_id>/delete', methods=['POST'])\n@login_required\ndef delete(checkpoint_id):\n    checkpoint = Checkpoint.query.get_or_404(checkpoint_id)\n    course = checkpoint.course\n    if course.instructor_id != current_user.id:\n        flash('권한이 없습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    try:\n        checkpoint.deleted_at = datetime.utcnow()\n        db.session.commit()\n        flash('체크포인트가 삭제되었습니다!', 'success')\n    except Exception as e:\n        db.session.rollback()\n        flash('체크포인트 삭제 중 오류가 발생했습니다.', 'danger')\n    return redirect(url_for('courses.view', course_id=course.id))\n\n\n@bp.route('/course/<int:course_id>/bulk-delete', methods=['POST'])\n@login_required\ndef bulk_delete(course_id):\n    course = Course.query.get_or_404(course_id)\n    if course.instructor_id != current_user.id:\n        return jsonify({'error': '권한이 없습니다.'}), 403\n    \n    data = request.get_json()\n    checkpoint_ids = data.get('checkpoint_ids', [])\n    delete_all = data.get('delete_all', False)\n    \n    if delete_all:\n        checkpoints = Checkpoint.query.filter_by(course_id=course_id, deleted_at=None).all()\n    else:\n        checkpoints = Checkpoint.query.filter(\n            Checkpoint.id.in_(checkpoint_ids),\n            Checkpoint.course_id == course_id,\n            Checkpoint.deleted_at == None\n        ).all()\n    \n    deleted_count = 0\n    for cp in checkpoints:\n        cp.deleted_at = datetime.utcnow()\n        deleted_count += 1\n    \n    db.session.commit()\n    \n    return jsonify({\n        'success': True,\n        'deleted_count': deleted_count\n    })\n\n@bp.route('/reorder', methods=['POST'])\n@login_required\ndef reorder():\n    data = request.get_json()\n    if not data or 'checkpoints' not in data:\n        return jsonify({'error': '잘못된 데이터입니다'}), 400\n    \n    for item in data['checkpoints']:\n        checkpoint = Checkpoint.query.get(item['id'])\n        if checkpoint and checkpoint.course.instructor_id == current_user.id:\n            checkpoint.order = item['order']\n    \n    db.session.commit()\n    return jsonify({'success': True})\n\n\n@bp.route('/course/<int:course_id>/ai-generate', methods=['GET', 'POST'])\n@login_required\ndef ai_generate(course_id):\n    course = Course.query.get_or_404(course_id)\n    if course.instructor_id != current_user.id:\n        flash('권한이 없습니다.', 'danger')\n        return redirect(url_for('main.dashboard'))\n    \n    if request.method == 'POST':\n        return redirect(url_for('checkpoints.ai_generate', course_id=course_id))\n    \n    return render_template('checkpoints/ai_generate.html', course=course)\n\n\n@bp.route('/course/<int:course_id>/ai-generate/upload', methods=['POST'])\n@login_required\ndef ai_generate_upload(course_id):\n    course = Course.query.get_or_404(course_id)\n    if course.instructor_id != current_user.id:\n        return jsonify({'error': '권한이 없습니다.'}), 403\n    \n    try:\n        from app.services.ai_checkpoint import CheckpointGenerator\n        \n        source_type = request.form.get('source_type', 'ppt')\n        file = request.files.get('file')\n        text_content = request.form.get('text_content', '')\n        \n        checkpoints = []\n        transcript = None\n        \n        if source_type == 'text' and text_content:\n            checkpoints = CheckpointGenerator.generate_from_text(text_content)\n        elif file:\n            file_data = file.read()\n            filename = file.filename or 'unknown'\n            \n            if source_type == 'ppt':\n                checkpoints = CheckpointGenerator.generate_checkpoints_from_ppt(file_data, filename)\n            elif source_type == 'video':\n                mime_type = file.content_type or 'video/mp4'\n                checkpoints, transcript = CheckpointGenerator.generate_checkpoints_from_media(file_data, mime_type)\n            elif source_type == 'audio':\n                mime_type = file.content_type or 'audio/mpeg'\n                checkpoints, transcript = CheckpointGenerator.generate_checkpoints_from_media(file_data, mime_type)\n        \n        return jsonify({\n            'success': True,\n            'checkpoints': checkpoints,\n            'transcript': transcript\n        })\n        \n    except Exception as e:\n        traceback.print_exc()\n        return jsonify({'error': str(e)}), 500\n\n\n@bp.route('/course/<int:course_id>/ai-generate/save', methods=['POST'])\n@login_required\ndef ai_generate_save(course_id):\n    course = Course.query.get_or_404(course_id)\n    if course.instructor_id != current_user.id:\n        return jsonify({'error': '권한이 없습니다.'}), 403\n    \n    data = request.get_json()\n    checkpoints_data = data.get('checkpoints', [])\n    \n    if not checkpoints_data:\n        return jsonify({'error': '체크포인트가 없습니다.'}), 400\n    \n    max_order = db.session.query(db.func.max(Checkpoint.order)).filter_by(course_id=course_id).scalar() or 0\n    \n    created_count = 0\n    for cp_data in checkpoints_data:\n        max_order += 1\n        checkpoint = Checkpoint(\n            course_id=course_id,\n            title=cp_data.get('title', ''),\n            description=cp_data.get('description', ''),\n            estimated_minutes=cp_data.get('estimated_minutes', 5),\n            order=max_order\n        )\n        db.session.add(checkpoint)\n        created_count += 1\n    \n    db.session.commit()\n    \n    return jsonify({\n        'success': True,\n        'created_count': created_count,\n        'redirect_url': url_for('courses.view', course_id=course_id)\n    })\n","path":null,"size_bytes":7871,"size_tokens":null},"seed.py":{"content":"from app import create_app, db\nfrom app.models import User, Course, Checkpoint, Enrollment, Progress, Subject, SubjectEnrollment, SubjectMember, Organization, QuizQuestion\nfrom datetime import datetime, timedelta\nimport random\n\ndef seed_database():\n    app = create_app()\n    with app.app_context():\n        print(\"Dropping all tables...\")\n        db.drop_all()\n        print(\"Creating all tables...\")\n        db.create_all()\n        \n        print(\"Creating organizations...\")\n        org1 = Organization(\n            name='테크 아카데미',\n            description='IT 전문 교육 기관'\n        )\n        org2 = Organization(\n            name='비즈니스 스쿨',\n            description='경영 및 비즈니스 교육 기관'\n        )\n        db.session.add(org1)\n        db.session.add(org2)\n        db.session.commit()\n        \n        print(\"Creating users...\")\n        \n        system_admin = User(\n            username='sysadmin',\n            email='sysadmin@example.com',\n            role='system_admin',\n            full_name='시스템 관리자'\n        )\n        system_admin.set_password('password123')\n        \n        org_admin1 = User(\n            username='orgadmin1',\n            email='orgadmin1@example.com',\n            role='org_admin',\n            organization_id=org1.id,\n            full_name='테크아카데미 관리자'\n        )\n        org_admin1.set_password('password123')\n        \n        org_admin2 = User(\n            username='orgadmin2',\n            email='orgadmin2@example.com',\n            role='org_admin',\n            organization_id=org2.id,\n            full_name='비즈니스스쿨 관리자'\n        )\n        org_admin2.set_password('password123')\n        \n        instructor1 = User(\n            username='instructor1',\n            email='instructor1@example.com',\n            role='instructor',\n            organization_id=org1.id,\n            full_name='김강사'\n        )\n        instructor1.set_password('password123')\n        \n        instructor2 = User(\n            username='instructor2',\n            email='instructor2@example.com',\n            role='instructor',\n            organization_id=org1.id,\n            full_name='이강사'\n        )\n        instructor2.set_password('password123')\n        \n        instructor3 = User(\n            username='instructor3',\n            email='instructor3@example.com',\n            role='instructor',\n            organization_id=org2.id,\n            full_name='박강사'\n        )\n        instructor3.set_password('password123')\n        \n        students = []\n        for i in range(1, 11):\n            org_id = org1.id if i <= 5 else org2.id\n            student = User(\n                username=f'student{i}',\n                email=f'student{i}@example.com',\n                role='student',\n                organization_id=org_id,\n                full_name=f'학습자{i}'\n            )\n            student.set_password('password123')\n            students.append(student)\n        \n        db.session.add(system_admin)\n        db.session.add(org_admin1)\n        db.session.add(org_admin2)\n        db.session.add(instructor1)\n        db.session.add(instructor2)\n        db.session.add(instructor3)\n        for student in students:\n            db.session.add(student)\n        db.session.commit()\n        \n        print(\"Creating subjects...\")\n        subject1 = Subject(\n            title='Python 프로그래밍 기초',\n            description='Python 프로그래밍을 처음부터 배우는 과정입니다.',\n            instructor_id=instructor1.id,\n            organization_id=org1.id,\n            invite_code='PYTHON01'\n        )\n        \n        subject2 = Subject(\n            title='웹개발 입문',\n            description='HTML, CSS, JavaScript를 활용한 웹개발 기초 과정',\n            instructor_id=instructor1.id,\n            organization_id=org1.id,\n            invite_code='WEBDEV01'\n        )\n        \n        subject3 = Subject(\n            title='데이터 분석 기초',\n            description='데이터 분석과 시각화, 머신러닝 기초',\n            instructor_id=instructor2.id,\n            organization_id=org1.id,\n            invite_code='DATASCI1'\n        )\n        \n        subject4 = Subject(\n            title='비즈니스 전략',\n            description='경영 전략과 의사결정 과정',\n            instructor_id=instructor3.id,\n            organization_id=org2.id,\n            invite_code='BIZ00001'\n        )\n        \n        db.session.add(subject1)\n        db.session.add(subject2)\n        db.session.add(subject3)\n        db.session.add(subject4)\n        db.session.commit()\n        \n        for subj, inst in [(subject1, instructor1), (subject2, instructor1), (subject3, instructor2), (subject4, instructor3)]:\n            member = SubjectMember(subject_id=subj.id, user_id=inst.id, role='instructor')\n            db.session.add(member)\n        db.session.commit()\n        \n        print(\"Creating courses (sessions)...\")\n        course1 = Course(\n            title='1주차: Python 설치 및 환경 설정',\n            description='개발 환경을 구축하고 첫 Python 프로그램을 작성합니다.',\n            instructor_id=instructor1.id,\n            subject_id=subject1.id,\n            session_type='live_session',\n            week_number=1,\n            invite_code='PY1WK001'\n        )\n        \n        course2 = Course(\n            title='2주차: 변수와 데이터 타입',\n            description='문자열, 숫자, 불리언 등 기본 데이터 타입을 학습합니다.',\n            instructor_id=instructor1.id,\n            subject_id=subject1.id,\n            session_type='video',\n            week_number=2,\n            invite_code='PY1WK002',\n            min_completion_time=60\n        )\n        \n        course3 = Course(\n            title='3주차: 제어문',\n            description='if/else와 반복문을 마스터합니다.',\n            instructor_id=instructor1.id,\n            subject_id=subject1.id,\n            session_type='live_session',\n            week_number=3,\n            invite_code='PY1WK003'\n        )\n        \n        course4 = Course(\n            title='4주차: 학습 자료 - Python 문법 정리',\n            description='Python 기본 문법을 정리한 학습 자료입니다.',\n            instructor_id=instructor1.id,\n            subject_id=subject1.id,\n            session_type='material',\n            week_number=4,\n            invite_code='PY1WK004',\n            assignment_description='<h5>Python 기본 문법 정리</h5><ul><li>변수와 데이터 타입</li><li>연산자</li><li>조건문과 반복문</li><li>함수</li></ul><p>위 내용을 학습하고 완료 버튼을 눌러주세요.</p>'\n        )\n        \n        course5 = Course(\n            title='5주차: 과제 - 계산기 프로그램',\n            description='간단한 계산기 프로그램을 작성하는 과제입니다.',\n            instructor_id=instructor1.id,\n            subject_id=subject1.id,\n            session_type='assignment',\n            week_number=5,\n            invite_code='PY1WK005',\n            assignment_description='<h5>과제: 계산기 프로그램 만들기</h5><p>다음 요구사항을 충족하는 계산기 프로그램을 작성하세요:</p><ol><li>덧셈, 뺄셈, 곱셈, 나눗셈 기능</li><li>사용자 입력 받기</li><li>결과 출력</li></ol>',\n            assignment_due_date=datetime.utcnow() + timedelta(days=7)\n        )\n        \n        course6 = Course(\n            title='6주차: 퀴즈 - Python 기초 테스트',\n            description='지금까지 배운 내용을 확인하는 퀴즈입니다.',\n            instructor_id=instructor1.id,\n            subject_id=subject1.id,\n            session_type='quiz',\n            week_number=6,\n            invite_code='PY1WK006',\n            quiz_time_limit=15,\n            quiz_pass_score=60\n        )\n        \n        course7 = Course(\n            title='유튜브 강의: Python 소개',\n            description='YouTube에서 Python 소개 영상을 시청합니다.',\n            instructor_id=instructor1.id,\n            subject_id=subject1.id,\n            session_type='video',\n            week_number=1,\n            session_number=2,\n            invite_code='PY1YT001',\n            video_url='https://www.youtube.com/watch?v=Y8Tko2YC5hA',\n            min_completion_time=120\n        )\n        \n        db.session.add(course1)\n        db.session.add(course2)\n        db.session.add(course3)\n        db.session.add(course4)\n        db.session.add(course5)\n        db.session.add(course6)\n        db.session.add(course7)\n        db.session.commit()\n        \n        print(\"Creating checkpoints...\")\n        python_checkpoints = [\n            ('개발 환경 설정', 'Python과 VS Code 설치', 10),\n            ('Hello World 출력', '첫 프로그램 작성하기', 15),\n            ('변수 선언', '변수에 값 할당하기', 20),\n        ]\n        \n        for i, (title, desc, est_min) in enumerate(python_checkpoints):\n            cp = Checkpoint(\n                course_id=course1.id,\n                title=title,\n                description=desc,\n                order=i + 1,\n                estimated_minutes=est_min\n            )\n            db.session.add(cp)\n        \n        db.session.commit()\n        \n        print(\"Creating quiz questions...\")\n        quiz_questions = [\n            ('Python에서 변수를 선언할 때 사용하는 키워드는?', 'short_answer', None, 'x = 10 처럼 직접 할당', 10),\n            ('print() 함수의 역할은?', 'multiple_choice', '화면에 출력\\n파일 저장\\n데이터 삭제\\n변수 선언', '화면에 출력', 10),\n            ('Python은 인터프리터 언어이다.', 'true_false', None, 'true', 10),\n            ('리스트와 튜플의 차이점은 무엇인가?', 'short_answer', None, '리스트는 수정 가능, 튜플은 수정 불가', 20),\n            ('for문에서 range(5)의 출력 범위는?', 'multiple_choice', '0부터 4까지\\n1부터 5까지\\n0부터 5까지\\n1부터 4까지', '0부터 4까지', 10),\n        ]\n        \n        for i, (question, q_type, options, answer, points) in enumerate(quiz_questions):\n            q = QuizQuestion(\n                course_id=course6.id,\n                question_text=question,\n                question_type=q_type,\n                options=options,\n                correct_answer=answer,\n                points=points,\n                order=i + 1\n            )\n            db.session.add(q)\n        \n        db.session.commit()\n        \n        print(\"Creating enrollments...\")\n        for student in students[:5]:\n            enrollment = SubjectEnrollment(subject_id=subject1.id, user_id=student.id)\n            db.session.add(enrollment)\n            for course in [course1, course2, course3, course4, course5, course6, course7]:\n                course_enroll = Enrollment(course_id=course.id, user_id=student.id)\n                db.session.add(course_enroll)\n        \n        db.session.commit()\n        \n        print(\"\\n\" + \"=\"*60)\n        print(\"    테스트 계정 정보\")\n        print(\"=\"*60)\n        print(\"\\n[시스템 관리자] - 전체 시스템 관리\")\n        print(f\"  이메일: sysadmin@example.com\")\n        print(f\"  비밀번호: password123\")\n        \n        print(\"\\n[기관 관리자] - 소속 기관 과목/세션만 관리\")\n        print(f\"  테크아카데미: orgadmin1@example.com\")\n        print(f\"  비즈니스스쿨: orgadmin2@example.com\")\n        print(f\"  비밀번호: password123 (공통)\")\n        \n        print(\"\\n[강사] - 과목 생성 및 수업 진행\")\n        print(f\"  테크아카데미: instructor1@example.com, instructor2@example.com\")\n        print(f\"  비즈니스스쿨: instructor3@example.com\")\n        print(f\"  비밀번호: password123 (공통)\")\n        \n        print(\"\\n[학습자] - 과목 수강 및 학습\")\n        print(f\"  테크아카데미: student1~5@example.com\")\n        print(f\"  비즈니스스쿨: student6~10@example.com\")\n        print(f\"  비밀번호: password123 (공통)\")\n        \n        print(\"\\n[샘플 초대 코드]\")\n        print(f\"  Python 프로그래밍 기초: PYTHON01\")\n        print(f\"  웹개발 입문: WEBDEV01\")\n        print(f\"  데이터 분석 기초: DATASCI1\")\n        print(f\"  비즈니스 전략: BIZ00001\")\n        print(\"\\n\" + \"=\"*60)\n        print(\"데이터베이스 시드 완료!\")\n\nif __name__ == '__main__':\n    seed_database()\n","path":null,"size_bytes":12516,"size_tokens":null}},"version":2}